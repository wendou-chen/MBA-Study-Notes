var w=Object.defineProperty;var N=Object.getOwnPropertyDescriptor;var V=Object.getOwnPropertyNames;var H=Object.prototype.hasOwnProperty;var K=(o,n)=>{for(var t in n)w(o,t,{get:n[t],enumerable:!0})},G=(o,n,t,e)=>{if(n&&typeof n=="object"||typeof n=="function")for(let s of V(n))!H.call(o,s)&&s!==t&&w(o,s,{get:()=>n[s],enumerable:!(e=N(n,s))||e.enumerable});return o};var W=o=>G(w({},"__esModule",{value:!0}),o);var at={};K(at,{default:()=>y});module.exports=W(at);var g=require("obsidian");var k=require("obsidian");var Y=[{id:1,name:"\u57FA\u7840\u592F\u5B9E",startDate:"2026-02-14",endDate:"2026-04-20",allocation:{math:.55,major:.2,english:.1,competition:.15}},{id:2,name:"\u57FA\u7840\u6536\u5C3E",startDate:"2026-04-21",endDate:"2026-06-30",allocation:{math:.5,major:.25,english:.1,review:.15}},{id:3,name:"\u5F3A\u5316\u7A81\u7834",startDate:"2026-07-01",endDate:"2026-09-30",allocation:{math:.4,major:.25,english:.15,politics:.15,review:.05}},{id:4,name:"\u51B2\u523A\u6A21\u8003",startDate:"2026-10-01",endDate:"2026-11-30",allocation:{math:.35,major:.25,english:.15,politics:.2,review:.05}},{id:5,name:"\u8003\u524D\u6536\u5B98",startDate:"2026-12-01",endDate:"2026-12-20",allocation:{math:.3,major:.2,english:.15,politics:.3,review:.05}}],J=[{month:"2026.03",items:["\u9AD8\u6570\u4E0A\u518C\u5168\u4E66\u4E00\u5237\u5B8C\u6210","\u4FE1\u53F7\u4E0E\u7CFB\u7EDF\u524D 4 \u7AE0\u901A\u8BFB"]},{month:"2026.04",items:["\u9AD8\u6570\u4E0B\u518C\u5168\u4E66\u4E00\u5237\u5B8C\u6210","\u5927\u5510\u676F/\u84DD\u6865\u676F\u6BD4\u8D5B\u7ED3\u675F"]},{month:"2026.05",items:["\u7EBF\u6027\u4EE3\u6570\u5168\u4E66\u4E00\u5237\u5B8C\u6210","\u4FE1\u53F7\u4E0E\u7CFB\u7EDF\u524D 8 \u7AE0\u901A\u8BFB"]},{month:"2026.06",items:["\u6982\u7387\u8BBA\u5168\u4E66\u4E00\u5237\u5B8C\u6210","\u5168\u4E66\u4E8C\u5237\u542F\u52A8","\u4FE1\u53F7\u6559\u6750\u901A\u8BFB\u5B8C\u6BD5"]},{month:"2026.07",items:["\u5168\u4E66\u4E8C\u5237\u8FC7\u534A","\u653F\u6CBB\u7CBE\u8BB2\u7CBE\u7EC3\u542F\u52A8","\u82F1\u8BED\u9605\u8BFB\u8BAD\u7EC3\u542F\u52A8"]},{month:"2026.08",items:["\u5168\u4E66\u4E8C\u5237\u5B8C\u6210","\u4FE1\u53F7\u771F\u9898\u4E00\u5237\u542F\u52A8","\u653F\u6CBB 1000 \u9898\u8FC7\u534A"]},{month:"2026.09",items:["\u6570\u5B66\u771F\u9898\u4E00\u5237\u5B8C\u6210","\u4FE1\u53F7\u771F\u9898\u4E00\u5237\u5B8C\u6210","\u653F\u6CBB 1000 \u9898\u5B8C\u6210"]},{month:"2026.10",items:["\u9996\u6B21\u5168\u79D1\u6A21\u8003","\u82F1\u8BED\u4F5C\u6587\u6A21\u677F\u6210\u578B","\u653F\u6CBB\u80CC\u8BF5\u542F\u52A8"]},{month:"2026.11",items:["\u6A21\u8003 3 \u8F6E\u4EE5\u4E0A","\u5404\u79D1\u67E5\u6F0F\u8865\u7F3A\u6E05\u5355\u751F\u6210"]},{month:"2026.12",items:["\u8003\u524D\u6700\u7EC8\u6A21\u8003","\u653F\u6CBB\u62BC\u9898\u5377","\u5FC3\u6001\u8C03\u6574"]}];function L(o){let n=new Date(o+"T00:00:00"),t=new Date;return t.setHours(0,0,0,0),Math.ceil((n.getTime()-t.getTime())/(1e3*60*60*24))}function I(o){var t;let n=new Date(o);return n.setHours(0,0,0,0),(t=Y.find(e=>{let s=new Date(e.startDate+"T00:00:00"),i=new Date(e.endDate+"T00:00:00");return n>=s&&n<=i}))!=null?t:null}function B(o,n){let t=new Date(o.startDate+"T00:00:00").getTime(),e=new Date(o.endDate+"T00:00:00").getTime(),s=new Date(n).setHours(0,0,0,0);return Math.min(1,Math.max(0,(s-t)/(e-t)))}function A(o){var t;let n=`${o.getFullYear()}.${String(o.getMonth()+1).padStart(2,"0")}`;return(t=J.find(e=>e.month===n))!=null?t:null}var j=["math","major","english","politics"],D={provider:"anthropic",apiKey:"",baseUrl:"",model:"claude-opus-4-6-20250616"};function X(){let o=new Date,n=o.getFullYear();o.getMonth()===11&&o.getDate()>25&&n++;let s=1+(6-new Date(n,11,1).getDay()+7)%7+14;return`${n}-12-${String(s).padStart(2,"0")}`}var M={math:"\u6570\u5B66",major:"\u4E13\u4E1A\u8BFE",english:"\u82F1\u8BED",politics:"\u653F\u6CBB",competition:"\u7ADE\u8D5B",review:"\u6A21\u8003/\u590D\u76D8"},q=[{id:"m1",subject:"math",text:"\u9AD8\u6570\u4E0A\u518C\u5168\u4E66\u4E00\u5237",completed:!1},{id:"m2",subject:"math",text:"\u9AD8\u6570\u4E0B\u518C\u5168\u4E66\u4E00\u5237",completed:!1},{id:"m3",subject:"math",text:"\u7EBF\u6027\u4EE3\u6570\u5168\u4E66\u4E00\u5237",completed:!1},{id:"m4",subject:"math",text:"\u6982\u7387\u8BBA\u5168\u4E66\u4E00\u5237",completed:!1},{id:"m5",subject:"math",text:"\u5168\u4E66\u4E8C\u5237",completed:!1},{id:"m6",subject:"math",text:"\u6570\u5B66\u771F\u9898\u4E00\u5237",completed:!1},{id:"j1",subject:"major",text:"\u4FE1\u53F7\u4E0E\u7CFB\u7EDF\u6559\u6750\u901A\u8BFB",completed:!1},{id:"j2",subject:"major",text:"\u4FE1\u53F7\u4E0E\u7CFB\u7EDF\u771F\u9898\u4E00\u5237",completed:!1},{id:"e1",subject:"english",text:"\u5355\u8BCD 5500 \u8FC7\u4E00\u904D",completed:!1},{id:"e2",subject:"english",text:"\u82F1\u8BED\u9605\u8BFB\u8BAD\u7EC3",completed:!1},{id:"e3",subject:"english",text:"\u4F5C\u6587\u6A21\u677F\u6210\u578B",completed:!1},{id:"p1",subject:"politics",text:"\u7CBE\u8BB2\u7CBE\u7EC3 + 1000 \u9898",completed:!1},{id:"p2",subject:"politics",text:"\u653F\u6CBB\u80CC\u8BF5",completed:!1},{id:"p3",subject:"politics",text:"\u62BC\u9898\u5377",completed:!1}],T={pomodoroDurationMin:25,shortBreakMin:5,longBreakMin:15,longBreakInterval:4,scientificDurationMin:90,scientificLongBreakMin:20,microPauseSec:15,strictMode:!1,autoStart:!1,defaultFocusMode:"pomodoro",defaultSubject:"math"},_={pomodorosToday:0,totalFocusMinutesToday:0,statsDate:""},x={examDate:X(),planFolder:"\u8003\u7814\u8BA1\u5212",tasks:q,completedMilestones:[],showAllocation:!0,viewMode:"day",focus:{...T},focusStats:{..._},ai:{...D},bookmarks:[]};var z=/^\|\s*(.+?)\s*\|\s*(.+?)\s*\|\s*(.+?)\s*\|\s*(⬜|✅)\s*\|/,Q=/^- \[([ xX])\]\s*(.+?)\s*\|\s*(.+?)\s*\|\s*(.+)/;function Z(o){let n=o.split(`
`),t=[];for(let e=0;e<n.length;e++){let s=n[e].match(z);if(s){let a=s[1].trim();if(a.includes("\u65F6\u95F4")||a.startsWith(":")||a.startsWith("-"))continue;t.push({time:a,subject:s[2].replace(/\*/g,"").trim(),description:s[3].replace(/\*/g,"").trim(),completed:s[4].trim()==="\u2705",lineIndex:e});continue}let i=n[e].match(Q);i&&t.push({time:i[2].trim(),subject:i[3].replace(/\*/g,"").trim(),description:i[4].replace(/\*/g,"").trim(),completed:i[1]!==" ",lineIndex:e})}return t}function O(o,n,t){let e=o.split(`
`);if(n<0||n>=e.length)return o;let s=e[n];return s.includes("\u2B1C")||s.includes("\u2705")?e[n]=t?s.replace("\u2B1C","\u2705"):s.replace("\u2705","\u2B1C"):e[n]=t?s.replace("- [ ]","- [x]"):s.replace(/- \[[xX]\]/,"- [ ]"),e.join(`
`)}function tt(o,n,t){var i;let e=o.getFiles(),s=`${t}/${n}`;return(i=e.find(a=>a.path.startsWith(s)&&a.extension==="md"))!=null?i:null}async function P(o,n,t){let e=tt(o,n,t);if(!e)return null;let s=await o.read(e);return{date:n,tasks:Z(s),filePath:e.path}}function et(o){let n=new Date(o);n.setHours(0,0,0,0);let t=n.getDay(),e=t===0?-6:1-t,s=new Date(n);s.setDate(n.getDate()+e);let i=[];for(let a=0;a<7;a++){let c=new Date(s);c.setDate(s.getDate()+a),i.push(c)}return i}var st=["\u5468\u65E5","\u5468\u4E00","\u5468\u4E8C","\u5468\u4E09","\u5468\u56DB","\u5468\u4E94","\u5468\u516D"];function it(o){let n=o.getFullYear(),t=String(o.getMonth()+1).padStart(2,"0"),e=String(o.getDate()).padStart(2,"0");return`${n}-${t}-${e}`}async function R(o,n,t){let e=et(n),s=[];for(let i of e){let a=it(i),c=await P(o,a,t);s.push({date:a,weekday:st[i.getDay()],total:c?c.tasks.length:0,done:c?c.tasks.filter(r=>r.completed).length:0,filePath:c?c.filePath:null})}return s}var C=null;function nt(){return C||(C=new AudioContext),C}function b(o,n,t){try{let e=nt(),s=e.createOscillator(),i=e.createGain();s.type="sine",s.frequency.value=o,i.gain.setValueAtTime(t,e.currentTime),i.gain.exponentialRampToValueAtTime(.001,e.currentTime+n),s.connect(i),i.connect(e.destination),s.start(e.currentTime),s.stop(e.currentTime+n)}catch(e){}}function U(o){switch(o){case"microPauseStart":b(600,.2,.15);break;case"microPauseEnd":b(600,.15,.2),setTimeout(()=>b(700,.15,.2),180);break;case"focusEnd":b(800,.5,.3);break;case"breakEnd":b(700,.3,.25);break}}function $(){return(Math.floor(Math.random()*4)+6)*60*1e3}function F(){let o=new Date;return`${o.getFullYear()}-${String(o.getMonth()+1).padStart(2,"0")}-${String(o.getDate()).padStart(2,"0")}`}var v=class{constructor(){this.focusMode="pomodoro";this.pomodoroDurationMin=25;this.shortBreakMin=5;this.longBreakMin=15;this.longBreakInterval=4;this.scientificDurationMin=90;this.scientificLongBreakMin=20;this.microPauseSec=15;this.strictMode=!1;this.autoStart=!1;this._state="IDLE";this._remainingMs=0;this._totalMs=0;this._pomodorosToday=0;this._totalFocusMs=0;this._pomodoroCount=0;this._nextMicroPauseMs=0;this._prePauseRemainingMs=0;this._prePauseTotalMs=0;this._tickInterval=null;this._statsDate="";this._subject="math";this._paused=!1;this._elapsedMs=0;this._tickCbs=[];this._stateChangeCbs=[];this._soundCbs=[]}on(n,t){n==="tick"?this._tickCbs.push(t):n==="stateChange"?this._stateChangeCbs.push(t):n==="sound"&&this._soundCbs.push(t)}getSnapshot(){return{state:this._state,remainingMs:this._state==="MICRO_PAUSE"?this._remainingMs:this._remainingMs,totalMs:this._state==="MICRO_PAUSE"?this.microPauseSec*1e3:this._totalMs,focusMode:this.focusMode,pomodorosToday:this._pomodorosToday,totalFocusMinutesToday:Math.floor(this._totalFocusMs/6e4),pomodoroCount:this._pomodoroCount,subject:this._subject,microPauseRemainingMs:this._state==="MICRO_PAUSE"?this._remainingMs:0,elapsedMs:this._elapsedMs}}loadStats(n){let t=F();n.statsDate===t?(this._pomodorosToday=n.pomodorosToday,this._totalFocusMs=n.totalFocusMinutesToday*6e4):(this._pomodorosToday=0,this._totalFocusMs=0),this._statsDate=t}exportStats(){return{pomodorosToday:this._pomodorosToday,totalFocusMinutesToday:Math.floor(this._totalFocusMs/6e4),statsDate:this._statsDate||F()}}start(n){this._subject=n,this._paused=!1,this._elapsedMs=0,this.checkDateReset(),this.focusMode==="stopwatch"?(this._totalMs=0,this._remainingMs=0):this.focusMode==="pomodoro"?(this._totalMs=this.pomodoroDurationMin*6e4,this._remainingMs=this._totalMs):(this._totalMs=this.scientificDurationMin*6e4,this._remainingMs=this._totalMs,this._nextMicroPauseMs=$()),this.transition("FOCUSING"),this.startTicking()}pause(){return this.strictMode||this._state!=="FOCUSING"?!1:(this._paused=!0,this.stopTicking(),!0)}resume(){this._paused&&(this._paused=!1,this.startTicking())}reset(){return this.strictMode&&this._state==="FOCUSING"?!1:(this.stopTicking(),this._paused=!1,this._elapsedMs=0,this._pomodoroCount=0,this.transition("IDLE"),!0)}skipBreak(){this._state!=="SHORT_BREAK"&&this._state!=="LONG_BREAK"||(this.stopTicking(),this.handleBreakEnd())}stopStopwatch(){this._state!=="FOCUSING"||this.focusMode!=="stopwatch"||(this.stopTicking(),this.emitSound("focusEnd"),this._elapsedMs=0,this._paused=!1,this.transition("IDLE"))}get isPaused(){return this._paused}get state(){return this._state}destroy(){this.stopTicking()}startTicking(){this.stopTicking(),this._tickInterval=window.setInterval(()=>this.tick(),1e3)}stopTicking(){this._tickInterval!==null&&(clearInterval(this._tickInterval),this._tickInterval=null)}transition(n){this._state=n;for(let t of this._stateChangeCbs)t(this.getSnapshot())}emitTick(){let n=this.getSnapshot();for(let t of this._tickCbs)t(n)}emitSound(n){for(let t of this._soundCbs)t(n)}checkDateReset(){let n=F();this._statsDate!==n&&(this._pomodorosToday=0,this._totalFocusMs=0,this._statsDate=n)}tick(){if(this.focusMode==="stopwatch"&&this._state==="FOCUSING"){this._elapsedMs+=1e3,this._totalFocusMs+=1e3,this.emitTick();return}if(this._remainingMs-=1e3,this._state==="FOCUSING"&&(this._totalFocusMs+=1e3,this.focusMode==="scientific"&&(this._nextMicroPauseMs-=1e3,this._nextMicroPauseMs<=0&&this._remainingMs>this.microPauseSec*1e3))){this._prePauseRemainingMs=this._remainingMs,this._prePauseTotalMs=this._totalMs,this._remainingMs=this.microPauseSec*1e3,this._totalMs=this.microPauseSec*1e3,this.emitSound("microPauseStart"),this.transition("MICRO_PAUSE");return}if(this._remainingMs<=0){this.handleTimerEnd();return}this.emitTick()}handleTimerEnd(){switch(this.stopTicking(),this._state){case"FOCUSING":this._pomodorosToday++,this._pomodoroCount++,this.emitSound("focusEnd"),this.focusMode==="pomodoro"?this._pomodoroCount>=this.longBreakInterval?(this._pomodoroCount=0,this._totalMs=this.longBreakMin*6e4,this._remainingMs=this._totalMs,this.transition("LONG_BREAK")):(this._totalMs=this.shortBreakMin*6e4,this._remainingMs=this._totalMs,this.transition("SHORT_BREAK")):(this._totalMs=this.scientificLongBreakMin*6e4,this._remainingMs=this._totalMs,this.transition("LONG_BREAK")),this.startTicking();break;case"MICRO_PAUSE":this.emitSound("microPauseEnd"),this._remainingMs=this._prePauseRemainingMs,this._totalMs=this._prePauseTotalMs,this._nextMicroPauseMs=$(),this.transition("FOCUSING"),this.startTicking();break;case"SHORT_BREAK":case"LONG_BREAK":this.handleBreakEnd();break}}handleBreakEnd(){this.emitSound("breakEnd"),this.autoStart?this.start(this._subject):(this._remainingMs=0,this._totalMs=0,this.transition("IDLE"))}};var f="kaoyan-countdown-view",S=class extends k.ItemView{constructor(t,e){super(t);this.refreshInterval=0;this.dailyPlan=null;this.timerDisplayEl=null;this.timerProgressEl=null;this.timerStateEl=null;this.focusSectionEl=null;this.selectedFocusMode="pomodoro";this.selectedSubject="math";this.selectedDurationMin=25;this.plugin=e,this.timerEngine=new v,this.syncEngineFromSettings(),this.timerEngine.loadStats(e.settings.focusStats),this.selectedFocusMode=e.settings.focus.defaultFocusMode,this.selectedSubject=e.settings.focus.defaultSubject,this.selectedDurationMin=e.settings.focus.pomodoroDurationMin,this.timerEngine.on("tick",s=>this.onTimerTick(s)),this.timerEngine.on("stateChange",s=>this.onTimerStateChange(s)),this.timerEngine.on("sound",s=>U(s))}getViewType(){return f}getDisplayText(){return"\u8003\u7814\u5012\u8BA1\u65F6"}getIcon(){return"clock"}async onOpen(){await this.fullRender(),this.refreshInterval=window.setInterval(()=>this.fullRender(),6e4),this.registerInterval(this.refreshInterval);let t=(0,k.debounce)(()=>this.fullRender(),200,!0);this.registerEvent(this.app.vault.on("modify",e=>{e.path.startsWith(this.plugin.settings.planFolder+"/")&&t()}))}async onClose(){await this.persistFocusStats(),this.timerEngine.destroy()}async refresh(){await this.fullRender()}get viewMode(){return this.plugin.settings.viewMode}async setViewMode(t){this.plugin.settings.viewMode=t,await this.plugin.saveSettings(),await this.fullRender()}todayStr(){let t=new Date,e=t.getFullYear(),s=String(t.getMonth()+1).padStart(2,"0"),i=String(t.getDate()).padStart(2,"0");return`${e}-${s}-${i}`}async fullRender(){let t=this.contentEl;switch(t.empty(),t.addClass("kaoyan-countdown-container"),this.renderCountdown(t),this.renderModeTabs(t),this.viewMode){case"day":await this.renderDayMode(t);break;case"week":await this.renderWeekMode(t);break;case"phase":this.renderPhaseMode(t);break;case"focus":this.renderFocusTab(t);break}}renderCountdown(t){let e=t.createDiv({cls:"kc-countdown-section"}),s=L(this.plugin.settings.examDate);e.createEl("div",{cls:"kc-title",text:"\u{1F3AF} \u8003\u7814\u5012\u8BA1\u65F6"}),e.createEl("div",{cls:"kc-days",text:`${s}`}),e.createEl("div",{cls:"kc-days-label",text:"\u5929"}),e.createEl("div",{cls:"kc-exam-date",text:`\u8003\u8BD5\u65E5\u671F\uFF1A${this.plugin.settings.examDate}`}),this.renderBookmarks(e)}renderBookmarks(t){let e=this.plugin.settings.bookmarks;if(!e||e.length===0)return;let s=t.createDiv({cls:"kc-bookmarks-wrapper"});s.createEl("div",{cls:"kc-bookmarks-title",text:"\u{1F4D6} \u7EE7\u7EED\u5B66\u4E60"});let i=e[0],a=s.createEl("button",{cls:"kc-bookmark-btn"});a.createEl("span",{cls:"kc-bookmark-icon",text:"\u25B6"}),a.createEl("span",{cls:"kc-bookmark-text",text:i.label});let c=Math.floor((Date.now()-i.timestamp)/6e4),r=c<60?`${c}\u5206\u949F\u524D`:`${Math.floor(c/60)}\u5C0F\u65F6\u524D`;a.createEl("span",{cls:"kc-bookmark-time",text:r}),a.createEl("span",{cls:"kc-bookmark-auto",text:"\u25CF \u81EA\u52A8"}),a.addEventListener("click",async()=>{let d=this.app.vault.getAbstractFileByPath(i.filePath);d?await this.app.workspace.getLeaf(!1).openFile(d,{state:i.state}):new k.Notice("\u6587\u4EF6\u5DF2\u4E0D\u5B58\u5728")})}renderModeTabs(t){let e=t.createDiv({cls:"kc-tabs"}),s=[{mode:"day",label:"\u{1F4C5} Day"},{mode:"week",label:"\u{1F4CA} Week"},{mode:"phase",label:"\u{1F5FA}\uFE0F Phase"},{mode:"focus",label:"\u{1F345} Focus"}];for(let{mode:i,label:a}of s)e.createEl("button",{cls:`kc-tab${this.viewMode===i?" kc-tab-active":""}`,text:a}).addEventListener("click",()=>this.setViewMode(i))}async renderDayMode(t){let e=t.createDiv({cls:"kc-day-section"}),s=this.todayStr();if(this.dailyPlan=await P(this.app.vault,s,this.plugin.settings.planFolder),!this.dailyPlan){e.createEl("div",{cls:"kc-empty",text:"\u4ECA\u65E5\u6682\u65E0\u8BA1\u5212\u6587\u4EF6"});return}let i=this.dailyPlan.tasks,a=i.filter(l=>l.completed).length,c=i.length,r=e.createDiv({cls:"kc-day-header"});r.createEl("span",{text:`\u5B8C\u6210\u7387 ${a}/${c}`,cls:"kc-day-progress-label"});let u=r.createDiv({cls:"kc-progress-bar"}).createDiv({cls:"kc-progress-fill"});u.style.width=c>0?`${Math.round(a/c*100)}%`:"0%";for(let l of i){let p=e.createDiv({cls:`kc-day-task${l.completed?" kc-day-task-done":""}`}),m=p.createEl("input",{type:"checkbox"});m.checked=l.completed,m.addEventListener("change",()=>this.toggleDailyTask(l.lineIndex,m.checked)),p.createEl("span",{cls:"kc-day-time",text:l.time}),p.createEl("span",{cls:"kc-day-subject",text:l.subject}),p.createEl("span",{cls:"kc-day-desc",text:l.description})}}async toggleDailyTask(t,e){if(!this.dailyPlan)return;let s=this.app.vault.getAbstractFileByPath(this.dailyPlan.filePath);if(!s||!("stat"in s))return;let i=await this.app.vault.read(s),a=O(i,t,e);await this.app.vault.modify(s,a)}async renderWeekMode(t){let e=t.createDiv({cls:"kc-week-section"}),s=this.todayStr(),i=await R(this.app.vault,new Date,this.plugin.settings.planFolder);for(let a of i){let c=a.date===s,r=e.createDiv({cls:`kc-week-row${c?" kc-week-today":""}`}),d=r.createDiv({cls:"kc-week-info"});if(d.createEl("span",{cls:"kc-week-date",text:`${a.date.slice(5)}`}),d.createEl("span",{cls:"kc-week-day",text:a.weekday}),a.filePath){let u=a.total>0?Math.round(a.done/a.total*100):0,p=r.createDiv({cls:"kc-progress-bar kc-week-bar"}).createDiv({cls:"kc-progress-fill"});p.style.width=`${u}%`,r.createEl("span",{cls:"kc-week-pct",text:`${u}%`}),r.style.cursor="pointer";let m=a.filePath;r.addEventListener("click",()=>{this.app.vault.getAbstractFileByPath(m)&&this.app.workspace.openLinkText(m,"",!1)})}else r.createEl("span",{cls:"kc-week-empty",text:"\u2014"})}}renderPhaseMode(t){this.renderPhase(t),this.renderTasks(t)}renderPhase(t){let e=t.createDiv({cls:"kc-phase-section"}),s=new Date,i=I(s);if(!i){e.createEl("div",{cls:"kc-phase-name",text:"\u5F53\u524D\u4E0D\u5728\u4EFB\u4F55\u9636\u6BB5\u8303\u56F4\u5185"});return}let a=B(i,s);e.createEl("div",{cls:"kc-phase-name",text:`\u{1F4CD} Phase ${i.id} ${i.name}`}),e.createEl("div",{cls:"kc-phase-range",text:`${i.startDate} \u2192 ${i.endDate}`});let r=e.createDiv({cls:"kc-progress-bar"}).createDiv({cls:"kc-progress-fill"});if(r.style.width=`${Math.round(a*100)}%`,e.createEl("div",{cls:"kc-progress-text",text:`${Math.round(a*100)}%`}),this.plugin.settings.showAllocation){let d=e.createDiv({cls:"kc-allocation"});for(let[u,l]of Object.entries(i.allocation))if(l&&l>0){let p=M[u]||u;d.createEl("span",{cls:"kc-alloc-tag",text:`${p} ${Math.round(l*100)}%`})}}}renderTasks(t){let e=t.createDiv({cls:"kc-tasks-section"}),i=A(new Date);if(i){e.createEl("div",{cls:"kc-section-title",text:`\u{1F4CB} ${i.month} \u91CC\u7A0B\u7891`});for(let r of i.items){let d=e.createDiv({cls:"kc-task-row"}),u=d.createEl("input",{type:"checkbox"});u.checked=this.plugin.settings.completedMilestones.includes(r),u.addEventListener("change",async()=>{let l=this.plugin.settings.completedMilestones;u.checked?l.includes(r)||l.push(r):this.plugin.settings.completedMilestones=l.filter(p=>p!==r),await this.plugin.saveSettings()}),d.createEl("span",{text:r,cls:u.checked?"kc-completed":""})}}e.createEl("div",{cls:"kc-section-title",text:"\u{1F4CB} \u5F85\u529E\u77E5\u8BC6\u70B9"});let a=this.plugin.settings.tasks,c={};for(let r of a)(c[r.subject]=c[r.subject]||[]).push(r);for(let[r,d]of Object.entries(c)){let u=M[r]||r;e.createEl("div",{cls:"kc-subject-label",text:u});for(let l of d){let p=e.createDiv({cls:"kc-task-row"}),m=p.createEl("input",{type:"checkbox"});m.checked=l.completed,m.addEventListener("change",async()=>{l.completed=m.checked,await this.plugin.saveSettings(),await this.fullRender()}),p.createEl("span",{text:l.text,cls:l.completed?"kc-completed":""})}}}renderFocusTab(t){this.focusSectionEl=t.createDiv({cls:"kc-focus-section"}),this.renderFocusContent()}renderFocusContent(){let t=this.focusSectionEl;if(!t)return;t.empty();let e=this.timerEngine.getSnapshot();this.renderFocusModeToggle(t,e),this.renderTimerDisplay(t,e),e.state==="IDLE"&&this.selectedFocusMode==="pomodoro"&&this.renderDurationPicker(t),e.state==="IDLE"?this.renderSubjectSelector(t):e.state!=="MICRO_PAUSE"&&t.createEl("div",{cls:"kc-focus-current-subject",text:`\u79D1\u76EE: ${M[e.subject]||e.subject}`}),e.state==="MICRO_PAUSE"&&this.renderMicroPauseOverlay(t,e),this.renderTimerControls(t,e),this.renderFocusStats(t,e)}renderFocusModeToggle(t,e){let s=t.createDiv({cls:"kc-focus-mode-toggle"}),i=e.state!=="IDLE",a=[{mode:"pomodoro",label:"\u756A\u8304\u949F"},{mode:"scientific",label:"\u79D1\u5B66\u4E13\u6CE8"},{mode:"stopwatch",label:"\u6B63\u8BA1\u65F6"}];for(let{mode:c,label:r}of a){let d=s.createEl("button",{cls:`kc-focus-mode-btn${this.selectedFocusMode===c?" kc-focus-mode-active":""}${i?" kc-disabled":""}`,text:r});i||d.addEventListener("click",()=>{this.selectedFocusMode!==c&&(this.selectedFocusMode=c,this.timerEngine.focusMode=c,this.renderFocusContent())})}}renderTimerDisplay(t,e){let s=t.createDiv({cls:"kc-timer-display"});this.timerStateEl=s.createEl("div",{cls:"kc-timer-state",text:this.getStateLabel(e.state)});let i;e.state==="IDLE"?this.selectedFocusMode==="pomodoro"?i=this.selectedDurationMin*6e4:this.selectedFocusMode==="scientific"?i=this.plugin.settings.focus.scientificDurationMin*6e4:i=0:e.focusMode==="stopwatch"?i=e.elapsedMs:i=e.remainingMs,this.timerDisplayEl=s.createEl("div",{cls:"kc-timer-countdown",text:this.formatTime(i)});let a=e.state==="IDLE"&&this.selectedFocusMode==="stopwatch"||e.state!=="IDLE"&&e.focusMode==="stopwatch",c=s.createDiv({cls:`kc-timer-progress-bar${a?" kc-hidden":""}`});this.timerProgressEl=c.createDiv({cls:"kc-timer-progress-fill"});let r=e.totalMs>0?(e.totalMs-e.remainingMs)/e.totalMs*100:0;this.timerProgressEl.style.width=`${Math.min(100,r)}%`}renderSubjectSelector(t){let e=t.createDiv({cls:"kc-subject-selector"});for(let s of j){let i=M[s]||s;e.createEl("button",{cls:`kc-subject-btn${this.selectedSubject===s?" kc-subject-btn-active":""}`,text:i}).addEventListener("click",()=>{this.selectedSubject=s,this.renderFocusContent()})}}renderDurationPicker(t){let e=t.createDiv({cls:"kc-duration-picker"}),s=[15,25,30,45,60];for(let i of s)e.createEl("button",{cls:`kc-duration-btn${this.selectedDurationMin===i?" kc-duration-btn-active":""}`,text:`${i}min`}).addEventListener("click",()=>{this.selectedDurationMin=i,this.renderFocusContent()})}renderMicroPauseOverlay(t,e){let s=t.createDiv({cls:"kc-micro-pause-overlay"});s.createEl("div",{cls:"kc-micro-pause-icon",text:"\u{1F60C}"}),s.createEl("div",{cls:"kc-micro-pause-text",text:"\u95ED\u773C\u4F11\u606F"}),s.createEl("div",{cls:"kc-micro-pause-timer",text:this.formatTime(e.microPauseRemainingMs)})}renderTimerControls(t,e){let s=t.createDiv({cls:"kc-timer-controls"});switch(e.state){case"IDLE":{if(s.createEl("button",{cls:"kc-btn kc-btn-start",text:"\u5F00\u59CB\u4E13\u6CE8"}).addEventListener("click",()=>{this.timerEngine.focusMode=this.selectedFocusMode,this.syncEngineFromSettings(),this.selectedFocusMode==="pomodoro"&&(this.timerEngine.pomodoroDurationMin=this.selectedDurationMin),this.timerEngine.start(this.selectedSubject)}),this.selectedFocusMode!=="stopwatch"){let a=s.createDiv({cls:"kc-strict-toggle"}),c=a.createEl("input",{type:"checkbox"});c.checked=this.timerEngine.strictMode,c.addEventListener("change",()=>{this.timerEngine.strictMode=c.checked,this.plugin.settings.focus.strictMode=c.checked,this.plugin.saveSettings()}),a.createEl("span",{cls:"kc-strict-label",text:"\u5B66\u9738\u6A21\u5F0F (\u7981\u6B62\u6682\u505C/\u653E\u5F03)"})}break}case"FOCUSING":{e.focusMode==="stopwatch"?(s.createEl("button",{cls:"kc-btn kc-btn-stop",text:"\u7ED3\u675F\u4E13\u6CE8"}).addEventListener("click",()=>this.timerEngine.stopStopwatch()),this.timerEngine.isPaused?s.createEl("button",{cls:"kc-btn kc-btn-start",text:"\u7EE7\u7EED"}).addEventListener("click",()=>this.timerEngine.resume()):s.createEl("button",{cls:"kc-btn kc-btn-pause",text:"\u6682\u505C"}).addEventListener("click",()=>{this.timerEngine.pause(),this.renderFocusContent()})):this.timerEngine.strictMode?s.createEl("span",{cls:"kc-strict-label",text:"\u{1F512} \u5B66\u9738\u6A21\u5F0F"}):this.timerEngine.isPaused?(s.createEl("button",{cls:"kc-btn kc-btn-start",text:"\u7EE7\u7EED"}).addEventListener("click",()=>this.timerEngine.resume()),s.createEl("button",{cls:"kc-btn kc-btn-reset",text:"\u653E\u5F03"}).addEventListener("click",()=>this.timerEngine.reset())):(s.createEl("button",{cls:"kc-btn kc-btn-pause",text:"\u6682\u505C"}).addEventListener("click",()=>{this.timerEngine.pause(),this.renderFocusContent()}),s.createEl("button",{cls:"kc-btn kc-btn-reset",text:"\u653E\u5F03"}).addEventListener("click",()=>this.timerEngine.reset()));break}case"SHORT_BREAK":case"LONG_BREAK":{s.createEl("button",{cls:"kc-btn kc-btn-skip",text:"\u8DF3\u8FC7\u4F11\u606F"}).addEventListener("click",()=>this.timerEngine.skipBreak());break}case"MICRO_PAUSE":break}}renderFocusStats(t,e){let s=t.createDiv({cls:"kc-focus-stats"});s.createEl("span",{cls:"kc-focus-stat",text:`\u{1F345} ${e.pomodorosToday} \u4E2A\u756A\u8304`}),s.createEl("span",{cls:"kc-focus-stat",text:`\u23F1 ${e.totalFocusMinutesToday} \u5206\u949F`})}onTimerTick(t){if(this.timerDisplayEl){let e=t.focusMode==="stopwatch"?t.elapsedMs:t.remainingMs;this.timerDisplayEl.textContent=this.formatTime(e)}if(this.timerProgressEl&&t.totalMs>0){let e=(t.totalMs-t.remainingMs)/t.totalMs*100;this.timerProgressEl.style.width=`${Math.min(100,e)}%`}}onTimerStateChange(t){this.viewMode==="focus"&&this.renderFocusContent(),this.persistFocusStats()}formatTime(t){let e=Math.max(0,Math.ceil(t/1e3)),s=Math.floor(e/3600),i=Math.floor(e%3600/60),a=e%60,c=String(i).padStart(2,"0"),r=String(a).padStart(2,"0");return s>0?`${String(s).padStart(2,"0")}:${c}:${r}`:`${c}:${r}`}getStateLabel(t){switch(t){case"IDLE":return"\u51C6\u5907\u5C31\u7EEA";case"FOCUSING":return"\u{1F525} \u4E13\u6CE8\u4E2D";case"MICRO_PAUSE":return"\u{1F60C} \u5FAE\u4F11\u606F";case"SHORT_BREAK":return"\u2615 \u77ED\u4F11\u606F";case"LONG_BREAK":return"\u{1F33F} \u957F\u4F11\u606F"}}syncEngineFromSettings(){let t=this.plugin.settings.focus,e=this.timerEngine;e.pomodoroDurationMin=t.pomodoroDurationMin,e.shortBreakMin=t.shortBreakMin,e.longBreakMin=t.longBreakMin,e.longBreakInterval=t.longBreakInterval,e.scientificDurationMin=t.scientificDurationMin,e.scientificLongBreakMin=t.scientificLongBreakMin,e.microPauseSec=t.microPauseSec,e.strictMode=t.strictMode,e.autoStart=t.autoStart}async persistFocusStats(){let t=this.timerEngine.exportStats();this.plugin.settings.focusStats=t,await this.plugin.saveSettings()}};var h=require("obsidian"),E=class extends h.PluginSettingTab{constructor(n,t){super(n,t),this.plugin=t}display(){let{containerEl:n}=this;n.empty(),n.createEl("h2",{text:"\u8003\u7814\u5012\u8BA1\u65F6 \u8BBE\u7F6E"}),new h.Setting(n).setName("\u8003\u8BD5\u65E5\u671F").setDesc("\u683C\u5F0F YYYY-MM-DD\uFF0C\u5982 2026-12-19").addText(i=>i.setPlaceholder("2026-12-19").setValue(this.plugin.settings.examDate).onChange(async a=>{/^\d{4}-\d{2}-\d{2}$/.test(a)&&(this.plugin.settings.examDate=a,await this.plugin.saveSettings(),this.plugin.refreshViews())})),new h.Setting(n).setName("\u8BA1\u5212\u6587\u4EF6\u5939").setDesc("\u5B58\u653E\u6BCF\u65E5\u8BA1\u5212\u6587\u4EF6\u7684\u6587\u4EF6\u5939\u8DEF\u5F84").addText(i=>i.setPlaceholder("\u8003\u7814\u8BA1\u5212").setValue(this.plugin.settings.planFolder).onChange(async a=>{this.plugin.settings.planFolder=a.trim()||"\u8003\u7814\u8BA1\u5212",await this.plugin.saveSettings(),this.plugin.refreshViews()})),new h.Setting(n).setName("\u663E\u793A\u65F6\u95F4\u5206\u914D").setDesc("\u5728\u9636\u6BB5\u89C6\u56FE\u4E2D\u663E\u793A\u5404\u79D1\u76EE\u65F6\u95F4\u5206\u914D\u6BD4\u4F8B").addToggle(i=>i.setValue(this.plugin.settings.showAllocation).onChange(async a=>{this.plugin.settings.showAllocation=a,await this.plugin.saveSettings(),this.plugin.refreshViews()})),n.createEl("h3",{text:"\u4E13\u6CE8\u6A21\u5F0F"}),new h.Setting(n).setName("\u756A\u8304\u949F\u65F6\u957F (\u5206\u949F)").addSlider(i=>i.setLimits(15,60,5).setValue(this.plugin.settings.focus.pomodoroDurationMin).setDynamicTooltip().onChange(async a=>{this.plugin.settings.focus.pomodoroDurationMin=a,await this.plugin.saveSettings()})),new h.Setting(n).setName("\u77ED\u4F11\u606F (\u5206\u949F)").addSlider(i=>i.setLimits(1,15,1).setValue(this.plugin.settings.focus.shortBreakMin).setDynamicTooltip().onChange(async a=>{this.plugin.settings.focus.shortBreakMin=a,await this.plugin.saveSettings()})),new h.Setting(n).setName("\u957F\u4F11\u606F (\u5206\u949F)").addSlider(i=>i.setLimits(10,30,5).setValue(this.plugin.settings.focus.longBreakMin).setDynamicTooltip().onChange(async a=>{this.plugin.settings.focus.longBreakMin=a,await this.plugin.saveSettings()})),new h.Setting(n).setName("\u957F\u4F11\u606F\u95F4\u9694 (\u756A\u8304\u6570)").addSlider(i=>i.setLimits(2,6,1).setValue(this.plugin.settings.focus.longBreakInterval).setDynamicTooltip().onChange(async a=>{this.plugin.settings.focus.longBreakInterval=a,await this.plugin.saveSettings()})),new h.Setting(n).setName("\u79D1\u5B66\u4E13\u6CE8\u65F6\u957F (\u5206\u949F)").addSlider(i=>i.setLimits(60,120,10).setValue(this.plugin.settings.focus.scientificDurationMin).setDynamicTooltip().onChange(async a=>{this.plugin.settings.focus.scientificDurationMin=a,await this.plugin.saveSettings()})),n.createEl("h3",{text:"AI \u6A21\u578B\u914D\u7F6E"});let t={anthropic:{url:"https://api.anthropic.com",model:"claude-opus-4-6-20250616"},openai:{url:"https://api.openai.com/v1",model:"gpt-4o"},deepseek:{url:"https://api.deepseek.com",model:"deepseek-chat"}};new h.Setting(n).setName("AI \u670D\u52A1\u5546").setDesc("\u9009\u62E9 AI API \u63D0\u4F9B\u5546").addDropdown(i=>i.addOption("anthropic","Anthropic (Claude)").addOption("openai","OpenAI (GPT)").addOption("deepseek","DeepSeek").setValue(this.plugin.settings.ai.provider).onChange(async a=>{this.plugin.settings.ai.provider=a,this.plugin.settings.ai.baseUrl="",this.plugin.settings.ai.model="",await this.plugin.saveSettings(),this.display()})),new h.Setting(n).setName("API Key").setDesc("\u7559\u7A7A\u5219\u4F7F\u7528 .env \u6587\u4EF6\u4E2D\u7684\u914D\u7F6E").addText(i=>{i.inputEl.type="password",i.setPlaceholder("sk-...").setValue(this.plugin.settings.ai.apiKey).onChange(async a=>{this.plugin.settings.ai.apiKey=a.trim(),await this.plugin.saveSettings()})});let e=this.plugin.settings.ai.provider,s=t[e]||t.anthropic;new h.Setting(n).setName("Base URL").setDesc("\u81EA\u5B9A\u4E49 API \u5730\u5740\uFF08\u7559\u7A7A\u4F7F\u7528\u9ED8\u8BA4\uFF09").addText(i=>i.setPlaceholder(s.url).setValue(this.plugin.settings.ai.baseUrl).onChange(async a=>{this.plugin.settings.ai.baseUrl=a.trim(),await this.plugin.saveSettings()})),new h.Setting(n).setName("\u6A21\u578B\u540D\u79F0").setDesc("\u7559\u7A7A\u4F7F\u7528\u9ED8\u8BA4\u6A21\u578B").addText(i=>i.setPlaceholder(s.model).setValue(this.plugin.settings.ai.model).onChange(async a=>{this.plugin.settings.ai.model=a.trim(),await this.plugin.saveSettings()}))}};var y=class extends g.Plugin{constructor(){super(...arguments);this.settings=x}async onload(){await this.loadSettings(),this.registerView(f,t=>new S(t,this)),this.addSettingTab(new E(this.app,this)),this.addRibbonIcon("clock","\u8003\u7814\u5012\u8BA1\u65F6",()=>{this.activateView()}),this.addCommand({id:"open-kaoyan-countdown",name:"\u6253\u5F00\u8003\u7814\u5012\u8BA1\u65F6",callback:()=>this.activateView()}),this.addCommand({id:"save-study-progress",name:"\u8BB0\u5F55\u5F53\u524D\u5B66\u4E60\u8FDB\u5EA6",callback:()=>this.saveCurrentProgress()}),this.app.workspace.onLayoutReady(()=>{this.app.workspace.getLeavesOfType(f).length===0&&this.activateView()}),this.registerInterval(window.setInterval(()=>this.autoTrackProgress(),8e3))}onunload(){this.app.workspace.detachLeavesOfType(f)}async activateView(){let{workspace:t}=this.app,e=t.getLeavesOfType(f);if(e.length>0){t.revealLeaf(e[0]);return}let s=t.getRightLeaf(!1);s&&(await s.setViewState({type:f,active:!0}),t.revealLeaf(s))}refreshViews(){for(let t of this.app.workspace.getLeavesOfType(f)){let e=t.view;e instanceof S&&e.refresh()}}async saveCurrentProgress(){let t=this.app.workspace.activeLeaf;if(!t){new g.Notice("\u6CA1\u6709\u6D3B\u52A8\u7684\u89C6\u56FE");return}let e=t.view;if(!(e instanceof g.FileView)||!e.file){new g.Notice("\u5F53\u524D\u89C6\u56FE\u4E0D\u662F\u6587\u4EF6\u89C6\u56FE");return}let s=e.getState(),i=e.file.path,a=Date.now(),c={filePath:i,state:s,label:e.file.basename,timestamp:a},r=this.settings.bookmarks||[];r=r.filter(d=>d.filePath!==i),r.unshift(c),r.length>5&&(r=r.slice(0,5)),this.settings.bookmarks=r,await this.saveSettings(),this.refreshViews(),new g.Notice(`\u5DF2\u8BB0\u5F55\u5B66\u4E60\u8FDB\u5EA6: ${e.file.basename}`)}async autoTrackProgress(){var d;let t=this.app.workspace.activeLeaf;if(!t)return;let e=t.view;if(!(e instanceof g.FileView)||!e.file||((d=e.file.extension)==null?void 0:d.toLowerCase())!=="pdf")return;let s=e.getState(),i=e.file.path,a=(this.settings.bookmarks||[]).find(u=>u.filePath===i);if(a&&JSON.stringify(a.state)===JSON.stringify(s))return;let c={filePath:i,state:s,label:e.file.basename,timestamp:Date.now()},r=this.settings.bookmarks||[];r=r.filter(u=>u.filePath!==i),r.unshift(c),r.length>5&&(r=r.slice(0,5)),this.settings.bookmarks=r,await this.saveSettings(),this.refreshViews()}async loadSettings(){let t=await this.loadData()||{};this.settings=Object.assign({},x,t),this.settings.focus=Object.assign({},T,t.focus),this.settings.focusStats=Object.assign({},_,t.focusStats),this.settings.ai=Object.assign({},D,t.ai)}async saveSettings(){await this.saveData(this.settings)}};
