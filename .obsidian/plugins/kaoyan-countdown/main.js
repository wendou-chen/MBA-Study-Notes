var S=Object.defineProperty;var A=Object.getOwnPropertyDescriptor;var $=Object.getOwnPropertyNames;var U=Object.prototype.hasOwnProperty;var H=(o,n)=>{for(var t in n)S(o,t,{get:n[t],enumerable:!0})},N=(o,n,t,e)=>{if(n&&typeof n=="object"||typeof n=="function")for(let s of $(n))!U.call(o,s)&&s!==t&&S(o,s,{get:()=>n[s],enumerable:!(e=A(n,s))||e.enumerable});return o};var V=o=>N(S({},"__esModule",{value:!0}),o);var st={};H(st,{default:()=>E});module.exports=V(st);var R=require("obsidian");var b=require("obsidian");var G=[{id:1,name:"\u57FA\u7840\u592F\u5B9E",startDate:"2026-02-14",endDate:"2026-04-20",allocation:{math:.55,major:.2,english:.1,competition:.15}},{id:2,name:"\u57FA\u7840\u6536\u5C3E",startDate:"2026-04-21",endDate:"2026-06-30",allocation:{math:.5,major:.25,english:.1,review:.15}},{id:3,name:"\u5F3A\u5316\u7A81\u7834",startDate:"2026-07-01",endDate:"2026-09-30",allocation:{math:.4,major:.25,english:.15,politics:.15,review:.05}},{id:4,name:"\u51B2\u523A\u6A21\u8003",startDate:"2026-10-01",endDate:"2026-11-30",allocation:{math:.35,major:.25,english:.15,politics:.2,review:.05}},{id:5,name:"\u8003\u524D\u6536\u5B98",startDate:"2026-12-01",endDate:"2026-12-20",allocation:{math:.3,major:.2,english:.15,politics:.3,review:.05}}],W=[{month:"2026.03",items:["\u9AD8\u6570\u4E0A\u518C\u5168\u4E66\u4E00\u5237\u5B8C\u6210","\u4FE1\u53F7\u4E0E\u7CFB\u7EDF\u524D 4 \u7AE0\u901A\u8BFB"]},{month:"2026.04",items:["\u9AD8\u6570\u4E0B\u518C\u5168\u4E66\u4E00\u5237\u5B8C\u6210","\u5927\u5510\u676F/\u84DD\u6865\u676F\u6BD4\u8D5B\u7ED3\u675F"]},{month:"2026.05",items:["\u7EBF\u6027\u4EE3\u6570\u5168\u4E66\u4E00\u5237\u5B8C\u6210","\u4FE1\u53F7\u4E0E\u7CFB\u7EDF\u524D 8 \u7AE0\u901A\u8BFB"]},{month:"2026.06",items:["\u6982\u7387\u8BBA\u5168\u4E66\u4E00\u5237\u5B8C\u6210","\u5168\u4E66\u4E8C\u5237\u542F\u52A8","\u4FE1\u53F7\u6559\u6750\u901A\u8BFB\u5B8C\u6BD5"]},{month:"2026.07",items:["\u5168\u4E66\u4E8C\u5237\u8FC7\u534A","\u653F\u6CBB\u7CBE\u8BB2\u7CBE\u7EC3\u542F\u52A8","\u82F1\u8BED\u9605\u8BFB\u8BAD\u7EC3\u542F\u52A8"]},{month:"2026.08",items:["\u5168\u4E66\u4E8C\u5237\u5B8C\u6210","\u4FE1\u53F7\u771F\u9898\u4E00\u5237\u542F\u52A8","\u653F\u6CBB 1000 \u9898\u8FC7\u534A"]},{month:"2026.09",items:["\u6570\u5B66\u771F\u9898\u4E00\u5237\u5B8C\u6210","\u4FE1\u53F7\u771F\u9898\u4E00\u5237\u5B8C\u6210","\u653F\u6CBB 1000 \u9898\u5B8C\u6210"]},{month:"2026.10",items:["\u9996\u6B21\u5168\u79D1\u6A21\u8003","\u82F1\u8BED\u4F5C\u6587\u6A21\u677F\u6210\u578B","\u653F\u6CBB\u80CC\u8BF5\u542F\u52A8"]},{month:"2026.11",items:["\u6A21\u8003 3 \u8F6E\u4EE5\u4E0A","\u5404\u79D1\u67E5\u6F0F\u8865\u7F3A\u6E05\u5355\u751F\u6210"]},{month:"2026.12",items:["\u8003\u524D\u6700\u7EC8\u6A21\u8003","\u653F\u6CBB\u62BC\u9898\u5377","\u5FC3\u6001\u8C03\u6574"]}];function x(o){let n=new Date(o+"T00:00:00"),t=new Date;return t.setHours(0,0,0,0),Math.ceil((n.getTime()-t.getTime())/(1e3*60*60*24))}function C(o){var t;let n=new Date(o);return n.setHours(0,0,0,0),(t=G.find(e=>{let s=new Date(e.startDate+"T00:00:00"),i=new Date(e.endDate+"T00:00:00");return n>=s&&n<=i}))!=null?t:null}function F(o,n){let t=new Date(o.startDate+"T00:00:00").getTime(),e=new Date(o.endDate+"T00:00:00").getTime(),s=new Date(n).setHours(0,0,0,0);return Math.min(1,Math.max(0,(s-t)/(e-t)))}function P(o){var t;let n=`${o.getFullYear()}.${String(o.getMonth()+1).padStart(2,"0")}`;return(t=W.find(e=>e.month===n))!=null?t:null}var L=["math","major","english","politics"],g={math:"\u6570\u5B66",major:"\u4E13\u4E1A\u8BFE",english:"\u82F1\u8BED",politics:"\u653F\u6CBB",competition:"\u7ADE\u8D5B",review:"\u6A21\u8003/\u590D\u76D8"},K=[{id:"m1",subject:"math",text:"\u9AD8\u6570\u4E0A\u518C\u5168\u4E66\u4E00\u5237",completed:!1},{id:"m2",subject:"math",text:"\u9AD8\u6570\u4E0B\u518C\u5168\u4E66\u4E00\u5237",completed:!1},{id:"m3",subject:"math",text:"\u7EBF\u6027\u4EE3\u6570\u5168\u4E66\u4E00\u5237",completed:!1},{id:"m4",subject:"math",text:"\u6982\u7387\u8BBA\u5168\u4E66\u4E00\u5237",completed:!1},{id:"m5",subject:"math",text:"\u5168\u4E66\u4E8C\u5237",completed:!1},{id:"m6",subject:"math",text:"\u6570\u5B66\u771F\u9898\u4E00\u5237",completed:!1},{id:"j1",subject:"major",text:"\u4FE1\u53F7\u4E0E\u7CFB\u7EDF\u6559\u6750\u901A\u8BFB",completed:!1},{id:"j2",subject:"major",text:"\u4FE1\u53F7\u4E0E\u7CFB\u7EDF\u771F\u9898\u4E00\u5237",completed:!1},{id:"e1",subject:"english",text:"\u5355\u8BCD 5500 \u8FC7\u4E00\u904D",completed:!1},{id:"e2",subject:"english",text:"\u82F1\u8BED\u9605\u8BFB\u8BAD\u7EC3",completed:!1},{id:"e3",subject:"english",text:"\u4F5C\u6587\u6A21\u677F\u6210\u578B",completed:!1},{id:"p1",subject:"politics",text:"\u7CBE\u8BB2\u7CBE\u7EC3 + 1000 \u9898",completed:!1},{id:"p2",subject:"politics",text:"\u653F\u6CBB\u80CC\u8BF5",completed:!1},{id:"p3",subject:"politics",text:"\u62BC\u9898\u5377",completed:!1}],v={pomodoroDurationMin:25,shortBreakMin:5,longBreakMin:15,longBreakInterval:4,scientificDurationMin:90,scientificLongBreakMin:20,microPauseSec:15,strictMode:!1,autoStart:!1,defaultFocusMode:"pomodoro",defaultSubject:"math"},y={pomodorosToday:0,totalFocusMinutesToday:0,statsDate:""},T={examDate:"2026-12-20",tasks:K,completedMilestones:[],showAllocation:!0,viewMode:"day",focus:{...v},focusStats:{...y}};var Y="\u8003\u7814\u8BA1\u5212",J=/^\|\s*(.+?)\s*\|\s*(.+?)\s*\|\s*(.+?)\s*\|\s*(⬜|✅)\s*\|/,X=/^- \[([ xX])\]\s*(.+?)\s*\|\s*(.+?)\s*\|\s*(.+)/;function q(o){let n=o.split(`
`),t=[];for(let e=0;e<n.length;e++){let s=n[e].match(J);if(s){let a=s[1].trim();if(a.includes("\u65F6\u95F4")||a.startsWith(":")||a.startsWith("-"))continue;t.push({time:a,subject:s[2].replace(/\*/g,"").trim(),description:s[3].replace(/\*/g,"").trim(),completed:s[4].trim()==="\u2705",lineIndex:e});continue}let i=n[e].match(X);i&&t.push({time:i[2].trim(),subject:i[3].replace(/\*/g,"").trim(),description:i[4].replace(/\*/g,"").trim(),completed:i[1]!==" ",lineIndex:e})}return t}function j(o,n,t){let e=o.split(`
`);if(n<0||n>=e.length)return o;let s=e[n];return s.includes("\u2B1C")||s.includes("\u2705")?e[n]=t?s.replace("\u2B1C","\u2705"):s.replace("\u2705","\u2B1C"):e[n]=t?s.replace("- [ ]","- [x]"):s.replace(/- \[[xX]\]/,"- [ ]"),e.join(`
`)}function z(o,n){var s;let t=o.getFiles(),e=`${Y}/${n}`;return(s=t.find(i=>i.path.startsWith(e)&&i.extension==="md"))!=null?s:null}async function D(o,n){let t=z(o,n);if(!t)return null;let e=await o.read(t);return{date:n,tasks:q(e),filePath:t.path}}function Q(o){let n=new Date(o);n.setHours(0,0,0,0);let t=n.getDay(),e=t===0?-6:1-t,s=new Date(n);s.setDate(n.getDate()+e);let i=[];for(let a=0;a<7;a++){let r=new Date(s);r.setDate(s.getDate()+a),i.push(r)}return i}var Z=["\u5468\u65E5","\u5468\u4E00","\u5468\u4E8C","\u5468\u4E09","\u5468\u56DB","\u5468\u4E94","\u5468\u516D"];function tt(o){let n=o.getFullYear(),t=String(o.getMonth()+1).padStart(2,"0"),e=String(o.getDate()).padStart(2,"0");return`${n}-${t}-${e}`}async function B(o,n){let t=Q(n),e=[];for(let s of t){let i=tt(s),a=await D(o,i);e.push({date:i,weekday:Z[s.getDay()],total:a?a.tasks.length:0,done:a?a.tasks.filter(r=>r.completed).length:0,filePath:a?a.filePath:null})}return e}var _=null;function et(){return _||(_=new AudioContext),_}function f(o,n,t){try{let e=et(),s=e.createOscillator(),i=e.createGain();s.type="sine",s.frequency.value=o,i.gain.setValueAtTime(t,e.currentTime),i.gain.exponentialRampToValueAtTime(.001,e.currentTime+n),s.connect(i),i.connect(e.destination),s.start(e.currentTime),s.stop(e.currentTime+n)}catch(e){}}function O(o){switch(o){case"microPauseStart":f(600,.2,.15);break;case"microPauseEnd":f(600,.15,.2),setTimeout(()=>f(700,.15,.2),180);break;case"focusEnd":f(800,.5,.3);break;case"breakEnd":f(700,.3,.25);break}}function I(){return(Math.floor(Math.random()*4)+6)*60*1e3}function w(){let o=new Date;return`${o.getFullYear()}-${String(o.getMonth()+1).padStart(2,"0")}-${String(o.getDate()).padStart(2,"0")}`}var k=class{constructor(){this.focusMode="pomodoro";this.pomodoroDurationMin=25;this.shortBreakMin=5;this.longBreakMin=15;this.longBreakInterval=4;this.scientificDurationMin=90;this.scientificLongBreakMin=20;this.microPauseSec=15;this.strictMode=!1;this.autoStart=!1;this._state="IDLE";this._remainingMs=0;this._totalMs=0;this._pomodorosToday=0;this._totalFocusMs=0;this._pomodoroCount=0;this._nextMicroPauseMs=0;this._prePauseRemainingMs=0;this._prePauseTotalMs=0;this._tickInterval=null;this._statsDate="";this._subject="math";this._paused=!1;this._elapsedMs=0;this._tickCbs=[];this._stateChangeCbs=[];this._soundCbs=[]}on(n,t){n==="tick"?this._tickCbs.push(t):n==="stateChange"?this._stateChangeCbs.push(t):n==="sound"&&this._soundCbs.push(t)}getSnapshot(){return{state:this._state,remainingMs:this._state==="MICRO_PAUSE"?this._remainingMs:this._remainingMs,totalMs:this._state==="MICRO_PAUSE"?this.microPauseSec*1e3:this._totalMs,focusMode:this.focusMode,pomodorosToday:this._pomodorosToday,totalFocusMinutesToday:Math.floor(this._totalFocusMs/6e4),pomodoroCount:this._pomodoroCount,subject:this._subject,microPauseRemainingMs:this._state==="MICRO_PAUSE"?this._remainingMs:0,elapsedMs:this._elapsedMs}}loadStats(n){let t=w();n.statsDate===t?(this._pomodorosToday=n.pomodorosToday,this._totalFocusMs=n.totalFocusMinutesToday*6e4):(this._pomodorosToday=0,this._totalFocusMs=0),this._statsDate=t}exportStats(){return{pomodorosToday:this._pomodorosToday,totalFocusMinutesToday:Math.floor(this._totalFocusMs/6e4),statsDate:this._statsDate||w()}}start(n){this._subject=n,this._paused=!1,this._elapsedMs=0,this.checkDateReset(),this.focusMode==="stopwatch"?(this._totalMs=0,this._remainingMs=0):this.focusMode==="pomodoro"?(this._totalMs=this.pomodoroDurationMin*6e4,this._remainingMs=this._totalMs):(this._totalMs=this.scientificDurationMin*6e4,this._remainingMs=this._totalMs,this._nextMicroPauseMs=I()),this.transition("FOCUSING"),this.startTicking()}pause(){return this.strictMode||this._state!=="FOCUSING"?!1:(this._paused=!0,this.stopTicking(),!0)}resume(){this._paused&&(this._paused=!1,this.startTicking())}reset(){return this.strictMode&&this._state==="FOCUSING"?!1:(this.stopTicking(),this._paused=!1,this._elapsedMs=0,this._pomodoroCount=0,this.transition("IDLE"),!0)}skipBreak(){this._state!=="SHORT_BREAK"&&this._state!=="LONG_BREAK"||(this.stopTicking(),this.handleBreakEnd())}stopStopwatch(){this._state!=="FOCUSING"||this.focusMode!=="stopwatch"||(this.stopTicking(),this.emitSound("focusEnd"),this._elapsedMs=0,this._paused=!1,this.transition("IDLE"))}get isPaused(){return this._paused}get state(){return this._state}destroy(){this.stopTicking()}startTicking(){this.stopTicking(),this._tickInterval=window.setInterval(()=>this.tick(),1e3)}stopTicking(){this._tickInterval!==null&&(clearInterval(this._tickInterval),this._tickInterval=null)}transition(n){this._state=n;for(let t of this._stateChangeCbs)t(this.getSnapshot())}emitTick(){let n=this.getSnapshot();for(let t of this._tickCbs)t(n)}emitSound(n){for(let t of this._soundCbs)t(n)}checkDateReset(){let n=w();this._statsDate!==n&&(this._pomodorosToday=0,this._totalFocusMs=0,this._statsDate=n)}tick(){if(this.focusMode==="stopwatch"&&this._state==="FOCUSING"){this._elapsedMs+=1e3,this._totalFocusMs+=1e3,this.emitTick();return}if(this._remainingMs-=1e3,this._state==="FOCUSING"&&(this._totalFocusMs+=1e3,this.focusMode==="scientific"&&(this._nextMicroPauseMs-=1e3,this._nextMicroPauseMs<=0&&this._remainingMs>this.microPauseSec*1e3))){this._prePauseRemainingMs=this._remainingMs,this._prePauseTotalMs=this._totalMs,this._remainingMs=this.microPauseSec*1e3,this._totalMs=this.microPauseSec*1e3,this.emitSound("microPauseStart"),this.transition("MICRO_PAUSE");return}if(this._remainingMs<=0){this.handleTimerEnd();return}this.emitTick()}handleTimerEnd(){switch(this.stopTicking(),this._state){case"FOCUSING":this._pomodorosToday++,this._pomodoroCount++,this.emitSound("focusEnd"),this.focusMode==="pomodoro"?this._pomodoroCount>=this.longBreakInterval?(this._pomodoroCount=0,this._totalMs=this.longBreakMin*6e4,this._remainingMs=this._totalMs,this.transition("LONG_BREAK")):(this._totalMs=this.shortBreakMin*6e4,this._remainingMs=this._totalMs,this.transition("SHORT_BREAK")):(this._totalMs=this.scientificLongBreakMin*6e4,this._remainingMs=this._totalMs,this.transition("LONG_BREAK")),this.startTicking();break;case"MICRO_PAUSE":this.emitSound("microPauseEnd"),this._remainingMs=this._prePauseRemainingMs,this._totalMs=this._prePauseTotalMs,this._nextMicroPauseMs=I(),this.transition("FOCUSING"),this.startTicking();break;case"SHORT_BREAK":case"LONG_BREAK":this.handleBreakEnd();break}}handleBreakEnd(){this.emitSound("breakEnd"),this.autoStart?this.start(this._subject):(this._remainingMs=0,this._totalMs=0,this.transition("IDLE"))}};var m="kaoyan-countdown-view",M=class extends b.ItemView{constructor(t,e){super(t);this.refreshInterval=0;this.dailyPlan=null;this.timerDisplayEl=null;this.timerProgressEl=null;this.timerStateEl=null;this.focusSectionEl=null;this.selectedFocusMode="pomodoro";this.selectedSubject="math";this.selectedDurationMin=25;this.plugin=e,this.timerEngine=new k,this.syncEngineFromSettings(),this.timerEngine.loadStats(e.settings.focusStats),this.selectedFocusMode=e.settings.focus.defaultFocusMode,this.selectedSubject=e.settings.focus.defaultSubject,this.selectedDurationMin=e.settings.focus.pomodoroDurationMin,this.timerEngine.on("tick",s=>this.onTimerTick(s)),this.timerEngine.on("stateChange",s=>this.onTimerStateChange(s)),this.timerEngine.on("sound",s=>O(s))}getViewType(){return m}getDisplayText(){return"\u8003\u7814\u5012\u8BA1\u65F6"}getIcon(){return"clock"}async onOpen(){await this.fullRender(),this.refreshInterval=window.setInterval(()=>this.fullRender(),6e4),this.registerInterval(this.refreshInterval);let t=(0,b.debounce)(()=>this.fullRender(),200,!0);this.registerEvent(this.app.vault.on("modify",e=>{e.path.startsWith("\u8003\u7814\u8BA1\u5212/")&&t()}))}async onClose(){await this.persistFocusStats(),this.timerEngine.destroy()}get viewMode(){return this.plugin.settings.viewMode}async setViewMode(t){this.plugin.settings.viewMode=t,await this.plugin.saveSettings(),await this.fullRender()}todayStr(){let t=new Date,e=t.getFullYear(),s=String(t.getMonth()+1).padStart(2,"0"),i=String(t.getDate()).padStart(2,"0");return`${e}-${s}-${i}`}async fullRender(){let t=this.contentEl;switch(t.empty(),t.addClass("kaoyan-countdown-container"),this.renderCountdown(t),this.renderModeTabs(t),this.viewMode){case"day":await this.renderDayMode(t);break;case"week":await this.renderWeekMode(t);break;case"phase":this.renderPhaseMode(t);break;case"focus":this.renderFocusTab(t);break}}renderCountdown(t){let e=t.createDiv({cls:"kc-countdown-section"}),s=x(this.plugin.settings.examDate);e.createEl("div",{cls:"kc-title",text:"\u{1F3AF} \u8003\u7814\u5012\u8BA1\u65F6"}),e.createEl("div",{cls:"kc-days",text:`${s}`}),e.createEl("div",{cls:"kc-days-label",text:"\u5929"}),e.createEl("div",{cls:"kc-exam-date",text:`\u8003\u8BD5\u65E5\u671F\uFF1A${this.plugin.settings.examDate}`})}renderModeTabs(t){let e=t.createDiv({cls:"kc-tabs"}),s=[{mode:"day",label:"\u{1F4C5} Day"},{mode:"week",label:"\u{1F4CA} Week"},{mode:"phase",label:"\u{1F5FA}\uFE0F Phase"},{mode:"focus",label:"\u{1F345} Focus"}];for(let{mode:i,label:a}of s)e.createEl("button",{cls:`kc-tab${this.viewMode===i?" kc-tab-active":""}`,text:a}).addEventListener("click",()=>this.setViewMode(i))}async renderDayMode(t){let e=t.createDiv({cls:"kc-day-section"}),s=this.todayStr();if(this.dailyPlan=await D(this.app.vault,s),!this.dailyPlan){e.createEl("div",{cls:"kc-empty",text:"\u4ECA\u65E5\u6682\u65E0\u8BA1\u5212\u6587\u4EF6"});return}let i=this.dailyPlan.tasks,a=i.filter(l=>l.completed).length,r=i.length,c=e.createDiv({cls:"kc-day-header"});c.createEl("span",{text:`\u5B8C\u6210\u7387 ${a}/${r}`,cls:"kc-day-progress-label"});let d=c.createDiv({cls:"kc-progress-bar"}).createDiv({cls:"kc-progress-fill"});d.style.width=r>0?`${Math.round(a/r*100)}%`:"0%";for(let l of i){let u=e.createDiv({cls:`kc-day-task${l.completed?" kc-day-task-done":""}`}),p=u.createEl("input",{type:"checkbox"});p.checked=l.completed,p.addEventListener("change",()=>this.toggleDailyTask(l.lineIndex,p.checked)),u.createEl("span",{cls:"kc-day-time",text:l.time}),u.createEl("span",{cls:"kc-day-subject",text:l.subject}),u.createEl("span",{cls:"kc-day-desc",text:l.description})}}async toggleDailyTask(t,e){if(!this.dailyPlan)return;let s=this.app.vault.getAbstractFileByPath(this.dailyPlan.filePath);if(!s||!("stat"in s))return;let i=await this.app.vault.read(s),a=j(i,t,e);await this.app.vault.modify(s,a)}async renderWeekMode(t){let e=t.createDiv({cls:"kc-week-section"}),s=this.todayStr(),i=await B(this.app.vault,new Date);for(let a of i){let r=a.date===s,c=e.createDiv({cls:`kc-week-row${r?" kc-week-today":""}`}),h=c.createDiv({cls:"kc-week-info"});if(h.createEl("span",{cls:"kc-week-date",text:`${a.date.slice(5)}`}),h.createEl("span",{cls:"kc-week-day",text:a.weekday}),a.filePath){let d=a.total>0?Math.round(a.done/a.total*100):0,u=c.createDiv({cls:"kc-progress-bar kc-week-bar"}).createDiv({cls:"kc-progress-fill"});u.style.width=`${d}%`,c.createEl("span",{cls:"kc-week-pct",text:`${d}%`}),c.style.cursor="pointer";let p=a.filePath;c.addEventListener("click",()=>{this.app.vault.getAbstractFileByPath(p)&&this.app.workspace.openLinkText(p,"",!1)})}else c.createEl("span",{cls:"kc-week-empty",text:"\u2014"})}}renderPhaseMode(t){this.renderPhase(t),this.renderTasks(t)}renderPhase(t){let e=t.createDiv({cls:"kc-phase-section"}),s=new Date,i=C(s);if(!i){e.createEl("div",{cls:"kc-phase-name",text:"\u5F53\u524D\u4E0D\u5728\u4EFB\u4F55\u9636\u6BB5\u8303\u56F4\u5185"});return}let a=F(i,s);e.createEl("div",{cls:"kc-phase-name",text:`\u{1F4CD} Phase ${i.id} ${i.name}`}),e.createEl("div",{cls:"kc-phase-range",text:`${i.startDate} \u2192 ${i.endDate}`});let c=e.createDiv({cls:"kc-progress-bar"}).createDiv({cls:"kc-progress-fill"});if(c.style.width=`${Math.round(a*100)}%`,e.createEl("div",{cls:"kc-progress-text",text:`${Math.round(a*100)}%`}),this.plugin.settings.showAllocation){let h=e.createDiv({cls:"kc-allocation"});for(let[d,l]of Object.entries(i.allocation))if(l&&l>0){let u=g[d]||d;h.createEl("span",{cls:"kc-alloc-tag",text:`${u} ${Math.round(l*100)}%`})}}}renderTasks(t){let e=t.createDiv({cls:"kc-tasks-section"}),i=P(new Date);if(i){e.createEl("div",{cls:"kc-section-title",text:`\u{1F4CB} ${i.month} \u91CC\u7A0B\u7891`});for(let c of i.items){let h=e.createDiv({cls:"kc-task-row"}),d=h.createEl("input",{type:"checkbox"});d.checked=this.plugin.settings.completedMilestones.includes(c),d.addEventListener("change",async()=>{let l=this.plugin.settings.completedMilestones;d.checked?l.includes(c)||l.push(c):this.plugin.settings.completedMilestones=l.filter(u=>u!==c),await this.plugin.saveSettings()}),h.createEl("span",{text:c,cls:d.checked?"kc-completed":""})}}e.createEl("div",{cls:"kc-section-title",text:"\u{1F4CB} \u5F85\u529E\u77E5\u8BC6\u70B9"});let a=this.plugin.settings.tasks,r={};for(let c of a)(r[c.subject]=r[c.subject]||[]).push(c);for(let[c,h]of Object.entries(r)){let d=g[c]||c;e.createEl("div",{cls:"kc-subject-label",text:d});for(let l of h){let u=e.createDiv({cls:"kc-task-row"}),p=u.createEl("input",{type:"checkbox"});p.checked=l.completed,p.addEventListener("change",async()=>{l.completed=p.checked,await this.plugin.saveSettings(),await this.fullRender()}),u.createEl("span",{text:l.text,cls:l.completed?"kc-completed":""})}}}renderFocusTab(t){this.focusSectionEl=t.createDiv({cls:"kc-focus-section"}),this.renderFocusContent()}renderFocusContent(){let t=this.focusSectionEl;if(!t)return;t.empty();let e=this.timerEngine.getSnapshot();this.renderFocusModeToggle(t,e),this.renderTimerDisplay(t,e),e.state==="IDLE"&&this.selectedFocusMode==="pomodoro"&&this.renderDurationPicker(t),e.state==="IDLE"?this.renderSubjectSelector(t):e.state!=="MICRO_PAUSE"&&t.createEl("div",{cls:"kc-focus-current-subject",text:`\u79D1\u76EE: ${g[e.subject]||e.subject}`}),e.state==="MICRO_PAUSE"&&this.renderMicroPauseOverlay(t,e),this.renderTimerControls(t,e),this.renderFocusStats(t,e)}renderFocusModeToggle(t,e){let s=t.createDiv({cls:"kc-focus-mode-toggle"}),i=e.state!=="IDLE",a=[{mode:"pomodoro",label:"\u756A\u8304\u949F"},{mode:"scientific",label:"\u79D1\u5B66\u4E13\u6CE8"},{mode:"stopwatch",label:"\u6B63\u8BA1\u65F6"}];for(let{mode:r,label:c}of a){let h=s.createEl("button",{cls:`kc-focus-mode-btn${this.selectedFocusMode===r?" kc-focus-mode-active":""}${i?" kc-disabled":""}`,text:c});i||h.addEventListener("click",()=>{this.selectedFocusMode!==r&&(this.selectedFocusMode=r,this.timerEngine.focusMode=r,this.renderFocusContent())})}}renderTimerDisplay(t,e){let s=t.createDiv({cls:"kc-timer-display"});this.timerStateEl=s.createEl("div",{cls:"kc-timer-state",text:this.getStateLabel(e.state)});let i;e.state==="IDLE"?this.selectedFocusMode==="pomodoro"?i=this.selectedDurationMin*6e4:this.selectedFocusMode==="scientific"?i=this.plugin.settings.focus.scientificDurationMin*6e4:i=0:e.focusMode==="stopwatch"?i=e.elapsedMs:i=e.remainingMs,this.timerDisplayEl=s.createEl("div",{cls:"kc-timer-countdown",text:this.formatTime(i)});let a=e.state==="IDLE"&&this.selectedFocusMode==="stopwatch"||e.state!=="IDLE"&&e.focusMode==="stopwatch",r=s.createDiv({cls:`kc-timer-progress-bar${a?" kc-hidden":""}`});this.timerProgressEl=r.createDiv({cls:"kc-timer-progress-fill"});let c=e.totalMs>0?(e.totalMs-e.remainingMs)/e.totalMs*100:0;this.timerProgressEl.style.width=`${Math.min(100,c)}%`}renderSubjectSelector(t){let e=t.createDiv({cls:"kc-subject-selector"});for(let s of L){let i=g[s]||s;e.createEl("button",{cls:`kc-subject-btn${this.selectedSubject===s?" kc-subject-btn-active":""}`,text:i}).addEventListener("click",()=>{this.selectedSubject=s,this.renderFocusContent()})}}renderDurationPicker(t){let e=t.createDiv({cls:"kc-duration-picker"}),s=[15,25,30,45,60];for(let i of s)e.createEl("button",{cls:`kc-duration-btn${this.selectedDurationMin===i?" kc-duration-btn-active":""}`,text:`${i}min`}).addEventListener("click",()=>{this.selectedDurationMin=i,this.renderFocusContent()})}renderMicroPauseOverlay(t,e){let s=t.createDiv({cls:"kc-micro-pause-overlay"});s.createEl("div",{cls:"kc-micro-pause-icon",text:"\u{1F60C}"}),s.createEl("div",{cls:"kc-micro-pause-text",text:"\u95ED\u773C\u4F11\u606F"}),s.createEl("div",{cls:"kc-micro-pause-timer",text:this.formatTime(e.microPauseRemainingMs)})}renderTimerControls(t,e){let s=t.createDiv({cls:"kc-timer-controls"});switch(e.state){case"IDLE":{if(s.createEl("button",{cls:"kc-btn kc-btn-start",text:"\u5F00\u59CB\u4E13\u6CE8"}).addEventListener("click",()=>{this.timerEngine.focusMode=this.selectedFocusMode,this.syncEngineFromSettings(),this.selectedFocusMode==="pomodoro"&&(this.timerEngine.pomodoroDurationMin=this.selectedDurationMin),this.timerEngine.start(this.selectedSubject)}),this.selectedFocusMode!=="stopwatch"){let a=s.createDiv({cls:"kc-strict-toggle"}),r=a.createEl("input",{type:"checkbox"});r.checked=this.timerEngine.strictMode,r.addEventListener("change",()=>{this.timerEngine.strictMode=r.checked,this.plugin.settings.focus.strictMode=r.checked,this.plugin.saveSettings()}),a.createEl("span",{cls:"kc-strict-label",text:"\u5B66\u9738\u6A21\u5F0F (\u7981\u6B62\u6682\u505C/\u653E\u5F03)"})}break}case"FOCUSING":{e.focusMode==="stopwatch"?(s.createEl("button",{cls:"kc-btn kc-btn-stop",text:"\u7ED3\u675F\u4E13\u6CE8"}).addEventListener("click",()=>this.timerEngine.stopStopwatch()),this.timerEngine.isPaused?s.createEl("button",{cls:"kc-btn kc-btn-start",text:"\u7EE7\u7EED"}).addEventListener("click",()=>this.timerEngine.resume()):s.createEl("button",{cls:"kc-btn kc-btn-pause",text:"\u6682\u505C"}).addEventListener("click",()=>{this.timerEngine.pause(),this.renderFocusContent()})):this.timerEngine.strictMode?s.createEl("span",{cls:"kc-strict-label",text:"\u{1F512} \u5B66\u9738\u6A21\u5F0F"}):this.timerEngine.isPaused?(s.createEl("button",{cls:"kc-btn kc-btn-start",text:"\u7EE7\u7EED"}).addEventListener("click",()=>this.timerEngine.resume()),s.createEl("button",{cls:"kc-btn kc-btn-reset",text:"\u653E\u5F03"}).addEventListener("click",()=>this.timerEngine.reset())):(s.createEl("button",{cls:"kc-btn kc-btn-pause",text:"\u6682\u505C"}).addEventListener("click",()=>{this.timerEngine.pause(),this.renderFocusContent()}),s.createEl("button",{cls:"kc-btn kc-btn-reset",text:"\u653E\u5F03"}).addEventListener("click",()=>this.timerEngine.reset()));break}case"SHORT_BREAK":case"LONG_BREAK":{s.createEl("button",{cls:"kc-btn kc-btn-skip",text:"\u8DF3\u8FC7\u4F11\u606F"}).addEventListener("click",()=>this.timerEngine.skipBreak());break}case"MICRO_PAUSE":break}}renderFocusStats(t,e){let s=t.createDiv({cls:"kc-focus-stats"});s.createEl("span",{cls:"kc-focus-stat",text:`\u{1F345} ${e.pomodorosToday} \u4E2A\u756A\u8304`}),s.createEl("span",{cls:"kc-focus-stat",text:`\u23F1 ${e.totalFocusMinutesToday} \u5206\u949F`})}onTimerTick(t){if(this.timerDisplayEl){let e=t.focusMode==="stopwatch"?t.elapsedMs:t.remainingMs;this.timerDisplayEl.textContent=this.formatTime(e)}if(this.timerProgressEl&&t.totalMs>0){let e=(t.totalMs-t.remainingMs)/t.totalMs*100;this.timerProgressEl.style.width=`${Math.min(100,e)}%`}}onTimerStateChange(t){this.viewMode==="focus"&&this.renderFocusContent(),this.persistFocusStats()}formatTime(t){let e=Math.max(0,Math.ceil(t/1e3)),s=Math.floor(e/3600),i=Math.floor(e%3600/60),a=e%60,r=String(i).padStart(2,"0"),c=String(a).padStart(2,"0");return s>0?`${String(s).padStart(2,"0")}:${r}:${c}`:`${r}:${c}`}getStateLabel(t){switch(t){case"IDLE":return"\u51C6\u5907\u5C31\u7EEA";case"FOCUSING":return"\u{1F525} \u4E13\u6CE8\u4E2D";case"MICRO_PAUSE":return"\u{1F60C} \u5FAE\u4F11\u606F";case"SHORT_BREAK":return"\u2615 \u77ED\u4F11\u606F";case"LONG_BREAK":return"\u{1F33F} \u957F\u4F11\u606F"}}syncEngineFromSettings(){let t=this.plugin.settings.focus,e=this.timerEngine;e.pomodoroDurationMin=t.pomodoroDurationMin,e.shortBreakMin=t.shortBreakMin,e.longBreakMin=t.longBreakMin,e.longBreakInterval=t.longBreakInterval,e.scientificDurationMin=t.scientificDurationMin,e.scientificLongBreakMin=t.scientificLongBreakMin,e.microPauseSec=t.microPauseSec,e.strictMode=t.strictMode,e.autoStart=t.autoStart}async persistFocusStats(){let t=this.timerEngine.exportStats();this.plugin.settings.focusStats=t,await this.plugin.saveSettings()}};var E=class extends R.Plugin{constructor(){super(...arguments);this.settings=T}async onload(){await this.loadSettings(),this.registerView(m,t=>new M(t,this)),this.addRibbonIcon("clock","\u8003\u7814\u5012\u8BA1\u65F6",()=>{this.activateView()}),this.addCommand({id:"open-kaoyan-countdown",name:"\u6253\u5F00\u8003\u7814\u5012\u8BA1\u65F6",callback:()=>this.activateView()}),this.app.workspace.onLayoutReady(()=>{this.app.workspace.getLeavesOfType(m).length===0&&this.activateView()})}onunload(){this.app.workspace.detachLeavesOfType(m)}async activateView(){let{workspace:t}=this.app,e=t.getLeavesOfType(m);if(e.length>0){t.revealLeaf(e[0]);return}let s=t.getRightLeaf(!1);s&&(await s.setViewState({type:m,active:!0}),t.revealLeaf(s))}async loadSettings(){let t=await this.loadData()||{};this.settings=Object.assign({},T,t),this.settings.focus=Object.assign({},v,t.focus),this.settings.focusStats=Object.assign({},y,t.focusStats)}async saveSettings(){await this.saveData(this.settings)}};
