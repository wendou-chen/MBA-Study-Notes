var D=Object.defineProperty;var U=Object.getOwnPropertyDescriptor;var N=Object.getOwnPropertyNames;var V=Object.prototype.hasOwnProperty;var H=(o,i)=>{for(var e in i)D(o,e,{get:i[e],enumerable:!0})},K=(o,i,e,t)=>{if(i&&typeof i=="object"||typeof i=="function")for(let s of N(i))!V.call(o,s)&&s!==e&&D(o,s,{get:()=>i[s],enumerable:!(t=U(i,s))||t.enumerable});return o};var G=o=>K(D({},"__esModule",{value:!0}),o);var nt={};H(nt,{default:()=>y});module.exports=G(nt);var g=require("obsidian");var k=require("obsidian");var W=[{id:1,name:"\u57FA\u7840\u592F\u5B9E",startDate:"2026-02-14",endDate:"2026-04-20",allocation:{math:.55,major:.2,english:.1,competition:.15}},{id:2,name:"\u57FA\u7840\u6536\u5C3E",startDate:"2026-04-21",endDate:"2026-06-30",allocation:{math:.5,major:.25,english:.1,review:.15}},{id:3,name:"\u5F3A\u5316\u7A81\u7834",startDate:"2026-07-01",endDate:"2026-09-30",allocation:{math:.4,major:.25,english:.15,politics:.15,review:.05}},{id:4,name:"\u51B2\u523A\u6A21\u8003",startDate:"2026-10-01",endDate:"2026-11-30",allocation:{math:.35,major:.25,english:.15,politics:.2,review:.05}},{id:5,name:"\u8003\u524D\u6536\u5B98",startDate:"2026-12-01",endDate:"2026-12-20",allocation:{math:.3,major:.2,english:.15,politics:.3,review:.05}}],Y=[{month:"2026.03",items:["\u9AD8\u6570\u4E0A\u518C\u5168\u4E66\u4E00\u5237\u5B8C\u6210","\u4FE1\u53F7\u4E0E\u7CFB\u7EDF\u524D 4 \u7AE0\u901A\u8BFB"]},{month:"2026.04",items:["\u9AD8\u6570\u4E0B\u518C\u5168\u4E66\u4E00\u5237\u5B8C\u6210","\u5927\u5510\u676F/\u84DD\u6865\u676F\u6BD4\u8D5B\u7ED3\u675F"]},{month:"2026.05",items:["\u7EBF\u6027\u4EE3\u6570\u5168\u4E66\u4E00\u5237\u5B8C\u6210","\u4FE1\u53F7\u4E0E\u7CFB\u7EDF\u524D 8 \u7AE0\u901A\u8BFB"]},{month:"2026.06",items:["\u6982\u7387\u8BBA\u5168\u4E66\u4E00\u5237\u5B8C\u6210","\u5168\u4E66\u4E8C\u5237\u542F\u52A8","\u4FE1\u53F7\u6559\u6750\u901A\u8BFB\u5B8C\u6BD5"]},{month:"2026.07",items:["\u5168\u4E66\u4E8C\u5237\u8FC7\u534A","\u653F\u6CBB\u7CBE\u8BB2\u7CBE\u7EC3\u542F\u52A8","\u82F1\u8BED\u9605\u8BFB\u8BAD\u7EC3\u542F\u52A8"]},{month:"2026.08",items:["\u5168\u4E66\u4E8C\u5237\u5B8C\u6210","\u4FE1\u53F7\u771F\u9898\u4E00\u5237\u542F\u52A8","\u653F\u6CBB 1000 \u9898\u8FC7\u534A"]},{month:"2026.09",items:["\u6570\u5B66\u771F\u9898\u4E00\u5237\u5B8C\u6210","\u4FE1\u53F7\u771F\u9898\u4E00\u5237\u5B8C\u6210","\u653F\u6CBB 1000 \u9898\u5B8C\u6210"]},{month:"2026.10",items:["\u9996\u6B21\u5168\u79D1\u6A21\u8003","\u82F1\u8BED\u4F5C\u6587\u6A21\u677F\u6210\u578B","\u653F\u6CBB\u80CC\u8BF5\u542F\u52A8"]},{month:"2026.11",items:["\u6A21\u8003 3 \u8F6E\u4EE5\u4E0A","\u5404\u79D1\u67E5\u6F0F\u8865\u7F3A\u6E05\u5355\u751F\u6210"]},{month:"2026.12",items:["\u8003\u524D\u6700\u7EC8\u6A21\u8003","\u653F\u6CBB\u62BC\u9898\u5377","\u5FC3\u6001\u8C03\u6574"]}];function F(o){let i=new Date(o+"T00:00:00"),e=new Date;return e.setHours(0,0,0,0),Math.ceil((i.getTime()-e.getTime())/(1e3*60*60*24))}function L(o){var e;let i=new Date(o);return i.setHours(0,0,0,0),(e=W.find(t=>{let s=new Date(t.startDate+"T00:00:00"),n=new Date(t.endDate+"T00:00:00");return i>=s&&i<=n}))!=null?e:null}function B(o,i){let e=new Date(o.startDate+"T00:00:00").getTime(),t=new Date(o.endDate+"T00:00:00").getTime(),s=new Date(i).setHours(0,0,0,0);return Math.min(1,Math.max(0,(s-e)/(t-e)))}function j(o){var e;let i=`${o.getFullYear()}.${String(o.getMonth()+1).padStart(2,"0")}`;return(e=Y.find(t=>t.month===i))!=null?e:null}var I=["math","major","english","politics"];function J(){let o=new Date,i=o.getFullYear();o.getMonth()===11&&o.getDate()>25&&i++;let s=1+(6-new Date(i,11,1).getDay()+7)%7+14;return`${i}-12-${String(s).padStart(2,"0")}`}var M={math:"\u6570\u5B66",major:"\u4E13\u4E1A\u8BFE",english:"\u82F1\u8BED",politics:"\u653F\u6CBB",competition:"\u7ADE\u8D5B",review:"\u6A21\u8003/\u590D\u76D8"},X=[{id:"m1",subject:"math",text:"\u9AD8\u6570\u4E0A\u518C\u5168\u4E66\u4E00\u5237",completed:!1},{id:"m2",subject:"math",text:"\u9AD8\u6570\u4E0B\u518C\u5168\u4E66\u4E00\u5237",completed:!1},{id:"m3",subject:"math",text:"\u7EBF\u6027\u4EE3\u6570\u5168\u4E66\u4E00\u5237",completed:!1},{id:"m4",subject:"math",text:"\u6982\u7387\u8BBA\u5168\u4E66\u4E00\u5237",completed:!1},{id:"m5",subject:"math",text:"\u5168\u4E66\u4E8C\u5237",completed:!1},{id:"m6",subject:"math",text:"\u6570\u5B66\u771F\u9898\u4E00\u5237",completed:!1},{id:"j1",subject:"major",text:"\u4FE1\u53F7\u4E0E\u7CFB\u7EDF\u6559\u6750\u901A\u8BFB",completed:!1},{id:"j2",subject:"major",text:"\u4FE1\u53F7\u4E0E\u7CFB\u7EDF\u771F\u9898\u4E00\u5237",completed:!1},{id:"e1",subject:"english",text:"\u5355\u8BCD 5500 \u8FC7\u4E00\u904D",completed:!1},{id:"e2",subject:"english",text:"\u82F1\u8BED\u9605\u8BFB\u8BAD\u7EC3",completed:!1},{id:"e3",subject:"english",text:"\u4F5C\u6587\u6A21\u677F\u6210\u578B",completed:!1},{id:"p1",subject:"politics",text:"\u7CBE\u8BB2\u7CBE\u7EC3 + 1000 \u9898",completed:!1},{id:"p2",subject:"politics",text:"\u653F\u6CBB\u80CC\u8BF5",completed:!1},{id:"p3",subject:"politics",text:"\u62BC\u9898\u5377",completed:!1}],w={pomodoroDurationMin:25,shortBreakMin:5,longBreakMin:15,longBreakInterval:4,scientificDurationMin:90,scientificLongBreakMin:20,microPauseSec:15,strictMode:!1,autoStart:!1,defaultFocusMode:"pomodoro",defaultSubject:"math"},T={pomodorosToday:0,totalFocusMinutesToday:0,statsDate:""},_={examDate:J(),planFolder:"\u8003\u7814\u8BA1\u5212",tasks:X,completedMilestones:[],showAllocation:!0,viewMode:"day",focus:{...w},focusStats:{...T},bookmarks:[]};var q=/^\|\s*(.+?)\s*\|\s*(.+?)\s*\|\s*(.+?)\s*\|\s*(⬜|✅)\s*\|/,z=/^- \[([ xX])\]\s*(.+?)\s*\|\s*(.+?)\s*\|\s*(.+)/;function Q(o){let i=o.split(`
`),e=[];for(let t=0;t<i.length;t++){let s=i[t].match(q);if(s){let a=s[1].trim();if(a.includes("\u65F6\u95F4")||a.startsWith(":")||a.startsWith("-"))continue;e.push({time:a,subject:s[2].replace(/\*/g,"").trim(),description:s[3].replace(/\*/g,"").trim(),completed:s[4].trim()==="\u2705",lineIndex:t});continue}let n=i[t].match(z);n&&e.push({time:n[2].trim(),subject:n[3].replace(/\*/g,"").trim(),description:n[4].replace(/\*/g,"").trim(),completed:n[1]!==" ",lineIndex:t})}return e}function O(o,i,e){let t=o.split(`
`);if(i<0||i>=t.length)return o;let s=t[i];return s.includes("\u2B1C")||s.includes("\u2705")?t[i]=e?s.replace("\u2B1C","\u2705"):s.replace("\u2705","\u2B1C"):t[i]=e?s.replace("- [ ]","- [x]"):s.replace(/- \[[xX]\]/,"- [ ]"),t.join(`
`)}function Z(o,i,e){var n;let t=o.getFiles(),s=`${e}/${i}`;return(n=t.find(a=>a.path.startsWith(s)&&a.extension==="md"))!=null?n:null}async function x(o,i,e){let t=Z(o,i,e);if(!t)return null;let s=await o.read(t);return{date:i,tasks:Q(s),filePath:t.path}}function tt(o){let i=new Date(o);i.setHours(0,0,0,0);let e=i.getDay(),t=e===0?-6:1-e,s=new Date(i);s.setDate(i.getDate()+t);let n=[];for(let a=0;a<7;a++){let c=new Date(s);c.setDate(s.getDate()+a),n.push(c)}return n}var et=["\u5468\u65E5","\u5468\u4E00","\u5468\u4E8C","\u5468\u4E09","\u5468\u56DB","\u5468\u4E94","\u5468\u516D"];function st(o){let i=o.getFullYear(),e=String(o.getMonth()+1).padStart(2,"0"),t=String(o.getDate()).padStart(2,"0");return`${i}-${e}-${t}`}async function A(o,i,e){let t=tt(i),s=[];for(let n of t){let a=st(n),c=await x(o,a,e);s.push({date:a,weekday:et[n.getDay()],total:c?c.tasks.length:0,done:c?c.tasks.filter(r=>r.completed).length:0,filePath:c?c.filePath:null})}return s}var C=null;function it(){return C||(C=new AudioContext),C}function b(o,i,e){try{let t=it(),s=t.createOscillator(),n=t.createGain();s.type="sine",s.frequency.value=o,n.gain.setValueAtTime(e,t.currentTime),n.gain.exponentialRampToValueAtTime(.001,t.currentTime+i),s.connect(n),n.connect(t.destination),s.start(t.currentTime),s.stop(t.currentTime+i)}catch(t){}}function $(o){switch(o){case"microPauseStart":b(600,.2,.15);break;case"microPauseEnd":b(600,.15,.2),setTimeout(()=>b(700,.15,.2),180);break;case"focusEnd":b(800,.5,.3);break;case"breakEnd":b(700,.3,.25);break}}function R(){return(Math.floor(Math.random()*4)+6)*60*1e3}function P(){let o=new Date;return`${o.getFullYear()}-${String(o.getMonth()+1).padStart(2,"0")}-${String(o.getDate()).padStart(2,"0")}`}var E=class{constructor(){this.focusMode="pomodoro";this.pomodoroDurationMin=25;this.shortBreakMin=5;this.longBreakMin=15;this.longBreakInterval=4;this.scientificDurationMin=90;this.scientificLongBreakMin=20;this.microPauseSec=15;this.strictMode=!1;this.autoStart=!1;this._state="IDLE";this._remainingMs=0;this._totalMs=0;this._pomodorosToday=0;this._totalFocusMs=0;this._pomodoroCount=0;this._nextMicroPauseMs=0;this._prePauseRemainingMs=0;this._prePauseTotalMs=0;this._tickInterval=null;this._statsDate="";this._subject="math";this._paused=!1;this._elapsedMs=0;this._tickCbs=[];this._stateChangeCbs=[];this._soundCbs=[]}on(i,e){i==="tick"?this._tickCbs.push(e):i==="stateChange"?this._stateChangeCbs.push(e):i==="sound"&&this._soundCbs.push(e)}getSnapshot(){return{state:this._state,remainingMs:this._state==="MICRO_PAUSE"?this._remainingMs:this._remainingMs,totalMs:this._state==="MICRO_PAUSE"?this.microPauseSec*1e3:this._totalMs,focusMode:this.focusMode,pomodorosToday:this._pomodorosToday,totalFocusMinutesToday:Math.floor(this._totalFocusMs/6e4),pomodoroCount:this._pomodoroCount,subject:this._subject,microPauseRemainingMs:this._state==="MICRO_PAUSE"?this._remainingMs:0,elapsedMs:this._elapsedMs}}loadStats(i){let e=P();i.statsDate===e?(this._pomodorosToday=i.pomodorosToday,this._totalFocusMs=i.totalFocusMinutesToday*6e4):(this._pomodorosToday=0,this._totalFocusMs=0),this._statsDate=e}exportStats(){return{pomodorosToday:this._pomodorosToday,totalFocusMinutesToday:Math.floor(this._totalFocusMs/6e4),statsDate:this._statsDate||P()}}start(i){this._subject=i,this._paused=!1,this._elapsedMs=0,this.checkDateReset(),this.focusMode==="stopwatch"?(this._totalMs=0,this._remainingMs=0):this.focusMode==="pomodoro"?(this._totalMs=this.pomodoroDurationMin*6e4,this._remainingMs=this._totalMs):(this._totalMs=this.scientificDurationMin*6e4,this._remainingMs=this._totalMs,this._nextMicroPauseMs=R()),this.transition("FOCUSING"),this.startTicking()}pause(){return this.strictMode||this._state!=="FOCUSING"?!1:(this._paused=!0,this.stopTicking(),!0)}resume(){this._paused&&(this._paused=!1,this.startTicking())}reset(){return this.strictMode&&this._state==="FOCUSING"?!1:(this.stopTicking(),this._paused=!1,this._elapsedMs=0,this._pomodoroCount=0,this.transition("IDLE"),!0)}skipBreak(){this._state!=="SHORT_BREAK"&&this._state!=="LONG_BREAK"||(this.stopTicking(),this.handleBreakEnd())}stopStopwatch(){this._state!=="FOCUSING"||this.focusMode!=="stopwatch"||(this.stopTicking(),this.emitSound("focusEnd"),this._elapsedMs=0,this._paused=!1,this.transition("IDLE"))}get isPaused(){return this._paused}get state(){return this._state}destroy(){this.stopTicking()}startTicking(){this.stopTicking(),this._tickInterval=window.setInterval(()=>this.tick(),1e3)}stopTicking(){this._tickInterval!==null&&(clearInterval(this._tickInterval),this._tickInterval=null)}transition(i){this._state=i;for(let e of this._stateChangeCbs)e(this.getSnapshot())}emitTick(){let i=this.getSnapshot();for(let e of this._tickCbs)e(i)}emitSound(i){for(let e of this._soundCbs)e(i)}checkDateReset(){let i=P();this._statsDate!==i&&(this._pomodorosToday=0,this._totalFocusMs=0,this._statsDate=i)}tick(){if(this.focusMode==="stopwatch"&&this._state==="FOCUSING"){this._elapsedMs+=1e3,this._totalFocusMs+=1e3,this.emitTick();return}if(this._remainingMs-=1e3,this._state==="FOCUSING"&&(this._totalFocusMs+=1e3,this.focusMode==="scientific"&&(this._nextMicroPauseMs-=1e3,this._nextMicroPauseMs<=0&&this._remainingMs>this.microPauseSec*1e3))){this._prePauseRemainingMs=this._remainingMs,this._prePauseTotalMs=this._totalMs,this._remainingMs=this.microPauseSec*1e3,this._totalMs=this.microPauseSec*1e3,this.emitSound("microPauseStart"),this.transition("MICRO_PAUSE");return}if(this._remainingMs<=0){this.handleTimerEnd();return}this.emitTick()}handleTimerEnd(){switch(this.stopTicking(),this._state){case"FOCUSING":this._pomodorosToday++,this._pomodoroCount++,this.emitSound("focusEnd"),this.focusMode==="pomodoro"?this._pomodoroCount>=this.longBreakInterval?(this._pomodoroCount=0,this._totalMs=this.longBreakMin*6e4,this._remainingMs=this._totalMs,this.transition("LONG_BREAK")):(this._totalMs=this.shortBreakMin*6e4,this._remainingMs=this._totalMs,this.transition("SHORT_BREAK")):(this._totalMs=this.scientificLongBreakMin*6e4,this._remainingMs=this._totalMs,this.transition("LONG_BREAK")),this.startTicking();break;case"MICRO_PAUSE":this.emitSound("microPauseEnd"),this._remainingMs=this._prePauseRemainingMs,this._totalMs=this._prePauseTotalMs,this._nextMicroPauseMs=R(),this.transition("FOCUSING"),this.startTicking();break;case"SHORT_BREAK":case"LONG_BREAK":this.handleBreakEnd();break}}handleBreakEnd(){this.emitSound("breakEnd"),this.autoStart?this.start(this._subject):(this._remainingMs=0,this._totalMs=0,this.transition("IDLE"))}};var f="kaoyan-countdown-view",S=class extends k.ItemView{constructor(e,t){super(e);this.refreshInterval=0;this.dailyPlan=null;this.timerDisplayEl=null;this.timerProgressEl=null;this.timerStateEl=null;this.focusSectionEl=null;this.selectedFocusMode="pomodoro";this.selectedSubject="math";this.selectedDurationMin=25;this.plugin=t,this.timerEngine=new E,this.syncEngineFromSettings(),this.timerEngine.loadStats(t.settings.focusStats),this.selectedFocusMode=t.settings.focus.defaultFocusMode,this.selectedSubject=t.settings.focus.defaultSubject,this.selectedDurationMin=t.settings.focus.pomodoroDurationMin,this.timerEngine.on("tick",s=>this.onTimerTick(s)),this.timerEngine.on("stateChange",s=>this.onTimerStateChange(s)),this.timerEngine.on("sound",s=>$(s))}getViewType(){return f}getDisplayText(){return"\u8003\u7814\u5012\u8BA1\u65F6"}getIcon(){return"clock"}async onOpen(){await this.fullRender(),this.refreshInterval=window.setInterval(()=>this.fullRender(),6e4),this.registerInterval(this.refreshInterval);let e=(0,k.debounce)(()=>this.fullRender(),200,!0);this.registerEvent(this.app.vault.on("modify",t=>{t.path.startsWith(this.plugin.settings.planFolder+"/")&&e()}))}async onClose(){await this.persistFocusStats(),this.timerEngine.destroy()}async refresh(){await this.fullRender()}get viewMode(){return this.plugin.settings.viewMode}async setViewMode(e){this.plugin.settings.viewMode=e,await this.plugin.saveSettings(),await this.fullRender()}todayStr(){let e=new Date,t=e.getFullYear(),s=String(e.getMonth()+1).padStart(2,"0"),n=String(e.getDate()).padStart(2,"0");return`${t}-${s}-${n}`}async fullRender(){let e=this.contentEl;switch(e.empty(),e.addClass("kaoyan-countdown-container"),this.renderCountdown(e),this.renderModeTabs(e),this.viewMode){case"day":await this.renderDayMode(e);break;case"week":await this.renderWeekMode(e);break;case"phase":this.renderPhaseMode(e);break;case"focus":this.renderFocusTab(e);break}}renderCountdown(e){let t=e.createDiv({cls:"kc-countdown-section"}),s=F(this.plugin.settings.examDate);t.createEl("div",{cls:"kc-title",text:"\u{1F3AF} \u8003\u7814\u5012\u8BA1\u65F6"}),t.createEl("div",{cls:"kc-days",text:`${s}`}),t.createEl("div",{cls:"kc-days-label",text:"\u5929"}),t.createEl("div",{cls:"kc-exam-date",text:`\u8003\u8BD5\u65E5\u671F\uFF1A${this.plugin.settings.examDate}`}),this.renderBookmarks(t)}renderBookmarks(e){let t=this.plugin.settings.bookmarks;if(!t||t.length===0)return;let s=e.createDiv({cls:"kc-bookmarks-wrapper"});s.createEl("div",{cls:"kc-bookmarks-title",text:"\u{1F4D6} \u7EE7\u7EED\u5B66\u4E60"});let n=t[0],a=s.createEl("button",{cls:"kc-bookmark-btn"});a.createEl("span",{cls:"kc-bookmark-icon",text:"\u25B6"}),a.createEl("span",{cls:"kc-bookmark-text",text:n.label});let c=Math.floor((Date.now()-n.timestamp)/6e4),r=c<60?`${c}\u5206\u949F\u524D`:`${Math.floor(c/60)}\u5C0F\u65F6\u524D`;a.createEl("span",{cls:"kc-bookmark-time",text:r}),a.createEl("span",{cls:"kc-bookmark-auto",text:"\u25CF \u81EA\u52A8"}),a.addEventListener("click",async()=>{let u=this.app.vault.getAbstractFileByPath(n.filePath);u?await this.app.workspace.getLeaf(!1).openFile(u,{state:n.state}):new k.Notice("\u6587\u4EF6\u5DF2\u4E0D\u5B58\u5728")})}renderModeTabs(e){let t=e.createDiv({cls:"kc-tabs"}),s=[{mode:"day",label:"\u{1F4C5} Day"},{mode:"week",label:"\u{1F4CA} Week"},{mode:"phase",label:"\u{1F5FA}\uFE0F Phase"},{mode:"focus",label:"\u{1F345} Focus"}];for(let{mode:n,label:a}of s)t.createEl("button",{cls:`kc-tab${this.viewMode===n?" kc-tab-active":""}`,text:a}).addEventListener("click",()=>this.setViewMode(n))}async renderDayMode(e){let t=e.createDiv({cls:"kc-day-section"}),s=this.todayStr();if(this.dailyPlan=await x(this.app.vault,s,this.plugin.settings.planFolder),!this.dailyPlan){t.createEl("div",{cls:"kc-empty",text:"\u4ECA\u65E5\u6682\u65E0\u8BA1\u5212\u6587\u4EF6"});return}let n=this.dailyPlan.tasks,a=n.filter(l=>l.completed).length,c=n.length,r=t.createDiv({cls:"kc-day-header"});r.createEl("span",{text:`\u5B8C\u6210\u7387 ${a}/${c}`,cls:"kc-day-progress-label"});let d=r.createDiv({cls:"kc-progress-bar"}).createDiv({cls:"kc-progress-fill"});d.style.width=c>0?`${Math.round(a/c*100)}%`:"0%";for(let l of n){let h=t.createDiv({cls:`kc-day-task${l.completed?" kc-day-task-done":""}`}),m=h.createEl("input",{type:"checkbox"});m.checked=l.completed,m.addEventListener("change",()=>this.toggleDailyTask(l.lineIndex,m.checked)),h.createEl("span",{cls:"kc-day-time",text:l.time}),h.createEl("span",{cls:"kc-day-subject",text:l.subject}),h.createEl("span",{cls:"kc-day-desc",text:l.description})}}async toggleDailyTask(e,t){if(!this.dailyPlan)return;let s=this.app.vault.getAbstractFileByPath(this.dailyPlan.filePath);if(!s||!("stat"in s))return;let n=await this.app.vault.read(s),a=O(n,e,t);await this.app.vault.modify(s,a)}async renderWeekMode(e){let t=e.createDiv({cls:"kc-week-section"}),s=this.todayStr(),n=await A(this.app.vault,new Date,this.plugin.settings.planFolder);for(let a of n){let c=a.date===s,r=t.createDiv({cls:`kc-week-row${c?" kc-week-today":""}`}),u=r.createDiv({cls:"kc-week-info"});if(u.createEl("span",{cls:"kc-week-date",text:`${a.date.slice(5)}`}),u.createEl("span",{cls:"kc-week-day",text:a.weekday}),a.filePath){let d=a.total>0?Math.round(a.done/a.total*100):0,h=r.createDiv({cls:"kc-progress-bar kc-week-bar"}).createDiv({cls:"kc-progress-fill"});h.style.width=`${d}%`,r.createEl("span",{cls:"kc-week-pct",text:`${d}%`}),r.style.cursor="pointer";let m=a.filePath;r.addEventListener("click",()=>{this.app.vault.getAbstractFileByPath(m)&&this.app.workspace.openLinkText(m,"",!1)})}else r.createEl("span",{cls:"kc-week-empty",text:"\u2014"})}}renderPhaseMode(e){this.renderPhase(e),this.renderTasks(e)}renderPhase(e){let t=e.createDiv({cls:"kc-phase-section"}),s=new Date,n=L(s);if(!n){t.createEl("div",{cls:"kc-phase-name",text:"\u5F53\u524D\u4E0D\u5728\u4EFB\u4F55\u9636\u6BB5\u8303\u56F4\u5185"});return}let a=B(n,s);t.createEl("div",{cls:"kc-phase-name",text:`\u{1F4CD} Phase ${n.id} ${n.name}`}),t.createEl("div",{cls:"kc-phase-range",text:`${n.startDate} \u2192 ${n.endDate}`});let r=t.createDiv({cls:"kc-progress-bar"}).createDiv({cls:"kc-progress-fill"});if(r.style.width=`${Math.round(a*100)}%`,t.createEl("div",{cls:"kc-progress-text",text:`${Math.round(a*100)}%`}),this.plugin.settings.showAllocation){let u=t.createDiv({cls:"kc-allocation"});for(let[d,l]of Object.entries(n.allocation))if(l&&l>0){let h=M[d]||d;u.createEl("span",{cls:"kc-alloc-tag",text:`${h} ${Math.round(l*100)}%`})}}}renderTasks(e){let t=e.createDiv({cls:"kc-tasks-section"}),n=j(new Date);if(n){t.createEl("div",{cls:"kc-section-title",text:`\u{1F4CB} ${n.month} \u91CC\u7A0B\u7891`});for(let r of n.items){let u=t.createDiv({cls:"kc-task-row"}),d=u.createEl("input",{type:"checkbox"});d.checked=this.plugin.settings.completedMilestones.includes(r),d.addEventListener("change",async()=>{let l=this.plugin.settings.completedMilestones;d.checked?l.includes(r)||l.push(r):this.plugin.settings.completedMilestones=l.filter(h=>h!==r),await this.plugin.saveSettings()}),u.createEl("span",{text:r,cls:d.checked?"kc-completed":""})}}t.createEl("div",{cls:"kc-section-title",text:"\u{1F4CB} \u5F85\u529E\u77E5\u8BC6\u70B9"});let a=this.plugin.settings.tasks,c={};for(let r of a)(c[r.subject]=c[r.subject]||[]).push(r);for(let[r,u]of Object.entries(c)){let d=M[r]||r;t.createEl("div",{cls:"kc-subject-label",text:d});for(let l of u){let h=t.createDiv({cls:"kc-task-row"}),m=h.createEl("input",{type:"checkbox"});m.checked=l.completed,m.addEventListener("change",async()=>{l.completed=m.checked,await this.plugin.saveSettings(),await this.fullRender()}),h.createEl("span",{text:l.text,cls:l.completed?"kc-completed":""})}}}renderFocusTab(e){this.focusSectionEl=e.createDiv({cls:"kc-focus-section"}),this.renderFocusContent()}renderFocusContent(){let e=this.focusSectionEl;if(!e)return;e.empty();let t=this.timerEngine.getSnapshot();this.renderFocusModeToggle(e,t),this.renderTimerDisplay(e,t),t.state==="IDLE"&&this.selectedFocusMode==="pomodoro"&&this.renderDurationPicker(e),t.state==="IDLE"?this.renderSubjectSelector(e):t.state!=="MICRO_PAUSE"&&e.createEl("div",{cls:"kc-focus-current-subject",text:`\u79D1\u76EE: ${M[t.subject]||t.subject}`}),t.state==="MICRO_PAUSE"&&this.renderMicroPauseOverlay(e,t),this.renderTimerControls(e,t),this.renderFocusStats(e,t)}renderFocusModeToggle(e,t){let s=e.createDiv({cls:"kc-focus-mode-toggle"}),n=t.state!=="IDLE",a=[{mode:"pomodoro",label:"\u756A\u8304\u949F"},{mode:"scientific",label:"\u79D1\u5B66\u4E13\u6CE8"},{mode:"stopwatch",label:"\u6B63\u8BA1\u65F6"}];for(let{mode:c,label:r}of a){let u=s.createEl("button",{cls:`kc-focus-mode-btn${this.selectedFocusMode===c?" kc-focus-mode-active":""}${n?" kc-disabled":""}`,text:r});n||u.addEventListener("click",()=>{this.selectedFocusMode!==c&&(this.selectedFocusMode=c,this.timerEngine.focusMode=c,this.renderFocusContent())})}}renderTimerDisplay(e,t){let s=e.createDiv({cls:"kc-timer-display"});this.timerStateEl=s.createEl("div",{cls:"kc-timer-state",text:this.getStateLabel(t.state)});let n;t.state==="IDLE"?this.selectedFocusMode==="pomodoro"?n=this.selectedDurationMin*6e4:this.selectedFocusMode==="scientific"?n=this.plugin.settings.focus.scientificDurationMin*6e4:n=0:t.focusMode==="stopwatch"?n=t.elapsedMs:n=t.remainingMs,this.timerDisplayEl=s.createEl("div",{cls:"kc-timer-countdown",text:this.formatTime(n)});let a=t.state==="IDLE"&&this.selectedFocusMode==="stopwatch"||t.state!=="IDLE"&&t.focusMode==="stopwatch",c=s.createDiv({cls:`kc-timer-progress-bar${a?" kc-hidden":""}`});this.timerProgressEl=c.createDiv({cls:"kc-timer-progress-fill"});let r=t.totalMs>0?(t.totalMs-t.remainingMs)/t.totalMs*100:0;this.timerProgressEl.style.width=`${Math.min(100,r)}%`}renderSubjectSelector(e){let t=e.createDiv({cls:"kc-subject-selector"});for(let s of I){let n=M[s]||s;t.createEl("button",{cls:`kc-subject-btn${this.selectedSubject===s?" kc-subject-btn-active":""}`,text:n}).addEventListener("click",()=>{this.selectedSubject=s,this.renderFocusContent()})}}renderDurationPicker(e){let t=e.createDiv({cls:"kc-duration-picker"}),s=[15,25,30,45,60];for(let n of s)t.createEl("button",{cls:`kc-duration-btn${this.selectedDurationMin===n?" kc-duration-btn-active":""}`,text:`${n}min`}).addEventListener("click",()=>{this.selectedDurationMin=n,this.renderFocusContent()})}renderMicroPauseOverlay(e,t){let s=e.createDiv({cls:"kc-micro-pause-overlay"});s.createEl("div",{cls:"kc-micro-pause-icon",text:"\u{1F60C}"}),s.createEl("div",{cls:"kc-micro-pause-text",text:"\u95ED\u773C\u4F11\u606F"}),s.createEl("div",{cls:"kc-micro-pause-timer",text:this.formatTime(t.microPauseRemainingMs)})}renderTimerControls(e,t){let s=e.createDiv({cls:"kc-timer-controls"});switch(t.state){case"IDLE":{if(s.createEl("button",{cls:"kc-btn kc-btn-start",text:"\u5F00\u59CB\u4E13\u6CE8"}).addEventListener("click",()=>{this.timerEngine.focusMode=this.selectedFocusMode,this.syncEngineFromSettings(),this.selectedFocusMode==="pomodoro"&&(this.timerEngine.pomodoroDurationMin=this.selectedDurationMin),this.timerEngine.start(this.selectedSubject)}),this.selectedFocusMode!=="stopwatch"){let a=s.createDiv({cls:"kc-strict-toggle"}),c=a.createEl("input",{type:"checkbox"});c.checked=this.timerEngine.strictMode,c.addEventListener("change",()=>{this.timerEngine.strictMode=c.checked,this.plugin.settings.focus.strictMode=c.checked,this.plugin.saveSettings()}),a.createEl("span",{cls:"kc-strict-label",text:"\u5B66\u9738\u6A21\u5F0F (\u7981\u6B62\u6682\u505C/\u653E\u5F03)"})}break}case"FOCUSING":{t.focusMode==="stopwatch"?(s.createEl("button",{cls:"kc-btn kc-btn-stop",text:"\u7ED3\u675F\u4E13\u6CE8"}).addEventListener("click",()=>this.timerEngine.stopStopwatch()),this.timerEngine.isPaused?s.createEl("button",{cls:"kc-btn kc-btn-start",text:"\u7EE7\u7EED"}).addEventListener("click",()=>this.timerEngine.resume()):s.createEl("button",{cls:"kc-btn kc-btn-pause",text:"\u6682\u505C"}).addEventListener("click",()=>{this.timerEngine.pause(),this.renderFocusContent()})):this.timerEngine.strictMode?s.createEl("span",{cls:"kc-strict-label",text:"\u{1F512} \u5B66\u9738\u6A21\u5F0F"}):this.timerEngine.isPaused?(s.createEl("button",{cls:"kc-btn kc-btn-start",text:"\u7EE7\u7EED"}).addEventListener("click",()=>this.timerEngine.resume()),s.createEl("button",{cls:"kc-btn kc-btn-reset",text:"\u653E\u5F03"}).addEventListener("click",()=>this.timerEngine.reset())):(s.createEl("button",{cls:"kc-btn kc-btn-pause",text:"\u6682\u505C"}).addEventListener("click",()=>{this.timerEngine.pause(),this.renderFocusContent()}),s.createEl("button",{cls:"kc-btn kc-btn-reset",text:"\u653E\u5F03"}).addEventListener("click",()=>this.timerEngine.reset()));break}case"SHORT_BREAK":case"LONG_BREAK":{s.createEl("button",{cls:"kc-btn kc-btn-skip",text:"\u8DF3\u8FC7\u4F11\u606F"}).addEventListener("click",()=>this.timerEngine.skipBreak());break}case"MICRO_PAUSE":break}}renderFocusStats(e,t){let s=e.createDiv({cls:"kc-focus-stats"});s.createEl("span",{cls:"kc-focus-stat",text:`\u{1F345} ${t.pomodorosToday} \u4E2A\u756A\u8304`}),s.createEl("span",{cls:"kc-focus-stat",text:`\u23F1 ${t.totalFocusMinutesToday} \u5206\u949F`})}onTimerTick(e){if(this.timerDisplayEl){let t=e.focusMode==="stopwatch"?e.elapsedMs:e.remainingMs;this.timerDisplayEl.textContent=this.formatTime(t)}if(this.timerProgressEl&&e.totalMs>0){let t=(e.totalMs-e.remainingMs)/e.totalMs*100;this.timerProgressEl.style.width=`${Math.min(100,t)}%`}}onTimerStateChange(e){this.viewMode==="focus"&&this.renderFocusContent(),this.persistFocusStats()}formatTime(e){let t=Math.max(0,Math.ceil(e/1e3)),s=Math.floor(t/3600),n=Math.floor(t%3600/60),a=t%60,c=String(n).padStart(2,"0"),r=String(a).padStart(2,"0");return s>0?`${String(s).padStart(2,"0")}:${c}:${r}`:`${c}:${r}`}getStateLabel(e){switch(e){case"IDLE":return"\u51C6\u5907\u5C31\u7EEA";case"FOCUSING":return"\u{1F525} \u4E13\u6CE8\u4E2D";case"MICRO_PAUSE":return"\u{1F60C} \u5FAE\u4F11\u606F";case"SHORT_BREAK":return"\u2615 \u77ED\u4F11\u606F";case"LONG_BREAK":return"\u{1F33F} \u957F\u4F11\u606F"}}syncEngineFromSettings(){let e=this.plugin.settings.focus,t=this.timerEngine;t.pomodoroDurationMin=e.pomodoroDurationMin,t.shortBreakMin=e.shortBreakMin,t.longBreakMin=e.longBreakMin,t.longBreakInterval=e.longBreakInterval,t.scientificDurationMin=e.scientificDurationMin,t.scientificLongBreakMin=e.scientificLongBreakMin,t.microPauseSec=e.microPauseSec,t.strictMode=e.strictMode,t.autoStart=e.autoStart}async persistFocusStats(){let e=this.timerEngine.exportStats();this.plugin.settings.focusStats=e,await this.plugin.saveSettings()}};var p=require("obsidian"),v=class extends p.PluginSettingTab{constructor(i,e){super(i,e),this.plugin=e}display(){let{containerEl:i}=this;i.empty(),i.createEl("h2",{text:"\u8003\u7814\u5012\u8BA1\u65F6 \u8BBE\u7F6E"}),new p.Setting(i).setName("\u8003\u8BD5\u65E5\u671F").setDesc("\u683C\u5F0F YYYY-MM-DD\uFF0C\u5982 2026-12-19").addText(e=>e.setPlaceholder("2026-12-19").setValue(this.plugin.settings.examDate).onChange(async t=>{/^\d{4}-\d{2}-\d{2}$/.test(t)&&(this.plugin.settings.examDate=t,await this.plugin.saveSettings(),this.plugin.refreshViews())})),new p.Setting(i).setName("\u8BA1\u5212\u6587\u4EF6\u5939").setDesc("\u5B58\u653E\u6BCF\u65E5\u8BA1\u5212\u6587\u4EF6\u7684\u6587\u4EF6\u5939\u8DEF\u5F84").addText(e=>e.setPlaceholder("\u8003\u7814\u8BA1\u5212").setValue(this.plugin.settings.planFolder).onChange(async t=>{this.plugin.settings.planFolder=t.trim()||"\u8003\u7814\u8BA1\u5212",await this.plugin.saveSettings(),this.plugin.refreshViews()})),new p.Setting(i).setName("\u663E\u793A\u65F6\u95F4\u5206\u914D").setDesc("\u5728\u9636\u6BB5\u89C6\u56FE\u4E2D\u663E\u793A\u5404\u79D1\u76EE\u65F6\u95F4\u5206\u914D\u6BD4\u4F8B").addToggle(e=>e.setValue(this.plugin.settings.showAllocation).onChange(async t=>{this.plugin.settings.showAllocation=t,await this.plugin.saveSettings(),this.plugin.refreshViews()})),i.createEl("h3",{text:"\u4E13\u6CE8\u6A21\u5F0F"}),new p.Setting(i).setName("\u756A\u8304\u949F\u65F6\u957F (\u5206\u949F)").addSlider(e=>e.setLimits(15,60,5).setValue(this.plugin.settings.focus.pomodoroDurationMin).setDynamicTooltip().onChange(async t=>{this.plugin.settings.focus.pomodoroDurationMin=t,await this.plugin.saveSettings()})),new p.Setting(i).setName("\u77ED\u4F11\u606F (\u5206\u949F)").addSlider(e=>e.setLimits(1,15,1).setValue(this.plugin.settings.focus.shortBreakMin).setDynamicTooltip().onChange(async t=>{this.plugin.settings.focus.shortBreakMin=t,await this.plugin.saveSettings()})),new p.Setting(i).setName("\u957F\u4F11\u606F (\u5206\u949F)").addSlider(e=>e.setLimits(10,30,5).setValue(this.plugin.settings.focus.longBreakMin).setDynamicTooltip().onChange(async t=>{this.plugin.settings.focus.longBreakMin=t,await this.plugin.saveSettings()})),new p.Setting(i).setName("\u957F\u4F11\u606F\u95F4\u9694 (\u756A\u8304\u6570)").addSlider(e=>e.setLimits(2,6,1).setValue(this.plugin.settings.focus.longBreakInterval).setDynamicTooltip().onChange(async t=>{this.plugin.settings.focus.longBreakInterval=t,await this.plugin.saveSettings()})),new p.Setting(i).setName("\u79D1\u5B66\u4E13\u6CE8\u65F6\u957F (\u5206\u949F)").addSlider(e=>e.setLimits(60,120,10).setValue(this.plugin.settings.focus.scientificDurationMin).setDynamicTooltip().onChange(async t=>{this.plugin.settings.focus.scientificDurationMin=t,await this.plugin.saveSettings()}))}};var y=class extends g.Plugin{constructor(){super(...arguments);this.settings=_}async onload(){await this.loadSettings(),this.registerView(f,e=>new S(e,this)),this.addSettingTab(new v(this.app,this)),this.addRibbonIcon("clock","\u8003\u7814\u5012\u8BA1\u65F6",()=>{this.activateView()}),this.addCommand({id:"open-kaoyan-countdown",name:"\u6253\u5F00\u8003\u7814\u5012\u8BA1\u65F6",callback:()=>this.activateView()}),this.addCommand({id:"save-study-progress",name:"\u8BB0\u5F55\u5F53\u524D\u5B66\u4E60\u8FDB\u5EA6",callback:()=>this.saveCurrentProgress()}),this.app.workspace.onLayoutReady(()=>{this.app.workspace.getLeavesOfType(f).length===0&&this.activateView()}),this.registerInterval(window.setInterval(()=>this.autoTrackProgress(),8e3))}onunload(){this.app.workspace.detachLeavesOfType(f)}async activateView(){let{workspace:e}=this.app,t=e.getLeavesOfType(f);if(t.length>0){e.revealLeaf(t[0]);return}let s=e.getRightLeaf(!1);s&&(await s.setViewState({type:f,active:!0}),e.revealLeaf(s))}refreshViews(){for(let e of this.app.workspace.getLeavesOfType(f)){let t=e.view;t instanceof S&&t.refresh()}}async saveCurrentProgress(){let e=this.app.workspace.activeLeaf;if(!e){new g.Notice("\u6CA1\u6709\u6D3B\u52A8\u7684\u89C6\u56FE");return}let t=e.view;if(!(t instanceof g.FileView)||!t.file){new g.Notice("\u5F53\u524D\u89C6\u56FE\u4E0D\u662F\u6587\u4EF6\u89C6\u56FE");return}let s=t.getState(),n=t.file.path,a=Date.now(),c={filePath:n,state:s,label:t.file.basename,timestamp:a},r=this.settings.bookmarks||[];r=r.filter(u=>u.filePath!==n),r.unshift(c),r.length>5&&(r=r.slice(0,5)),this.settings.bookmarks=r,await this.saveSettings(),this.refreshViews(),new g.Notice(`\u5DF2\u8BB0\u5F55\u5B66\u4E60\u8FDB\u5EA6: ${t.file.basename}`)}async autoTrackProgress(){var u;let e=this.app.workspace.activeLeaf;if(!e)return;let t=e.view;if(!(t instanceof g.FileView)||!t.file||((u=t.file.extension)==null?void 0:u.toLowerCase())!=="pdf")return;let s=t.getState(),n=t.file.path,a=(this.settings.bookmarks||[]).find(d=>d.filePath===n);if(a&&JSON.stringify(a.state)===JSON.stringify(s))return;let c={filePath:n,state:s,label:t.file.basename,timestamp:Date.now()},r=this.settings.bookmarks||[];r=r.filter(d=>d.filePath!==n),r.unshift(c),r.length>5&&(r=r.slice(0,5)),this.settings.bookmarks=r,await this.saveSettings(),this.refreshViews()}async loadSettings(){let e=await this.loadData()||{};this.settings=Object.assign({},_,e),this.settings.focus=Object.assign({},w,e.focus),this.settings.focusStats=Object.assign({},T,e.focusStats)}async saveSettings(){await this.saveData(this.settings)}};
