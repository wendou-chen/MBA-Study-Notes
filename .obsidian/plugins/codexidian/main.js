var Ie=Object.defineProperty;var st=Object.getOwnPropertyDescriptor;var rt=Object.getOwnPropertyNames;var at=Object.prototype.hasOwnProperty;var ot=(S,n)=>{for(var e in n)Ie(S,e,{get:n[e],enumerable:!0})},lt=(S,n,e,t)=>{if(n&&typeof n=="object"||typeof n=="function")for(let i of rt(n))!at.call(S,i)&&i!==e&&Ie(S,i,{get:()=>n[i],enumerable:!(t=st(n,i))||t.enumerable});return S};var dt=S=>lt(Ie({},"__esModule",{value:!0}),S);var Tt={};ot(Tt,{default:()=>Pe});module.exports=dt(Tt);var M=require("obsidian");var oe=require("child_process"),ae=class{constructor(n,e,t,i,s,r,a){this.getSettings=n;this.getVaultPath=e;this.onThreadIdChanged=t;this.onSystemMessage=i;this.onApprovalRequest=s;this.onUserInputRequest=r;this.onMcpToolCall=a;this.process=null;this.stdoutBuffer="";this.stderrBuffer="";this.requestCounter=1;this.pendingRequests=new Map;this.pendingTurns=new Map;this.preTurnDeltas=new Map;this.preTurnToolDeltas=new Map;this.preTurnThinkingDeltas=new Map;this.preTurnToolStarts=new Map;this.preTurnToolCompletes=new Map;this.preTurnResult=new Map;this.turnHasMessageDelta=new Set;this.turnHasThinkingDelta=new Set;this.turnActiveToolItemId=new Map;this.startPromise=null;this.disposed=!1;this.intentionalShutdown=!1;this.reconnectAttempts=0;this.reconnectTimer=null;this.maxReconnectAttempts=3;this.activeCommand=null;this.currentThreadId=null;this.currentTurnId=null}getThreadId(){return this.currentThreadId}isRunning(){return!!(this.process&&!this.process.killed)}getCurrentTurnId(){return this.currentTurnId}setThreadId(n){this.currentThreadId=n}async cancelTurn(n){var s;let e=n.trim();if(!e)return!1;let t=!1;if(this.process&&!this.process.killed)try{await this.request("turn/cancel",{turnId:e}),t=!0}catch(r){}let i=this.pendingTurns.get(e);return i&&(this.pendingTurns.delete(e),i.resolve({threadId:(s=this.currentThreadId)!=null?s:"",turnId:e,status:"cancelled",errorMessage:"Cancelled by user"}),t=!0),this.preTurnDeltas.delete(e),this.preTurnToolDeltas.delete(e),this.preTurnThinkingDeltas.delete(e),this.preTurnToolStarts.delete(e),this.preTurnToolCompletes.delete(e),this.preTurnResult.delete(e),this.clearTurnTransientState(e),this.clearCurrentTurnId(e),t}async restart(){await this.dispose(),this.disposed=!1,this.intentionalShutdown=!1,this.reconnectAttempts=0,await this.start()}async dispose(){this.disposed=!0,this.intentionalShutdown=!0,this.clearReconnectTimer();for(let[n,e]of this.pendingRequests)clearTimeout(e.timeout),e.reject(new Error("Codex app-server stopped.")),this.pendingRequests.delete(n);for(let[n,e]of this.pendingTurns)e.reject(new Error(`Turn ${n} interrupted: app-server stopped.`)),this.pendingTurns.delete(n),this.clearTurnTransientState(n),this.clearCurrentTurnId(n);this.process&&!this.process.killed&&this.process.kill(),this.process=null,this.stdoutBuffer="",this.stderrBuffer="",this.startPromise=null,this.currentTurnId=null,this.preTurnDeltas.clear(),this.preTurnToolDeltas.clear(),this.preTurnThinkingDeltas.clear(),this.preTurnToolStarts.clear(),this.preTurnToolCompletes.clear(),this.preTurnResult.clear(),this.turnHasMessageDelta.clear(),this.turnHasThinkingDelta.clear(),this.turnActiveToolItemId.clear()}async newThread(){return await this.start(),await this.startThread()}async sendTurn(n,e={},t){var a,l,d,p,c;this.debugLog("sendTurn:start",{promptLength:n.length,model:(a=t==null?void 0:t.model)!=null?a:null,effort:(l=t==null?void 0:t.effort)!=null?l:null,imageCount:(p=(d=t==null?void 0:t.images)==null?void 0:d.length)!=null?p:0}),await this.start();let i=await this.ensureThread(),s;try{s=await this.request("turn/start",this.buildTurnStartParams(i,n,t))}catch(u){let g=u instanceof Error?u.message:String(u);if(!this.isThreadNotFoundError(g))throw u;this.debugLog("turn/start thread not found, retrying with thread/start",{threadId:i,message:g}),this.invalidateThreadState(i),i=await this.startThread(),s=await this.request("turn/start",this.buildTurnStartParams(i,n,t))}let r=(c=s==null?void 0:s.turn)==null?void 0:c.id;if(!r)throw new Error("turn/start did not return turn id.");return this.currentTurnId=r,await new Promise((u,g)=>{let v=setTimeout(()=>{this.pendingTurns.has(r)&&(this.pendingTurns.delete(r),this.clearTurnTransientState(r),this.clearCurrentTurnId(r),g(new Error("Turn timed out after 15 minutes.")))},9e5);this.pendingTurns.set(r,{handlers:e,resolve:E=>{clearTimeout(v),this.clearTurnTransientState(r),this.clearCurrentTurnId(r),u(E)},reject:E=>{clearTimeout(v),this.clearTurnTransientState(r),this.clearCurrentTurnId(r),g(E)},startedAt:Date.now()});let m=this.preTurnDeltas.get(r);if(m&&m.length>0){for(let E of m)this.safeInvoke(()=>{var P;return(P=e.onDelta)==null?void 0:P.call(e,E)},`onDelta(pre):${r}`);this.preTurnDeltas.delete(r)}let f=this.preTurnToolDeltas.get(r);if(f&&f.length>0){for(let E of f)this.safeInvoke(()=>{var P;return(P=e.onToolDelta)==null?void 0:P.call(e,E)},`onToolDelta(pre):${r}`);this.preTurnToolDeltas.delete(r)}let x=this.preTurnThinkingDeltas.get(r);if(x&&x.length>0){for(let E of x)this.safeInvoke(()=>{var P;return(P=e.onThinkingDelta)==null?void 0:P.call(e,E)},`onThinkingDelta(pre):${r}`);this.preTurnThinkingDeltas.delete(r)}let T=this.preTurnToolStarts.get(r);if(T&&T.length>0){for(let E of T)this.safeInvoke(()=>{var P;return(P=e.onToolStart)==null?void 0:P.call(e,E)},`onToolStart(pre):${r}`);this.preTurnToolStarts.delete(r)}let h=this.preTurnToolCompletes.get(r);if(h&&h.length>0){for(let E of h)this.safeInvoke(()=>{var P;return(P=e.onToolComplete)==null?void 0:P.call(e,E)},`onToolComplete(pre):${r}`);this.preTurnToolCompletes.delete(r)}let A=this.preTurnResult.get(r);A&&(this.preTurnResult.delete(r),this.pendingTurns.delete(r),this.clearTurnTransientState(r),this.clearCurrentTurnId(r),u(A))})}async start(){if(this.intentionalShutdown=!1,this.disposed=!1,this.clearReconnectTimer(),!(this.process&&!this.process.killed)){if(this.startPromise){await this.startPromise;return}this.startPromise=this.startInternal();try{await this.startPromise,this.reconnectAttempts=0}finally{this.startPromise=null}}}async startInternal(){var l,d,p;let n=this.getSettings(),e=this.resolveCwd(n),t=this.buildSpawnEnv(),i=this.buildCommandCandidates(n.codexCommand);if(i.length===0)throw new Error("Codex command is empty. Please configure it in settings.");this.debugLog("start:env",{configuredCommand:n.codexCommand,reconnectAttempts:this.reconnectAttempts,platform:process.platform,cwd:e,pathPreview:((l=t.PATH)!=null?l:"").split(process.platform==="win32"?";":":").slice(0,10),candidates:i});let s=this.selectStartCommand(i,t,e),r=s.command;this.activeCommand=r,this.debugLog("app-server start command",{command:r,probe:s.probe.detail,reconnectAttempts:this.reconnectAttempts,cwd:e});let a;try{a=(0,oe.spawn)(r,["app-server","--listen","stdio://"],{cwd:e,env:t,shell:process.platform==="win32",windowsHide:!0})}catch(c){let u=c instanceof Error?c.message:String(c);throw this.debugError("spawn:throw",c,{command:r,cwd:e}),this.onSystemMessage(`Failed to spawn Codex app-server: ${u}`),this.scheduleReconnect(),c}this.process=a,(d=a.stdout)==null||d.on("data",c=>{this.consumeStdout(c.toString())}),(p=a.stderr)==null||p.on("data",c=>{this.consumeStderr(c.toString())}),a.on("error",c=>{let u=c instanceof Error?c.message:String(c);this.debugError("spawn:error-event",c,{command:r,cwd:e}),this.handleProcessTermination(a,`Codex app-server error (${r}): ${u}`)}),a.on("exit",(c,u)=>{let g=u?`signal ${u}`:`${c!=null?c:"unknown"}`;this.debugLog("spawn:exit-event",{command:r,code:c,signal:u!=null?u:null}),this.handleProcessTermination(a,`Codex app-server exited (${g}) [${r}].`)});try{await this.request("initialize",{clientInfo:{name:"codexidian",title:"Codexidian",version:"0.1.0"},capabilities:{experimentalApi:!0,optOutNotificationMethods:null}}),this.notify("initialized"),this.reconnectAttempts=0}catch(c){if(this.process===a&&!a.killed)try{a.kill()}catch(u){}throw c}}handleProcessTermination(n,e){this.process===n&&(this.rejectAllPending(e),this.process=null,this.currentTurnId=null,this.activeCommand=null,this.stdoutBuffer="",this.stderrBuffer="",this.preTurnDeltas.clear(),this.preTurnToolDeltas.clear(),this.preTurnThinkingDeltas.clear(),this.preTurnToolStarts.clear(),this.preTurnToolCompletes.clear(),this.preTurnResult.clear(),this.turnHasMessageDelta.clear(),this.turnHasThinkingDelta.clear(),this.turnActiveToolItemId.clear(),!(this.disposed||this.intentionalShutdown)&&(this.onSystemMessage(e),this.scheduleReconnect()))}rejectAllPending(n){for(let[e,t]of this.pendingRequests)clearTimeout(t.timeout),t.reject(new Error(n)),this.pendingRequests.delete(e);for(let[e,t]of this.pendingTurns)t.reject(new Error(n)),this.pendingTurns.delete(e),this.clearTurnTransientState(e),this.clearCurrentTurnId(e)}clearReconnectTimer(){this.reconnectTimer!==null&&(clearTimeout(this.reconnectTimer),this.reconnectTimer=null)}scheduleReconnect(){if(this.disposed||this.intentionalShutdown||this.reconnectTimer!==null)return;if(this.reconnectAttempts>=this.maxReconnectAttempts){this.onSystemMessage("Codex app-server reconnect attempts exhausted. Use Reconnect/Restart to try again.");return}this.reconnectAttempts+=1;let n=this.reconnectAttempts,e=Math.min(8e3,1e3*2**(n-1));this.onSystemMessage(`Reconnecting to Codex app-server in ${Math.ceil(e/1e3)}s (${n}/${this.maxReconnectAttempts})...`),this.reconnectTimer=setTimeout(()=>{this.reconnectTimer=null,!(this.disposed||this.intentionalShutdown)&&this.start().then(()=>{this.onSystemMessage("Codex app-server reconnected.")}).catch(t=>{let i=t instanceof Error?t.message:String(t);this.onSystemMessage(`Reconnect attempt ${n} failed: ${i}`),this.isRunning()||this.scheduleReconnect()})},e)}async ensureThread(){var t,i;if(this.currentThreadId)return this.currentThreadId;let n=this.getSettings(),e=n.persistThread?(t=n.lastThreadId)==null?void 0:t.trim():"";if(e)try{let s=await this.request("thread/resume",{threadId:e,model:n.model.trim()||null,modelProvider:null,cwd:this.resolveCwd(n),approvalPolicy:n.approvalPolicy,sandbox:n.sandboxMode,config:null,baseInstructions:null,developerInstructions:null,personality:null}),r=(i=s==null?void 0:s.thread)==null?void 0:i.id;if(r)return this.updateThreadId(r),r}catch(s){let r=s instanceof Error?s.message:String(s);this.debugLog("thread/resume failed, falling back to thread/start",{threadId:e,message:r}),this.onSystemMessage(`Failed to resume thread, starting new one. (${r})`),this.invalidateThreadState(e)}return await this.startThread()}async startThread(){var i;let n=this.getSettings(),e=await this.request("thread/start",{model:n.model.trim()||null,modelProvider:null,cwd:this.resolveCwd(n),approvalPolicy:n.approvalPolicy,sandbox:n.sandboxMode,config:null,baseInstructions:null,developerInstructions:null,personality:null,ephemeral:!1,experimentalRawEvents:!1,persistExtendedHistory:!0}),t=(i=e==null?void 0:e.thread)==null?void 0:i.id;if(!t)throw new Error("thread/start did not return thread id.");return this.updateThreadId(t),this.debugLog("new thread created",{threadId:t}),t}resolveCwd(n){let e=n.workingDirectory.trim();return e||this.getVaultPath()}buildTurnStartParams(n,e,t){var r,a,l;let i=[],s=0;for(let d of(r=t==null?void 0:t.images)!=null?r:[]){let p=typeof(d==null?void 0:d.path)=="string"?d.path.trim():"";if(p.length>0){i.push({type:"localImage",path:p});continue}let c=typeof(d==null?void 0:d.dataUrl)=="string"?d.dataUrl.trim():"",u=this.normalizeImageUrl(c);if(!u){s+=1;continue}i.push({type:"image",url:u})}if(i.length>0||s>0){let d=i[0];this.debugLog("image payload",{count:i.length,droppedImages:s,firstImageType:(a=d==null?void 0:d.type)!=null?a:null,firstImageUrlPrefix:d&&d.type==="image"?d.url.slice(0,50):null,firstImageUrlLength:d&&d.type==="image"?d.url.length:null,firstImagePath:d&&d.type==="localImage"?d.path:null})}return{threadId:n,input:[...i,{type:"text",text:e,text_elements:[]}],cwd:null,approvalPolicy:null,sandboxPolicy:null,model:((l=t==null?void 0:t.model)==null?void 0:l.trim())||null,effort:(t==null?void 0:t.effort)||null,summary:null,personality:null,outputSchema:null,collaborationMode:null}}normalizeImageUrl(n){let e=n.trim();return e?/^data:image\/[a-z0-9.+-]+;base64,/i.test(e)||/^https?:\/\//i.test(e)||/^file:\/\//i.test(e)?e:/^[A-Za-z0-9+/]+={0,2}$/.test(e)&&e.length>=64?`data:image/png;base64,${e}`:null:null}isThreadNotFoundError(n){return n.trim().toLowerCase().includes("thread not found")}invalidateThreadState(n){this.currentThreadId&&this.currentThreadId===n&&(this.currentThreadId=null);let e=this.getSettings();if(e.lastThreadId&&e.lastThreadId.trim()===n){e.lastThreadId="";try{this.onThreadIdChanged("")}catch(t){}}}consumeStdout(n){var t;this.stdoutBuffer+=n;let e=this.stdoutBuffer.split(/\r?\n/);this.stdoutBuffer=(t=e.pop())!=null?t:"";for(let i of e){let s=i.trim();if(!s)continue;let r;try{r=JSON.parse(s)}catch(a){this.onSystemMessage(`[app-server/stdout] ${s}`);continue}this.routeIncomingMessage(r)}}consumeStderr(n){var t;this.stderrBuffer+=n;let e=this.stderrBuffer.split(/\r?\n/);this.stderrBuffer=(t=e.pop())!=null?t:"";for(let i of e){let s=i.trim();s&&(s.includes("failed to install system skills")||s.includes("failed to record rollout")||s.startsWith("WARNING: proceeding, even though we could not update PATH")||this.onSystemMessage(`[app-server/stderr] ${s}`))}}routeIncomingMessage(n){if(n&&Object.prototype.hasOwnProperty.call(n,"id")&&(Object.prototype.hasOwnProperty.call(n,"result")||Object.prototype.hasOwnProperty.call(n,"error"))){this.resolvePendingRequest(n);return}if(n&&Object.prototype.hasOwnProperty.call(n,"id")&&typeof n.method=="string"){this.handleServerRequest(n);return}n&&typeof n.method=="string"&&this.handleNotification(n)}resolvePendingRequest(n){var i;let e=String(n.id),t=this.pendingRequests.get(e);if(t){if(clearTimeout(t.timeout),this.pendingRequests.delete(e),Object.prototype.hasOwnProperty.call(n,"error")&&n.error){let s=((i=n.error)==null?void 0:i.message)||JSON.stringify(n.error);t.reject(new Error(s));return}t.resolve(n.result)}}async handleServerRequest(n){let e=n.id,t=n.method,i=this.getSettings();try{let s;if(this.isApprovalMethod(t)){let r=this.mapApprovalType(t),a={requestId:e,type:r,command:this.extractApprovalCommand(n.params),filePath:this.extractApprovalFilePath(n.params),cwd:this.extractApprovalCwd(n.params),params:n.params},l=await this.resolveApprovalDecision(a);t==="execCommandApproval"||t==="applyPatchApproval"?s={decision:l==="accept"?"approved":"denied"}:s={decision:l}}else if(t==="item/tool/requestUserInput"){let r=this.buildUserInputRequest(e,n.params),a=null;if(this.onUserInputRequest)try{a=await this.withTimeout(this.onUserInputRequest(r),6e4)}catch(l){let d=l instanceof Error?l.message:String(l);this.onSystemMessage(`[input] Request timed out, using fallback response. (${d})`)}s=a!=null?a:this.buildDefaultUserInputResponse(r)}else if(t==="item/tool/call")if(!i.enableMcp)s=this.buildToolCallErrorResult("MCP is disabled in Codexidian settings.");else if(!this.onMcpToolCall)s=this.buildToolCallErrorResult("No MCP tool handler is configured.");else{let r=this.buildMcpToolCallRequest(e,n.params);if(!r.name)s=this.buildToolCallErrorResult("Tool call is missing tool name.");else try{s=await this.withTimeout(this.onMcpToolCall(r),12e4)}catch(a){let l=a instanceof Error?a.message:String(a);s=this.buildToolCallErrorResult(`MCP tool call failed (${r.name}): ${l}`)}}else{this.writeJson({id:e,error:{code:-32601,message:`Unsupported server request: ${t}`}});return}this.writeJson({id:e,result:s})}catch(s){let r=s instanceof Error?s.message:String(s);this.writeJson({id:e,error:{code:-32603,message:r}})}}isApprovalMethod(n){return n==="item/commandExecution/requestApproval"||n==="item/fileChange/requestApproval"||n==="execCommandApproval"||n==="applyPatchApproval"}mapApprovalType(n){return n==="item/commandExecution/requestApproval"?"commandExecution":n==="item/fileChange/requestApproval"?"fileChange":n==="execCommandApproval"?"execCommand":"applyPatch"}async resolveApprovalDecision(n){let e=this.buildApprovalSummary(n),{approvalMode:t}=this.getSettings();if(t==="yolo")return this.onSystemMessage(`[approval] Auto-approved ${e}`),"accept";if(t==="safe")return this.onSystemMessage(`[approval] Auto-denied ${e}`),"decline";if(this.onApprovalRequest)try{return await this.withTimeout(this.onApprovalRequest(n),6e4)}catch(i){let s=i instanceof Error?i.message:String(i);return this.onSystemMessage(`[approval] Timed out. Denied ${e}. (${s})`),"decline"}return this.onSystemMessage(`[approval] No approval UI available. Denied ${e}.`),"decline"}buildApprovalSummary(n){return n.command?`${n.type} (${n.command.slice(0,80)})`:n.filePath?`${n.type} (${n.filePath})`:n.type}extractApprovalCommand(n){var t,i,s,r,a,l,d;let e=(d=(a=(s=(t=n==null?void 0:n.command)!=null?t:n==null?void 0:n.cmd)!=null?s:(i=n==null?void 0:n.input)==null?void 0:i.command)!=null?a:(r=n==null?void 0:n.request)==null?void 0:r.command)!=null?d:(l=n==null?void 0:n.request)==null?void 0:l.cmd;if(typeof e=="string"&&e.trim().length>0)return e.trim();if(Array.isArray(n==null?void 0:n.command)&&n.command.every(p=>typeof p=="string"))return n.command.join(" ").trim()||void 0}extractApprovalFilePath(n){var i,s,r,a,l,d,p,c,u;let e=(c=(d=(a=(s=(i=n==null?void 0:n.filePath)!=null?i:n==null?void 0:n.path)!=null?s:n==null?void 0:n.targetPath)!=null?a:(r=n==null?void 0:n.request)==null?void 0:r.filePath)!=null?d:(l=n==null?void 0:n.request)==null?void 0:l.path)!=null?c:(p=n==null?void 0:n.file)==null?void 0:p.path;if(typeof e=="string"&&e.trim().length>0)return e.trim();let t=Array.isArray(n==null?void 0:n.changes)?(u=n.changes.find(g=>typeof(g==null?void 0:g.path)=="string"))==null?void 0:u.path:void 0;if(typeof t=="string"&&t.trim().length>0)return t.trim()}extractApprovalCwd(n){var t,i,s;let e=(s=(t=n==null?void 0:n.cwd)!=null?t:n==null?void 0:n.workingDirectory)!=null?s:(i=n==null?void 0:n.request)==null?void 0:i.cwd;if(typeof e=="string"&&e.trim().length>0)return e.trim()}buildUserInputRequest(n,e){let i=(Array.isArray(e==null?void 0:e.questions)?e.questions:[]).map(s=>{let r=typeof(s==null?void 0:s.id)=="string"?s.id:"";if(!r)return null;let a=typeof(s==null?void 0:s.question)=="string"?s.question:typeof(s==null?void 0:s.text)=="string"?s.text:void 0,l=Array.isArray(s==null?void 0:s.options)?s.options.map(d=>{let p=typeof(d==null?void 0:d.label)=="string"?d.label:"";return p?{label:p}:null}).filter(d=>!!d):void 0;return{id:r,text:a,options:l}}).filter(s=>!!s);return{requestId:n,questions:i}}buildDefaultUserInputResponse(n){let e={};for(let t of n.questions){let i=t.options&&t.options.length>0?t.options[0].label:"";e[t.id]={answers:[i]}}return{answers:e}}buildMcpToolCallRequest(n,e){let t=e&&typeof e=="object"?e:{};return{requestId:n,name:this.extractToolCallName(t),arguments:this.extractToolCallArguments(t),rawParams:e}}extractToolCallName(n){var t,i,s,r;let e=[n.name,n.toolName,(t=n.tool)==null?void 0:t.name,(i=n.call)==null?void 0:i.name,(s=n.request)==null?void 0:s.name,(r=n.toolCall)==null?void 0:r.name];for(let a of e)if(typeof a=="string"&&a.trim().length>0)return a.trim();return""}extractToolCallArguments(n){var t,i,s;let e=[n.arguments,n.args,n.input,(t=n.call)==null?void 0:t.arguments,(i=n.request)==null?void 0:i.arguments,(s=n.tool)==null?void 0:s.input];for(let r of e){let a=this.parseToolArguments(r);if(a)return a}return{}}parseToolArguments(n){if(!n)return null;if(typeof n=="object"&&!Array.isArray(n))return n;if(typeof n!="string")return null;let e=n.trim();if(!e)return null;try{let t=JSON.parse(e);return t&&typeof t=="object"&&!Array.isArray(t)?t:null}catch(t){return{input:e}}}buildToolCallErrorResult(n){return{success:!1,isError:!0,contentItems:[{type:"inputText",text:n}]}}async withTimeout(n,e){return await new Promise((t,i)=>{let s=setTimeout(()=>{i(new Error(`timeout after ${e}ms`))},e);n.then(r=>{clearTimeout(s),t(r)},r=>{clearTimeout(s),i(r)})})}handleNotification(n){var i,s,r,a,l,d,p;let e=n.method,t=(i=n.params)!=null?i:{};if(e==="thread/started"){let c=(s=t==null?void 0:t.thread)==null?void 0:s.id;typeof c=="string"&&c&&this.updateThreadId(c);return}if(e==="item/agentMessage/delta"){let c=t==null?void 0:t.turnId,u=t==null?void 0:t.delta;typeof c=="string"&&typeof u=="string"&&u.length>0&&(this.turnHasMessageDelta.add(c),this.emitTurnDelta(c,u));return}if(e==="item/commandExecution/outputDelta"||e==="item/fileChange/outputDelta"){let c=t==null?void 0:t.turnId,u=t==null?void 0:t.delta;if(typeof c=="string"&&typeof u=="string"&&u.length>0){let g=this.extractItemId((r=t==null?void 0:t.item)!=null?r:t,c);g&&this.turnActiveToolItemId.set(c,g),this.emitToolDelta(c,u)}return}if(e.startsWith("item/")&&e.endsWith("/delta")){let c=t==null?void 0:t.turnId,u=this.extractTextDelta(t);typeof c=="string"&&typeof u=="string"&&u.length>0&&this.isThinkingMethod(e)&&this.emitThinkingDelta(c,u);return}if(e==="item/started"){let c=t==null?void 0:t.turnId,u=t==null?void 0:t.item,g=this.normalizeItemType((a=u==null?void 0:u.type)!=null?a:t==null?void 0:t.type),v=this.extractItemId(u,c);if(typeof c=="string"&&v){if(this.isThinkingType(g)){let m=this.extractTextDelta(u);m&&this.emitThinkingDelta(c,m);return}if(g!=="agentmessage"){let m={turnId:c,itemId:v,type:g||"tool",name:this.extractToolName(u),command:this.extractCommand(u),filePath:this.extractFilePath(u)};this.turnActiveToolItemId.set(c,v),this.emitToolStart(c,m)}}return}if(e==="item/completed"){let c=t==null?void 0:t.turnId,u=t==null?void 0:t.item,g=this.normalizeItemType((l=u==null?void 0:u.type)!=null?l:t==null?void 0:t.type);if(typeof c=="string"){if(g==="agentmessage"&&typeof(u==null?void 0:u.text)=="string"){!this.turnHasMessageDelta.has(c)&&u.text.length>0&&this.emitTurnDelta(c,u.text);return}if(this.isThinkingType(g)){let m=this.extractTextDelta(u);m&&!this.turnHasThinkingDelta.has(c)&&this.emitThinkingDelta(c,m);return}let v=this.extractItemId(u,c);if(v){let m={turnId:c,itemId:v,type:g||"tool",status:this.extractItemStatus(u,t),name:this.extractToolName(u),command:this.extractCommand(u),filePath:this.extractFilePath(u)};this.emitToolComplete(c,m),this.turnActiveToolItemId.get(c)===v&&this.turnActiveToolItemId.delete(c)}}return}if(e==="error"){let c=t==null?void 0:t.turnId,u=(d=t==null?void 0:t.error)==null?void 0:d.message,g=!!(t!=null&&t.willRetry);if(typeof c=="string"&&typeof u=="string"){let v=this.pendingTurns.get(c);v&&this.safeInvoke(()=>{var m,f;return(f=(m=v.handlers).onSystem)==null?void 0:f.call(m,`[error] ${u}`)},`onSystem(error):${c}`),!g&&!v&&this.onSystemMessage(`[error] ${u}`)}return}if(e==="turn/completed"){let c=t==null?void 0:t.turn,u=c==null?void 0:c.id,g=t==null?void 0:t.threadId,v=c==null?void 0:c.status,m=(p=c==null?void 0:c.error)==null?void 0:p.message;if(typeof u=="string"&&typeof g=="string"&&typeof v=="string"){let f={threadId:g,turnId:u,status:v,errorMessage:typeof m=="string"?m:void 0},x=this.pendingTurns.get(u);x?(v!=="completed"&&f.errorMessage&&this.safeInvoke(()=>{var T,h;return(h=(T=x.handlers).onSystem)==null?void 0:h.call(T,`[turn ${v}] ${f.errorMessage}`)},`onSystem(turn-completed):${u}`),x.resolve(f),this.pendingTurns.delete(u)):v!=="cancelled"?this.preTurnResult.set(u,f):this.clearTurnTransientState(u),x&&this.clearTurnTransientState(u),this.clearCurrentTurnId(u)}return}e.startsWith("codex/event/")}emitTurnDelta(n,e){var s;let t=this.pendingTurns.get(n);if(t){this.safeInvoke(()=>{var r,a;return(a=(r=t.handlers).onDelta)==null?void 0:a.call(r,e)},`onDelta:${n}`);return}let i=(s=this.preTurnDeltas.get(n))!=null?s:[];i.push(e),this.preTurnDeltas.set(n,i)}emitToolDelta(n,e){var s;let t=this.pendingTurns.get(n);if(t){this.safeInvoke(()=>{var r,a;return(a=(r=t.handlers).onToolDelta)==null?void 0:a.call(r,e)},`onToolDelta:${n}`);return}let i=(s=this.preTurnToolDeltas.get(n))!=null?s:[];i.push(e),this.preTurnToolDeltas.set(n,i)}emitThinkingDelta(n,e){var s;this.turnHasThinkingDelta.add(n);let t=this.pendingTurns.get(n);if(t){this.safeInvoke(()=>{var r,a;return(a=(r=t.handlers).onThinkingDelta)==null?void 0:a.call(r,e)},`onThinkingDelta:${n}`);return}let i=(s=this.preTurnThinkingDeltas.get(n))!=null?s:[];i.push(e),this.preTurnThinkingDeltas.set(n,i)}emitToolStart(n,e){var s;let t=this.pendingTurns.get(n);if(t){this.safeInvoke(()=>{var r,a;return(a=(r=t.handlers).onToolStart)==null?void 0:a.call(r,e)},`onToolStart:${n}`);return}let i=(s=this.preTurnToolStarts.get(n))!=null?s:[];i.push(e),this.preTurnToolStarts.set(n,i)}emitToolComplete(n,e){var s;let t=this.pendingTurns.get(n);if(t){this.safeInvoke(()=>{var r,a;return(a=(r=t.handlers).onToolComplete)==null?void 0:a.call(r,e)},`onToolComplete:${n}`);return}let i=(s=this.preTurnToolCompletes.get(n))!=null?s:[];i.push(e),this.preTurnToolCompletes.set(n,i)}clearTurnTransientState(n){this.preTurnDeltas.delete(n),this.preTurnToolDeltas.delete(n),this.preTurnThinkingDeltas.delete(n),this.preTurnToolStarts.delete(n),this.preTurnToolCompletes.delete(n),this.turnHasMessageDelta.delete(n),this.turnHasThinkingDelta.delete(n),this.turnActiveToolItemId.delete(n)}normalizeItemType(n){return typeof n!="string"?"":n.replace(/[^a-zA-Z]/g,"").toLowerCase()}isThinkingType(n){return n.includes("thinking")||n.includes("reasoning")}isThinkingMethod(n){let e=n.toLowerCase();return e.includes("thinking")||e.includes("reasoning")}extractTextDelta(n){if(!n||typeof n!="object")return null;let e=[n.delta,n.text,n.content,n.message,n.output];for(let t of e)if(typeof t=="string"&&t.length>0)return t;return null}extractItemId(n,e){var r;let t=(r=n==null?void 0:n.id)!=null?r:n==null?void 0:n.itemId;if(typeof t=="string"&&t.trim().length>0)return t;if(typeof e=="string"){let a=this.turnActiveToolItemId.get(e);if(a)return a}let i=typeof e=="string"&&e.length>0?e:"turn",s=`${Date.now()}-${Math.random().toString(36).slice(2,7)}`;return`${i}:${s}`}extractToolName(n){var t,i,s,r,a;let e=(a=(s=(t=n==null?void 0:n.name)!=null?t:n==null?void 0:n.toolName)!=null?s:(i=n==null?void 0:n.tool)==null?void 0:i.name)!=null?a:(r=n==null?void 0:n.command)==null?void 0:r.name;if(typeof e=="string"&&e.trim().length>0)return e.trim()}extractCommand(n){var t,i,s,r,a;let e=(a=(s=(i=n==null?void 0:n.command)!=null?i:(t=n==null?void 0:n.input)==null?void 0:t.command)!=null?s:n==null?void 0:n.rawCommand)!=null?a:(r=n==null?void 0:n.toolInput)==null?void 0:r.command;if(typeof e=="string"&&e.trim().length>0)return e.trim()}extractFilePath(n){var t,i,s,r,a,l;let e=(l=(r=(i=(t=n==null?void 0:n.filePath)!=null?t:n==null?void 0:n.path)!=null?i:n==null?void 0:n.targetPath)!=null?r:(s=n==null?void 0:n.file)==null?void 0:s.path)!=null?l:(a=n==null?void 0:n.input)==null?void 0:a.path;if(typeof e=="string"&&e.trim().length>0)return e.trim()}extractItemStatus(n,e){var i,s,r;let t=(r=(i=n==null?void 0:n.status)!=null?i:e==null?void 0:e.status)!=null?r:(s=e==null?void 0:e.result)==null?void 0:s.status;return typeof t=="string"&&t.trim().length>0?t.trim():"completed"}async request(n,e){if(!this.process||this.process.killed)throw new Error("Codex app-server is not running.");let t=String(this.requestCounter++),i=new Promise((s,r)=>{let a=setTimeout(()=>{this.pendingRequests.delete(t),r(new Error(`Request timeout: ${n}`))},6e4);this.pendingRequests.set(t,{resolve:s,reject:r,timeout:a})});return this.writeJson({id:t,method:n,params:e}),await i}notify(n,e){if(e===void 0){this.writeJson({method:n});return}this.writeJson({method:n,params:e})}writeJson(n){if(!this.process||this.process.killed||!this.process.stdin)throw new Error("Codex app-server is not running.");this.process.stdin.write(`${JSON.stringify(n)}
`)}updateThreadId(n){this.currentThreadId=n,this.onThreadIdChanged(n)}clearCurrentTurnId(n){this.currentTurnId===n&&(this.currentTurnId=null)}buildCommandCandidates(n){let e=n.trim(),t=[],i=r=>{let a=r.trim();a&&(t.includes(a)||t.push(a))},s=e.toLowerCase().endsWith(".cmd");return process.platform==="win32"?(i(e),i(s?e.slice(0,-4):`${e}.cmd`),i("codex.cmd"),i("codex")):(s&&i(e.slice(0,-4)),i(e),i("codex"),i("codex.cmd")),t}buildSpawnEnv(){var s;let n=(s=process.env.PATH)!=null?s:"",e=process.platform==="win32"?";":":",t=process.platform==="win32"?["C:\\Program Files\\nodejs","C:\\Users\\admin\\AppData\\Roaming\\npm"]:["/usr/local/bin","/usr/bin","/home/mirror/.local/bin","/home/mirror/.nvm/versions/node/v22.14.0/bin"],i=[...n.split(e).filter(r=>r.trim().length>0)];for(let r of t)i.includes(r)||i.push(r);return{...process.env,PATH:i.join(e)}}selectStartCommand(n,e,t){let i=Math.min(this.reconnectAttempts,Math.max(0,n.length-1)),s=[];for(let a=0;a<n.length;a++){let l=(i+a)%n.length,d=n[l],p=this.probeCommand(d,e,t);if(this.debugLog("start:probe",{candidate:d,ok:p.ok,detail:p.detail}),p.ok)return{command:d,probe:p};s.push(`${d}: ${p.detail}`)}let r=s.join(" | ");throw new Error(`No usable codex command found. ${r}`)}probeCommand(n,e,t){var i;try{let s=(0,oe.spawnSync)(n,["--version"],{cwd:t,env:e,shell:process.platform==="win32",windowsHide:!0,encoding:"utf-8",timeout:5e3});if(s.error)return{ok:!1,detail:`${s.error.name}: ${s.error.message}`};let r=typeof s.stdout=="string"?s.stdout.trim():"",a=typeof s.stderr=="string"?s.stderr.trim():"",l=(r||a).replace(/\s+/g," ").trim();return s.status===0?{ok:!0,detail:l||"ok"}:{ok:!1,detail:`exit=${(i=s.status)!=null?i:"unknown"} ${l||"no output"}`}}catch(s){return{ok:!1,detail:s instanceof Error?s.message:String(s)}}}safeInvoke(n,e){try{n()}catch(t){let i=t instanceof Error?t.message:String(t);this.onSystemMessage(`[callback:${e}] ${i}`),this.debugError("callback failure",t,{label:e,reason:i})}}debugLog(n,e){if(e===void 0){console.log(`[CODEXIDIAN DEBUG] ${n}`);return}console.log(`[CODEXIDIAN DEBUG] ${n} ${this.stringifyDebug(e)}`)}debugError(n,e,t){var a;let i=e instanceof Error?e.message:String(e),s=e instanceof Error&&(a=e.stack)!=null?a:"",r={...t!=null?t:{},message:i,stack:s};console.error(`[CODEXIDIAN DEBUG] ${n} ${this.stringifyDebug(r)}`)}stringifyDebug(n){try{return JSON.stringify(n)}catch(e){return String(n)}}};var w=require("obsidian");var j=[{value:"",label:"Default (Codex)"},{value:"codex-5.3",label:"Codex 5.3"},{value:"gpt-5.2",label:"GPT 5.2"}],K=[{value:"low",label:"Low"},{value:"medium",label:"Medium"},{value:"high",label:"High"},{value:"xhigh",label:"Extra High"}],Z=[{value:"safe",label:"Safe",description:"prompt-free decline"},{value:"prompt",label:"Prompt",description:"ask in transcript"},{value:"yolo",label:"Yolo",description:"auto-approve"}];function Re(S){return Z.some(n=>n.value===S)}var F={locale:"zh",codexCommand:process.platform==="win32"?"codex.cmd":"codex",workingDirectory:"",model:"",thinkingEffort:"medium",skillPreset:"none",approvalMode:"prompt",allowRules:[],approvalPolicy:"on-request",sandboxMode:"workspace-write",autoApproveRequests:!0,persistThread:!0,lastThreadId:"",maxTabs:5,enableContextInjection:!0,enableSelectionPolling:!0,enableReviewPane:!1,enableMcp:!1,mcpEndpoint:"http://127.0.0.1:27124",mcpApiKey:"",mcpContextNoteLimit:3,securityBlockedPaths:[".obsidian/",".claude/",".codex/",".agent/",".env","*.secret"],securityRequireApprovalForWrite:!0,securityMaxNoteSize:500};function Ze(){return`conv-${Date.now()}-${Math.random().toString(36).slice(2,11)}`}function Je(){return`msg-${Date.now()}-${Math.random().toString(36).slice(2,6)}`}function Ge(){return`tab-${Date.now()}-${Math.random().toString(36).slice(2,6)}`}var le=class{constructor(n){this.app=n}async exists(n){return this.app.vault.adapter.exists(n)}async read(n){return this.app.vault.adapter.read(n)}async write(n,e){await this.app.vault.adapter.write(n,e)}async delete(n){await this.exists(n)&&await this.app.vault.adapter.remove(n)}async listFiles(n){return await this.exists(n)?(await this.app.vault.adapter.list(n)).files:[]}async ensureFolder(n){await this.exists(n)||await this.app.vault.adapter.mkdir(n)}};var ke=".codexidian/sessions",de=class{constructor(n){this.adapter=n}async init(){await this.adapter.ensureFolder(".codexidian"),await this.adapter.ensureFolder(ke)}filePath(n){return`${ke}/${n}.jsonl`}async saveConversation(n){let e=this.normalizeTags(n.tags),t={type:"meta",id:n.id,title:n.title,createdAt:n.createdAt,updatedAt:n.updatedAt,lastResponseAt:n.lastResponseAt,threadId:n.threadId,archived:n.archived===!0,pinned:n.pinned===!0,tags:e.length>0?e:void 0},i=[JSON.stringify(t)];for(let s of n.messages)i.push(JSON.stringify({type:"message",message:s}));await this.adapter.write(this.filePath(n.id),i.join(`
`)+`
`)}async loadConversation(n){var f,x,T,h,A,E,P,I;let e=this.filePath(n);if(!await this.adapter.exists(e))return null;let i=(await this.adapter.read(e)).split(`
`).filter(D=>D.trim());if(i.length===0)return null;let s=this.parseJsonRecord(i[0]);if(!s||s.type!=="meta")return null;let r=[];for(let D=1;D<i.length;D++){let L=this.parseJsonRecord(i[D]);(L==null?void 0:L.type)==="message"&&L.message&&r.push(L.message)}let a=((f=this.readString(s.id))==null?void 0:f.trim())||n,l=((x=this.readString(s.title))==null?void 0:x.trim())||a,d=(T=this.readNumber(s.createdAt))!=null?T:Date.now(),p=(h=this.readNumber(s.updatedAt))!=null?h:d,c=(A=this.readNumber(s.lastResponseAt))!=null?A:void 0,u=((E=this.readString(s.threadId))==null?void 0:E.trim())||void 0,g=(P=this.readBoolean(s.archived))!=null?P:!1,v=(I=this.readBoolean(s.pinned))!=null?I:!1,m=this.normalizeTags(s.tags);return{id:a,title:l,createdAt:d,updatedAt:p,lastResponseAt:c,threadId:u,archived:g,pinned:v,tags:m,messages:r}}async updateMeta(n,e){var l;let t=this.filePath(n);if(!await this.adapter.exists(t))return null;let s=(await this.adapter.read(t)).split(`
`).filter(d=>d.trim().length>0);if(s.length===0)return null;let r=this.parseJsonRecord(s[0]);if(!r||r.type!=="meta")return null;if(e.archived!==void 0&&(r.archived=!!e.archived),e.pinned!==void 0&&(r.pinned=!!e.pinned),e.tags!==void 0){let d=this.normalizeTags(e.tags);d.length>0?r.tags=d:delete r.tags}r.updatedAt=Date.now(),s[0]=JSON.stringify(r),await this.adapter.write(t,`${s.join(`
`)}
`);let a=this.parseMetaFromRaw(t,s.join(`
`),!1);return(l=a==null?void 0:a.meta)!=null?l:null}async deleteConversation(n){await this.adapter.delete(this.filePath(n))}async listConversations(n="all"){let e=await this.collectMetas(!1);return this.filterAndSortMetas(e.map(t=>t.meta),n)}async searchConversations(n,e="all"){let t=n.trim().toLowerCase();if(!t)return this.listConversations(e);let s=(await this.collectMetas(!0)).filter(r=>{var p;let a=r.meta.title.toLowerCase().includes(t),l=r.meta.preview.toLowerCase().includes(t),d=((p=r.searchTextLower)!=null?p:"").includes(t);return a||l||d}).map(r=>r.meta);return this.filterAndSortMetas(s,e)}async collectMetas(n){let e=await this.adapter.listFiles(ke),t=[];for(let i of e)if(i.endsWith(".jsonl"))try{let s=await this.adapter.read(i),r=this.parseMetaFromRaw(i,s,n);r&&t.push(r)}catch(s){}return t}parseMetaFromRaw(n,e,t){var A,E,P,I,D,L,O,se,U,X;let i=e.split(`
`).filter(z=>z.trim().length>0);if(i.length===0)return null;let s=this.parseJsonRecord(i[0]);if(!s||s.type!=="meta")return null;let r=((A=n.split("/").pop())==null?void 0:A.replace(/\.jsonl$/,""))||n,a=((E=this.readString(s.id))==null?void 0:E.trim())||r,l=((P=this.readString(s.title))==null?void 0:P.trim())||a,d=(I=this.readNumber(s.createdAt))!=null?I:Date.now(),p=(D=this.readNumber(s.updatedAt))!=null?D:d,c=(L=this.readNumber(s.lastResponseAt))!=null?L:void 0,u=((O=this.readString(s.threadId))==null?void 0:O.trim())||void 0,g=(se=this.readBoolean(s.archived))!=null?se:!1,v=(U=this.readBoolean(s.pinned))!=null?U:!1,m=this.normalizeTags(s.tags),f=0,x="",T=[];for(let z=1;z<i.length;z++){let _=this.parseJsonRecord(i[z]);if(!_||_.type!=="message"||!_.message)continue;f++;let W=(X=this.readString(_.message.content))!=null?X:"";W&&(x=W.slice(0,80),t&&T.push(W))}let h={id:a,title:l,createdAt:d,updatedAt:p,lastResponseAt:c,threadId:u,archived:g,pinned:v,tags:m,messageCount:f,preview:x};return t?{meta:h,searchTextLower:T.join(`
`).toLowerCase()}:{meta:h}}filterAndSortMetas(n,e){return n.filter(i=>e==="active"?!i.archived:e==="archived"?i.archived===!0:e==="pinned"?i.pinned===!0:!0).sort((i,s)=>{var a,l;let r=+!!s.pinned-+!!i.pinned;return r!==0?r:((a=s.updatedAt)!=null?a:0)-((l=i.updatedAt)!=null?l:0)})}parseJsonRecord(n){try{let e=JSON.parse(n);return!e||typeof e!="object"?null:e}catch(e){return null}}readString(n){return typeof n=="string"?n:null}readNumber(n){return typeof n=="number"&&Number.isFinite(n)?n:null}readBoolean(n){return typeof n=="boolean"?n:null}normalizeTags(n){if(!Array.isArray(n))return[];let e=new Set;for(let t of n){if(typeof t!="string")continue;let i=t.trim();i&&e.add(i)}return Array.from(e)}};var et=require("obsidian");var ct={appTitle:"Codexidian",localeNameEn:"English",localeNameZh:"Chinese",connected:"Connected",disconnected:"Disconnected",history:"History",newThread:"New Conversation",restart:"Restart",reconnect:"Reconnect",model:"Model",effort:"Thinking",skill:"Skill",mode:"Mode",send:"Send",attachImage:"Attach images",dropImagesHere:"Drop images here",sendShortcutHint:"Enter to send",askPlaceholder:"Ask Codex about this vault...",open:"Open",del:"Del",cancel:"Cancel",saveAndResend:"Save & Resend",submit:"Submit",approve:"Approve",deny:"Deny",alwaysAllow:"Always Allow",clear:"Clear",apply:"Apply",copy:"Copy",copied:"Copied!",output:"Output",toolTitle:"Tool",text:"text",streaming:"streaming",openCodexidianCommand:"Open Codexidian",startNewThreadCommand:"Codexidian: Start New Thread",cmdNewLabel:"New Chat",cmdNewDesc:"Start a new conversation tab.",cmdClearLabel:"Clear Chat",cmdClearDesc:"Clear messages in the current conversation.",cmdModelLabel:"Cycle Model",cmdModelDesc:"Switch to the next configured model.",cmdEffortLabel:"Cycle Effort",cmdEffortDesc:"Cycle thinking effort (low \u2192 medium \u2192 high \u2192 xhigh).",cmdHistoryLabel:"Open Sessions",cmdHistoryDesc:"Open the session manager modal.",cmdTabsLabel:"Show Tabs",cmdTabsDesc:"Show a summary of current tabs.",cmdHelpLabel:"Show Help",cmdHelpDesc:"List all available slash commands.",noticeStorageInitFailed:"Codexidian: storage initialization failed ({error}). Continuing without persistence.",noticeFileContextInitFailed:"Codexidian: failed to initialize file mention context ({error})",noticeImageContextInitFailed:"Codexidian: failed to initialize image paste context ({error})",noticeAttachmentLimitReached:"You can attach up to {max} images per turn.",noticeImageOnlyAttachments:"Only image files can be attached.",noticeImageReadFailed:"Failed to read one or more image attachments.",noticePersistTabStateFailed:"Codexidian: failed to persist tab state ({error})",noticeNoActiveTabToClear:"No active tab to clear.",noticeClearedConversation:"Cleared current conversation messages.",noticeCannotCreateTabMax:"Cannot create new tab: max tabs ({max}) reached.",noticeModelSet:"Model set to {model}",noticeEffortSet:"Thinking effort set to {effort}",noticeSkillSet:"Skill set to {skill}",noticeCollaborationModeSet:"Mode set to {mode}",noticeAllowRuleAdded:"Added allow rule: {type} ({pattern})",noticeAllowRuleExists:"Allow rule already exists: {type} ({pattern})",noticeAllowRuleAddFailed:"Failed to add allow rule: {error}",noticeAllowRuleRemoved:"Removed allow rule.",noticeAllowRuleRemoveFailed:"Failed to remove allow rule: {error}",noticeAllowRulesCleared:"Cleared all allow rules.",noticeAllowRulesClearFailed:"Failed to clear allow rules: {error}",messageNoTabsOpen:"No tabs are currently open.",messageTabsSummary:"Tabs {count}/{max}: {summary}",messageNoSlashCommands:"No slash commands are registered.",messageAvailableSlashCommands:"Available slash commands: {list}",messageQueuedCount:"{count} message queued",messageQueuedCountPlural:"{count} messages queued",messageCancelledByUser:"(Cancelled by user)",messageCancelRequestFailed:"Cancel request failed: {error}",noticeProcessQueueFailed:"Codexidian: failed to process queue ({error})",messageQueuedSendFailed:"Queued message failed: {error}",messageFailedInitConversation:"Failed to initialize conversation: {error}",messageReadyHint:"Ready. Click Send to start Codex in this pane.",messageMcpContextAttached:"MCP context attached: {paths}",imageAttached:"(Image attached: {name})",messageImageUploadUnsupported:"Image upload is not supported by this Codex app-server version.",messageNoAssistantOutput:"(No assistant output)",messageTurnFinishedStatus:"Turn finished with status {status}{suffix}",messageRequestFailed:"Request failed: {error}",noticeCodexError:"Codexidian: {error}",noticeImageUploadUnsupported:"Codexidian: image upload is unsupported by the current app-server.",messageAutoApprovedByRule:"Auto-approved by allow rule: {summary} [{pattern}]",messageStartedNewThread:"Started new thread: {threadId}",messageFailedStartNewThread:"Failed to start new thread: {error}",messageRestarted:"Codex app-server restarted.",messageRestartFailed:"Restart failed: {error}",historyEmpty:"No conversations yet",historyMessageCount:"{count} messages",sessionModalTitle:"Sessions",sessionSearchPlaceholder:"Search sessions by title or content...",sessionFilterAll:"All",sessionFilterActive:"Active",sessionFilterArchived:"Archived",sessionFilterPinned:"Pinned",sessionOpen:"Open",sessionFork:"Fork",sessionPin:"Pin",sessionUnpin:"Unpin",sessionArchive:"Archive",sessionUnarchive:"Unarchive",sessionDelete:"Delete",sessionEmpty:"No sessions found.",sessionArchivedBadge:"Archived",sessionMetaLine:"{date} \xB7 {count} messages",sessionDeleteConfirm:"Delete session '{title}'?",sessionActionFailed:"Session action failed: {error}",sessionLoadFailed:"Failed to load sessions: {error}",sessionForkPrefix:"Fork",noticeFailedLoadConversation:"Failed to load conversation",noticeRestoreTabsFailed:"Codexidian: failed to restore tabs ({error}), creating a fresh tab.",editMessageTitle:"Edit and resend this message",rewindTitle:"Rewind to this message",forkTitle:"Fork from this message",noticeCannotEditRunning:"Cannot edit while a turn is running.",noticeCannotEditNotFound:"Cannot edit: user message not found.",noticeEditedMessageEmpty:"Edited message cannot be empty.",confirmSaveEditResend:"Save edit and resend from this point? This will remove later messages.",noticeEditMessageNotFound:"Unable to edit: message not found in conversation.",messageEditedStartedFreshThread:"Edited message. Started a fresh thread.",messageEditedSaveButThreadFail:"Edited message saved, but failed to start a fresh thread: {error}",noticeEditFailed:"Edit failed: {error}",noticeNoCodeToApply:"No code content to apply.",promptTargetNotePath:"Target note path",noticeTargetPathRequired:"Target note path is required.",securityBlocked:"Blocked by security policy: {reason}",securityBlockedReasonDefault:"Path matches blocklist.",replaceSelection:"Replace Selection",appendToNote:"Append to Note",confirmApplyCode:"Apply code to '{path}' using '{mode}'?",noticeAppliedCode:"Applied code to {path} ({mode}).",noticeApplyCodeFailed:"Failed to apply code: {error}",confirmApplyModeFallback:`Apply mode:
OK = Replace Selection
Cancel = Append to Note`,applyModeCancel:"Cancel",errorNoActiveEditor:"No active markdown editor found.",errorReplaceSelectionRequiresTarget:"Replace Selection requires the target note to be open and active.",errorNoSelectionToReplace:"No selected text to replace.",errorMaxSizeExceeded:"Resulting note exceeds max size ({kb} KB).",errorTargetPathNotFile:"Target path is not a file: {path}",noticeCannotRewindRunning:"Cannot rewind while a turn is running.",confirmRewind:"Rewind to this message? Messages after it will be removed.",noticeUnableRewind:"Unable to rewind: message not found.",messageRewindComplete:"Rewind complete. Started a fresh thread.",messageRewindThreadFail:"Rewind succeeded, but failed to start new thread: {error}",noticeRewindFailed:"Rewind failed: {error}",noticeCannotForkRunning:"Cannot fork while a turn is running.",noticeCannotForkMax:"Cannot fork: max tabs ({max}) reached.",noticeUnableFork:"Unable to fork: message not found.",messageForkCreated:"Fork created with a fresh thread.",messageForkThreadFail:"Fork created, but failed to start new thread: {error}",noticeForkFailed:"Fork failed: {error}",messageContextFileNotFound:"Context file not found: {path}",messageContextFileReadFailed:"Failed to read context file {path}: {error}",noteToggleOn:"Include note: on",noteToggleOff:"Include note: off",selectionPreview:"{path} ({count} {lineLabel}): {preview}...",lineSingular:"line",linePlural:"lines",approvalTitleCommand:"Command Execution Request",approvalTitleFile:"File Change Request",approvalTitleGeneric:"Approval Request",approvalMetaFile:"File: {path}",approvalMetaCwd:"cwd: {cwd}",approvalTimedOut:"Timed out (auto-denied)",approvalDecisionPrefix:"Decision: {status}",approvalApproved:"Approved",approvalDenied:"Denied",approvalAlwaysAllowed:"Approved (always)",userInputRequest:"User Input Request",userInputPlaceholder:"Or type a custom answer",userInputTimedOutDefault:"Timed out. Used default answers.",userInputSubmitted:"Submitted",statusUserInputRequest:"User input request",running:"Running",idle:"Idle",thread:"thread",noThread:"no thread",defaultModel:"default",statusThinking:"Thinking...",statusStreaming:"Streaming response...",statusWaitingApproval:"Waiting for approval...",statusRunningTool:"Running tool...",statusRunningGeneric:"Running...",statusTypeTool:"TOOL",reasoning:"Reasoning",toolOutput:"Tool output",toolStatusPrefix:"Tool",statusTypeThinking:"THINK",statusTypeAgent:"AGENT",statusTypeInfo:"INFO",statusRunningShort:"running",statusFailedShort:"failed",statusDoneShort:"done",reviewTitle:"Review",reviewDiffsTitle:"Last turn file changes",reviewCommentsTitle:"Queued comments",reviewCommentsEmpty:"No review comments queued.",reviewScopePlaceholder:"Scope (file path or section)",reviewCommentPlaceholder:"Add review comment for next turn",reviewAddComment:"Add",reviewCommentRemove:"Remove",reviewStatusAdded:"added",reviewStatusModified:"modified",reviewStatusDeleted:"deleted",reviewPromptHeader:"Review Comments",planTitle:"Plan",planStatusProposed:"Proposed",planStatusApproved:"Approved",planStatusInProgress:"In Progress",planStatusCompleted:"Completed",planApproveAll:"Approve All",planGiveFeedback:"Give Feedback",planExecuteNext:"Execute Next",planFeedbackPrompt:"Plan feedback",planApprovedProceedMessage:"Approved. Please proceed with the plan.",planFeedbackMessagePrefix:"Plan feedback",planExecuteStepMessage:"Please execute step {index}: {description}",settingsTitle:"Codexidian Settings",settingLanguageName:"Language",settingLanguageDesc:"Choose UI language for Codexidian.",settingCodexCommandName:"Codex command",settingCodexCommandDesc:"CLI command used to launch app-server. Windows default: codex.cmd",settingWorkingDirName:"Working directory",settingWorkingDirDesc:"Root directory Codex uses for this plugin session.",settingModelName:"Model",settingModelDesc:"Select the AI model for Codex sessions.",settingEffortName:"Thinking effort",settingEffortDesc:"Control how deeply Codex thinks before responding.",settingSkillPresetName:"Skill",settingSkillPresetDesc:"Default skill for the next turn (loaded from .codex/skills).",settingCollaborationModeName:"Mode",settingCollaborationModeDesc:"Approval mode for requests: Safe, Prompt, or Yolo.",skillPresetNone:"None",skillPresetCodeReview:"Code Review",skillPresetExplain:"Explain",skillPresetRefactor:"Refactor",skillPresetDebug:"Debug",skillPresetTest:"Test",collaborationModeAutonomous:"Autonomous",collaborationModeInteractive:"Interactive",collaborationModePlanFirst:"Plan First",settingsAllowRulesSection:"Approval Allow Rules",settingsAllowRulesDesc:"Automatically approve matching requests without showing the approval card.",allowRulesEmpty:"No allow rules configured.",allowRuleDelete:"Delete",allowRulesClearAll:"Clear All",confirmAllowRulesClearAll:"Clear all allow rules?",allowRuleTypeCommand:"Command",allowRuleTypeFileWrite:"File Write",allowRuleTypeTool:"Tool",settingApprovalPolicyName:"Approval policy",settingApprovalPolicyDesc:"Codex ask-for-approval mode for new or resumed threads.",settingSandboxName:"Sandbox mode",settingSandboxDesc:"Sandbox mode for newly started or resumed threads.",settingAutoApproveName:"Auto-approve app-server requests",settingAutoApproveDesc:"If enabled, command/file approval callbacks are answered automatically.",settingPersistThreadName:"Persist thread across restarts",settingPersistThreadDesc:"Reuse the last thread id when possible.",settingSavedThreadName:"Saved thread",settingSavedThreadEmpty:"(none)",settingSavedThreadClear:"Clear",noticeSavedThreadCleared:"Codexidian saved thread cleared.",settingsUiSection:"UI Settings",settingMaxTabsName:"Max tabs",settingMaxTabsDesc:"Maximum number of open tabs (1-5).",settingContextInjectionName:"Context injection",settingContextInjectionDesc:"Inject current note path and editor selection into prompts.",settingSelectionPollingName:"Selection polling",settingSelectionPollingDesc:"Poll editor selection to show context indicator.",settingEnableReviewPaneName:"Enable review pane",settingEnableReviewPaneDesc:"Show the review pane (diff + queued comments) between messages and input.",settingsMcpSection:"MCP Integration",settingEnableMcpName:"Enable MCP vault tools",settingEnableMcpDesc:"Allow app-server tool calls to read/write/search/list notes through Obsidian vault APIs.",settingMcpEndpointName:"MCP endpoint (optional)",settingMcpEndpointDesc:"Optional endpoint metadata for external MCP/REST bridge setups.",settingMcpApiKeyName:"MCP API key (optional)",settingMcpApiKeyDesc:"Optional key for external MCP/REST bridge usage.",settingMcpContextLimitName:"Auto MCP context notes",settingMcpContextLimitDesc:"Automatically attach top related notes to each prompt when MCP is enabled (0 to disable).",settingsSecuritySection:"Security Controls",settingBlockedPathsName:"Blocked paths",settingBlockedPathsDesc:"One path pattern per line. Block read/write to sensitive files and folders.",settingRequireApprovalWriteName:"Require approval for write",settingRequireApprovalWriteDesc:"Require explicit approval before write operations (MCP write_note and Apply to Note).",settingMaxNoteSizeName:"Max note size (KB)",settingMaxNoteSizeDesc:"Maximum resulting note size allowed for write operations.",noticeNewThreadCreated:"Codexidian new thread: {threadId}...",mcpDisabledMessage:"MCP is disabled in Codexidian settings.",mcpToolExecutionFailed:"MCP tool execution failed: {error}"},ut={appTitle:"Codexidian",localeNameEn:"\u82F1\u6587",localeNameZh:"\u4E2D\u6587",connected:"\u5DF2\u8FDE\u63A5",disconnected:"\u672A\u8FDE\u63A5",history:"History",newThread:"New Conversation",restart:"Restart",reconnect:"Reconnect",model:"Model",effort:"Thinking",skill:"Skill",mode:"Mode",send:"Send",attachImage:"Attach images",dropImagesHere:"Drop images here",sendShortcutHint:"Enter to send",askPlaceholder:"Ask Codex about this vault...",open:"\u6253\u5F00",del:"\u5220",cancel:"\u53D6\u6D88",saveAndResend:"\u4FDD\u5B58\u5E76\u91CD\u53D1",submit:"\u63D0\u4EA4",approve:"\u6279\u51C6",deny:"\u62D2\u7EDD",alwaysAllow:"\u59CB\u7EC8\u5141\u8BB8",clear:"\u6E05\u9664",apply:"\u5E94\u7528",copy:"\u590D\u5236",copied:"\u5DF2\u590D\u5236",output:"\u8F93\u51FA",toolTitle:"\u5DE5\u5177",text:"\u6587\u672C",streaming:"\u6D41\u5F0F\u4E2D",openCodexidianCommand:"\u6253\u5F00 Codexidian",startNewThreadCommand:"Codexidian\uFF1A\u65B0\u5EFA\u7EBF\u7A0B",cmdNewLabel:"\u65B0\u5EFA\u4F1A\u8BDD",cmdNewDesc:"\u65B0\u5EFA\u4E00\u4E2A\u4F1A\u8BDD\u6807\u7B7E\u9875\u3002",cmdClearLabel:"\u6E05\u7A7A\u4F1A\u8BDD",cmdClearDesc:"\u6E05\u7A7A\u5F53\u524D\u4F1A\u8BDD\u6D88\u606F\u3002",cmdModelLabel:"\u5207\u6362\u6A21\u578B",cmdModelDesc:"\u5207\u6362\u5230\u4E0B\u4E00\u4E2A\u6A21\u578B\u3002",cmdEffortLabel:"\u5207\u6362\u601D\u8003\u5F3A\u5EA6",cmdEffortDesc:"\u5FAA\u73AF\u5207\u6362\u601D\u8003\u5F3A\u5EA6\uFF08low \u2192 medium \u2192 high \u2192 xhigh\uFF09\u3002",cmdHistoryLabel:"\u4F1A\u8BDD\u7BA1\u7406",cmdHistoryDesc:"\u6253\u5F00\u4F1A\u8BDD\u7BA1\u7406\u5F39\u7A97\u3002",cmdTabsLabel:"\u663E\u793A\u6807\u7B7E\u6982\u89C8",cmdTabsDesc:"\u663E\u793A\u5F53\u524D\u6807\u7B7E\u9875\u6458\u8981\u3002",cmdHelpLabel:"\u663E\u793A\u547D\u4EE4\u5E2E\u52A9",cmdHelpDesc:"\u5217\u51FA\u6240\u6709\u659C\u6760\u547D\u4EE4\u3002",noticeStorageInitFailed:"Codexidian\uFF1A\u5B58\u50A8\u521D\u59CB\u5316\u5931\u8D25\uFF08{error}\uFF09\uFF0C\u5C06\u4EE5\u65E0\u6301\u4E45\u5316\u6A21\u5F0F\u7EE7\u7EED\u3002",noticeFileContextInitFailed:"Codexidian\uFF1A\u6587\u4EF6\u63D0\u53CA\u4E0A\u4E0B\u6587\u521D\u59CB\u5316\u5931\u8D25\uFF08{error}\uFF09",noticeImageContextInitFailed:"Codexidian\uFF1A\u56FE\u7247\u7C98\u8D34\u4E0A\u4E0B\u6587\u521D\u59CB\u5316\u5931\u8D25\uFF08{error}\uFF09",noticeAttachmentLimitReached:"\u6BCF\u8F6E\u6700\u591A\u53EF\u9644\u52A0 {max} \u5F20\u56FE\u7247\u3002",noticeImageOnlyAttachments:"\u4EC5\u652F\u6301\u9644\u52A0\u56FE\u7247\u6587\u4EF6\u3002",noticeImageReadFailed:"\u8BFB\u53D6\u56FE\u7247\u9644\u4EF6\u5931\u8D25\u3002",noticePersistTabStateFailed:"Codexidian\uFF1A\u6807\u7B7E\u72B6\u6001\u6301\u4E45\u5316\u5931\u8D25\uFF08{error}\uFF09",noticeNoActiveTabToClear:"\u5F53\u524D\u6CA1\u6709\u53EF\u6E05\u7A7A\u7684\u6807\u7B7E\u9875\u3002",noticeClearedConversation:"\u5DF2\u6E05\u7A7A\u5F53\u524D\u4F1A\u8BDD\u6D88\u606F\u3002",noticeCannotCreateTabMax:"\u65E0\u6CD5\u65B0\u5EFA\u6807\u7B7E\u9875\uFF1A\u5DF2\u8FBE\u5230\u4E0A\u9650\uFF08{max}\uFF09\u3002",noticeModelSet:"\u6A21\u578B\u5DF2\u5207\u6362\u4E3A {model}",noticeEffortSet:"\u601D\u8003\u5F3A\u5EA6\u5DF2\u5207\u6362\u4E3A {effort}",noticeSkillSet:"\u6280\u80FD\u5DF2\u5207\u6362\u4E3A {skill}",noticeCollaborationModeSet:"\u534F\u4F5C\u6A21\u5F0F\u5DF2\u5207\u6362\u4E3A {mode}",noticeAllowRuleAdded:"\u5DF2\u6DFB\u52A0\u5141\u8BB8\u89C4\u5219\uFF1A{type}\uFF08{pattern}\uFF09",noticeAllowRuleExists:"\u5141\u8BB8\u89C4\u5219\u5DF2\u5B58\u5728\uFF1A{type}\uFF08{pattern}\uFF09",noticeAllowRuleAddFailed:"\u6DFB\u52A0\u5141\u8BB8\u89C4\u5219\u5931\u8D25\uFF1A{error}",noticeAllowRuleRemoved:"\u5DF2\u5220\u9664\u5141\u8BB8\u89C4\u5219\u3002",noticeAllowRuleRemoveFailed:"\u5220\u9664\u5141\u8BB8\u89C4\u5219\u5931\u8D25\uFF1A{error}",noticeAllowRulesCleared:"\u5DF2\u6E05\u7A7A\u6240\u6709\u5141\u8BB8\u89C4\u5219\u3002",noticeAllowRulesClearFailed:"\u6E05\u7A7A\u5141\u8BB8\u89C4\u5219\u5931\u8D25\uFF1A{error}",messageNoTabsOpen:"\u5F53\u524D\u6CA1\u6709\u6253\u5F00\u7684\u6807\u7B7E\u9875\u3002",messageTabsSummary:"\u6807\u7B7E\u9875 {count}/{max}\uFF1A{summary}",messageNoSlashCommands:"\u5F53\u524D\u672A\u6CE8\u518C\u659C\u6760\u547D\u4EE4\u3002",messageAvailableSlashCommands:"\u53EF\u7528\u659C\u6760\u547D\u4EE4\uFF1A{list}",messageQueuedCount:"\u5DF2\u6392\u961F {count} \u6761\u6D88\u606F",messageQueuedCountPlural:"\u5DF2\u6392\u961F {count} \u6761\u6D88\u606F",messageCancelledByUser:"\uFF08\u5DF2\u7531\u7528\u6237\u53D6\u6D88\uFF09",messageCancelRequestFailed:"\u53D6\u6D88\u8BF7\u6C42\u5931\u8D25\uFF1A{error}",noticeProcessQueueFailed:"Codexidian\uFF1A\u5904\u7406\u961F\u5217\u5931\u8D25\uFF08{error}\uFF09",messageQueuedSendFailed:"\u961F\u5217\u6D88\u606F\u53D1\u9001\u5931\u8D25\uFF1A{error}",messageFailedInitConversation:"\u521D\u59CB\u5316\u4F1A\u8BDD\u5931\u8D25\uFF1A{error}",messageReadyHint:"\u5DF2\u5C31\u7EEA\u3002\u70B9\u51FB\u53D1\u9001\u5373\u53EF\u5F00\u59CB\u5728\u6B64\u9762\u677F\u4F7F\u7528 Codex\u3002",messageMcpContextAttached:"\u5DF2\u9644\u52A0 MCP \u4E0A\u4E0B\u6587\uFF1A{paths}",imageAttached:"\uFF08\u5DF2\u9644\u52A0\u56FE\u7247\uFF1A{name}\uFF09",messageImageUploadUnsupported:"\u5F53\u524D Codex app-server \u7248\u672C\u4E0D\u652F\u6301\u56FE\u7247\u4E0A\u4F20\u3002",messageNoAssistantOutput:"\uFF08\u65E0\u52A9\u624B\u8F93\u51FA\uFF09",messageTurnFinishedStatus:"\u672C\u8F6E\u72B6\u6001\uFF1A{status}{suffix}",messageRequestFailed:"\u8BF7\u6C42\u5931\u8D25\uFF1A{error}",noticeCodexError:"Codexidian\uFF1A{error}",noticeImageUploadUnsupported:"Codexidian\uFF1A\u5F53\u524D app-server \u4E0D\u652F\u6301\u56FE\u7247\u4E0A\u4F20\u3002",messageAutoApprovedByRule:"\u547D\u4E2D\u5141\u8BB8\u89C4\u5219\u81EA\u52A8\u6279\u51C6\uFF1A{summary} [{pattern}]",messageStartedNewThread:"\u5DF2\u521B\u5EFA\u65B0\u7EBF\u7A0B\uFF1A{threadId}",messageFailedStartNewThread:"\u521B\u5EFA\u65B0\u7EBF\u7A0B\u5931\u8D25\uFF1A{error}",messageRestarted:"Codex app-server \u5DF2\u91CD\u542F\u3002",messageRestartFailed:"\u91CD\u542F\u5931\u8D25\uFF1A{error}",historyEmpty:"\u6682\u65E0\u4F1A\u8BDD\u8BB0\u5F55",historyMessageCount:"{count} \u6761\u6D88\u606F",sessionModalTitle:"\u4F1A\u8BDD\u7BA1\u7406",sessionSearchPlaceholder:"\u641C\u7D22\u4F1A\u8BDD\u6807\u9898\u6216\u5185\u5BB9...",sessionFilterAll:"\u5168\u90E8",sessionFilterActive:"\u8FDB\u884C\u4E2D",sessionFilterArchived:"\u5DF2\u5F52\u6863",sessionFilterPinned:"\u7F6E\u9876",sessionOpen:"\u6253\u5F00",sessionFork:"\u5206\u53C9",sessionPin:"\u7F6E\u9876",sessionUnpin:"\u53D6\u6D88\u7F6E\u9876",sessionArchive:"\u5F52\u6863",sessionUnarchive:"\u53D6\u6D88\u5F52\u6863",sessionDelete:"\u5220\u9664",sessionEmpty:"\u672A\u627E\u5230\u4F1A\u8BDD\u3002",sessionArchivedBadge:"\u5DF2\u5F52\u6863",sessionMetaLine:"{date} \xB7 {count} \u6761\u6D88\u606F",sessionDeleteConfirm:"\u786E\u5B9A\u5220\u9664\u4F1A\u8BDD\u300C{title}\u300D\uFF1F",sessionActionFailed:"\u4F1A\u8BDD\u64CD\u4F5C\u5931\u8D25\uFF1A{error}",sessionLoadFailed:"\u52A0\u8F7D\u4F1A\u8BDD\u5931\u8D25\uFF1A{error}",sessionForkPrefix:"\u5206\u53C9",noticeFailedLoadConversation:"\u52A0\u8F7D\u4F1A\u8BDD\u5931\u8D25",noticeRestoreTabsFailed:"Codexidian\uFF1A\u6062\u590D\u6807\u7B7E\u5931\u8D25\uFF08{error}\uFF09\uFF0C\u5DF2\u521B\u5EFA\u65B0\u6807\u7B7E\u3002",editMessageTitle:"\u7F16\u8F91\u5E76\u91CD\u53D1\u8FD9\u6761\u6D88\u606F",rewindTitle:"\u56DE\u9000\u5230\u6B64\u6D88\u606F",forkTitle:"\u4ECE\u6B64\u6D88\u606F\u5206\u53C9",noticeCannotEditRunning:"\u8FD0\u884C\u4E2D\u65E0\u6CD5\u7F16\u8F91\u6D88\u606F\u3002",noticeCannotEditNotFound:"\u65E0\u6CD5\u7F16\u8F91\uFF1A\u672A\u627E\u5230\u7528\u6237\u6D88\u606F\u3002",noticeEditedMessageEmpty:"\u7F16\u8F91\u540E\u7684\u6D88\u606F\u4E0D\u80FD\u4E3A\u7A7A\u3002",confirmSaveEditResend:"\u786E\u5B9A\u4FDD\u5B58\u7F16\u8F91\u5E76\u4ECE\u6B64\u5904\u91CD\u65B0\u53D1\u9001\uFF1F\u540E\u7EED\u6D88\u606F\u5C06\u88AB\u79FB\u9664\u3002",noticeEditMessageNotFound:"\u65E0\u6CD5\u7F16\u8F91\uFF1A\u4F1A\u8BDD\u4E2D\u672A\u627E\u5230\u8BE5\u6D88\u606F\u3002",messageEditedStartedFreshThread:"\u7F16\u8F91\u5B8C\u6210\uFF0C\u5DF2\u542F\u52A8\u65B0\u7EBF\u7A0B\u3002",messageEditedSaveButThreadFail:"\u7F16\u8F91\u5DF2\u4FDD\u5B58\uFF0C\u4F46\u542F\u52A8\u65B0\u7EBF\u7A0B\u5931\u8D25\uFF1A{error}",noticeEditFailed:"\u7F16\u8F91\u5931\u8D25\uFF1A{error}",noticeNoCodeToApply:"\u6CA1\u6709\u53EF\u5E94\u7528\u7684\u4EE3\u7801\u5185\u5BB9\u3002",promptTargetNotePath:"\u76EE\u6807\u7B14\u8BB0\u8DEF\u5F84",noticeTargetPathRequired:"\u76EE\u6807\u7B14\u8BB0\u8DEF\u5F84\u4E0D\u80FD\u4E3A\u7A7A\u3002",securityBlocked:"\u88AB\u5B89\u5168\u7B56\u7565\u62E6\u622A\uFF1A{reason}",securityBlockedReasonDefault:"\u8DEF\u5F84\u547D\u4E2D\u7981\u6B62\u89C4\u5219\u3002",replaceSelection:"\u66FF\u6362\u9009\u533A",appendToNote:"\u8FFD\u52A0\u5230\u7B14\u8BB0\u672B\u5C3E",confirmApplyCode:"\u786E\u5B9A\u4EE5\u201C{mode}\u201D\u65B9\u5F0F\u5C06\u4EE3\u7801\u5E94\u7528\u5230\u201C{path}\u201D\uFF1F",noticeAppliedCode:"\u5DF2\u5C06\u4EE3\u7801\u5E94\u7528\u5230 {path}\uFF08{mode}\uFF09\u3002",noticeApplyCodeFailed:"\u5E94\u7528\u4EE3\u7801\u5931\u8D25\uFF1A{error}",confirmApplyModeFallback:`\u5E94\u7528\u6A21\u5F0F\uFF1A
\u786E\u5B9A = \u66FF\u6362\u9009\u533A
\u53D6\u6D88 = \u8FFD\u52A0\u5230\u7B14\u8BB0`,applyModeCancel:"\u53D6\u6D88",errorNoActiveEditor:"\u672A\u627E\u5230\u6D3B\u52A8\u7684 Markdown \u7F16\u8F91\u5668\u3002",errorReplaceSelectionRequiresTarget:"\u201C\u66FF\u6362\u9009\u533A\u201D\u8981\u6C42\u76EE\u6807\u7B14\u8BB0\u6B63\u5904\u4E8E\u6253\u5F00\u4E14\u6FC0\u6D3B\u72B6\u6001\u3002",errorNoSelectionToReplace:"\u6CA1\u6709\u53EF\u66FF\u6362\u7684\u9009\u4E2D\u6587\u672C\u3002",errorMaxSizeExceeded:"\u7ED3\u679C\u7B14\u8BB0\u8D85\u51FA\u5927\u5C0F\u9650\u5236\uFF08{kb} KB\uFF09\u3002",errorTargetPathNotFile:"\u76EE\u6807\u8DEF\u5F84\u4E0D\u662F\u6587\u4EF6\uFF1A{path}",noticeCannotRewindRunning:"\u8FD0\u884C\u4E2D\u65E0\u6CD5\u56DE\u9000\u3002",confirmRewind:"\u786E\u5B9A\u56DE\u9000\u5230\u8BE5\u6D88\u606F\uFF1F\u5176\u540E\u7684\u6D88\u606F\u5C06\u88AB\u79FB\u9664\u3002",noticeUnableRewind:"\u65E0\u6CD5\u56DE\u9000\uFF1A\u672A\u627E\u5230\u8BE5\u6D88\u606F\u3002",messageRewindComplete:"\u56DE\u9000\u5B8C\u6210\uFF0C\u5DF2\u542F\u52A8\u65B0\u7EBF\u7A0B\u3002",messageRewindThreadFail:"\u56DE\u9000\u5DF2\u5B8C\u6210\uFF0C\u4F46\u542F\u52A8\u65B0\u7EBF\u7A0B\u5931\u8D25\uFF1A{error}",noticeRewindFailed:"\u56DE\u9000\u5931\u8D25\uFF1A{error}",noticeCannotForkRunning:"\u8FD0\u884C\u4E2D\u65E0\u6CD5\u5206\u53C9\u3002",noticeCannotForkMax:"\u65E0\u6CD5\u5206\u53C9\uFF1A\u5DF2\u8FBE\u5230\u6807\u7B7E\u9875\u4E0A\u9650\uFF08{max}\uFF09\u3002",noticeUnableFork:"\u65E0\u6CD5\u5206\u53C9\uFF1A\u672A\u627E\u5230\u8BE5\u6D88\u606F\u3002",messageForkCreated:"\u5DF2\u521B\u5EFA\u5206\u53C9\uFF0C\u5E76\u542F\u52A8\u65B0\u7EBF\u7A0B\u3002",messageForkThreadFail:"\u5206\u53C9\u5DF2\u521B\u5EFA\uFF0C\u4F46\u542F\u52A8\u65B0\u7EBF\u7A0B\u5931\u8D25\uFF1A{error}",noticeForkFailed:"\u5206\u53C9\u5931\u8D25\uFF1A{error}",messageContextFileNotFound:"\u4E0A\u4E0B\u6587\u6587\u4EF6\u4E0D\u5B58\u5728\uFF1A{path}",messageContextFileReadFailed:"\u8BFB\u53D6\u4E0A\u4E0B\u6587\u6587\u4EF6\u5931\u8D25 {path}\uFF1A{error}",noteToggleOn:"\u5305\u542B\u5F53\u524D\u7B14\u8BB0\uFF1A\u5F00",noteToggleOff:"\u5305\u542B\u5F53\u524D\u7B14\u8BB0\uFF1A\u5173",selectionPreview:"{path}\uFF08{count}{lineLabel}\uFF09\uFF1A{preview}...",lineSingular:"\u884C",linePlural:"\u884C",approvalTitleCommand:"\u547D\u4EE4\u6267\u884C\u8BF7\u6C42",approvalTitleFile:"\u6587\u4EF6\u4FEE\u6539\u8BF7\u6C42",approvalTitleGeneric:"\u5BA1\u6279\u8BF7\u6C42",approvalMetaFile:"\u6587\u4EF6\uFF1A{path}",approvalMetaCwd:"\u5DE5\u4F5C\u76EE\u5F55\uFF1A{cwd}",approvalTimedOut:"\u8D85\u65F6\uFF08\u81EA\u52A8\u62D2\u7EDD\uFF09",approvalDecisionPrefix:"\u51B3\u7B56\uFF1A{status}",approvalApproved:"\u5DF2\u6279\u51C6",approvalDenied:"\u5DF2\u62D2\u7EDD",approvalAlwaysAllowed:"\u5DF2\u6279\u51C6\uFF08\u59CB\u7EC8\uFF09",userInputRequest:"\u7528\u6237\u8F93\u5165\u8BF7\u6C42",userInputPlaceholder:"\u6216\u8F93\u5165\u81EA\u5B9A\u4E49\u7B54\u6848",userInputTimedOutDefault:"\u5DF2\u8D85\u65F6\uFF0C\u5DF2\u4F7F\u7528\u9ED8\u8BA4\u7B54\u6848\u3002",userInputSubmitted:"\u5DF2\u63D0\u4EA4",statusUserInputRequest:"\u7528\u6237\u8F93\u5165\u8BF7\u6C42",running:"\u8FD0\u884C\u4E2D",idle:"\u7A7A\u95F2",thread:"\u7EBF\u7A0B",noThread:"\u65E0\u7EBF\u7A0B",defaultModel:"\u9ED8\u8BA4",statusThinking:"\u601D\u8003\u4E2D...",statusStreaming:"\u6B63\u5728\u6D41\u5F0F\u56DE\u590D...",statusWaitingApproval:"\u7B49\u5F85\u5BA1\u6279\u4E2D...",statusRunningTool:"\u5DE5\u5177\u6267\u884C\u4E2D...",statusRunningGeneric:"\u8FD0\u884C\u4E2D...",statusTypeTool:"\u5DE5\u5177",reasoning:"\u63A8\u7406",toolOutput:"\u5DE5\u5177\u8F93\u51FA",toolStatusPrefix:"\u5DE5\u5177",statusTypeThinking:"\u601D\u8003",statusTypeAgent:"\u4EE3\u7406",statusTypeInfo:"\u4FE1\u606F",statusRunningShort:"\u8FD0\u884C\u4E2D",statusFailedShort:"\u5931\u8D25",statusDoneShort:"\u5B8C\u6210",reviewTitle:"\u5BA1\u67E5",reviewDiffsTitle:"\u4E0A\u4E00\u8F6E\u6587\u4EF6\u53D8\u66F4",reviewCommentsTitle:"\u5F85\u53D1\u9001\u8BC4\u8BBA",reviewCommentsEmpty:"\u6682\u65E0\u5F85\u53D1\u9001\u8BC4\u8BBA\u3002",reviewScopePlaceholder:"\u8303\u56F4\uFF08\u6587\u4EF6\u8DEF\u5F84\u6216\u533A\u57DF\uFF09",reviewCommentPlaceholder:"\u4E3A\u4E0B\u4E00\u8F6E\u6DFB\u52A0\u5BA1\u67E5\u8BC4\u8BBA",reviewAddComment:"\u6DFB\u52A0",reviewCommentRemove:"\u5220\u9664",reviewStatusAdded:"\u65B0\u589E",reviewStatusModified:"\u4FEE\u6539",reviewStatusDeleted:"\u5220\u9664",reviewPromptHeader:"Review Comments",planTitle:"\u8BA1\u5212",planStatusProposed:"\u5F85\u5BA1\u6279",planStatusApproved:"\u5DF2\u5BA1\u6279",planStatusInProgress:"\u6267\u884C\u4E2D",planStatusCompleted:"\u5DF2\u5B8C\u6210",planApproveAll:"\u5168\u90E8\u6279\u51C6",planGiveFeedback:"\u53CD\u9988",planExecuteNext:"\u6267\u884C\u4E0B\u4E00\u6B65",planFeedbackPrompt:"\u8BA1\u5212\u53CD\u9988",planApprovedProceedMessage:"\u5DF2\u6279\u51C6\uFF0C\u8BF7\u6309\u8BA1\u5212\u7EE7\u7EED\u6267\u884C\u3002",planFeedbackMessagePrefix:"\u8BA1\u5212\u53CD\u9988",planExecuteStepMessage:"\u8BF7\u6267\u884C\u7B2C {index} \u6B65\uFF1A{description}",settingsTitle:"Codexidian \u8BBE\u7F6E",settingLanguageName:"\u8BED\u8A00",settingLanguageDesc:"\u9009\u62E9 Codexidian \u7684\u754C\u9762\u8BED\u8A00\u3002",settingCodexCommandName:"Codex \u547D\u4EE4",settingCodexCommandDesc:"\u7528\u4E8E\u542F\u52A8 app-server \u7684 CLI \u547D\u4EE4\u3002Windows \u9ED8\u8BA4\uFF1Acodex.cmd",settingWorkingDirName:"\u5DE5\u4F5C\u76EE\u5F55",settingWorkingDirDesc:"Codex \u5728\u672C\u63D2\u4EF6\u4F1A\u8BDD\u4E2D\u4F7F\u7528\u7684\u6839\u76EE\u5F55\u3002",settingModelName:"\u6A21\u578B",settingModelDesc:"\u9009\u62E9 Codex \u4F1A\u8BDD\u4F7F\u7528\u7684 AI \u6A21\u578B\u3002",settingEffortName:"\u601D\u8003\u5F3A\u5EA6",settingEffortDesc:"\u63A7\u5236 Codex \u56DE\u590D\u524D\u7684\u601D\u8003\u6DF1\u5EA6\u3002",settingSkillPresetName:"Skill",settingSkillPresetDesc:"Default skill for the next turn (loaded from .codex/skills).",settingCollaborationModeName:"Mode",settingCollaborationModeDesc:"Approval mode for requests: Safe, Prompt, or Yolo.",skillPresetNone:"None",skillPresetCodeReview:"\u4EE3\u7801\u8BC4\u5BA1",skillPresetExplain:"\u8BB2\u89E3",skillPresetRefactor:"\u91CD\u6784",skillPresetDebug:"\u8C03\u8BD5",skillPresetTest:"\u6D4B\u8BD5",collaborationModeAutonomous:"\u81EA\u4E3B",collaborationModeInteractive:"\u4EA4\u4E92",collaborationModePlanFirst:"\u5148\u8BA1\u5212",settingsAllowRulesSection:"\u5BA1\u6279\u5141\u8BB8\u89C4\u5219",settingsAllowRulesDesc:"\u547D\u4E2D\u89C4\u5219\u7684\u8BF7\u6C42\u5C06\u81EA\u52A8\u6279\u51C6\uFF0C\u4E0D\u518D\u5F39\u51FA\u5BA1\u6279\u5361\u7247\u3002",allowRulesEmpty:"\u5F53\u524D\u6CA1\u6709\u5141\u8BB8\u89C4\u5219\u3002",allowRuleDelete:"\u5220\u9664",allowRulesClearAll:"\u6E05\u7A7A\u5168\u90E8",confirmAllowRulesClearAll:"\u786E\u5B9A\u6E05\u7A7A\u6240\u6709\u5141\u8BB8\u89C4\u5219\uFF1F",allowRuleTypeCommand:"\u547D\u4EE4",allowRuleTypeFileWrite:"\u6587\u4EF6\u5199\u5165",allowRuleTypeTool:"\u5DE5\u5177",settingApprovalPolicyName:"\u5BA1\u6279\u7B56\u7565",settingApprovalPolicyDesc:"\u65B0\u5EFA\u6216\u6062\u590D\u7EBF\u7A0B\u65F6\u4F7F\u7528\u7684\u5BA1\u6279\u6A21\u5F0F\u3002",settingSandboxName:"\u6C99\u7BB1\u6A21\u5F0F",settingSandboxDesc:"\u65B0\u5EFA\u6216\u6062\u590D\u7EBF\u7A0B\u65F6\u4F7F\u7528\u7684\u6C99\u7BB1\u6A21\u5F0F\u3002",settingAutoApproveName:"\u81EA\u52A8\u6279\u51C6 app-server \u8BF7\u6C42",settingAutoApproveDesc:"\u542F\u7528\u540E\uFF0C\u547D\u4EE4/\u6587\u4EF6\u5BA1\u6279\u56DE\u8C03\u5C06\u81EA\u52A8\u7B54\u590D\u3002",settingPersistThreadName:"\u91CD\u542F\u540E\u4FDD\u7559\u7EBF\u7A0B",settingPersistThreadDesc:"\u5C3D\u53EF\u80FD\u590D\u7528\u4E0A\u6B21\u7EBF\u7A0B ID\u3002",settingSavedThreadName:"\u5DF2\u4FDD\u5B58\u7EBF\u7A0B",settingSavedThreadEmpty:"\uFF08\u65E0\uFF09",settingSavedThreadClear:"\u6E05\u9664",noticeSavedThreadCleared:"\u5DF2\u6E05\u9664 Codexidian \u4FDD\u5B58\u7684\u7EBF\u7A0B\u3002",settingsUiSection:"\u754C\u9762\u8BBE\u7F6E",settingMaxTabsName:"\u6700\u5927\u6807\u7B7E\u9875\u6570",settingMaxTabsDesc:"\u6700\u591A\u6253\u5F00\u6807\u7B7E\u9875\u6570\u91CF\uFF081-5\uFF09\u3002",settingContextInjectionName:"\u4E0A\u4E0B\u6587\u6CE8\u5165",settingContextInjectionDesc:"\u5C06\u5F53\u524D\u7B14\u8BB0\u8DEF\u5F84\u548C\u7F16\u8F91\u5668\u9009\u533A\u6CE8\u5165\u5230\u63D0\u793A\u8BCD\u3002",settingSelectionPollingName:"\u9009\u533A\u8F6E\u8BE2",settingSelectionPollingDesc:"\u8F6E\u8BE2\u7F16\u8F91\u5668\u9009\u533A\u5E76\u663E\u793A\u4E0A\u4E0B\u6587\u6307\u793A\u3002",settingEnableReviewPaneName:"\u542F\u7528\u5BA1\u67E5\u9762\u677F",settingEnableReviewPaneDesc:"\u5728\u6D88\u606F\u533A\u4E0E\u8F93\u5165\u533A\u4E4B\u95F4\u663E\u793A\u5BA1\u67E5\u9762\u677F\uFF08diff + \u5F85\u53D1\u9001\u8BC4\u8BBA\uFF09\u3002",settingsMcpSection:"MCP \u96C6\u6210",settingEnableMcpName:"\u542F\u7528 MCP \u7B14\u8BB0\u5DE5\u5177",settingEnableMcpDesc:"\u5141\u8BB8 app-server \u901A\u8FC7 Obsidian Vault API \u8BFB/\u5199/\u641C/\u5217\u7B14\u8BB0\u3002",settingMcpEndpointName:"MCP \u7AEF\u70B9\uFF08\u53EF\u9009\uFF09",settingMcpEndpointDesc:"\u7528\u4E8E\u5916\u90E8 MCP/REST \u6865\u63A5\u573A\u666F\u7684\u53EF\u9009\u7AEF\u70B9\u5143\u6570\u636E\u3002",settingMcpApiKeyName:"MCP API Key\uFF08\u53EF\u9009\uFF09",settingMcpApiKeyDesc:"\u7528\u4E8E\u5916\u90E8 MCP/REST \u6865\u63A5\u573A\u666F\u7684\u53EF\u9009\u5BC6\u94A5\u3002",settingMcpContextLimitName:"\u81EA\u52A8 MCP \u4E0A\u4E0B\u6587\u7B14\u8BB0\u6570",settingMcpContextLimitDesc:"\u542F\u7528 MCP \u65F6\u81EA\u52A8\u9644\u52A0\u76F8\u5173\u7B14\u8BB0\u6570\u91CF\uFF080 \u4E3A\u5173\u95ED\uFF09\u3002",settingsSecuritySection:"\u5B89\u5168\u63A7\u5236",settingBlockedPathsName:"\u7981\u6B62\u8DEF\u5F84",settingBlockedPathsDesc:"\u6BCF\u884C\u4E00\u4E2A\u8DEF\u5F84\u6A21\u5F0F\uFF0C\u7981\u6B62\u8BFB\u53D6/\u5199\u5165\u654F\u611F\u6587\u4EF6\u6216\u76EE\u5F55\u3002",settingRequireApprovalWriteName:"\u5199\u5165\u9700\u5BA1\u6279",settingRequireApprovalWriteDesc:"\u5199\u64CD\u4F5C\u524D\u9700\u8981\u663E\u5F0F\u5BA1\u6279\uFF08MCP write_note \u4E0E Apply to Note\uFF09\u3002",settingMaxNoteSizeName:"\u7B14\u8BB0\u6700\u5927\u5927\u5C0F\uFF08KB\uFF09",settingMaxNoteSizeDesc:"\u5199\u64CD\u4F5C\u540E\u5141\u8BB8\u7684\u7B14\u8BB0\u6700\u5927\u5927\u5C0F\u3002",noticeNewThreadCreated:"Codexidian \u65B0\u7EBF\u7A0B\uFF1A{threadId}...",mcpDisabledMessage:"Codexidian \u8BBE\u7F6E\u4E2D\u5DF2\u7981\u7528 MCP\u3002",mcpToolExecutionFailed:"MCP \u5DE5\u5177\u6267\u884C\u5931\u8D25\uFF1A{error}"},Xe={en:ct,zh:ut},Ye="en";function ce(S){Ye=S in Xe?S:"en"}function o(S){return Xe[Ye][S]}function y(S,n){let e=o(S);for(let[t,i]of Object.entries(n))e=e.split(`{${t}}`).join(String(i));return e}function De(S){return S==="en"||S==="zh"}var pt=100,ue=class{constructor(n,e,t){this.app=n;this.component=e;this.onApplyCode=t;this.debounceTimers=new Map}async renderContent(n,e,t=""){n.empty(),n.classList.add("codexidian-message-content"),await et.MarkdownRenderer.renderMarkdown(e,n,t,this.component),this.enhanceCodeBlocks(n)}renderStreaming(n,e,t=""){let i=this.debounceTimers.get(n);i&&clearTimeout(i);let s=setTimeout(()=>{this.debounceTimers.delete(n),this.renderContent(n,e,t)},pt);this.debounceTimers.set(n,s)}destroy(){for(let n of this.debounceTimers.values())clearTimeout(n);this.debounceTimers.clear()}enhanceCodeBlocks(n){var t,i;let e=n.querySelectorAll("pre");for(let s=0;s<e.length;s++){let r=e[s];if((t=r.parentElement)!=null&&t.classList.contains("codexidian-code-wrapper"))continue;let a=document.createElement("div");a.classList.add("codexidian-code-wrapper");let l=r.querySelector("code"),d="";if(l){let m=Array.from(l.classList).find(f=>f.startsWith("language-"));m&&(d=m.replace("language-",""))}let p=document.createElement("div");p.classList.add("codexidian-code-header");let c=document.createElement("span");c.classList.add("codexidian-code-lang-label"),c.setText(d||o("text")),p.appendChild(c);let u=document.createElement("div");u.classList.add("codexidian-code-header-actions");let g=document.createElement("button");g.classList.add("codexidian-code-apply-btn"),g.setText(o("apply")),g.addEventListener("click",m=>{var x,T;m.preventDefault(),m.stopPropagation();let f=(T=(x=l==null?void 0:l.textContent)!=null?x:r.textContent)!=null?T:"";f.trim()&&this.onApplyCode&&this.onApplyCode({code:f,language:d||"text",triggerEl:g})}),u.appendChild(g);let v=document.createElement("button");v.classList.add("codexidian-code-copy-btn"),v.setText(o("copy")),v.addEventListener("click",()=>{var f,x;let m=(x=(f=l==null?void 0:l.textContent)!=null?f:r.textContent)!=null?x:"";navigator.clipboard.writeText(m).then(()=>{v.setText(o("copied")),setTimeout(()=>v.setText(o("copy")),1500)})}),u.appendChild(v),p.appendChild(u),(i=r.parentNode)==null||i.insertBefore(a,r),a.appendChild(p),a.appendChild(r)}}};var pe=class{createBlock(n){let e=n.createEl("details",{cls:"codexidian-thinking-block codexidian-thinking-streaming"}),t=e.createEl("summary",{cls:"codexidian-thinking-header"});t.createSpan({cls:"codexidian-thinking-title",text:o("statusThinking")});let i=t.createSpan({cls:"codexidian-thinking-meta",text:o("streaming")}),s=e.createEl("pre",{cls:"codexidian-thinking-content"}),r=Date.now(),a="",l=!1;return{el:e,appendContent:d=>{d&&(a+=d,s.setText(a))},finalize:()=>{if(l)return;l=!0,e.removeClass("codexidian-thinking-streaming");let d=((Date.now()-r)/1e3).toFixed(1);i.setText(`${d}s`)}}}};var he=class{createCard(n,e){let t=n.createDiv({cls:"codexidian-tool-card is-collapsed"}),i=!0,s=t.createDiv({cls:"codexidian-tool-header"});s.setAttr("role","button"),s.setAttr("tabindex","0"),s.setAttr("aria-expanded","false");let r=s.createSpan({cls:"codexidian-tool-icon",text:"\u2699"}),a=s.createSpan({cls:"codexidian-tool-title",text:this.buildTitle(e)}),l=s.createSpan({cls:"codexidian-tool-status codexidian-tool-status-running",text:`\u23F3 ${o("statusRunningShort")}`}),d=s.createSpan({cls:"codexidian-tool-duration",text:""}),p=t.createDiv({cls:"codexidian-tool-body"});e.command&&p.createDiv({cls:"codexidian-tool-command",text:e.command}),e.filePath&&p.createDiv({cls:"codexidian-tool-file",text:e.filePath});let c=p.createDiv({cls:"codexidian-tool-output-wrap"});c.createDiv({cls:"codexidian-tool-output-summary",text:o("output")});let u=c.createEl("pre",{cls:"codexidian-tool-output"});c.addClass("is-empty");let g="",v=f=>{i=f,t.toggleClass("is-collapsed",f),s.setAttr("aria-expanded",String(!f))},m=()=>{v(!i)};return s.addEventListener("click",()=>{m()}),s.addEventListener("keydown",f=>{f.key!=="Enter"&&f.key!==" "||(f.preventDefault(),m())}),{el:t,appendOutput:f=>{f&&(g+=f,u.setText(g),c.removeClass("is-empty"))},complete:(f,x)=>{let T=f.trim().toLowerCase();l.removeClass("codexidian-tool-status-running"),l.removeClass("codexidian-tool-status-done"),l.removeClass("codexidian-tool-status-error");let h=typeof x=="number"&&Number.isFinite(x)&&x>=0;if(d.setText(h?`${Math.round(x)}ms`:""),this.isErrorStatus(T)){l.addClass("codexidian-tool-status-error"),l.setText(`\u2717 ${T||o("statusFailedShort")}`),r.setText("\u2716");return}if(this.isDoneStatus(T)){l.addClass("codexidian-tool-status-done"),l.setText(`\u2713 ${T||o("statusDoneShort")}`),r.setText("\u2713");return}l.addClass("codexidian-tool-status-running"),l.setText(`\u23F3 ${T||o("statusRunningShort")}`),r.setText("\u2699"),a.setText(this.buildTitle(e))}}}buildTitle(n){return n.name&&n.name.trim().length>0?n.name.trim():n.type&&n.type.trim().length>0?n.type.trim():o("toolTitle")}isDoneStatus(n){return n==="completed"||n==="complete"||n==="success"||n==="ok"||n==="done"}isErrorStatus(n){return n.includes("error")||n.includes("fail")||n.includes("deny")||n.includes("reject")||n.includes("cancel")||n.includes("interrupted")}};var ge=class{static render(n,e,t){n.empty();let i=n.createDiv({cls:"codexidian-plan-card"}),s=i.createDiv({cls:"codexidian-plan-header"});s.createDiv({cls:"codexidian-plan-title",text:e.title||o("planTitle")}),s.createDiv({cls:`codexidian-plan-status codexidian-plan-status--${e.status}`,text:this.planStatusLabel(e.status)});let r=i.createDiv({cls:"codexidian-plan-steps"});for(let u of e.steps){let g=r.createDiv({cls:`codexidian-plan-step codexidian-plan-step--${u.status}`});g.createDiv({cls:"codexidian-plan-step-index",text:`${u.index}.`});let v=g.createDiv({cls:"codexidian-plan-step-description",text:u.description});v.title=u.description,g.createDiv({cls:"codexidian-plan-step-status",text:this.stepStatusIcon(u.status)})}let a=i.createDiv({cls:"codexidian-plan-actions"}),l=a.createEl("button",{cls:"codexidian-plan-action-btn plan-approve",text:o("planApproveAll")}),d=a.createEl("button",{cls:"codexidian-plan-action-btn plan-feedback",text:o("planGiveFeedback")}),p=a.createEl("button",{cls:"codexidian-plan-action-btn plan-execute",text:o("planExecuteNext")});l.type="button",d.type="button",p.type="button";let c=e.steps.some(u=>u.status==="approved"||u.status==="pending");return l.disabled=e.status!=="proposed",p.disabled=!(e.status==="approved"||e.status==="in_progress")||!c,l.addEventListener("click",()=>{var u;(u=t.onApproveAll)==null||u.call(t)}),d.addEventListener("click",()=>{var u;(u=t.onGiveFeedback)==null||u.call(t)}),p.addEventListener("click",()=>{var u;(u=t.onExecuteNext)==null||u.call(t)}),i}static planStatusLabel(n){return n==="approved"?o("planStatusApproved"):n==="in_progress"?o("planStatusInProgress"):n==="completed"?o("planStatusCompleted"):o("planStatusProposed")}static stepStatusIcon(n){return n==="completed"?"\u2713":n==="failed"?"\u2717":n==="executing"?"\u23F3":n==="approved"?"\u2022":n==="skipped"?"\u21B7":"\u25CB"}};var ht=500,me=class{constructor(n,e){this.storage=n;this.renderer=e;this.activeConversation=null;this.saveTimer=null}getActive(){return this.activeConversation}getActiveThreadId(){var n;return(n=this.activeConversation)==null?void 0:n.threadId}setThreadId(n){if(this.activeConversation){let e=n.trim();e?this.activeConversation.threadId=e:delete this.activeConversation.threadId,this.scheduleSave()}}clearThreadId(){this.setThreadId("")}async createNew(n){let e=Date.now(),t={id:Ze(),title:n!=null?n:`Chat ${new Date(e).toLocaleString()}`,createdAt:e,updatedAt:e,messages:[]};this.activeConversation=t;try{await this.storage.saveConversation(t)}catch(i){}return t}async switchTo(n){await this.flushSave();let e=await this.storage.loadConversation(n);return e&&(this.activeConversation=e),e}async loadActive(n){return this.switchTo(n)}addMessage(n,e,t){if(!this.activeConversation)throw new Error("No active conversation");let i={id:Je(),role:n,content:e,timestamp:Date.now()};return t!=null&&t.images&&t.images.length>0&&(i.images=t.images.filter(s=>s.dataUrl.trim().length>0).map(s=>({name:s.name,dataUrl:s.dataUrl}))),this.activeConversation.messages.push(i),this.activeConversation.updatedAt=Date.now(),n==="assistant"&&(this.activeConversation.lastResponseAt=Date.now()),this.scheduleSave(),i}async truncateAfter(n){if(!this.activeConversation)throw new Error("No active conversation");let e=this.activeConversation.messages.findIndex(i=>i.id===n);if(e<0)return null;let t=this.activeConversation.messages[e];return this.activeConversation.messages=this.activeConversation.messages.slice(0,e),this.activeConversation.updatedAt=Date.now(),this.recomputeLastResponseAt(),await this.flushSave(),this.cloneMessage(t)}getMessagesUpTo(n){if(!this.activeConversation)throw new Error("No active conversation");let e=this.activeConversation.messages.findIndex(t=>t.id===n);return e<0?[]:this.activeConversation.messages.slice(0,e+1).map(t=>this.cloneMessage(t))}setMessages(n){if(!this.activeConversation)throw new Error("No active conversation");this.activeConversation.messages=n.map(e=>this.cloneMessage(e)),this.activeConversation.updatedAt=Date.now(),this.recomputeLastResponseAt(),this.scheduleSave()}async deleteConversation(n){var e;await this.storage.deleteConversation(n),((e=this.activeConversation)==null?void 0:e.id)===n&&(this.activeConversation=null)}async renameConversation(n,e){var t;if(((t=this.activeConversation)==null?void 0:t.id)===n)this.activeConversation.title=e,this.activeConversation.updatedAt=Date.now(),this.scheduleSave();else{let i=await this.storage.loadConversation(n);i&&(i.title=e,i.updatedAt=Date.now(),await this.storage.saveConversation(i))}}async listConversations(n="all"){return this.storage.listConversations(n)}async searchConversations(n,e="all"){return this.storage.searchConversations(n,e)}async updateMeta(n,e){var i;let t=await this.storage.updateMeta(n,e);return t&&((i=this.activeConversation)==null?void 0:i.id)===n&&(this.activeConversation.updatedAt=t.updatedAt,this.activeConversation.archived=t.archived===!0,this.activeConversation.pinned=t.pinned===!0,this.activeConversation.tags=t.tags?[...t.tags]:[]),t}scheduleSave(){this.saveTimer&&clearTimeout(this.saveTimer),this.saveTimer=setTimeout(()=>{this.saveTimer=null,this.activeConversation&&this.storage.saveConversation(this.activeConversation).catch(()=>{})},ht)}async flushSave(){if(this.saveTimer&&(clearTimeout(this.saveTimer),this.saveTimer=null),this.activeConversation)try{await this.storage.saveConversation(this.activeConversation)}catch(n){}}destroy(){this.saveTimer&&(clearTimeout(this.saveTimer),this.saveTimer=null)}recomputeLastResponseAt(){if(!this.activeConversation)return;let n=this.activeConversation.messages.filter(t=>t.role==="assistant");if(n.length===0){this.activeConversation.lastResponseAt=void 0;return}let e=n.reduce((t,i)=>Math.max(t,i.timestamp),0);this.activeConversation.lastResponseAt=e>0?e:void 0}cloneMessage(n){let e=Array.isArray(n.images)?n.images.filter(t=>!!t&&typeof t.name=="string"&&typeof t.dataUrl=="string"&&t.dataUrl.trim().length>0).map(t=>({name:t.name,dataUrl:t.dataUrl})):void 0;return{...n,images:e}}};var tt=require("obsidian");var gt=250,ve=class{constructor(n){this.app=n;this.intervalId=null;this.current=null;this.indicatorEl=null;this.enabled=!0;this.onContextChanged=null}setEnabled(n){this.enabled=n,n||(this.current=null,this.updateIndicator())}getContext(){return this.current}setOnContextChanged(n){this.onContextChanged=n}start(n){this.indicatorEl=n,this.stop(),this.intervalId=setInterval(()=>this.poll(),gt)}stop(){this.intervalId!==null&&(clearInterval(this.intervalId),this.intervalId=null),this.current=null,this.updateIndicator()}poll(){var r,a;if(!this.enabled){this.current&&(this.current=null,this.updateIndicator());return}let n=this.app.workspace.getActiveViewOfType(tt.MarkdownView);if(!n){this.current&&(this.current=null,this.updateIndicator());return}let e=n.editor,t=e.getSelection();if(!t||!t.trim()){this.current&&(this.current=null,this.updateIndicator());return}let i=e.getCursor("from"),s=t.split(`
`).length;this.current={notePath:(a=(r=n.file)==null?void 0:r.path)!=null?a:"",mode:"selection",selectedText:t,lineCount:s,startLine:i.line+1},this.updateIndicator()}updateIndicator(){var a,l,d;if(!this.indicatorEl){(a=this.onContextChanged)==null||a.call(this);return}if(!this.current){this.indicatorEl.empty(),this.indicatorEl.style.display="none",(l=this.onContextChanged)==null||l.call(this);return}this.indicatorEl.style.display="flex",this.indicatorEl.empty();let n=this.indicatorEl.createSpan({cls:"codexidian-context-icon",text:"\u{1F4CE}"}),e=this.indicatorEl.createSpan({cls:"codexidian-context-text"}),t=this.current.lineCount,i=this.current.selectedText.slice(0,60).replace(/\n/g," "),s=t>1?o("linePlural"):o("lineSingular");e.setText(y("selectionPreview",{path:this.current.notePath,count:t,lineLabel:s,preview:i})),this.indicatorEl.createSpan({cls:"codexidian-context-clear",text:"\u2715"}).addEventListener("click",()=>{this.current=null,this.updateIndicator()}),(d=this.onContextChanged)==null||d.call(this)}};var fe=class{constructor(n,e){this.tabs=[];this.activeTabId=null;this.maxTabs=e.maxTabs,this.onSelect=e.onSelect,this.onClose=e.onClose,this.onAdd=e.onAdd,this.containerEl=n.createDiv({cls:"codexidian-tab-bar"})}update(n,e){this.tabs=n,this.activeTabId=e,this.render()}setStreaming(n,e){let t=this.containerEl.querySelector(`[data-tab-id="${n}"]`);t&&t.classList.toggle("codexidian-tab-badge-streaming",e)}render(){if(this.containerEl.empty(),this.tabs.forEach((n,e)=>{let t=this.containerEl.createDiv({cls:"codexidian-tab-badge"});t.dataset.tabId=n.tabId,t.setText(String(e+1)),t.setAttribute("aria-label",`Tab ${e+1}`),n.tabId===this.activeTabId&&t.classList.add("codexidian-tab-badge-active"),t.addEventListener("click",()=>this.onSelect(n.tabId)),t.addEventListener("contextmenu",i=>{i.preventDefault(),this.tabs.length>1&&this.onClose(n.tabId)})}),this.tabs.length<this.maxTabs){let n=this.containerEl.createDiv({cls:"codexidian-tab-add"});n.setText("+"),n.setAttribute("aria-label","New Tab"),n.addEventListener("click",()=>this.onAdd())}}};var ye=class{constructor(n,e,t,i,s){this.tabBar=n;this.messagesContainer=e;this.createConversationController=t;this.client=i;this.onTabSwitch=s;this.tabs=new Map;this.activeTabId=null}getActiveTab(){var n;return this.activeTabId&&(n=this.tabs.get(this.activeTabId))!=null?n:null}getTab(n){var e;return(e=this.tabs.get(n))!=null?e:null}getActiveConversationController(){var n,e;return(e=(n=this.getActiveTab())==null?void 0:n.conversationController)!=null?e:null}getAllTabStates(){return Array.from(this.tabs.values()).map(n=>n.state)}addTab(n=null,e){let t=typeof e=="string"?e.trim():"",i=t&&!this.tabs.has(t)?t:Ge(),s=this.messagesContainer.createDiv({cls:"codexidian-tab-panel"});s.style.display="none";let r={state:{tabId:i,conversationId:n},panelEl:s,conversationController:this.createConversationController()};return this.tabs.set(i,r),this.switchTo(i),this.updateTabBar(),r}switchTo(n){let e=this.tabs.get(n);if(!e)return;for(let i of this.tabs.values())i.panelEl.style.display="none";e.panelEl.style.display="flex",this.activeTabId=n;let t=e.conversationController.getActiveThreadId();this.client.setThreadId(t!=null?t:null),this.updateTabBar(),this.onTabSwitch(e)}closeTab(n){if(this.tabs.size<=1)return;let e=this.tabs.get(n);if(e){if(e.conversationController.destroy(),e.panelEl.remove(),this.tabs.delete(n),this.activeTabId===n){let t=this.tabs.keys().next().value;t&&this.switchTo(t)}this.updateTabBar()}}setConversationId(n,e){let t=this.tabs.get(n);t&&(t.state.conversationId=e)}getState(){return{openTabs:this.getAllTabStates(),activeTabId:this.activeTabId}}async restoreState(n){let e=Array.isArray(n==null?void 0:n.openTabs)?n.openTabs:[];if(!e.length){this.addTab();return}for(let t of e){if(!t||typeof t.tabId!="string")continue;let i=typeof t.conversationId=="string"?t.conversationId:null;this.addTab(i,t.tabId)}if(this.tabs.size===0){this.addTab();return}if(n.activeTabId&&this.tabs.has(n.activeTabId))this.switchTo(n.activeTabId);else{let t=this.tabs.keys().next().value;t&&this.switchTo(t)}this.updateTabBar()}updateTabBar(){this.tabBar.update(this.getAllTabStates(),this.activeTabId)}destroy(){for(let n of this.tabs.values())n.conversationController.destroy();this.tabs.clear()}};function mt(S,n,e=[]){let t=[];if(S&&t.push(`<current_note>${S}</current_note>`),n&&n.selectedText.trim()){let i=n.startLine,s=i+n.lineCount-1;t.push(`<editor_selection path="${n.notePath}" lines="${i}-${s}">${n.selectedText}</editor_selection>`)}for(let i of e)t.push(`<attached_file path="${i.path}">${i.content}</attached_file>`);return t.join(`
`)}function nt(S,n,e,t=[]){let i=mt(n,e,t);return i?`${i}

${S}`:S}var Te=class{constructor(n,e,t){this.app=n;this.inputEl=t;this.files=new Set;this.searchEl=null;this.queryStart=-1;this.queryEnd=-1;var i;this.chipsEl=e.createDiv({cls:"codexidian-file-chips"}),this.inputWrapperEl=(i=this.inputEl.parentElement)!=null?i:e,this.onInputBound=s=>{try{this.handleInput(s)}catch(r){this.hideSearch()}},this.onOutsideClickBound=s=>{try{this.handleOutsideClick(s)}catch(r){this.hideSearch()}},this.inputEl.addEventListener("input",this.onInputBound),document.addEventListener("mousedown",this.onOutsideClickBound)}getFiles(){return Array.from(this.files)}clear(){this.files.clear(),this.renderChips(),this.hideSearch()}destroy(){this.inputEl.removeEventListener("input",this.onInputBound),document.removeEventListener("mousedown",this.onOutsideClickBound),this.hideSearch(),this.chipsEl.empty()}handleInput(n){var d,p;let e=this.inputEl.value,t=(d=this.inputEl.selectionStart)!=null?d:e.length,i=e.slice(0,t),s=/(?:^|\s)@([^\s@]*)$/.exec(i);if(!s){this.hideSearch();return}let r=(p=s[1])!=null?p:"";this.queryStart=t-r.length-1,this.queryEnd=t;let a=r.toLowerCase(),l=this.app.vault.getFiles().map(c=>c.path).filter(c=>!this.files.has(c)).filter(c=>a.length===0||c.toLowerCase().includes(a)).slice(0,10);if(l.length===0){this.hideSearch();return}this.renderSearch(l)}renderSearch(n){this.hideSearch(),this.searchEl=this.inputWrapperEl.createDiv({cls:"codexidian-file-search"});for(let e of n)this.searchEl.createDiv({cls:"codexidian-file-search-item",text:e}).addEventListener("click",()=>{this.addFile(e)})}hideSearch(){this.searchEl&&(this.searchEl.remove(),this.searchEl=null),this.queryStart=-1,this.queryEnd=-1}addFile(n){this.files.add(n),this.renderChips();let e=this.inputEl.value;if(this.queryStart>=0&&this.queryEnd>=this.queryStart){let t=e.slice(0,this.queryStart),i=e.slice(this.queryEnd);this.inputEl.value=`${t}${i}`;let s=t.length;this.inputEl.selectionStart=s,this.inputEl.selectionEnd=s}this.hideSearch(),this.inputEl.focus()}renderChips(){this.chipsEl.empty();for(let n of this.files){let e=this.chipsEl.createDiv({cls:"codexidian-file-chip"});e.createSpan({cls:"codexidian-file-chip-text",text:n}),e.createSpan({cls:"codexidian-file-chip-remove",text:"\u2715"}).addEventListener("click",()=>{this.files.delete(n),this.renderChips()})}}handleOutsideClick(n){let e=n.target;e&&e!==this.inputEl&&(this.searchEl&&this.searchEl.contains(e)||this.hideSearch())}};var J=class J{constructor(n,e,t={}){this.inputEl=e;this.images=[];this.dragDepth=0;this.dropZoneActive=!1;var i;this.dropTargetEl=(i=t.dropTargetEl)!=null?i:null,this.onDropZoneActiveChange=t.onDropZoneActiveChange,this.onLimitReached=t.onLimitReached,this.onFilesIgnored=t.onFilesIgnored,this.onReadFailure=t.onReadFailure,this.previewsEl=n.createDiv({cls:"codexidian-image-previews"}),this.onPasteBound=s=>{this.handlePaste(s)},this.onDragEnterBound=s=>{this.handleDragEnter(s)},this.onDragOverBound=s=>{this.handleDragOver(s)},this.onDragLeaveBound=s=>{this.handleDragLeave(s)},this.onDropBound=s=>{this.handleDrop(s)},this.inputEl.addEventListener("paste",this.onPasteBound),this.dropTargetEl&&(this.dropTargetEl.addEventListener("dragenter",this.onDragEnterBound),this.dropTargetEl.addEventListener("dragover",this.onDragOverBound),this.dropTargetEl.addEventListener("dragleave",this.onDragLeaveBound),this.dropTargetEl.addEventListener("drop",this.onDropBound))}getImages(){return this.images.map(n=>({name:n.name,dataUrl:n.dataUrl,path:n.path}))}async addFiles(n){try{let e=Array.isArray(n)?n:Array.from(n);return await this.ingestFiles(e)}catch(e){return 0}}clear(){this.images=[],this.dragDepth=0,this.setDropZoneActive(!1),this.render()}destroy(){this.inputEl.removeEventListener("paste",this.onPasteBound),this.dropTargetEl&&(this.dropTargetEl.removeEventListener("dragenter",this.onDragEnterBound),this.dropTargetEl.removeEventListener("dragover",this.onDragOverBound),this.dropTargetEl.removeEventListener("dragleave",this.onDragLeaveBound),this.dropTargetEl.removeEventListener("drop",this.onDropBound)),this.clear()}async handlePaste(n){var e;try{let t=(e=n.clipboardData)==null?void 0:e.items;if(!t||t.length===0)return;let i=[];for(let s of Array.from(t)){if(!s.type.startsWith("image/"))continue;let r=s.getAsFile();r&&i.push(r)}i.length>0&&(n.preventDefault(),await this.ingestFiles(i))}catch(t){}}handleDragEnter(n){this.hasImageFiles(n.dataTransfer)&&(this.dragDepth+=1,this.setDropZoneActive(!0))}handleDragOver(n){this.hasImageFiles(n.dataTransfer)&&(n.preventDefault(),n.dataTransfer&&(n.dataTransfer.dropEffect="copy"),this.setDropZoneActive(!0))}handleDragLeave(n){if(!this.dropZoneActive)return;let e=n.target,t=n.relatedTarget;this.dropTargetEl&&e&&this.dropTargetEl.contains(e)&&t&&this.dropTargetEl.contains(t)||(this.dragDepth=Math.max(0,this.dragDepth-1),this.dragDepth===0&&this.setDropZoneActive(!1))}async handleDrop(n){var t;let e=(t=n.dataTransfer)==null?void 0:t.files;this.dragDepth=0,this.setDropZoneActive(!1),!(!e||e.length===0)&&this.hasImageFiles(n.dataTransfer)&&(n.preventDefault(),await this.ingestFiles(Array.from(e)))}async ingestFiles(n){var a,l,d,p;if(n.length===0)return 0;let e=n.filter(c=>c.type.startsWith("image/")),t=n.length-e.length;if(t>0)try{(a=this.onFilesIgnored)==null||a.call(this,t)}catch(c){}if(e.length===0)return 0;let i=J.MAX_ATTACHMENTS-this.images.length;if(i<=0){try{(l=this.onLimitReached)==null||l.call(this,J.MAX_ATTACHMENTS)}catch(c){}return 0}if(e.length>i)try{(d=this.onLimitReached)==null||d.call(this,J.MAX_ATTACHMENTS)}catch(c){}let s=e.slice(0,i),r=0;for(let c of s)try{let u=await this.fileToDataUrl(c),g=this.extractLocalPath(c);this.images.push({name:this.getAttachmentName(c,r),dataUrl:u,sizeBytes:c.size,path:g}),r+=1}catch(u){try{(p=this.onReadFailure)==null||p.call(this,c.name||"image")}catch(g){}}return r>0&&this.render(),r}render(){if(this.previewsEl.empty(),this.images.length===0){this.previewsEl.style.display="none";return}this.previewsEl.style.display="flex",this.images.forEach((n,e)=>{let t=this.previewsEl.createDiv({cls:"codexidian-attachment-chip"}),s=t.createDiv({cls:"codexidian-attachment-thumb"}).createEl("img");s.src=n.dataUrl,s.alt=n.name,s.title=n.name;let r=t.createDiv({cls:"codexidian-attachment-info"});r.createDiv({cls:"codexidian-attachment-name",text:n.name}),r.createDiv({cls:"codexidian-attachment-size",text:this.formatSize(n.sizeBytes)});let a=t.createEl("button",{cls:"codexidian-attachment-remove",text:"\u2715"});a.type="button",a.addEventListener("click",()=>{this.images.splice(e,1),this.render()})})}setDropZoneActive(n){var e;if(this.dropZoneActive!==n){this.dropZoneActive=n;try{(e=this.onDropZoneActiveChange)==null||e.call(this,n)}catch(t){}}}hasImageFiles(n){var t;return!n||!Array.from((t=n.types)!=null?t:[]).includes("Files")?!1:n.items&&n.items.length>0?Array.from(n.items).some(i=>i.kind==="file"&&i.type.startsWith("image/")):n.files&&n.files.length>0?Array.from(n.files).some(i=>i.type.startsWith("image/")):!1}getAttachmentName(n,e){return n.name&&n.name.trim().length>0?n.name.trim():`image-${Date.now()}-${e+1}.png`}formatSize(n){return n<1024?`${n} B`:n<1024*1024?`${(n/1024).toFixed(1)} KB`:`${(n/(1024*1024)).toFixed(1)} MB`}async fileToDataUrl(n){return await new Promise((e,t)=>{let i=new FileReader;i.onload=()=>{let s=typeof i.result=="string"?i.result:"";e(s)},i.onerror=()=>{t(new Error("failed to read image"))},i.readAsDataURL(n)})}extractLocalPath(n){let e=n.path;if(typeof e!="string")return;let t=e.trim();return t.length>0?t:void 0}};J.MAX_ATTACHMENTS=5;var we=J;var Ce=class{constructor(n){this.commands=[];this.filteredCommands=[];this.selectedIndex=0;this.visible=!1;this.menuEl=n.createDiv({cls:"codexidian-slash-menu"})}registerCommand(n){let e=this.normalizeName(n.name);if(!e)return;let t={...n,name:e},i=this.commands.findIndex(s=>s.name===e);i>=0?this.commands[i]=t:this.commands.push(t)}getCommands(){return this.commands.map(n=>({...n}))}isVisible(){return this.visible}show(n){let e=n.trim().toLowerCase();if(this.filteredCommands=this.commands.filter(t=>this.matchesFilter(t,e)).slice(0,8),this.filteredCommands.length===0){this.hide();return}this.selectedIndex>=this.filteredCommands.length&&(this.selectedIndex=0),this.visible=!0,this.menuEl.addClass("is-visible"),this.render()}hide(){this.visible=!1,this.filteredCommands=[],this.selectedIndex=0,this.menuEl.removeClass("is-visible"),this.menuEl.empty()}selectNext(){!this.visible||this.filteredCommands.length===0||(this.selectedIndex=(this.selectedIndex+1)%this.filteredCommands.length,this.render())}selectPrev(){!this.visible||this.filteredCommands.length===0||(this.selectedIndex=(this.selectedIndex-1+this.filteredCommands.length)%this.filteredCommands.length,this.render())}async executeSelected(){return!this.visible||this.filteredCommands.length===0?!1:await this.executeByIndex(this.selectedIndex)}async executeByName(n){let e=this.normalizeName(n);if(!e)return!1;let t=this.commands.find(i=>i.name===e);if(!t)return!1;try{await t.execute()}finally{this.hide()}return!0}destroy(){this.hide(),this.commands=[],this.menuEl.remove()}render(){this.menuEl.empty(),this.filteredCommands.forEach((n,e)=>{let t=this.menuEl.createDiv({cls:"codexidian-slash-item"});e===this.selectedIndex&&t.addClass("is-selected");let i=n.icon?`${n.icon} /${n.name}`:`/${n.name}`;t.createDiv({cls:"codexidian-slash-item-name",text:i}),t.createDiv({cls:"codexidian-slash-item-desc",text:n.description||n.label}),t.addEventListener("mouseenter",()=>{this.selectedIndex=e,this.render()}),t.addEventListener("mousedown",s=>{s.preventDefault(),this.executeByIndex(e)})})}async executeByIndex(n){let e=this.filteredCommands[n];if(!e)return!1;try{await e.execute()}finally{this.hide()}return!0}matchesFilter(n,e){if(!e)return!0;let t=n.name.toLowerCase(),i=n.label.toLowerCase(),s=n.description.toLowerCase();return t.includes(e)||i.includes(e)||s.includes(e)}normalizeName(n){let e=n.trim().toLowerCase();return e?e.startsWith("/")?e.slice(1):e:""}};var be=class{constructor(n){this.collapsed=!1;this.entries=[];this.turnStatus="idle";this.cleanupTimer=null;this.containerEl=n,this.containerEl.addClass("codexidian-status-panel"),this.headerEl=this.containerEl.createDiv({cls:"codexidian-status-header"}),this.currentEl=this.headerEl.createDiv({cls:"codexidian-status-current",text:o("idle")}),this.arrowEl=this.headerEl.createSpan({cls:"status-arrow",text:"\u25BE"}),this.entriesEl=this.containerEl.createDiv({cls:"codexidian-status-entries"}),this.headerEl.addEventListener("click",()=>this.toggleCollapsed()),this.render()}setTurnStatus(n){this.turnStatus=n,n==="idle"&&this.clearFinishedAfterDelay(3e3),this.render()}addEntry(n){let e={...n,detail:this.normalizeDetail(n.detail),timestamp:Date.now()},t=this.entries.findIndex(i=>i.id===e.id);if(t>=0){let i=this.entries[t];this.entries[t]={...i,...e,timestamp:i.timestamp}}else this.entries.push(e);this.entries.sort((i,s)=>s.timestamp-i.timestamp),this.entries.length>5&&(this.entries=this.entries.slice(0,5)),this.render()}updateEntry(n,e){var a,l,d;let t=this.entries.findIndex(p=>p.id===n);if(t<0)return;let i=this.entries[t],s=(a=e.status)!=null?a:i.status,r=(l=e.duration)!=null?l:s==="running"?i.duration:Date.now()-i.timestamp;this.entries[t]={...i,...e,id:i.id,timestamp:i.timestamp,detail:this.normalizeDetail((d=e.detail)!=null?d:i.detail),duration:r,status:s},this.render()}clearFinishedAfterDelay(n=3e3){this.cleanupTimer!==null&&window.clearTimeout(this.cleanupTimer),this.cleanupTimer=window.setTimeout(()=>{this.cleanupTimer=null,this.entries=this.entries.filter(e=>e.status==="running"),this.render()},n)}clear(){this.entries=[],this.cleanupTimer!==null&&(window.clearTimeout(this.cleanupTimer),this.cleanupTimer=null),this.render()}destroy(){this.cleanupTimer!==null&&(window.clearTimeout(this.cleanupTimer),this.cleanupTimer=null),this.containerEl.empty()}refreshLocale(){this.render()}toggleCollapsed(){this.collapsed=!this.collapsed,this.render()}render(){let n=this.getCurrentStatusText();this.currentEl.setText(n),this.currentEl.toggleClass("is-active",this.turnStatus!=="idle"),this.containerEl.toggleClass("is-collapsed",this.collapsed),this.arrowEl.setText(this.collapsed?"\u25B8":"\u25BE"),this.renderEntries();let e=this.turnStatus!=="idle"||this.entries.length>0;this.containerEl.toggleClass("is-active",e)}renderEntries(){this.entriesEl.empty();for(let n of this.entries){let e=this.entriesEl.createDiv({cls:`codexidian-status-entry codexidian-status-entry--${n.status}`});e.createSpan({cls:"codexidian-status-entry-icon",text:this.statusIcon(n.status)}),e.createSpan({cls:"entry-label",text:this.entryTypeLabel(n.type)});let t=e.createSpan({cls:"entry-detail"}),i=n.detail?`${n.label}: ${n.detail}`:n.label;t.setText(i),t.title=i,n.status!=="running"&&e.createSpan({cls:"entry-duration",text:this.formatDuration(n.duration)})}}getCurrentStatusText(){return this.turnStatus==="idle"?o("idle"):this.turnStatus==="thinking"?o("statusThinking"):this.turnStatus==="streaming"?o("statusStreaming"):this.turnStatus==="waiting_approval"?o("statusWaitingApproval"):this.entries.find(e=>e.type==="tool_call"&&e.status==="running")?o("statusRunningTool"):o("statusRunningGeneric")}entryTypeLabel(n){return n==="tool_call"?o("statusTypeTool"):n==="thinking"?o("statusTypeThinking"):n==="subagent"?o("statusTypeAgent"):o("statusTypeInfo")}statusIcon(n){return n==="running"?"\u23F3":n==="completed"?"\u2705":"\u274C"}formatDuration(n){return!n||n<0?"":n<1e3?`${n}ms`:`${(n/1e3).toFixed(1)}s`}normalizeDetail(n){if(!n)return;let e=n.replace(/\s+/g," ").trim();if(e)return e.length<=80?e:`${e.slice(0,80)}...`}};var xe=class{constructor(n,e={}){this.collapsed=!1;this.diffs=[];this.comments=[];this.selectedDiffPath=null;this.options=e,this.containerEl=n,this.containerEl.addClass("codexidian-review-pane"),this.headerEl=this.containerEl.createDiv({cls:"codexidian-review-header"});let t=this.headerEl.createDiv({cls:"codexidian-review-header-left"});this.titleEl=t.createSpan({cls:"codexidian-review-title"}),this.countBadgeEl=t.createSpan({cls:"codexidian-review-count"}),this.arrowEl=this.headerEl.createSpan({cls:"codexidian-review-arrow"}),this.bodyEl=this.containerEl.createDiv({cls:"codexidian-review-body"}),this.diffsEl=this.bodyEl.createDiv({cls:"codexidian-review-diffs"}),this.commentsEl=this.bodyEl.createDiv({cls:"codexidian-review-comments"});let i=this.bodyEl.createDiv({cls:"codexidian-review-add"});this.scopeInputEl=i.createEl("input",{cls:"codexidian-review-scope-input",attr:{type:"text"}}),this.commentInputEl=i.createEl("input",{cls:"codexidian-review-comment-input",attr:{type:"text"}}),this.addBtnEl=i.createEl("button",{cls:"codexidian-review-add-btn"}),this.addBtnEl.type="button",this.headerEl.addEventListener("click",()=>{this.collapsed=!this.collapsed,this.render()}),this.addBtnEl.addEventListener("click",()=>this.addCommentFromInputs()),this.commentInputEl.addEventListener("keydown",s=>{s.key!=="Enter"||s.shiftKey||s.isComposing||(s.preventDefault(),s.stopPropagation(),this.addCommentFromInputs())}),this.render()}setDiffs(n){var s,r,a;let e=[],t=new Set;for(let l of n){let d=typeof(l==null?void 0:l.filePath)=="string"?l.filePath.trim():"";if(!d)continue;let p=d.toLowerCase();t.has(p)||(t.add(p),e.push({filePath:d,status:l.status,summary:((s=l.summary)==null?void 0:s.trim())||void 0}))}this.diffs=e,this.selectedDiffPath&&this.diffs.some(l=>l.filePath===this.selectedDiffPath)||(this.selectedDiffPath=(a=(r=this.diffs[0])==null?void 0:r.filePath)!=null?a:null),!this.scopeInputEl.value.trim()&&this.selectedDiffPath&&(this.scopeInputEl.value=this.selectedDiffPath),this.render()}addComment(n){var i;let e=n.text.trim();if(!e)return;let t={id:((i=n.id)==null?void 0:i.trim())||this.generateCommentId(),scope:n.scope.trim()||this.selectedDiffPath||"general",text:e,createdAt:Number.isFinite(n.createdAt)?n.createdAt:Date.now()};this.comments.push(t),this.notifyCommentsChanged(),this.render()}removeComment(n){let e=this.comments.filter(t=>t.id!==n);e.length!==this.comments.length&&(this.comments=e,this.notifyCommentsChanged(),this.render())}getComments(){return this.comments.map(n=>({...n}))}clearComments(){this.comments.length!==0&&(this.comments=[],this.notifyCommentsChanged(),this.render())}clear(){this.diffs=[],this.selectedDiffPath=null,this.scopeInputEl.value="",this.commentInputEl.value="",this.clearComments(),this.render()}destroy(){this.containerEl.empty()}refreshLocale(){this.render()}addCommentFromInputs(){var i;let n=this.commentInputEl.value.trim();if(!n)return;let e=this.selectedDiffPath||((i=this.diffs[0])==null?void 0:i.filePath)||"general",t=this.scopeInputEl.value.trim()||e;this.addComment({id:this.generateCommentId(),scope:t,text:n,createdAt:Date.now()}),this.commentInputEl.value="",this.scopeInputEl.value=t,this.commentInputEl.focus()}notifyCommentsChanged(){var n,e;try{(e=(n=this.options).onCommentsChanged)==null||e.call(n,this.getComments())}catch(t){}}render(){let n=this.diffs.length>0;this.containerEl.toggleClass("is-active",n),this.containerEl.toggleClass("is-collapsed",this.collapsed),this.titleEl.setText(o("reviewTitle")),this.countBadgeEl.setText(String(this.comments.length)),this.arrowEl.setText(this.collapsed?"\u25B8":"\u25BE"),this.scopeInputEl.placeholder=o("reviewScopePlaceholder"),this.commentInputEl.placeholder=o("reviewCommentPlaceholder"),this.addBtnEl.setText(o("reviewAddComment")),n&&(this.renderDiffs(),this.renderComments())}renderDiffs(){this.diffsEl.empty();let n=this.diffsEl.createDiv({cls:"codexidian-review-section-title",text:o("reviewDiffsTitle")});n.title=o("reviewDiffsTitle");for(let e of this.diffs){let t=this.diffsEl.createDiv({cls:`codexidian-review-diff-item codexidian-review-diff-item--${e.status}`});e.filePath===this.selectedDiffPath&&t.addClass("is-selected"),t.createSpan({cls:"codexidian-review-diff-icon",text:this.diffIcon(e.status)});let i=t.createSpan({cls:"codexidian-review-diff-path",text:e.filePath});if(i.title=e.filePath,t.createSpan({cls:"codexidian-review-diff-status",text:this.diffStatusLabel(e.status)}),e.summary){let s=t.createSpan({cls:"codexidian-review-diff-summary",text:e.summary});s.title=e.summary}t.addEventListener("click",()=>{this.selectedDiffPath=e.filePath,this.scopeInputEl.value=e.filePath,this.renderDiffs()})}}renderComments(){if(this.commentsEl.empty(),this.commentsEl.createDiv({cls:"codexidian-review-section-title",text:o("reviewCommentsTitle")}),this.comments.length===0){this.commentsEl.createDiv({cls:"codexidian-review-comment-empty",text:o("reviewCommentsEmpty")});return}for(let n of this.comments){let e=this.commentsEl.createDiv({cls:"codexidian-review-comment"}),t=e.createSpan({cls:"codexidian-review-comment-scope",text:n.scope});t.title=n.scope;let i=e.createSpan({cls:"codexidian-review-comment-text",text:n.text});i.title=n.text;let s=e.createEl("button",{cls:"codexidian-review-comment-remove",text:o("reviewCommentRemove")});s.type="button",s.addEventListener("click",r=>{r.preventDefault(),r.stopPropagation(),this.removeComment(n.id)})}}diffIcon(n){return n==="added"?"+":n==="deleted"?"-":"~"}diffStatusLabel(n){return n==="added"?o("reviewStatusAdded"):n==="deleted"?o("reviewStatusDeleted"):o("reviewStatusModified")}generateCommentId(){return`review-${Date.now()}-${Math.random().toString(36).slice(2,8)}`}};var ne=require("obsidian");var vt=["all","active","archived","pinned"],Ee=class extends ne.Modal{constructor(e,t){super(e);this.searchInputEl=null;this.filtersEl=null;this.listEl=null;this.emptyEl=null;this.filter="active";this.query="";this.sessions=[];this.selectedIndex=0;this.busy=!1;this.options=t}onOpen(){this.modalEl.addClass("codexidian-session-modal"),this.contentEl.empty(),this.contentEl.createEl("h2",{cls:"codexidian-session-title",text:o("sessionModalTitle")});let e=this.contentEl.createDiv({cls:"codexidian-session-search"});this.searchInputEl=e.createEl("input",{cls:"codexidian-session-search-input",attr:{type:"search"}}),this.searchInputEl.placeholder=o("sessionSearchPlaceholder"),this.searchInputEl.addEventListener("input",()=>{var t,i;this.query=(i=(t=this.searchInputEl)==null?void 0:t.value.trim())!=null?i:"",this.refreshSessions()}),this.filtersEl=this.contentEl.createDiv({cls:"codexidian-session-filters"}),this.renderFilters(),this.listEl=this.contentEl.createDiv({cls:"codexidian-session-list"}),this.emptyEl=this.contentEl.createDiv({cls:"codexidian-session-empty",text:o("sessionEmpty")}),this.contentEl.addEventListener("keydown",t=>{this.handleKeyboardNavigation(t)}),this.refreshSessions(),this.searchInputEl.focus()}onClose(){this.contentEl.empty(),this.sessions=[],this.searchInputEl=null,this.filtersEl=null,this.listEl=null,this.emptyEl=null}renderFilters(){if(this.filtersEl){this.filtersEl.empty();for(let e of vt){let t=this.filtersEl.createEl("button",{cls:"codexidian-session-filter-btn",text:this.getFilterLabel(e)});t.type="button",e===this.filter&&t.addClass("is-active"),t.addEventListener("click",()=>{this.busy||this.filter===e||(this.filter=e,this.selectedIndex=0,this.renderFilters(),this.refreshSessions())})}}}async refreshSessions(){if(!this.busy){this.setBusy(!0);try{let e=this.query?await this.options.searchConversations(this.query,this.filter):await this.options.listConversations(this.filter);this.sessions=e.map(t=>({...t,tags:Array.isArray(t.tags)?[...t.tags]:[]})).sort((t,i)=>{var r,a;let s=+!!i.pinned-+!!t.pinned;return s!==0?s:((r=i.updatedAt)!=null?r:0)-((a=t.updatedAt)!=null?a:0)}),this.selectedIndex>=this.sessions.length&&(this.selectedIndex=this.sessions.length>0?this.sessions.length-1:0)}catch(e){let t=e instanceof Error?e.message:String(e);new ne.Notice(y("sessionLoadFailed",{error:t})),this.sessions=[],this.selectedIndex=0}finally{this.setBusy(!1),this.renderList()}}}renderList(){if(!(!this.listEl||!this.emptyEl)){if(this.listEl.empty(),this.sessions.length===0){this.emptyEl.style.display="block";return}this.emptyEl.style.display="none",this.sessions.forEach((e,t)=>{var d;let i=(d=this.listEl)==null?void 0:d.createDiv({cls:"codexidian-session-item"});if(!i)return;i.dataset.index=String(t),t===this.selectedIndex&&i.addClass("is-selected");let s=i.createDiv({cls:"codexidian-session-item-info"}),r=s.createDiv({cls:"codexidian-session-item-title-row"});r.createDiv({cls:"codexidian-session-item-title",text:e.title}),e.pinned&&r.createSpan({cls:"codexidian-session-item-pin",text:"PIN"}),e.archived&&r.createSpan({cls:"codexidian-session-item-archived",text:o("sessionArchivedBadge")});let a=new Date(e.updatedAt||e.createdAt).toLocaleString();if(s.createDiv({cls:"codexidian-session-item-meta",text:y("sessionMetaLine",{date:a,count:e.messageCount})}),e.tags&&e.tags.length>0){let p=s.createDiv({cls:"codexidian-session-item-tags"});for(let c of e.tags)p.createSpan({cls:"codexidian-session-item-tag",text:c})}let l=i.createDiv({cls:"codexidian-session-item-actions"});this.createActionButton(l,o("sessionOpen"),async()=>{await this.options.onOpen(e),this.close()}),this.createActionButton(l,o("sessionFork"),async()=>{await this.options.onFork(e)}),this.createActionButton(l,e.pinned?o("sessionUnpin"):o("sessionPin"),async()=>{await this.options.onTogglePin(e,!e.pinned)}),this.createActionButton(l,e.archived?o("sessionUnarchive"):o("sessionArchive"),async()=>{await this.options.onToggleArchive(e,!e.archived)}),this.createActionButton(l,o("sessionDelete"),async()=>{window.confirm(y("sessionDeleteConfirm",{title:e.title}))&&await this.options.onDelete(e)},"is-danger"),i.addEventListener("click",()=>{this.selectedIndex=t,this.highlightSelection()}),i.addEventListener("dblclick",()=>{this.busy||this.runAction(async()=>{await this.options.onOpen(e),this.close()})})})}}createActionButton(e,t,i,s){let r=e.createEl("button",{cls:`codexidian-session-action-btn${s?` ${s}`:""}`,text:t});r.type="button",r.disabled=this.busy,r.addEventListener("click",a=>{a.preventDefault(),a.stopPropagation(),!this.busy&&this.runAction(i)})}async runAction(e){if(!this.busy){this.setBusy(!0);try{await e()}catch(t){let i=t instanceof Error?t.message:String(t);new ne.Notice(y("sessionActionFailed",{error:i}))}finally{this.setBusy(!1),this.listEl&&await this.refreshSessions()}}}handleKeyboardNavigation(e){if(e.key==="Escape"){e.preventDefault(),e.stopPropagation(),this.close();return}if(!(this.sessions.length===0||this.busy)){if(e.key==="ArrowDown"){e.preventDefault(),this.selectedIndex=Math.min(this.selectedIndex+1,this.sessions.length-1),this.highlightSelection();return}if(e.key==="ArrowUp"){e.preventDefault(),this.selectedIndex=Math.max(this.selectedIndex-1,0),this.highlightSelection();return}if(e.key==="Enter"){e.preventDefault();let t=this.sessions[this.selectedIndex];if(!t)return;this.runAction(async()=>{await this.options.onOpen(t),this.close()})}}}highlightSelection(){if(!this.listEl)return;Array.from(this.listEl.querySelectorAll(".codexidian-session-item")).forEach((t,i)=>{i===this.selectedIndex?(t.addClass("is-selected"),t.scrollIntoView({block:"nearest"})):t.removeClass("is-selected")})}setBusy(e){this.busy=e,this.modalEl.toggleClass("is-busy",e)}getFilterLabel(e){return e==="active"?o("sessionFilterActive"):e==="archived"?o("sessionFilterArchived"):e==="pinned"?o("sessionFilterPinned"):o("sessionFilterAll")}};var G=class{constructor(n){this.blockedPatterns=n.map(e=>this.normalizePattern(e)).filter(e=>!!e)}isBlocked(n){return this.getMatchedPattern(n)!==null}validate(n,e){let t=this.getMatchedPattern(n);return t?{allowed:!1,reason:`Path matches security blocklist (${t}) for ${e}.`}:{allowed:!0}}getMatchedPattern(n){var i;let e=this.normalizePath(n);if(!e)return null;let t=(i=e.split("/").pop())!=null?i:e;for(let s of this.blockedPatterns)if(this.matchesPattern(e,t,s))return s;return null}matchesPattern(n,e,t){if(t.includes("*")){let i=this.wildcardToRegex(t);return t.includes("/")?i.test(n):i.test(e)||i.test(n)}if(t.endsWith("/")){let i=`${t.replace(/\/+$/,"")}/`;return n.startsWith(i)||n.includes(`/${i}`)}return t.includes("/")?n===t||n.startsWith(`${t}/`):e===t||n===t||n.endsWith(`/${t}`)}wildcardToRegex(n){let e=n.replace(/[|\\{}()[\]^$+?.]/g,"\\$&").replace(/\*/g,".*");return new RegExp(`^${e}$`,"i")}normalizePattern(n){let e=n.trim();return e&&e.replace(/\\/g,"/").replace(/\/{2,}/g,"/").replace(/^\/+/,"").toLowerCase()||null}normalizePath(n){return n.trim().replace(/\\/g,"/").replace(/^\.\//,"").replace(/\/{2,}/g,"/").replace(/^\/+/,"").toLowerCase()}};var Q="codexidian-view",ie=class extends w.ItemView{constructor(e,t){super(e);this.plugin=t;this.attachBtn=null;this.imageFileInputEl=null;this.dropZoneEl=null;this.dropZoneTextEl=null;this.fileContext=null;this.imageContext=null;this.slashMenu=null;this.statusPanel=null;this.reviewPane=null;this.running=!1;this.messageQueue=[];this.currentTurnId=null;this.queueIndicatorEl=null;this.modelLabelEl=null;this.effortLabelEl=null;this.skillLabelEl=null;this.modeLabelEl=null;this.sendSequence=0;this.cancelledSendSequences=new Set;this.includeCurrentNoteContent=!1;this.availableSkills=[];this.reviewStateByTabId=new Map;this.planStateByTabId=new Map}getViewType(){return Q}getDisplayText(){return o("appTitle")}getIcon(){return"bot"}async onOpen(){let e=this.containerEl.children[1];e.empty(),this.vaultAdapter=new le(this.app),this.sessionStorage=new de(this.vaultAdapter);let t=null;try{await this.sessionStorage.init()}catch(h){t=h instanceof Error?h.message:String(h),new w.Notice(y("noticeStorageInitFailed",{error:t}))}this.messageRenderer=new ue(this.app,this,async h=>{await this.applyCodeToNote(h.code,h.language,h.triggerEl)}),this.thinkingRenderer=new pe,this.toolCallRenderer=new he,this.rootEl=e.createDiv({cls:"codexidian-view"});let i=this.rootEl.createDiv({cls:"codexidian-header"}),s=i.createDiv({cls:"codexidian-header-left"});this.titleEl=s.createDiv({cls:"codexidian-title",text:o("appTitle")}),this.statusEl=s.createDiv({cls:"codexidian-status",text:o("disconnected")});let r=i.createDiv({cls:"codexidian-tab-bar-container"}),a=i.createDiv({cls:"codexidian-header-right"});this.historyBtn=a.createEl("button",{cls:"codexidian-header-icon-btn"}),this.newThreadBtn=a.createEl("button",{cls:"codexidian-header-icon-btn"}),this.restartBtn=a.createEl("button",{cls:"codexidian-header-icon-btn"}),this.historyBtn.type="button",this.newThreadBtn.type="button",this.restartBtn.type="button",this.updateHeaderButtons(),this.messagesContainer=this.rootEl.createDiv({cls:"codexidian-messages-container"}),this.contextRowEl=this.rootEl.createDiv({cls:"codexidian-context-row"}),this.noteContextEl=this.contextRowEl.createDiv({cls:"codexidian-note-context"}),this.noteContextTextEl=this.noteContextEl.createSpan({cls:"codexidian-note-context-text"}),this.noteContextToggleEl=this.noteContextEl.createEl("button",{cls:"codexidian-note-context-toggle"}),this.noteContextToggleEl.addEventListener("click",()=>{this.includeCurrentNoteContent=!this.includeCurrentNoteContent,this.updateNoteContextToggle()}),this.selectionContextEl=this.contextRowEl.createDiv({cls:"codexidian-selection-context"}),this.updateNoteContextToggle();let l=this.rootEl.createDiv({cls:"codexidian-status-panel"});if(this.statusPanel=new be(l),this.plugin.settings.enableReviewPane){let h=this.rootEl.createDiv({cls:"codexidian-review-pane-host"});this.reviewPane=new xe(h,{onCommentsChanged:A=>this.handleReviewCommentsChanged(A)})}let d=this.rootEl.createDiv({cls:"codexidian-footer"}),p=d.createDiv({cls:"codexidian-file-chips-container"}),c=d.createDiv({cls:"codexidian-image-previews-container"}),u=d.createDiv({cls:"codexidian-input-wrapper"});this.inputEl=u.createEl("textarea",{cls:"codexidian-input"}),this.inputEl.placeholder=o("askPlaceholder"),this.slashMenu=new Ce(u),this.registerBuiltinSlashCommands(),this.imageFileInputEl=d.createEl("input",{cls:"codexidian-attach-file-input",attr:{type:"file"}}),this.imageFileInputEl.accept="image/*",this.imageFileInputEl.multiple=!0;let g=d.createDiv({cls:"codexidian-toolbar"}),v=g.createDiv({cls:"codexidian-toolbar-group"});this.modelLabelEl=v.createSpan({cls:"codexidian-toolbar-label",text:o("model")}),this.modelSelect=v.createEl("select",{cls:"codexidian-toolbar-select"});for(let h of j){let A=this.modelSelect.createEl("option",{text:h.label,value:h.value});h.value===this.plugin.settings.model&&(A.selected=!0)}this.modelSelect.addEventListener("change",()=>{this.plugin.settings.model=this.modelSelect.value,this.plugin.saveSettings()});let m=g.createDiv({cls:"codexidian-toolbar-group"});this.effortLabelEl=m.createSpan({cls:"codexidian-toolbar-label",text:o("effort")}),this.effortSelect=m.createEl("select",{cls:"codexidian-toolbar-select"});for(let h of K){let A=this.effortSelect.createEl("option",{text:h.label,value:h.value});h.value===this.plugin.settings.thinkingEffort&&(A.selected=!0)}this.effortSelect.addEventListener("change",()=>{this.plugin.settings.thinkingEffort=this.effortSelect.value,this.plugin.saveSettings()});let f=g.createDiv({cls:"codexidian-toolbar-group"});this.skillLabelEl=f.createSpan({cls:"codexidian-toolbar-label",text:o("skill")}),this.skillMenuBtn=f.createEl("button",{cls:"codexidian-toolbar-select codexidian-toolbar-menu-btn",text:this.getSkillPresetLabel(this.plugin.settings.skillPreset)}),this.skillMenuBtn.type="button",this.skillMenuBtn.addEventListener("click",h=>{this.openSkillMenu(h)});let x=g.createDiv({cls:"codexidian-toolbar-group codexidian-toolbar-attach-group"});this.attachBtn=x.createEl("button",{cls:"codexidian-attach-btn",text:"\u{1F4C1}"}),this.attachBtn.type="button",this.attachBtn.setAttr("aria-label",o("attachImage")),this.attachBtn.setAttr("title",o("attachImage"));let T=g.createDiv({cls:"codexidian-toolbar-group"});this.modeLabelEl=T.createSpan({cls:"codexidian-toolbar-label",text:o("mode")}),this.modeMenuBtn=T.createEl("button",{cls:"codexidian-toolbar-select codexidian-toolbar-menu-btn",text:this.getApprovalModeLabel(this.plugin.settings.approvalMode)}),this.modeMenuBtn.type="button",this.modeMenuBtn.addEventListener("click",h=>{this.openApprovalModeMenu(h)}),g.createDiv({cls:"codexidian-toolbar-spacer"}),this.sendBtn=g.createEl("button",{cls:"codexidian-send-btn"}),this.sendBtn.type="button",this.updateSendButton(),this.queueIndicatorEl=d.createDiv({cls:"codexidian-queue-indicator"}),this.updateQueueIndicator(),this.dropZoneEl=this.rootEl.createDiv({cls:"codexidian-drop-zone"}),this.dropZoneTextEl=this.dropZoneEl.createDiv({cls:"codexidian-drop-zone-text",text:o("dropImagesHere")}),this.tabBar=new fe(r,{maxTabs:this.plugin.settings.maxTabs,onSelect:h=>this.tabManager.switchTo(h),onClose:h=>this.closeTabWithReviewState(h),onAdd:()=>this.createNewTab()}),this.tabManager=new ye(this.tabBar,this.messagesContainer,()=>new me(this.sessionStorage,this.messageRenderer),this.plugin.client,h=>this.onTabSwitched(h)),this.selectionController=new ve(this.app),this.selectionController.setEnabled(this.plugin.settings.enableSelectionPolling),this.selectionController.setOnContextChanged(()=>this.updateContextRowVisibility()),this.selectionController.start(this.selectionContextEl);try{this.fileContext=new Te(this.app,p,this.inputEl)}catch(h){let A=h instanceof Error?h.message:String(h);new w.Notice(y("noticeFileContextInitFailed",{error:A})),this.fileContext=null}try{this.imageContext=new we(c,this.inputEl,{dropTargetEl:this.rootEl,onDropZoneActiveChange:h=>this.setDropZoneActive(h),onLimitReached:h=>new w.Notice(y("noticeAttachmentLimitReached",{max:h})),onFilesIgnored:()=>new w.Notice(o("noticeImageOnlyAttachments")),onReadFailure:()=>new w.Notice(o("noticeImageReadFailed"))})}catch(h){let A=h instanceof Error?h.message:String(h);new w.Notice(y("noticeImageContextInitFailed",{error:A})),this.imageContext=null}this.registerEvent(this.app.workspace.on("active-leaf-change",()=>{this.refreshCurrentNoteContext()})),this.registerEvent(this.app.workspace.on("file-open",()=>{this.refreshCurrentNoteContext()})),this.refreshCurrentNoteContext();try{await this.restoreTabsWithFallback(),this.ensureReviewStateForAllTabs(),this.ensurePlanStateForAllTabs();let h=this.tabManager.getActiveTab();h&&(await this.ensureConversationReady(h),this.applyReviewStateToPane(h.state.tabId),this.renderPlanCardForTab(h.state.tabId))}catch(h){let A=h instanceof Error?h.message:String(h);new w.Notice(y("noticeRestoreTabsFailed",{error:A})),this.tabManager.getActiveTab()||await this.createNewTab()}if(t){let h=this.tabManager.getActiveTab();h&&this.appendSystemMessageToPanel(h.panelEl,y("noticeStorageInitFailed",{error:t}))}try{await this.refreshAvailableSkills()}catch(h){this.debugError("onOpen:refreshAvailableSkills",h)}this.updateSkillButtonText(),this.updateModeButtonText(),this.autoResizeInput(),this.bindEvents(),this.updateStatus()}async onClose(){var e,t,i,s,r,a,l,d,p;try{let c=this.plugin.settings;this.tabManager&&(c._tabManagerState=this.tabManager.getState()),await this.plugin.saveSettings()}catch(c){let u=c instanceof Error?c.message:String(c);new w.Notice(y("noticePersistTabStateFailed",{error:u}))}(e=this.selectionController)==null||e.stop(),(t=this.selectionController)==null||t.setOnContextChanged(null),(i=this.fileContext)==null||i.destroy(),this.fileContext=null,(s=this.imageContext)==null||s.destroy(),this.imageContext=null,(r=this.slashMenu)==null||r.destroy(),this.slashMenu=null,(a=this.messageRenderer)==null||a.destroy(),(l=this.statusPanel)==null||l.destroy(),this.statusPanel=null,(d=this.reviewPane)==null||d.destroy(),this.reviewPane=null,this.reviewStateByTabId.clear(),this.planStateByTabId.clear(),(p=this.tabManager)==null||p.destroy(),this.setDropZoneActive(!1),this.dropZoneTextEl=null,this.dropZoneEl=null,this.attachBtn=null,this.imageFileInputEl=null}bindEvents(){var e,t;this.sendBtn.addEventListener("click",()=>{this.sendCurrentInput().catch(i=>this.handleUnhandledSendError(i))}),(e=this.attachBtn)==null||e.addEventListener("click",()=>{var i;(i=this.imageFileInputEl)==null||i.click()}),(t=this.imageFileInputEl)==null||t.addEventListener("change",()=>{var s;let i=(s=this.imageFileInputEl)==null?void 0:s.files;!i||i.length===0||(this.handleImageFileSelection(i),this.imageFileInputEl&&(this.imageFileInputEl.value=""))}),this.inputEl.addEventListener("input",()=>{this.autoResizeInput(),this.handleSlashInputChanged()}),this.inputEl.addEventListener("keydown",i=>{var r,a;if((i.key==="Enter"||i.code==="Enter"||i.code==="NumpadEnter")&&this.debugLog("Enter pressed",{key:i.key,code:i.code,ctrlKey:i.ctrlKey,metaKey:i.metaKey,shiftKey:i.shiftKey,isComposing:i.isComposing,slashMenuVisible:((r=this.slashMenu)==null?void 0:r.isVisible())||!1,running:this.running,inputDisabled:this.inputEl.disabled}),(a=this.slashMenu)!=null&&a.isVisible()){if(i.key==="ArrowDown"){i.preventDefault(),i.stopPropagation(),this.slashMenu.selectNext();return}if(i.key==="ArrowUp"){i.preventDefault(),i.stopPropagation(),this.slashMenu.selectPrev();return}if(i.key==="Enter"){i.preventDefault(),i.stopPropagation(),this.executeSelectedSlashCommand();return}if(i.key==="Escape"){i.preventDefault(),i.stopPropagation(),this.slashMenu.hide();return}}if(i.key==="Escape"&&this.running){i.preventDefault(),i.stopPropagation(),this.cancelCurrentStream();return}(i.key==="Enter"||i.code==="Enter"||i.code==="NumpadEnter")&&!i.shiftKey&&!i.isComposing&&((i.ctrlKey||i.metaKey)&&console.log("[CODEXIDIAN DEBUG] Ctrl+Enter captured in input keydown"),i.preventDefault(),i.stopPropagation(),this.sendCurrentInput().catch(l=>this.handleUnhandledSendError(l)))}),this.newThreadBtn.addEventListener("click",()=>{this.startNewThread()}),this.restartBtn.addEventListener("click",()=>{this.restartEngine()}),this.historyBtn.addEventListener("click",()=>this.openSessionModal())}async handleImageFileSelection(e){var t;try{await((t=this.imageContext)==null?void 0:t.addFiles(e)),this.inputEl.focus()}catch(i){this.debugError("handleImageFileSelection",i),new w.Notice(o("noticeImageReadFailed"))}}setDropZoneActive(e){this.dropZoneEl&&(e?this.dropZoneEl.addClass("is-active"):this.dropZoneEl.removeClass("is-active"))}registerBuiltinSlashCommands(){if(!this.slashMenu)return;let e=t=>{var i;(i=this.slashMenu)==null||i.registerCommand({...t,execute:async()=>{var s;this.setInputValue(""),(s=this.slashMenu)==null||s.hide(),await t.execute(),this.inputEl.focus()}})};e({name:"new",label:o("cmdNewLabel"),description:o("cmdNewDesc"),icon:"\u2795",execute:async()=>{if(this.tabManager.getAllTabStates().length>=this.plugin.settings.maxTabs){new w.Notice(y("noticeCannotCreateTabMax",{max:this.plugin.settings.maxTabs}));return}await this.createNewTab()}}),e({name:"clear",label:o("cmdClearLabel"),description:o("cmdClearDesc"),icon:"\u{1F9F9}",execute:async()=>{await this.clearCurrentConversationMessages()}}),e({name:"model",label:o("cmdModelLabel"),description:o("cmdModelDesc"),icon:"\u{1F916}",execute:async()=>{await this.cycleModelSetting()}}),e({name:"effort",label:o("cmdEffortLabel"),description:o("cmdEffortDesc"),icon:"\u{1F9E0}",execute:async()=>{await this.cycleEffortSetting()}}),e({name:"history",label:o("cmdHistoryLabel"),description:o("cmdHistoryDesc"),icon:"\u{1F558}",execute:()=>{this.openSessionModal()}}),e({name:"tabs",label:o("cmdTabsLabel"),description:o("cmdTabsDesc"),icon:"\u{1F5C2}",execute:()=>{this.showTabsSummary()}}),e({name:"help",label:o("cmdHelpLabel"),description:o("cmdHelpDesc"),icon:"\u2753",execute:()=>{this.showSlashCommandHelp()}})}handleSlashInputChanged(){if(!this.slashMenu)return;let e=this.inputEl.value;if(!e.startsWith("/")){this.slashMenu.hide();return}let t=this.extractSlashFilter(e);this.slashMenu.show(t)}async executeSelectedSlashCommand(){var t;await((t=this.slashMenu)==null?void 0:t.executeSelected())&&(this.setInputValue(""),this.inputEl.focus())}async executeSlashCommandByName(e){var i,s;return await((i=this.slashMenu)==null?void 0:i.executeByName(e))?(this.setInputValue(""),(s=this.slashMenu)==null||s.hide(),this.inputEl.focus(),!0):!1}extractSlashFilter(e){if(!e.startsWith("/"))return"";let t=e.slice(1).trimStart(),[i]=t.split(/\s+/,1);return(i!=null?i:"").trim().toLowerCase()}extractSlashCommandName(e){if(!e.startsWith("/"))return null;let t=this.extractSlashFilter(e);return t.length>0?t:null}async clearCurrentConversationMessages(){var i,s;let e=this.tabManager.getActiveTab();if(!e){new w.Notice(o("noticeNoActiveTabToClear"));return}await this.ensureConversationReady(e)&&(e.panelEl.empty(),e.conversationController.setMessages([]),(i=this.statusPanel)==null||i.clear(),this.setReviewStateForTab(e.state.tabId,[]),this.setPlanForTab(e.state.tabId,null),(s=this.reviewPane)==null||s.clearComments(),new w.Notice(o("noticeClearedConversation")))}async cycleModelSetting(){let e=this.plugin.settings.model,t=j.findIndex(r=>r.value===e),i=t>=0?t:0,s=j[(i+1)%j.length];this.plugin.settings.model=s.value,this.modelSelect.value=s.value,await this.plugin.saveSettings(),this.updateStatus(),new w.Notice(y("noticeModelSet",{model:s.label}))}async cycleEffortSetting(){let e=K.map(a=>a.value),t=this.plugin.settings.thinkingEffort,i=e.indexOf(t),s=i>=0?i:0,r=K[(s+1)%K.length];this.plugin.settings.thinkingEffort=r.value,this.effortSelect.value=r.value,await this.plugin.saveSettings(),this.updateStatus(),new w.Notice(y("noticeEffortSet",{effort:r.label}))}async refreshAvailableSkills(){try{this.availableSkills=await this.plugin.refreshAvailableSkills()}catch(e){this.availableSkills=this.plugin.getAvailableSkills()}}getSkillPresetLabel(e){let t=e.trim();return!t||t==="none"?o("skillPresetNone"):t}getApprovalModeLabel(e){var i;let t=Z.find(s=>s.value===e);return(i=t==null?void 0:t.label)!=null?i:"Prompt"}updateSkillButtonText(){if(!this.skillMenuBtn)return;let e=this.getSkillPresetLabel(this.plugin.settings.skillPreset);this.skillMenuBtn.setText(e),this.skillMenuBtn.setAttribute("aria-label",`${o("skill")}: ${e}`)}updateModeButtonText(){if(!this.modeMenuBtn)return;let e=this.getApprovalModeLabel(this.plugin.settings.approvalMode);this.modeMenuBtn.setText(e),this.modeMenuBtn.setAttribute("aria-label",`${o("mode")}: ${e}`)}async openSkillMenu(e){await this.refreshAvailableSkills();let t=new w.Menu,i=["none",...this.availableSkills];this.plugin.settings.skillPreset!=="none"&&this.plugin.settings.skillPreset.trim().length>0&&!i.includes(this.plugin.settings.skillPreset)&&i.push(this.plugin.settings.skillPreset);for(let s of i){let r=this.getSkillPresetLabel(s);t.addItem(a=>{a.setTitle(r),this.plugin.settings.skillPreset===s&&a.setChecked(!0),a.onClick(()=>{this.plugin.settings.skillPreset=s,this.updateSkillButtonText(),this.plugin.saveSettings(),new w.Notice(y("noticeSkillSet",{skill:r}))})})}t.showAtMouseEvent(e)}openApprovalModeMenu(e){let t=new w.Menu;for(let i of Z){let s=`${i.label} (${i.description})`;t.addItem(r=>{r.setTitle(s),this.plugin.settings.approvalMode===i.value&&r.setChecked(!0),r.onClick(()=>{this.plugin.settings.approvalMode=i.value,this.updateModeButtonText(),this.plugin.saveSettings(),new w.Notice(y("noticeCollaborationModeSet",{mode:i.label}))})})}t.showAtMouseEvent(e)}showTabsSummary(){var s,r;let e=this.tabManager.getAllTabStates();if(e.length===0){this.appendSystemMessage(o("messageNoTabsOpen"));return}let t=(r=(s=this.tabManager.getActiveTab())==null?void 0:s.state.tabId)!=null?r:null,i=e.map((a,l)=>{let d=a.tabId===t?"*":"",p=a.tabId.slice(-4),c=a.conversationId?a.conversationId.slice(-6):"none";return`${d}${l+1}[${p}] conv:${c}`}).join(" | ");this.appendSystemMessage(y("messageTabsSummary",{count:e.length,max:this.plugin.settings.maxTabs,summary:i}))}showSlashCommandHelp(){var i,s;let e=(s=(i=this.slashMenu)==null?void 0:i.getCommands())!=null?s:[];if(e.length===0){this.appendSystemMessage(o("messageNoSlashCommands"));return}let t=e.map(r=>`/${r.name}: ${r.description}`).join(" | ");this.appendSystemMessage(y("messageAvailableSlashCommands",{list:t}))}updateQueueIndicator(){if(!this.queueIndicatorEl)return;let e=this.messageQueue.length;if(e<=0){this.queueIndicatorEl.removeClass("visible"),this.queueIndicatorEl.setText("");return}this.queueIndicatorEl.setText(e===1?y("messageQueuedCount",{count:e}):y("messageQueuedCountPlural",{count:e})),this.queueIndicatorEl.addClass("visible")}async cancelCurrentStream(){var s,r,a,l;if(!this.running)return;let e=this.sendSequence;this.cancelledSendSequences.add(e);let t=(s=this.currentTurnId)!=null?s:this.plugin.client.getCurrentTurnId();this.currentTurnId=t;let i=(r=this.tabManager)==null?void 0:r.getActiveTab();i&&(this.tabBar.setStreaming(i.state.tabId,!1),this.appendSystemMessageToPanel(i.panelEl,o("messageCancelledByUser"))),this.running=!1,this.updateStatus(),(a=this.statusPanel)==null||a.setTurnStatus("idle"),(l=this.statusPanel)==null||l.clearFinishedAfterDelay(3e3);try{t&&await this.plugin.client.cancelTurn(t)}catch(d){let p=d instanceof Error?d.message:String(d);i&&this.appendSystemMessageToPanel(i.panelEl,y("messageCancelRequestFailed",{error:p}))}finally{this.currentTurnId=null}try{await this.processQueue()}catch(d){let p=d instanceof Error?d.message:String(d);new w.Notice(y("noticeProcessQueueFailed",{error:p}))}}async processQueue(){var t;if(this.running)return;let e=this.messageQueue.shift();if(this.updateQueueIndicator(),!!e)try{await this.sendCurrentInput(e)}catch(i){let s=i instanceof Error?i.message:String(i),r=(t=this.tabManager)==null?void 0:t.getActiveTab();r&&this.appendSystemMessageToPanel(r.panelEl,y("messageQueuedSendFailed",{error:s}))}}closeTabWithReviewState(e){var i,s;this.tabManager.closeTab(e),this.reviewStateByTabId.delete(e),this.planStateByTabId.delete(e);let t=(i=this.tabManager.getActiveTab())==null?void 0:i.state.tabId;t?(this.applyReviewStateToPane(t),this.renderPlanCardForTab(t)):(s=this.reviewPane)==null||s.clear()}ensureReviewStateForAllTabs(){for(let e of this.tabManager.getAllTabStates())this.ensureReviewState(e.tabId)}ensurePlanStateForAllTabs(){for(let e of this.tabManager.getAllTabStates())this.ensurePlanState(e.tabId)}ensureReviewState(e){let t=this.reviewStateByTabId.get(e);if(t)return t;let i={diffs:[],comments:[]};return this.reviewStateByTabId.set(e,i),i}ensurePlanState(e){var t;return this.planStateByTabId.has(e)?(t=this.planStateByTabId.get(e))!=null?t:null:(this.planStateByTabId.set(e,null),null)}applyReviewStateToPane(e){let t=this.ensureReviewState(e);if(!this.reviewPane)return;let i=t.comments.map(s=>({...s}));this.reviewPane.setDiffs(t.diffs),this.reviewPane.clearComments();for(let s of i)this.reviewPane.addComment(s)}setReviewStateForTab(e,t){var s,r;let i=this.ensureReviewState(e);i.diffs=t.map(a=>({...a})),((s=this.tabManager.getActiveTab())==null?void 0:s.state.tabId)===e&&((r=this.reviewPane)==null||r.setDiffs(i.diffs))}handleReviewCommentsChanged(e){let t=this.tabManager.getActiveTab();if(!t)return;let i=this.ensureReviewState(t.state.tabId);i.comments=e.map(s=>({...s}))}consumeReviewCommentsForActiveTab(){var s;let e=this.tabManager.getActiveTab();if(!e)return[];let t=this.ensureReviewState(e.state.tabId),i=t.comments.map(r=>({...r}));return t.comments=[],this.reviewPane&&e.state.tabId===((s=this.tabManager.getActiveTab())==null?void 0:s.state.tabId)&&this.reviewPane.clearComments(),i}setPlanForTab(e,t){this.planStateByTabId.set(e,t?this.clonePlan(t):null),this.renderPlanCardForTab(e)}getPlanForTab(e){var t;return(t=this.planStateByTabId.get(e))!=null?t:null}clonePlan(e){return{...e,steps:e.steps.map(t=>({...t}))}}getOrCreatePlanCardHost(e){let t=e.querySelector(".codexidian-plan-card-host");return t||e.createDiv({cls:"codexidian-plan-card-host"})}renderPlanCardForTab(e){let t=this.tabManager.getTab(e);if(!t)return;let i=this.getOrCreatePlanCardHost(t.panelEl),s=this.getPlanForTab(e);if(!s){i.empty(),i.remove();return}ge.render(i,s,{onApproveAll:async()=>{await this.handlePlanApproveAll(e)},onGiveFeedback:async()=>{await this.handlePlanFeedback(e)},onExecuteNext:async()=>{await this.handlePlanExecuteNext(e)}})}updatePlanForTab(e,t){let i=this.getPlanForTab(e);if(!i)return;let s=this.clonePlan(i);t(s),this.setPlanForTab(e,s)}async handlePlanApproveAll(e){this.updatePlanForTab(e,t=>{t.status="approved";for(let i of t.steps)i.status==="pending"&&(i.status="approved")});try{await this.sendCurrentInput(o("planApprovedProceedMessage"))}catch(t){this.debugError("handlePlanApproveAll",t,{tabId:e})}}async handlePlanFeedback(e){let t=window.prompt(o("planFeedbackPrompt"),"");if(t===null)return;let i=t.trim();if(!i)return;let s=`${o("planFeedbackMessagePrefix")}:
${i}`;try{await this.sendCurrentInput(s)}catch(r){this.debugError("handlePlanFeedback",r,{tabId:e})}}async handlePlanExecuteNext(e){let t=this.getPlanForTab(e);if(!t)return;let i=t.steps.find(s=>s.status==="approved"||s.status==="pending");if(i){this.updatePlanForTab(e,s=>{let r=s.steps.find(a=>a.id===i.id);r&&(r.status="executing",s.status!=="completed"&&(s.status="in_progress"))});try{await this.sendCurrentInput(y("planExecuteStepMessage",{index:i.index,description:i.description})),this.updatePlanForTab(e,s=>{let r=s.steps.find(l=>l.id===i.id);if(!r)return;r.status="completed";let a=s.steps.some(l=>l.status==="approved"||l.status==="pending"||l.status==="executing");s.status=a?"in_progress":"completed"})}catch(s){this.debugError("handlePlanExecuteNext",s,{tabId:e,stepId:i.id}),this.updatePlanForTab(e,r=>{let a=r.steps.find(l=>l.id===i.id);a&&(a.status="failed")})}}}async createNewTab(){let e=this.tabManager.addTab();this.ensureReviewState(e.state.tabId),this.ensurePlanState(e.state.tabId);try{let t=await e.conversationController.createNew();this.tabManager.setConversationId(e.state.tabId,t.id)}catch(t){let i=t instanceof Error?t.message:String(t);this.appendSystemMessageToPanel(e.panelEl,y("messageFailedInitConversation",{error:i}))}this.appendSystemMessageToPanel(e.panelEl,o("messageReadyHint"))}async restoreTabConversation(e){if(!e.state.conversationId){await this.ensureConversationReady(e);return}try{let t=await e.conversationController.switchTo(e.state.conversationId);if(!t){this.tabManager.setConversationId(e.state.tabId,null),await this.ensureConversationReady(e);return}await this.renderConversationMessages(e.panelEl,t.messages),t.threadId&&this.plugin.client.setThreadId(t.threadId)}catch(t){this.tabManager.setConversationId(e.state.tabId,null),await this.ensureConversationReady(e)}}onTabSwitched(e){this.ensureReviewState(e.state.tabId),this.applyReviewStateToPane(e.state.tabId),this.ensurePlanState(e.state.tabId),this.renderPlanCardForTab(e.state.tabId),this.updateStatus(),e.panelEl.scrollTop=e.panelEl.scrollHeight}async ensureConversationReady(e){let t=e.conversationController.getActive();if(t)return(!e.state.conversationId||e.state.conversationId!==t.id)&&this.tabManager.setConversationId(e.state.tabId,t.id),!0;try{let i=await e.conversationController.createNew();return this.tabManager.setConversationId(e.state.tabId,i.id),!0}catch(i){let s=i instanceof Error?i.message:String(i);return this.appendSystemMessageToPanel(e.panelEl,y("messageFailedInitConversation",{error:s})),new w.Notice(y("noticeCodexError",{error:s})),!1}}handleUnhandledSendError(e){var s,r,a;let t=e instanceof Error?e.message:String(e);this.debugError("handleUnhandledSendError",e);let i=(s=this.tabManager)==null?void 0:s.getActiveTab();i&&this.appendSystemMessageToPanel(i.panelEl,y("messageRequestFailed",{error:t})),new w.Notice(y("noticeCodexError",{error:t})),this.running=!1,this.currentTurnId=null,(r=this.statusPanel)==null||r.setTurnStatus("idle"),(a=this.statusPanel)==null||a.clearFinishedAfterDelay(3e3),this.updateStatus()}async sendCurrentInput(e){var Be,$e,He,qe,Oe,Ue,ze,Ve,_e,We;this.debugLog("sendCurrentInput:entry",{hasOverride:e!==void 0,running:this.running,queueLength:this.messageQueue.length});let i=(e!=null?e:this.inputEl.value).trim();if(!i){this.debugLog("sendCurrentInput:skip-empty");return}let s=this.extractSlashCommandName(i);if(s&&await this.executeSlashCommandByName(s)){this.debugLog("sendCurrentInput:slash-executed",{slashCommandName:s}),e===void 0&&this.setInputValue("");return}if(this.running){this.messageQueue.push(i),this.debugLog("sendCurrentInput:queued",{queueLength:this.messageQueue.length}),e===void 0&&this.setInputValue(""),this.updateQueueIndicator();return}if(!this.tabManager)return;let r=this.tabManager.getActiveTab();if(r||(this.debugLog("sendCurrentInput:no-active-tab, creating"),await this.createNewTab(),r=this.tabManager.getActiveTab()),!r){this.debugLog("sendCurrentInput:abort-no-tab");return}if(!await this.ensureConversationReady(r)){this.debugLog("sendCurrentInput:abort-conversation-not-ready");return}let l=r.conversationController;e===void 0&&this.setInputValue("");let d=null;try{d=this.getCurrentMarkdownNotePath()}catch(C){this.debugError("sendCurrentInput:notePath-failed",C)}let p=null;try{p=this.plugin.settings.enableContextInjection&&($e=(Be=this.selectionController)==null?void 0:Be.getContext())!=null?$e:null}catch(C){this.debugError("sendCurrentInput:editorCtx-failed",C),p=null}let c=[];try{c=await this.collectAttachedFileContents(d,r.panelEl)}catch(C){this.debugError("sendCurrentInput:collectAttachedFileContents-failed",C),c=[]}let u=new Set(c.map(C=>C.path)),g=[];try{g=await this.plugin.collectMcpContextForPrompt(i,d,u)}catch(C){this.debugError("sendCurrentInput:mcpContext-failed",C),g=[]}let v=[...c];if(g.length>0){for(let C of g)u.has(C.path)||(u.add(C.path),v.push(C));try{this.appendSystemMessageToPanel(r.panelEl,y("messageMcpContextAttached",{paths:g.map(C=>C.path).join(", ")}))}catch(C){this.debugError("sendCurrentInput:mcpContext-notice-failed",C)}}let m=[];try{m=(qe=(He=this.imageContext)==null?void 0:He.getImages())!=null?qe:[]}catch(C){this.debugError("sendCurrentInput:imageContext-failed",C),m=[]}let f=m.map(C=>({name:C.name,dataUrl:typeof C.dataUrl=="string"?C.dataUrl.trim():"",path:typeof C.path=="string"?C.path.trim():""})).filter(C=>C.dataUrl.length>0||C.path.length>0),x=this.consumeReviewCommentsForActiveTab(),T=this.buildPromptWithTurnControls(i),h=this.appendReviewCommentsToPrompt(T,x),A=h;try{A=nt(h,d,p,v)}catch(C){this.debugError("sendCurrentInput:buildAugmentedPrompt-failed",C),A=h}if(this.debugLog("sendCurrentInput:prompt-ready",{promptLength:i.length,promptWithControlsLength:T.length,promptWithReviewCommentsLength:h.length,augmentedLength:A.length,attachedFiles:c.length,mcpContextFiles:g.length,imageAttachments:m.length,reviewComments:x.length,skillPreset:this.plugin.settings.skillPreset,approvalMode:this.plugin.settings.approvalMode,notePath:d}),f.length>0){let C=f[0];this.debugLog("sendCurrentInput:image payload",{count:f.length,firstImageHasPath:C.path.length>0,firstImagePath:C.path.length>0?C.path:null,firstImageUrlPrefix:C.dataUrl.slice(0,50),firstImageUrlLength:C.dataUrl.length})}let E;try{let C=f.length>0?f.map(R=>({name:R.name,dataUrl:R.dataUrl})):void 0,k=l.addMessage("user",i,{images:C});this.appendMessageToPanel(r.panelEl,"user",i,k.id,k.images),E=this.createMessageEl(r.panelEl,"assistant")}catch(C){throw this.debugError("sendCurrentInput:pre-send-render-failed",C),C}let P="",I=++this.sendSequence,D=new Map,L=new Set,O=null,se=0,U=null,X=!1,z=new Map,_=new Map,W=new Map,Fe=new Map,Y=null,q=null,ee=0,Ne=()=>{let C=r.panelEl.createDiv(),k=E.closest(".codexidian-msg-wrapper"),R=k instanceof HTMLElement?k:E;return R.parentElement===r.panelEl&&r.panelEl.insertBefore(C,R),C},re=()=>{var C;X||!U||(X=!0,U.finalize(),q&&((C=this.statusPanel)==null||C.updateEntry(q,{status:"completed",duration:Date.now()-ee}),q=null,ee=0))},it=()=>{var C;q||(q=`thinking-${I}`,ee=Date.now(),(C=this.statusPanel)==null||C.addEntry({id:q,type:"thinking",label:o("reasoning"),status:"running"}))},Ae=(C,k)=>{var b;let R=D.get(C);if(R)return R;let V=this.toolCallRenderer.createCard(Ne(),{type:(b=k==null?void 0:k.type)!=null?b:"tool",name:k==null?void 0:k.name,command:k==null?void 0:k.command,filePath:k==null?void 0:k.filePath});return D.set(C,V),V};this.running=!0,this.currentTurnId=null,this.updateStatus(),(Oe=this.statusPanel)==null||Oe.setTurnStatus("thinking"),this.tabBar.setStreaming(r.state.tabId,!0);try{this.debugLog("sendCurrentInput:before-sendTurn",{sendSeq:I,tabId:r.state.tabId,model:this.modelSelect.value||"(default)",effort:this.effortSelect.value||"(default)",imageInputs:f.length});let C=this.plugin.client.sendTurn(A,{onDelta:b=>{var B,H;this.debugLog("sendCurrentInput:onDelta",{sendSeq:I,deltaLength:b.length}),this.currentTurnId||(this.currentTurnId=this.plugin.client.getCurrentTurnId()),q&&((B=this.statusPanel)==null||B.updateEntry(q,{status:"completed",duration:Date.now()-ee}),q=null,ee=0),(H=this.statusPanel)==null||H.setTurnStatus("streaming"),P+=b,this.messageRenderer.renderStreaming(E,P),r.panelEl.scrollTop=r.panelEl.scrollHeight},onThinkingDelta:b=>{var B;this.debugLog("sendCurrentInput:onThinkingDelta",{sendSeq:I,deltaLength:b.length}),b&&((B=this.statusPanel)==null||B.setTurnStatus("thinking"),it(),U||(U=this.thinkingRenderer.createBlock(Ne())),U.appendContent(b),r.panelEl.scrollTop=r.panelEl.scrollHeight)},onToolStart:b=>{var H,N;this.debugLog("sendCurrentInput:onToolStart",{sendSeq:I,itemId:b.itemId,type:b.type,name:b.name});let B=Ae(b.itemId,b);L.add(b.itemId),O=b.itemId,B.complete("running"),z.set(b.itemId,Date.now()),_.set(b.itemId,{type:b.type,name:b.name,command:b.command,filePath:b.filePath}),(H=this.statusPanel)==null||H.setTurnStatus("tool_calling"),(N=this.statusPanel)==null||N.addEntry({id:b.itemId,type:"tool_call",label:b.name||b.type||"Tool",detail:this.truncateStatusDetail(b.command||b.filePath),status:"running"}),r.panelEl.scrollTop=r.panelEl.scrollHeight},onToolDelta:b=>{var B,H;if(this.debugLog("sendCurrentInput:onToolDelta",{sendSeq:I,deltaLength:b.length}),this.currentTurnId||(this.currentTurnId=this.plugin.client.getCurrentTurnId()),(B=this.statusPanel)==null||B.setTurnStatus("tool_calling"),b.length>0){let N=O;N||(N=`tool-fallback-${I}-${++se}`,O=N,L.add(N)),Ae(N,{type:"tool",name:o("toolOutput")}).appendOutput(b);let te=(H=W.get(N))!=null?H:"";W.set(N,`${te}${b}`)}b.trim().length>0&&this.statusEl.setText(`${o("toolStatusPrefix")}: ${b.trim().slice(0,80)}`)},onToolComplete:b=>{var Ke,Qe;this.debugLog("sendCurrentInput:onToolComplete",{sendSeq:I,itemId:b.itemId,status:b.status});let B=Ae(b.itemId,b),H=z.get(b.itemId),N=H?Date.now()-H:void 0;if(B.complete(b.status,N),(Ke=this.statusPanel)==null||Ke.updateEntry(b.itemId,{status:this.resolveEntryStatus(b.status),duration:N}),L.delete(b.itemId),O===b.itemId){let Me=Array.from(L);O=Me.length>0?Me[Me.length-1]:null}let je=_.get(b.itemId),te=this.inferDiffEntryFromTool(b,je);te&&Fe.set(te.filePath.toLowerCase(),te),Y||(Y=this.detectPlanFromToolOutput(b,(Qe=W.get(b.itemId))!=null?Qe:"")),r.panelEl.scrollTop=r.panelEl.scrollHeight},onSystem:b=>{this.debugLog("sendCurrentInput:onSystem",{sendSeq:I,message:b}),this.appendSystemMessageToPanel(r.panelEl,b)}},{model:this.modelSelect.value||void 0,effort:this.effortSelect.value||void 0,images:f.length>0?f:void 0});if(f.length>0)try{(Ue=this.imageContext)==null||Ue.clear()}catch(b){this.debugError("sendCurrentInput:imageContext-clear-after-send",b)}let k=()=>{if(this.currentTurnId||!this.running||I!==this.sendSequence)return;let b=this.plugin.client.getCurrentTurnId();if(b){this.currentTurnId=b;return}window.setTimeout(k,25)};k();let R=await C;this.debugLog("sendCurrentInput:onComplete",{sendSeq:I,turnId:R.turnId,status:R.status,hasErrorMessage:!!R.errorMessage}),this.currentTurnId=R.turnId,(ze=this.statusPanel)==null||ze.setTurnStatus("streaming");let V=this.cancelledSendSequences.has(I);if(P.trim().length===0&&(V||R.status==="cancelled"?P=o("messageCancelledByUser"):P=R.errorMessage||o("messageNoAssistantOutput")),await this.messageRenderer.renderContent(E,P),re(),R.threadId&&l.setThreadId(R.threadId),l.addMessage("assistant",P),R.status!=="completed"&&!(V&&R.status==="cancelled")){let b=R.errorMessage?`: ${R.errorMessage}`:"";this.appendSystemMessageToPanel(r.panelEl,y("messageTurnFinishedStatus",{status:R.status,suffix:b}))}if(R.status==="completed"){this.setReviewStateForTab(r.state.tabId,Array.from(Fe.values()));let b=Y!=null?Y:this.detectPlanFromAssistantText(P);b&&this.setPlanForTab(r.state.tabId,b)}}catch(C){this.debugError("sendCurrentInput:onError",C,{sendSeq:I});let k=this.cancelledSendSequences.has(I),R=C instanceof Error?C.message:String(C);if(this.isThreadNotFoundMessage(R)&&(this.debugLog("sendCurrentInput:thread-reset",{reason:R,tabId:r.state.tabId}),l.clearThreadId(),this.plugin.client.setThreadId(null)),k){let V=P.trim().length>0?P:o("messageCancelledByUser");await this.messageRenderer.renderContent(E,V),l.addMessage("assistant",V),re()}else await this.messageRenderer.renderContent(E,o("messageNoAssistantOutput")),this.appendSystemMessageToPanel(r.panelEl,y("messageRequestFailed",{error:R})),f.length>0&&this.isImageInputUnsupportedMessage(R)&&(this.appendSystemMessageToPanel(r.panelEl,o("messageImageUploadUnsupported")),new w.Notice(o("noticeImageUploadUnsupported"))),new w.Notice(y("noticeCodexError",{error:R})),re()}finally{if(this.debugLog("sendCurrentInput:finally",{sendSeq:I,running:this.running,queueLength:this.messageQueue.length}),re(),this.cancelledSendSequences.delete(I),I!==this.sendSequence)return;this.running=!1,this.currentTurnId=null,this.tabBar.setStreaming(r.state.tabId,!1),(Ve=this.statusPanel)==null||Ve.setTurnStatus("idle"),(_e=this.statusPanel)==null||_e.clearFinishedAfterDelay(3e3),this.updateStatus();try{(We=this.fileContext)==null||We.clear()}catch(C){}try{await this.processQueue()}catch(C){let k=C instanceof Error?C.message:String(C);new w.Notice(y("noticeProcessQueueFailed",{error:k}))}}}buildPromptWithTurnControls(e){let t=[],i=this.plugin.settings.skillPreset.trim();return i&&i!=="none"&&t.push(`[Skill: ${i}]`),t.length===0?e:`${t.join(`
`)}

${e}`}appendReviewCommentsToPrompt(e,t){if(t.length===0)return e;let i=t.map(s=>{let r=s.scope.trim()||"general",a=s.text.trim();return a?`- ${r}: ${a}`:""}).filter(s=>s.length>0);return i.length===0?e:`${e}

[${o("reviewPromptHeader")}]
${i.join(`
`)}`}async startNewThread(){if(!this.running){this.running=!0,this.updateStatus();try{let e=await this.plugin.client.newThread(),t=this.tabManager.getActiveTab();t&&(t.conversationController.setThreadId(e),this.appendSystemMessageToPanel(t.panelEl,y("messageStartedNewThread",{threadId:e})))}catch(e){let t=e instanceof Error?e.message:String(e),i=this.tabManager.getActiveTab();i&&this.appendSystemMessageToPanel(i.panelEl,y("messageFailedStartNewThread",{error:t})),new w.Notice(y("noticeCodexError",{error:t}))}finally{this.running=!1,this.updateStatus()}}}async restartEngine(){if(!this.running){this.running=!0,this.updateStatus();try{await this.plugin.client.restart();let e=this.tabManager.getActiveTab();e&&this.appendSystemMessageToPanel(e.panelEl,o("messageRestarted"))}catch(e){let t=e instanceof Error?e.message:String(e),i=this.tabManager.getActiveTab();i&&this.appendSystemMessageToPanel(i.panelEl,y("messageRestartFailed",{error:t})),new w.Notice(y("noticeCodexError",{error:t}))}finally{this.running=!1,this.updateStatus()}}}openSessionModal(){try{new Ee(this.app,{listConversations:async t=>await this.listConversations(t),searchConversations:async(t,i)=>await this.searchConversations(t,i),onOpen:async t=>await this.openConversation(t.id),onFork:async t=>await this.forkConversation(t.id),onTogglePin:async(t,i)=>{await this.updateConversationMeta(t.id,{pinned:i})},onToggleArchive:async(t,i)=>{await this.updateConversationMeta(t.id,{archived:i})},onDelete:async t=>{await this.deleteConversation(t.id)}}).open()}catch(e){let t=e instanceof Error?e.message:String(e);new w.Notice(y("sessionActionFailed",{error:t}))}}getAnyConversationController(){let e=this.tabManager.getActiveConversationController();if(e)return e;for(let t of this.tabManager.getAllTabStates()){let i=this.tabManager.getTab(t.tabId);if(i)return i.conversationController}return null}async listConversations(e){let t=this.getAnyConversationController();return t?await t.listConversations(e):await this.sessionStorage.listConversations(e)}async searchConversations(e,t){let i=this.getAnyConversationController();return i?await i.searchConversations(e,t):await this.sessionStorage.searchConversations(e,t)}async updateConversationMeta(e,t){let i=this.getAnyConversationController();return i?await i.updateMeta(e,t):await this.sessionStorage.updateMeta(e,t)}async openConversation(e){var s;let t=await this.ensureActiveTabForInlineCard();if(!t)return;let i=await t.conversationController.switchTo(e);if(!i){new w.Notice(o("noticeFailedLoadConversation"));return}this.tabManager.setConversationId(t.state.tabId,e),t.panelEl.empty(),this.setReviewStateForTab(t.state.tabId,[]),this.setPlanForTab(t.state.tabId,null),await this.renderConversationMessages(t.panelEl,i.messages),this.plugin.client.setThreadId((s=i.threadId)!=null?s:null),this.updateStatus(),t.panelEl.scrollTop=t.panelEl.scrollHeight}async deleteConversation(e){let t=this.getAnyConversationController();t?await t.deleteConversation(e):await this.sessionStorage.deleteConversation(e);let i=this.tabManager.getActiveTab();if(!i||i.state.conversationId!==e)return;i.panelEl.empty(),this.tabManager.setConversationId(i.state.tabId,null),this.setReviewStateForTab(i.state.tabId,[]),this.setPlanForTab(i.state.tabId,null),await this.ensureConversationReady(i)&&this.appendSystemMessageToPanel(i.panelEl,o("messageReadyHint"))}async forkConversation(e){if(this.running){new w.Notice(o("noticeCannotForkRunning"));return}if(this.tabManager.getAllTabStates().length>=this.plugin.settings.maxTabs){new w.Notice(y("noticeCannotForkMax",{max:this.plugin.settings.maxTabs}));return}let i=await this.sessionStorage.loadConversation(e);if(!i){new w.Notice(o("noticeFailedLoadConversation"));return}let s=this.tabManager.addTab();this.ensureReviewState(s.state.tabId),this.ensurePlanState(s.state.tabId);let r=`${o("sessionForkPrefix")} ${i.title}`,a=await s.conversationController.createNew(r);this.tabManager.setConversationId(s.state.tabId,a.id),s.conversationController.setMessages(i.messages),s.panelEl.empty(),await this.renderConversationMessages(s.panelEl,i.messages);try{let l=await this.plugin.client.newThread();s.conversationController.setThreadId(l),this.appendSystemMessageToPanel(s.panelEl,o("messageForkCreated"))}catch(l){let d=l instanceof Error?l.message:String(l);this.appendSystemMessageToPanel(s.panelEl,y("messageForkThreadFail",{error:d}))}this.tabManager.switchTo(s.state.tabId),this.updateStatus()}async renderConversationMessages(e,t){for(let i of t)if(i.role==="assistant"){let s=this.createMessageEl(e,"assistant",i.id);await this.messageRenderer.renderContent(s,i.content)}else this.appendMessageToPanel(e,i.role,i.content,i.id,i.role==="user"?i.images:void 0)}createMessageEl(e,t,i){let s=e.createDiv({cls:"codexidian-msg-wrapper"});s.dataset.msgRole=t,i&&(s.dataset.msgId=i);let r=s.createDiv({cls:`codexidian-msg codexidian-msg-${t}`});return t==="user"&&i&&this.attachUserMessageActions(s,i),r}appendMessageToPanel(e,t,i,s,r){let a=this.createMessageEl(e,t,s);return a.setText(i),t==="user"&&r&&r.length>0&&this.appendMessageImages(a,r),e.scrollTop=e.scrollHeight,a}appendMessageImages(e,t){let i=t.map(r=>({name:r.name,dataUrl:typeof r.dataUrl=="string"?r.dataUrl.trim():""})).filter(r=>r.dataUrl.length>0);if(i.length===0)return;let s=e.createDiv({cls:"codexidian-msg-images"});for(let r of i){let a=s.createEl("img",{cls:"codexidian-msg-image-thumb"});a.src=r.dataUrl,a.alt=r.name,a.title=r.name,a.loading="lazy"}}attachUserMessageActions(e,t){let i=e.createDiv({cls:"codexidian-msg-actions"});i.createEl("button",{cls:"codexidian-msg-action-btn",text:"\u270F",title:o("editMessageTitle")}).addEventListener("click",l=>{l.preventDefault(),l.stopPropagation(),this.editMessage(t)}),i.createEl("button",{cls:"codexidian-msg-action-btn",text:"\u21A9",title:o("rewindTitle")}).addEventListener("click",l=>{l.preventDefault(),l.stopPropagation(),this.rewindToMessage(t)}),i.createEl("button",{cls:"codexidian-msg-action-btn",text:"\u2442",title:o("forkTitle")}).addEventListener("click",l=>{l.preventDefault(),l.stopPropagation(),this.forkFromMessage(t)})}async editMessage(e){var v;if(this.running){new w.Notice(o("noticeCannotEditRunning"));return}let t=this.tabManager.getActiveTab();if(!t)return;let i=this.getMessageWrapper(t.panelEl,e);if(!i||i.dataset.msgRole!=="user"){new w.Notice(o("noticeCannotEditNotFound"));return}if(i.querySelector(".codexidian-msg-edit-area"))return;let s=i.querySelector(".codexidian-msg-user");if(!s)return;let r=(v=s.textContent)!=null?v:"",a=i.querySelector(".codexidian-msg-actions");s.style.display="none",a&&(a.style.display="none");let l=i.createDiv({cls:"codexidian-msg-edit-wrap"}),d=l.createEl("textarea",{cls:"codexidian-msg-edit-area"});d.value=r;let p=l.createDiv({cls:"codexidian-msg-edit-actions"}),c=p.createEl("button",{cls:"codexidian-msg-edit-save",text:o("saveAndResend")}),u=p.createEl("button",{cls:"codexidian-msg-edit-cancel",text:o("cancel")}),g=()=>{l.remove(),s.style.display="",a&&(a.style.display="")};u.addEventListener("click",()=>{g()}),c.addEventListener("click",()=>{(async()=>{let m=d.value.trim();if(!m){new w.Notice(o("noticeEditedMessageEmpty"));return}if(window.confirm(o("confirmSaveEditResend"))){c.disabled=!0,u.disabled=!0;try{let x=await t.conversationController.truncateAfter(e);if(!x||x.role!=="user"){new w.Notice(o("noticeEditMessageNotFound")),g();return}this.removePanelContentFromMessage(t.panelEl,e);try{let T=await this.plugin.client.newThread();t.conversationController.setThreadId(T),this.appendSystemMessageToPanel(t.panelEl,o("messageEditedStartedFreshThread"))}catch(T){let h=T instanceof Error?T.message:String(T);this.appendSystemMessageToPanel(t.panelEl,y("messageEditedSaveButThreadFail",{error:h}))}this.setInputValue(""),await this.sendCurrentInput(m)}catch(x){let T=x instanceof Error?x.message:String(x);new w.Notice(y("noticeEditFailed",{error:T})),g()}}})()}),d.focus(),d.setSelectionRange(d.value.length,d.value.length)}async applyCodeToNote(e,t,i){var g,v;let s=e.trimEnd();if(!s){new w.Notice(o("noticeNoCodeToApply"));return}let r=(g=this.getCurrentMarkdownNotePath())!=null?g:"",a=window.prompt(o("promptTargetNotePath"),r);if(a===null)return;let l=(0,w.normalizePath)((a.trim()||r).trim());if(!l){new w.Notice(o("noticeTargetPathRequired"));return}let d=this.getPathValidator().validate(l,"write");if(!d.allowed){new w.Notice(y("securityBlocked",{reason:(v=d.reason)!=null?v:o("securityBlockedReasonDefault")}));return}let p=await this.pickApplyMode(i);if(!p)return;let c=p==="replace-selection"?o("replaceSelection"):o("appendToNote");if(this.plugin.settings.securityRequireApprovalForWrite&&!window.confirm(y("confirmApplyCode",{path:l,mode:c})))return;let u=this.getMaxNoteSizeBytes();try{p==="replace-selection"?await this.applyCodeReplaceSelection(l,s,u):await this.applyCodeAppendToNote(l,s,t,u),new w.Notice(y("noticeAppliedCode",{path:l,mode:c}))}catch(m){let f=m instanceof Error?m.message:String(m);new w.Notice(y("noticeApplyCodeFailed",{error:f}))}}async pickApplyMode(e){let t=()=>window.confirm(o("confirmApplyModeFallback"))?"replace-selection":"append-to-note";return!e||!document.body?t():(document.querySelectorAll(".codexidian-apply-mode-menu").forEach(i=>i.remove()),await new Promise(i=>{let s=document.createElement("div");s.classList.add("codexidian-apply-mode-menu");let r=document.createElement("button");r.classList.add("codexidian-apply-mode-option"),r.textContent=o("replaceSelection");let a=document.createElement("button");a.classList.add("codexidian-apply-mode-option"),a.textContent=o("appendToNote");let l=document.createElement("button");l.classList.add("codexidian-apply-mode-cancel"),l.textContent=o("applyModeCancel"),s.appendChild(r),s.appendChild(a),s.appendChild(l),document.body.appendChild(s);let d=e.getBoundingClientRect(),p=210,c=Math.max(8,Math.min(window.innerWidth-p-8,d.right-p)),g=Math.max(8,Math.min(window.innerHeight-132-8,d.bottom+6));s.style.left=`${c}px`,s.style.top=`${g}px`;let v=!1,m=T=>{v||(v=!0,document.removeEventListener("mousedown",f,!0),document.removeEventListener("keydown",x,!0),s.remove(),i(T))},f=T=>{let h=T.target;h instanceof Node&&(s.contains(h)||h===e||m(null))},x=T=>{T.key==="Escape"&&(T.preventDefault(),m(null))};r.addEventListener("click",T=>{T.preventDefault(),T.stopPropagation(),m("replace-selection")}),a.addEventListener("click",T=>{T.preventDefault(),T.stopPropagation(),m("append-to-note")}),l.addEventListener("click",T=>{T.preventDefault(),T.stopPropagation(),m(null)}),window.setTimeout(()=>{document.addEventListener("mousedown",f,!0),document.addEventListener("keydown",x,!0)},0)}))}async applyCodeReplaceSelection(e,t,i){let s=this.app.workspace.getActiveViewOfType(w.MarkdownView);if(!s||!s.file)throw new Error(o("errorNoActiveEditor"));let r=(0,w.normalizePath)(s.file.path),a=(0,w.normalizePath)(e);if(r!==a)throw new Error(o("errorReplaceSelectionRequiresTarget"));let l=s.editor.getSelection();if(!l)throw new Error(o("errorNoSelectionToReplace"));let d=s.editor.getValue();if(this.getByteLength(d)-this.getByteLength(l)+this.getByteLength(t)>i)throw new Error(y("errorMaxSizeExceeded",{kb:this.plugin.settings.securityMaxNoteSize}));s.editor.replaceSelection(t)}async applyCodeAppendToNote(e,t,i,s){let r=(0,w.normalizePath)(e),a=this.app.vault.getAbstractFileByPath(r),l=this.formatFencedCode(t,i);if(a instanceof w.TFile){let p=await this.app.vault.read(a),c=p.length===0?"":p.endsWith(`
`)?`
`:`

`,u=`${p}${c}${l}
`;if(this.getByteLength(u)>s)throw new Error(y("errorMaxSizeExceeded",{kb:this.plugin.settings.securityMaxNoteSize}));await this.app.vault.modify(a,u);return}if(a)throw new Error(y("errorTargetPathNotFile",{path:r}));let d=`${l}
`;if(this.getByteLength(d)>s)throw new Error(y("errorMaxSizeExceeded",{kb:this.plugin.settings.securityMaxNoteSize}));await this.app.vault.create(r,d)}formatFencedCode(e,t){let i=t.trim().toLowerCase();return`\`\`\`${i&&i!=="text"?i:""}
${e}
\`\`\``}getPathValidator(){return new G(this.plugin.settings.securityBlockedPaths)}getMaxNoteSizeBytes(){return(Number.isFinite(this.plugin.settings.securityMaxNoteSize)?Math.max(1,Math.round(this.plugin.settings.securityMaxNoteSize)):500)*1024}getByteLength(e){return new TextEncoder().encode(e).length}getMessageWrapper(e,t){let i=Array.from(e.children);for(let s of i)if(s instanceof HTMLElement&&s.dataset.msgId===t)return s;return null}async rewindToMessage(e){if(this.running){new w.Notice(o("noticeCannotRewindRunning"));return}if(!window.confirm(o("confirmRewind")))return;let i=this.tabManager.getActiveTab();if(i)try{let s=await i.conversationController.truncateAfter(e);if(!s||s.role!=="user"){new w.Notice(o("noticeUnableRewind"));return}this.removePanelContentFromMessage(i.panelEl,e),this.setInputValue(s.content),this.inputEl.focus();try{let r=await this.plugin.client.newThread();i.conversationController.setThreadId(r),this.appendSystemMessageToPanel(i.panelEl,o("messageRewindComplete"))}catch(r){let a=r instanceof Error?r.message:String(r);this.appendSystemMessageToPanel(i.panelEl,y("messageRewindThreadFail",{error:a}))}}catch(s){let r=s instanceof Error?s.message:String(s);new w.Notice(y("noticeRewindFailed",{error:r}))}finally{this.updateStatus()}}async forkFromMessage(e){if(this.running){new w.Notice(o("noticeCannotForkRunning"));return}if(this.tabManager.getAllTabStates().length>=this.plugin.settings.maxTabs){new w.Notice(y("noticeCannotForkMax",{max:this.plugin.settings.maxTabs}));return}let i=this.tabManager.getActiveTab();if(i)try{let s=i.conversationController.getMessagesUpTo(e);if(s.length===0){new w.Notice(o("noticeUnableFork"));return}let r=this.tabManager.addTab();this.ensureReviewState(r.state.tabId),this.ensurePlanState(r.state.tabId);let a=await r.conversationController.createNew(`Fork ${new Date().toLocaleString()}`);this.tabManager.setConversationId(r.state.tabId,a.id),r.conversationController.setMessages(s),r.panelEl.empty(),await this.renderConversationMessages(r.panelEl,s);try{let l=await this.plugin.client.newThread();r.conversationController.setThreadId(l),this.appendSystemMessageToPanel(r.panelEl,o("messageForkCreated"))}catch(l){let d=l instanceof Error?l.message:String(l);this.appendSystemMessageToPanel(r.panelEl,y("messageForkThreadFail",{error:d}))}this.tabManager.switchTo(r.state.tabId),this.updateStatus()}catch(s){let r=s instanceof Error?s.message:String(s);new w.Notice(y("noticeForkFailed",{error:r}))}}removePanelContentFromMessage(e,t){let i=Array.from(e.children),s=i.findIndex(r=>r instanceof HTMLElement&&r.dataset.msgId===t);if(!(s<0)){for(let r=i.length-1;r>=s;r--)i[r].remove();e.scrollTop=e.scrollHeight}}appendSystemMessageToPanel(e,t){this.appendMessageToPanel(e,"system",t)}appendSystemMessage(e){var i;let t=(i=this.tabManager)==null?void 0:i.getActiveTab();t&&this.appendSystemMessageToPanel(t.panelEl,e)}refreshLocale(){var e,t,i,s,r,a,l,d,p,c;(e=this.titleEl)==null||e.setText(o("appTitle")),this.updateHeaderButtons(),this.inputEl.placeholder=o("askPlaceholder"),(t=this.modelLabelEl)==null||t.setText(o("model")),(i=this.effortLabelEl)==null||i.setText(o("effort")),(s=this.skillLabelEl)==null||s.setText(o("skill")),(r=this.modeLabelEl)==null||r.setText(o("mode")),this.updateSkillButtonText(),this.updateModeButtonText(),this.attachBtn&&(this.attachBtn.setAttr("aria-label",o("attachImage")),this.attachBtn.setAttr("title",o("attachImage"))),(a=this.dropZoneTextEl)==null||a.setText(o("dropImagesHere")),this.updateSendButton(),this.updateNoteContextToggle(),this.registerBuiltinSlashCommands(),(l=this.statusPanel)==null||l.refreshLocale(),(d=this.reviewPane)==null||d.refreshLocale();for(let u of(c=(p=this.tabManager)==null?void 0:p.getAllTabStates())!=null?c:[])this.renderPlanCardForTab(u.tabId);this.updateQueueIndicator(),this.updateStatus()}async collectAttachedFileContents(e,t){var a,l;let s=new Set;for(let d of(l=(a=this.fileContext)==null?void 0:a.getFiles())!=null?l:[])s.add(d);this.includeCurrentNoteContent&&e&&s.add(e);let r=[];for(let d of s){let p=this.app.vault.getAbstractFileByPath(d);if(!(p instanceof w.TFile)){this.appendSystemMessageToPanel(t,y("messageContextFileNotFound",{path:d}));continue}try{let c=await this.app.vault.read(p);c.length>1e4&&(c=`${c.slice(0,1e4)}

...[truncated to 10000 characters]`),r.push({path:d,content:c})}catch(c){let u=c instanceof Error?c.message:String(c);this.appendSystemMessageToPanel(t,y("messageContextFileReadFailed",{path:d,error:u}))}}return r}refreshCurrentNoteContext(){let e=this.getCurrentMarkdownNotePath();if(!e){this.noteContextEl.style.display="none",this.noteContextTextEl.setText(""),this.noteContextTextEl.title="",this.updateContextRowVisibility();return}this.noteContextEl.style.display="flex",this.noteContextTextEl.setText(`\u{1F4DD} ${this.getFileName(e)}`),this.noteContextTextEl.title=e,this.updateContextRowVisibility()}updateNoteContextToggle(){this.noteContextToggleEl.setText(this.includeCurrentNoteContent?o("noteToggleOn"):o("noteToggleOff")),this.includeCurrentNoteContent?this.noteContextToggleEl.addClass("is-enabled"):this.noteContextToggleEl.removeClass("is-enabled")}updateContextRowVisibility(){let e=this.noteContextEl.style.display!=="none",t=this.selectionContextEl.style.display!=="none";this.contextRowEl.style.display=e||t?"flex":"none"}getFileName(e){let t=e.split("/");return t[t.length-1]||e}getCurrentMarkdownNotePath(){var i,s;let e=this.app.workspace.getActiveViewOfType(w.MarkdownView);if((i=e==null?void 0:e.file)!=null&&i.path)return e.file.path;let t=this.app.workspace.getLeavesOfType("markdown");for(let r of t){let a=r.view;if(a instanceof w.MarkdownView&&((s=a.file)!=null&&s.path))return a.file.path}return null}async showApprovalCard(e){var g,v;(g=this.statusPanel)==null||g.setTurnStatus("waiting_approval");let t=await this.ensureActiveTabForInlineCard();if(!t)return this.restoreStatusAfterInteractiveCard(),"decline";let i=`approval-${Date.now()}-${Math.random().toString(36).slice(2,8)}`;(v=this.statusPanel)==null||v.addEntry({id:i,type:"info",label:this.getApprovalTitle(e.type),detail:this.truncateStatusDetail(e.command||e.filePath||e.cwd),status:"running"});let s=t.panelEl.createDiv({cls:"codexidian-approval-card"}),r=s.createDiv({cls:"codexidian-approval-header"});r.createSpan({cls:"codexidian-approval-icon",text:e.type==="fileChange"||e.type==="applyPatch"?"\u{1F4DD}":"\u26A1"}),r.createSpan({text:this.getApprovalTitle(e.type)});let a=s.createDiv({cls:"codexidian-approval-body"});e.command&&a.createEl("code",{text:e.command}),e.filePath&&a.createDiv({cls:"codexidian-approval-meta",text:y("approvalMetaFile",{path:e.filePath})}),e.cwd&&a.createDiv({cls:"codexidian-approval-meta",text:y("approvalMetaCwd",{cwd:e.cwd})}),!e.command&&!e.filePath&&e.params&&a.createEl("code",{text:JSON.stringify(e.params).slice(0,800)});let l=s.createDiv({cls:"codexidian-approval-actions"}),d=l.createEl("button",{cls:"codexidian-approval-btn approve",text:o("approve")}),p=l.createEl("button",{cls:"codexidian-approval-btn codexidian-approval-always-btn",text:o("alwaysAllow")}),c=l.createEl("button",{cls:"codexidian-approval-btn deny",text:o("deny")}),u=s.createDiv({cls:"codexidian-approval-status"});return t.panelEl.scrollTop=t.panelEl.scrollHeight,await new Promise(m=>{let f=!1,x=window.setTimeout(()=>{T("decline",o("approvalTimedOut"))},6e4),T=(h,A)=>{var E;f||(f=!0,window.clearTimeout(x),d.disabled=!0,p.disabled=!0,c.disabled=!0,s.addClass("codexidian-approval-card-readonly"),s.addClass(h==="accept"?"codexidian-approval-accepted":"codexidian-approval-denied"),u.setText(y("approvalDecisionPrefix",{status:A})),(E=this.statusPanel)==null||E.updateEntry(i,{status:h==="accept"?"completed":"failed"}),this.restoreStatusAfterInteractiveCard(),m(h))};d.addEventListener("click",()=>T("accept",o("approvalApproved"))),p.addEventListener("click",()=>{(async()=>{try{let h=await this.plugin.addAllowRuleFromApprovalRequest(e),A=this.getAllowRuleTypeLabel(h.ruleType);h.status==="added"?new w.Notice(y("noticeAllowRuleAdded",{type:A,pattern:h.pattern})):h.status==="exists"&&new w.Notice(y("noticeAllowRuleExists",{type:A,pattern:h.pattern}))}catch(h){let A=h instanceof Error?h.message:String(h);new w.Notice(y("noticeAllowRuleAddFailed",{error:A}))}finally{T("accept",o("approvalAlwaysAllowed"))}})()}),c.addEventListener("click",()=>T("decline",o("approvalDenied")))})}async showUserInputCard(e){var u,g,v;(u=this.statusPanel)==null||u.setTurnStatus("waiting_approval");let t=await this.ensureActiveTabForInlineCard();if(!t)return this.restoreStatusAfterInteractiveCard(),this.buildDefaultUserInputResponse(e);let i=`input-${Date.now()}-${Math.random().toString(36).slice(2,8)}`;(g=this.statusPanel)==null||g.addEntry({id:i,type:"info",label:o("statusUserInputRequest"),detail:this.truncateStatusDetail(e.questions.map(m=>m.id).join(", ")),status:"running"});let s=t.panelEl.createDiv({cls:"codexidian-user-input-card"});s.createDiv({cls:"codexidian-user-input-header"}).createSpan({text:o("userInputRequest")});let a=new Map;for(let m of e.questions){let f=s.createDiv({cls:"codexidian-user-input-question"});f.createDiv({cls:"codexidian-user-input-text",text:m.text||m.id});let x=f.createDiv({cls:"codexidian-user-input-options"}),T=[],h="";for(let P of(v=m.options)!=null?v:[]){h||(h=P.label);let I=x.createEl("button",{cls:"codexidian-user-input-option",text:P.label});T.push(I)}let E={selected:null,inputEl:f.createEl("input",{cls:"codexidian-user-input-freeform",type:"text",placeholder:o("userInputPlaceholder")}),optionButtons:T,firstOption:h};a.set(m.id,E);for(let P of T)P.addEventListener("click",()=>{var I;E.selected=(I=P.textContent)!=null?I:"";for(let D of T)D===P?D.addClass("is-selected"):D.removeClass("is-selected")})}let d=s.createDiv({cls:"codexidian-user-input-actions"}).createEl("button",{cls:"codexidian-user-input-submit",text:o("submit")}),p=s.createDiv({cls:"codexidian-user-input-status"}),c=m=>{var x,T,h;if(m)return this.buildDefaultUserInputResponse(e);let f={};for(let A of e.questions){let E=a.get(A.id),P=(x=E==null?void 0:E.inputEl.value.trim())!=null?x:"",I=(T=E==null?void 0:E.selected)!=null?T:"",D=(h=E==null?void 0:E.firstOption)!=null?h:"",L=P||I||D;f[A.id]={answers:[L]}}return{answers:f}};return t.panelEl.scrollTop=t.panelEl.scrollHeight,await new Promise(m=>{let f=!1,x=window.setTimeout(()=>{T(c(!0),o("userInputTimedOutDefault"),!0)},6e4),T=(h,A,E=!1)=>{var P;if(!f){f=!0,window.clearTimeout(x),d.disabled=!0;for(let I of a.values()){I.inputEl.disabled=!0;for(let D of I.optionButtons)D.disabled=!0}s.addClass("codexidian-user-input-card-readonly"),p.setText(A),(P=this.statusPanel)==null||P.updateEntry(i,{status:E?"failed":"completed"}),this.restoreStatusAfterInteractiveCard(),m(h)}};d.addEventListener("click",()=>{T(c(!1),o("userInputSubmitted"),!1)})})}updateStatus(){let e=this.plugin.settings,t=this.plugin.client.getThreadId(),s=this.plugin.client.isRunning()?o("connected"):o("disconnected"),r=this.running?o("running"):o("idle"),a=t?`${o("thread")} ${t.slice(0,8)}...`:o("noThread");this.statusEl.setText(`${s} | ${r} | ${a} | ${e.model||o("defaultModel")} | ${e.thinkingEffort} | ${e.approvalPolicy}`),this.updateHeaderButtons(),this.sendBtn.disabled=!1,this.inputEl.disabled=!1,this.newThreadBtn.disabled=this.running,this.restartBtn.disabled=this.running,this.updateQueueIndicator()}updateHeaderButtons(){var t;this.setHeaderIconButton(this.historyBtn,"clock",o("history")),this.setHeaderIconButton(this.newThreadBtn,"file-plus",o("newThread"));let e=(t=this.plugin.client)!=null&&t.isRunning()?o("restart"):o("reconnect");this.setHeaderIconButton(this.restartBtn,"refresh-cw",e)}setHeaderIconButton(e,t,i){e&&((0,w.setIcon)(e,t),e.setAttribute("aria-label",i))}updateSendButton(){this.sendBtn&&((0,w.setIcon)(this.sendBtn,"arrow-up"),this.sendBtn.setAttribute("aria-label",o("send")))}autoResizeInput(){if(!this.inputEl)return;this.inputEl.style.height="auto";let e=Math.min(Math.max(this.inputEl.scrollHeight,80),300);this.inputEl.style.height=`${e}px`}setInputValue(e){this.inputEl.value=e,this.autoResizeInput()}isValidTabManagerState(e){if(!e||typeof e!="object")return!1;let t=e;return!Array.isArray(t.openTabs)||t.activeTabId!==null&&t.activeTabId!==void 0&&typeof t.activeTabId!="string"?!1:t.openTabs.every(i=>i&&typeof i=="object"&&typeof i.tabId=="string"&&(i.conversationId===null||typeof i.conversationId=="string"))}async restoreTabsWithFallback(){let e=this.plugin.settings._tabManagerState;if(this.isValidTabManagerState(e))try{await this.tabManager.restoreState(e);for(let i of this.tabManager.getAllTabStates()){if(!i.conversationId)continue;let s=this.tabManager.getTab(i.tabId);s&&await this.restoreTabConversation(s)}}catch(i){let s=i instanceof Error?i.message:String(i);new w.Notice(y("noticeRestoreTabsFailed",{error:s}))}if(!this.tabManager.getActiveTab()){let i=this.tabManager.getAllTabStates()[0];i&&this.tabManager.switchTo(i.tabId)}this.tabManager.getActiveTab()||await this.createNewTab()}async ensureActiveTabForInlineCard(){if(!this.tabManager)return null;let e=this.tabManager.getActiveTab();return e||(await this.createNewTab(),e=this.tabManager.getActiveTab()),e!=null?e:null}buildDefaultUserInputResponse(e){let t={};for(let i of e.questions){let s=i.options&&i.options.length>0?i.options[0].label:"";t[i.id]={answers:[s]}}return{answers:t}}getApprovalTitle(e){return e==="commandExecution"||e==="execCommand"?o("approvalTitleCommand"):e==="fileChange"||e==="applyPatch"?o("approvalTitleFile"):o("approvalTitleGeneric")}detectPlanFromToolOutput(e,t){let s=`${e.type||""} ${e.name||""}`.toLowerCase().includes("plan");if(!s&&!t.trim())return null;let r=this.parseStructuredPlan(t);return r||(s?this.detectPlanFromAssistantText(t):null)}detectPlanFromAssistantText(e){let t=this.parseMarkdownPlan(e);return t||this.parseStructuredPlan(e)}parseStructuredPlan(e){var u,g,v,m;let t=this.parseUnknownJson(e);if(!t||typeof t!="object")return null;let i=t,s=i.plan&&typeof i.plan=="object"?i.plan:i,r=Array.isArray(s.steps)?s.steps:[];if(r.length===0)return null;let a=[];for(let f=0;f<r.length;f++){let x=r[f];if(typeof x=="string"){let I=x.trim();if(!I)continue;a.push({id:`plan-step-${f+1}`,index:f+1,description:I,status:"pending"});continue}if(!x||typeof x!="object")continue;let T=x,h=(g=(u=T.description)!=null?u:T.text)!=null?g:T.title,A=typeof h=="string"?h.trim():"";if(!A)continue;let E=typeof T.status=="string"?T.status:"pending",P=typeof T.id=="string"?T.id.trim():"";a.push({id:P||`plan-step-${f+1}`,index:f+1,description:A,status:this.normalizePlanStepStatus(E)})}if(a.length===0)return null;let l=(m=(v=s.title)!=null?v:s.name)!=null?m:s.summary,d=typeof l=="string"&&l.trim()?l.trim():o("planTitle"),p=typeof s.status=="string"?s.status:"proposed";return{planId:(typeof s.planId=="string"?s.planId:typeof s.id=="string"?s.id:"").trim()||`plan-${Date.now()}-${Math.random().toString(36).slice(2,8)}`,title:d,steps:a,status:this.normalizePlanStatus(p)}}parseMarkdownPlan(e){if(!e||!e.trim())return null;let t=/(^|\n)\s*#{2,4}\s*(plan|steps?)\b/i.test(e),i=e.split(/\r?\n/),s=[];for(let a of i){let l=a.match(/^\s*(\d+)[\.\)]\s+(.+)$/);if(l){let d=l[2].trim();d&&s.push({id:`plan-step-${s.length+1}`,index:s.length+1,description:d,status:"pending"});continue}if(t){let d=a.match(/^\s*[-*]\s+(.+)$/);if(d){let p=d[1].trim();p&&s.push({id:`plan-step-${s.length+1}`,index:s.length+1,description:p,status:"pending"})}}}return(t?s.length>=2:s.length>=3)?{planId:`plan-${Date.now()}-${Math.random().toString(36).slice(2,8)}`,title:o("planTitle"),steps:s,status:"proposed"}:null}parseUnknownJson(e){if(e&&typeof e=="object")return e;if(typeof e!="string")return null;let t=e.trim();if(!t)return null;let i=[t],s=t.match(/```(?:json)?\s*([\s\S]*?)\s*```/i);s!=null&&s[1]&&i.unshift(s[1].trim());for(let r of i)try{return JSON.parse(r)}catch(a){}return null}normalizePlanStatus(e){let t=e.trim().toLowerCase();return t==="approved"?"approved":t==="in_progress"||t==="inprogress"||t==="executing"?"in_progress":t==="completed"||t==="done"?"completed":"proposed"}normalizePlanStepStatus(e){let t=e.trim().toLowerCase();return t==="approved"?"approved":t==="executing"||t==="in_progress"||t==="inprogress"?"executing":t==="completed"||t==="done"?"completed":t==="failed"||t==="error"?"failed":t==="skipped"?"skipped":"pending"}inferDiffEntryFromTool(e,t){var p;if(this.resolveEntryStatus(e.status)!=="completed")return null;let i=(e.type||(t==null?void 0:t.type)||"").trim().toLowerCase(),s=(e.name||(t==null?void 0:t.name)||"").trim(),r=(e.command||(t==null?void 0:t.command)||"").trim(),a=(p=e.filePath||(t==null?void 0:t.filePath)||this.extractFilePathFromCommand(r))==null?void 0:p.trim();if(!a)return null;let l=this.inferDiffStatusFromTool(i,s,r),d=r||s||e.type;return{filePath:a,status:l,summary:this.truncateStatusDetail(d)}}inferDiffStatusFromTool(e,t,i){let s=`${e} ${t} ${i}`.toLowerCase();return s.includes("delete")||s.includes("remove")||s.includes("unlink")||s.includes(" rm ")?"deleted":s.includes("create")||s.includes("new_file")||s.includes("add_file")||s.includes("mkdir")||s.includes("touch ")?"added":"modified"}extractFilePathFromCommand(e){if(!e)return null;let t=e.match(/["']([^"']+\.[\w-]+)["']/);if(t&&t[1])return(0,w.normalizePath)(t[1]);let i=e.split(/\s+/).map(s=>s.trim()).filter(Boolean);for(let s=i.length-1;s>=0;s--){let r=i[s];if(r&&!r.startsWith("-")){if(r.includes("/")||r.includes("\\"))return(0,w.normalizePath)(r.replace(/^['"]|['"]$/g,""));if(/\.[a-zA-Z0-9]{1,8}$/.test(r))return(0,w.normalizePath)(r.replace(/^['"]|['"]$/g,""))}}return null}resolveEntryStatus(e){let t=e.trim().toLowerCase();return t.includes("error")||t.includes("fail")||t.includes("deny")||t.includes("reject")||t.includes("cancel")||t.includes("interrupt")?"failed":"completed"}truncateStatusDetail(e){if(!e)return;let t=e.replace(/\s+/g," ").trim();if(t)return t.length<=80?t:`${t.slice(0,80)}...`}getAllowRuleTypeLabel(e){return e==="command"?o("allowRuleTypeCommand"):e==="file_write"?o("allowRuleTypeFileWrite"):o("allowRuleTypeTool")}isThreadNotFoundMessage(e){return e.toLowerCase().includes("thread not found")}isImageInputUnsupportedMessage(e){let t=e.toLowerCase();return t.includes("image")?t.includes("unknown variant")||t.includes("invalid")||t.includes("failed to parse")||t.includes("deserialize")||t.includes("not supported")||t.includes("unsupported"):!1}restoreStatusAfterInteractiveCard(){if(this.statusPanel){if(this.running){this.statusPanel.setTurnStatus("tool_calling");return}this.statusPanel.setTurnStatus("idle"),this.statusPanel.clearFinishedAfterDelay(3e3)}}debugLog(e,t){if(t===void 0){console.log(`[CODEXIDIAN DEBUG] ${e}`);return}console.log(`[CODEXIDIAN DEBUG] ${e} ${this.stringifyDebug(t)}`)}debugError(e,t,i){var l;let s=t instanceof Error?t.message:String(t),r=t instanceof Error&&(l=t.stack)!=null?l:"",a={...i!=null?i:{},message:s,stack:r};console.error(`[CODEXIDIAN DEBUG] ${e} ${this.stringifyDebug(a)}`)}stringifyDebug(e){try{return JSON.stringify(e)}catch(t){return String(e)}}};var $=require("obsidian");var ft=2e4,yt=8e3,Se=class{constructor(n,e=()=>({blockedPatterns:[],requireApprovalForWrite:!1,maxNoteSizeKb:500}),t){this.app=n;this.getSecuritySettings=e;this.requestWriteApproval=t}async handleToolCall(n){let e=this.normalizeToolName(n.name);return e==="list_notes"?await this.handleListNotes(n.arguments):e==="read_note"?await this.handleReadNote(n.arguments):e==="write_note"?await this.handleWriteNote(n.arguments):e==="search_notes"?await this.handleSearchNotes(n.arguments):this.errorResult(`Unknown MCP tool '${n.name}'. Supported tools: list_notes, read_note, write_note, search_notes.`)}async collectRelatedNotes(n,e,t){var g;let i=this.getPathValidator(),s=this.clampInt(t.limit,0,8,3);if(s<=0)return[];let r=this.clampInt(t.maxCharsPerNote,500,4e4,yt),a=(g=t.excludePaths)!=null?g:new Set,l=this.extractQueryTokens(n),d=this.app.vault.getMarkdownFiles(),p=[];for(let v of d){if(a.has(v.path)||!i.validate(v.path,"read").allowed)continue;let m=0,f=v.path.toLowerCase();for(let x of l)f.includes(x)&&(m+=3);e&&v.path===e&&(m+=20),m>0&&p.push({file:v,score:m})}if(p.length===0&&e&&!a.has(e)&&i.validate(e,"read").allowed){let v=this.app.vault.getAbstractFileByPath(e);v instanceof $.TFile&&p.push({file:v,score:20})}p.sort((v,m)=>m.score-v.score||v.file.path.localeCompare(m.file.path));let c=p.slice(0,s),u=[];for(let v of c)try{let m=await this.app.vault.read(v.file);u.push({path:v.file.path,content:this.truncateContent(m,r)})}catch(m){}return u}async handleListNotes(n){var l;let e=this.getOptionalString(n,["folder","path"]),t=this.clampInt(this.getOptionalNumber(n,["limit"]),1,200,50),i=e?(0,$.normalizePath)(e).replace(/\/+$/,""):null,s=this.getPathValidator();if(i){let d=s.validate(i,"read");if(!d.allowed)return this.blockedResult((l=d.reason)!=null?l:"Path matches security blocklist.")}let r=this.app.vault.getMarkdownFiles().filter(d=>!i||d.path===i||d.path.startsWith(`${i}/`)).filter(d=>s.validate(d.path,"read").allowed).map(d=>d.path).sort((d,p)=>d.localeCompare(p)).slice(0,t),a=r.length>0?r.map(d=>`- ${d}`).join(`
`):"(no matching notes)";return this.successResult(`Listed ${r.length} note(s)${i?` under '${i}'`:""}:
${a}`)}async handleReadNote(n){var d;let e=this.getOptionalString(n,["path","notePath","file"]);if(!e)return this.errorResult("read_note requires argument 'path'.");let t=(0,$.normalizePath)(e),i=this.getPathValidator().validate(t,"read");if(!i.allowed)return this.blockedResult((d=i.reason)!=null?d:"Path matches security blocklist.");let s=this.app.vault.getAbstractFileByPath(t);if(!(s instanceof $.TFile))return this.errorResult(`Note not found: ${t}`);let r=this.clampInt(this.getOptionalNumber(n,["maxChars","max_chars"]),500,1e5,ft),a=await this.app.vault.read(s),l=this.truncateContent(a,r);return this.successResult(`<note path="${s.path}">
${l}
</note>`)}async handleWriteNote(n){var g;let e=this.getOptionalString(n,["path","notePath","file"]),t=this.getOptionalString(n,["content","text"]),s=this.getOptionalString(n,["mode"])==="append"?"append":"overwrite";if(!e)return this.errorResult("write_note requires argument 'path'.");if(t===null)return this.errorResult("write_note requires argument 'content'.");let r=(0,$.normalizePath)(e),a=this.getPathValidator().validate(r,"write");if(!a.allowed)return this.blockedResult((g=a.reason)!=null?g:"Path matches security blocklist.");let l=this.getSecuritySettings(),d=this.getMaxWriteBytes(l.maxNoteSizeKb),p=this.app.vault.getAbstractFileByPath(r),c=t;if(p instanceof $.TFile){let v=await this.app.vault.read(p);c=s==="append"?`${v}${t}`:t}if(this.getByteLength(c)>d)return this.limitExceededResult(`write_note exceeds max note size (${l.maxNoteSizeKb} KB).`);if(l.requireApprovalForWrite){if(!this.requestWriteApproval)return this.blockedResult("Write requires approval but no approval handler is configured.");let v=!1;try{v=await this.requestWriteApproval({path:r,mode:s,content:t,contentBytes:this.getByteLength(t)})}catch(m){let f=m instanceof Error?m.message:String(m);return this.blockedResult(`Write approval failed: ${f}`)}if(!v)return this.blockedResult("Write operation denied by user approval.")}return p instanceof $.TFile?(await this.app.vault.modify(p,c),this.successResult(`Updated note '${r}' (${s}).`)):(await this.ensureParentFolders(r),await this.app.vault.create(r,t),this.successResult(`Created note '${r}'.`))}async handleSearchNotes(n){let e=this.getOptionalString(n,["query","q","keyword"]);if(!e)return this.errorResult("search_notes requires argument 'query'.");let t=this.clampInt(this.getOptionalNumber(n,["limit"]),1,20,5),i=e.toLowerCase(),s=this.app.vault.getMarkdownFiles(),r=[],a=this.getPathValidator();for(let p of s){if(!a.validate(p.path,"read").allowed)continue;let c=0;p.path.toLowerCase().includes(i)&&(c+=5);let g="";try{let v=await this.app.vault.read(p),f=v.toLowerCase().indexOf(i);f>=0&&(c+=10,g=this.extractSnippet(v,f,e.length))}catch(v){}c>0&&r.push({path:p.path,score:c,snippet:g})}r.sort((p,c)=>c.score-p.score||p.path.localeCompare(c.path));let l=r.slice(0,t);if(l.length===0)return this.successResult(`No note matched query '${e}'.`);let d=l.map((p,c)=>{let u=p.snippet?`
   ${p.snippet}`:"";return`${c+1}. ${p.path}${u}`}).join(`
`);return this.successResult(`Search results for '${e}':
${d}`)}async ensureParentFolders(n){let e=n.split("/");if(e.length<=1)return;let t="";for(let i=0;i<e.length-1;i++){t=t?`${t}/${e[i]}`:e[i];let s=this.app.vault.getAbstractFileByPath(t);if(!(s instanceof $.TFolder)){if(s instanceof $.TFile)throw new Error(`Cannot create folder '${t}' because a file with that path already exists.`);try{await this.app.vault.createFolder(t)}catch(r){}}}}successResult(n){return{success:!0,contentItems:[{type:"inputText",text:n}]}}errorResult(n){return{success:!1,isError:!0,contentItems:[{type:"inputText",text:n}]}}blockedResult(n){return{success:!1,isError:!0,error:"blocked",reason:n,contentItems:[{type:"inputText",text:JSON.stringify({error:"blocked",reason:n})}]}}limitExceededResult(n){return{success:!1,isError:!0,error:"limit_exceeded",reason:n,contentItems:[{type:"inputText",text:n}]}}getPathValidator(){return new G(this.getSecuritySettings().blockedPatterns)}getMaxWriteBytes(n){return(Number.isFinite(n)?Math.max(1,Math.round(n)):500)*1024}getByteLength(n){return new TextEncoder().encode(n).length}normalizeToolName(n){return n.trim().toLowerCase().replace(/^\//,"").replace(/[\s-]+/g,"_")}getOptionalString(n,e){for(let t of e){let i=n[t];if(typeof i=="string")return i}return null}getOptionalNumber(n,e){for(let t of e){let i=n[t];if(typeof i=="number"&&Number.isFinite(i))return i;if(typeof i=="string"&&i.trim().length>0){let s=Number(i);if(Number.isFinite(s))return s}}return null}clampInt(n,e,t,i){if(n===null)return i;let s=Math.round(n);return s<e?e:s>t?t:s}truncateContent(n,e){return n.length<=e?n:`${n.slice(0,e)}

...[truncated to ${e} chars]`}extractSnippet(n,e,t){let s=Math.max(0,e-90),r=Math.min(n.length,e+t+90),a=n.slice(s,r).replace(/\s+/g," ").trim();return s>0&&r<n.length?`...${a}...`:s>0?`...${a}`:r<n.length?`${a}...`:a}extractQueryTokens(n){let e=new Set(["the","and","for","that","this","with","from","what","when","where","how","why","about","into","over","after","before","have","has","are","was","were","you","your","note","notes","read","write","search"]);return n.toLowerCase().split(/[^a-z0-9_\u4e00-\u9fa5]+/i).map(t=>t.trim()).filter(t=>t.length>=2&&!e.has(t)).slice(0,8)}};var Pe=class extends M.Plugin{constructor(){super(...arguments);this.settings={...F};this.availableSkills=[]}async onload(){await this.loadSettings(),await this.refreshAvailableSkills(),ce(this.settings.locale),this.mcpService=new Se(this.app,()=>({blockedPatterns:this.settings.securityBlockedPaths,requireApprovalForWrite:this.settings.securityRequireApprovalForWrite,maxNoteSizeKb:this.settings.securityMaxNoteSize}),async e=>await this.requestMcpWriteApproval(e)),this.client=new ae(()=>this.settings,()=>this.getVaultBasePath(),e=>{this.settings.persistThread&&(this.settings.lastThreadId=e,this.saveSettings())},e=>{let t=this.getOpenView();t&&(t.appendSystemMessage(e),t.updateStatus())},async e=>await this.handleApprovalRequest(e),async e=>await this.handleUserInputRequest(e),async e=>await this.handleMcpToolCall(e)),this.registerView(Q,e=>new ie(e,this)),this.addRibbonIcon("bot",o("openCodexidianCommand"),()=>{this.activateView()}),this.addCommand({id:"open-codexidian",name:o("openCodexidianCommand"),callback:()=>{this.activateView()}}),this.addCommand({id:"codexidian-new-thread",name:o("startNewThreadCommand"),callback:async()=>{try{let e=await this.client.newThread();new M.Notice(y("noticeNewThreadCreated",{threadId:e.slice(0,8)})),this.refreshStatus()}catch(e){let t=e instanceof Error?e.message:String(e);new M.Notice(y("noticeCodexError",{error:t}))}}}),this.addSettingTab(new Le(this.app,this))}async onunload(){this.app.workspace.detachLeavesOfType(Q),this.client&&await this.client.dispose()}getVaultBasePath(){let e=this.app.vault.adapter;return e instanceof M.FileSystemAdapter?e.getBasePath():process.cwd()}getOpenView(){let e=this.app.workspace.getLeavesOfType(Q);if(e.length===0)return null;let t=e[0].view;return t instanceof ie?t:null}getAvailableSkills(){return[...this.availableSkills]}async refreshAvailableSkills(){var i;let e=[],t=new Set;try{let s=await this.app.vault.adapter.list(".codex/skills"),r=Array.isArray(s.folders)?s.folders:[];for(let a of r){if(typeof a!="string")continue;let l=a.replace(/\\/g,"/"),d=l.split("/").filter(Boolean),p=(i=d[d.length-1])==null?void 0:i.trim();!p||t.has(p)||!await this.app.vault.adapter.exists(`${l}/SKILL.md`)||(t.add(p),e.push(p))}}catch(s){return this.getAvailableSkills()}return e.sort((s,r)=>s.localeCompare(r)),this.availableSkills=e,this.settings.skillPreset!=="none"&&!e.includes(this.settings.skillPreset)&&(this.settings.skillPreset="none",await this.saveSettings()),this.getAvailableSkills()}async handleApprovalRequest(e){if(this.settings.approvalMode==="safe")return"decline";if(this.settings.approvalMode==="yolo")return"accept";let t=this.findMatchingAllowRule(e);if(t){let s=this.getOpenView();return s&&(s.appendSystemMessage(y("messageAutoApprovedByRule",{summary:this.buildApprovalSummary(e),pattern:t.pattern})),s.updateStatus()),"accept"}let i=this.getOpenView();if(i||(await this.activateView(),i=this.getOpenView()),!i)throw new Error("Codexidian view is not available for approval.");return await i.showApprovalCard(e)}async addAllowRuleFromApprovalRequest(e){let t=this.extractAllowRuleCandidate(e);if(!t)throw new Error("Unable to extract allow rule from approval request.");let i=this.settings.allowRules.find(r=>r.type===t.type&&r.pattern===t.pattern);if(i)return{status:"exists",ruleType:i.type,pattern:i.pattern};let s={id:`allow-${Date.now()}-${Math.random().toString(36).slice(2,8)}`,type:t.type,pattern:t.pattern,createdAt:Date.now()};return this.settings.allowRules.push(s),await this.saveSettings(),{status:"added",ruleType:s.type,pattern:s.pattern}}async handleUserInputRequest(e){let t=this.getOpenView();if(t||(await this.activateView(),t=this.getOpenView()),!t)throw new Error("Codexidian view is not available for user input.");return await t.showUserInputCard(e)}async handleMcpToolCall(e){if(!this.settings.enableMcp)return{success:!1,isError:!0,contentItems:[{type:"inputText",text:o("mcpDisabledMessage")}]};try{return await this.mcpService.handleToolCall(e)}catch(t){let i=t instanceof Error?t.message:String(t);return{success:!1,isError:!0,contentItems:[{type:"inputText",text:y("mcpToolExecutionFailed",{error:i})}]}}}async requestMcpWriteApproval(e){if(!this.settings.securityRequireApprovalForWrite)return!0;try{return await this.handleApprovalRequest({requestId:`mcp-write-${Date.now()}`,type:"fileChange",filePath:e.path,params:{source:"mcp/write_note",mode:e.mode,sizeBytes:e.contentBytes,preview:e.content.slice(0,300)}})==="accept"}catch(t){return!1}}async collectMcpContextForPrompt(e,t,i=new Set){if(!this.settings.enableMcp)return[];let s=this.settings.mcpContextNoteLimit;if(s<=0)return[];try{return await this.mcpService.collectRelatedNotes(e,t,{limit:s,maxCharsPerNote:8e3,excludePaths:i})}catch(r){return[]}}refreshStatus(){let e=this.getOpenView();e==null||e.updateStatus()}async activateView(){var i;let e=this.app.workspace,t=(i=e.getLeavesOfType(Q)[0])!=null?i:null;if(!t){if(t=e.getRightLeaf(!1),!t)return;await t.setViewState({type:Q,active:!0})}e.revealLeaf(t)}async loadSettings(){var t;let e=await this.loadData();if(this.settings=Object.assign({},F,e!=null?e:{}),De(this.settings.locale)||(this.settings.locale=F.locale),ce(this.settings.locale),this.settings.workingDirectory.trim()||(this.settings.workingDirectory=this.getVaultBasePath()),typeof this.settings.skillPreset!="string"||this.settings.skillPreset.trim().length===0?this.settings.skillPreset=F.skillPreset:this.settings.skillPreset=this.settings.skillPreset.trim(),!Re(this.settings.approvalMode)){let i=String((t=e==null?void 0:e.collaborationMode)!=null?t:"").trim().toLowerCase();this.settings.approvalMode=i==="autonomous"||i==="interactive"||i==="plan-first"?F.approvalMode:F.approvalMode}Array.isArray(this.settings.securityBlockedPaths)?this.settings.securityBlockedPaths=this.settings.securityBlockedPaths.map(i=>String(i).trim()).filter(i=>i.length>0):this.settings.securityBlockedPaths=[...F.securityBlockedPaths],typeof this.settings.enableReviewPane!="boolean"&&(this.settings.enableReviewPane=F.enableReviewPane),this.settings.allowRules=this.normalizeAllowRules(this.settings.allowRules),(!Number.isFinite(this.settings.securityMaxNoteSize)||this.settings.securityMaxNoteSize<=0)&&(this.settings.securityMaxNoteSize=F.securityMaxNoteSize)}async saveSettings(){await this.saveData(this.settings)}normalizeAllowRules(e){var i,s,r;if(!Array.isArray(e))return[];let t=[];for(let a of e){if(!a||typeof a!="object")continue;let l=String((i=a.type)!=null?i:"").trim();if(!this.isAllowRuleType(l))continue;let d=String((s=a.pattern)!=null?s:"").trim();if(!d)continue;let p=Number(a.createdAt),c=Number.isFinite(p)&&p>0?p:Date.now(),g=String((r=a.id)!=null?r:"").trim()||`allow-${c}-${Math.random().toString(36).slice(2,8)}`;t.push({id:g,type:l,pattern:d,createdAt:c})}return t}isAllowRuleType(e){return e==="command"||e==="file_write"||e==="tool"}findMatchingAllowRule(e){let t=this.settings.allowRules;if(!Array.isArray(t)||t.length===0)return null;let i=this.extractApprovalCommand(e),s=this.extractApprovalToolName(e),r=this.extractApprovalFilePaths(e);for(let a of t){if(a.type==="command"){if(i&&i.startsWith(a.pattern))return a;continue}if(a.type==="file_write"){let l=this.normalizeFilePathForRule(a.pattern);if(r.some(p=>this.normalizeFilePathForRule(p).startsWith(l)))return a;continue}if(a.type==="tool"&&s&&s.toLowerCase()===a.pattern.toLowerCase())return a}return null}extractAllowRuleCandidate(e){let t=this.extractApprovalCommand(e);if(t)return{type:"command",pattern:t};let i=this.extractApprovalFilePaths(e)[0];if(i)return{type:"file_write",pattern:i};let s=this.extractApprovalToolName(e);return s?{type:"tool",pattern:s}:null}extractApprovalCommand(e){var r,a,l;let t=typeof e.command=="string"?e.command.trim():"";if(t)return t;let i=e.params,s=[i==null?void 0:i.command,i==null?void 0:i.cmd,(r=i==null?void 0:i.input)==null?void 0:r.command,(a=i==null?void 0:i.request)==null?void 0:a.command,(l=i==null?void 0:i.request)==null?void 0:l.cmd].find(d=>typeof d=="string");return typeof s=="string"?s.trim():""}extractApprovalFilePaths(e){var d,p,c;let t=[];typeof e.filePath=="string"&&e.filePath.trim()&&t.push(e.filePath.trim());let i=e.params,s=[i==null?void 0:i.path,i==null?void 0:i.filePath,i==null?void 0:i.targetPath,(d=i==null?void 0:i.request)==null?void 0:d.path,(p=i==null?void 0:i.request)==null?void 0:p.filePath,(c=i==null?void 0:i.request)==null?void 0:c.targetPath];for(let u of s)typeof u=="string"&&u.trim()&&t.push(u.trim());let r=i==null?void 0:i.files;if(Array.isArray(r))for(let u of r){if(typeof u=="string"&&u.trim()){t.push(u.trim());continue}if(!u||typeof u!="object")continue;let g=u,v=[g.path,g.filePath,g.newPath,g.oldPath].find(m=>typeof m=="string"&&m.trim().length>0);typeof v=="string"&&t.push(v.trim())}let a=[],l=new Set;for(let u of t){let g=u.trim();!g||l.has(g)||(l.add(g),a.push(g))}return a}extractApprovalToolName(e){var s,r,a;let t=e.params,i=[t==null?void 0:t.tool,t==null?void 0:t.toolName,t==null?void 0:t.name,(s=t==null?void 0:t.request)==null?void 0:s.tool,(r=t==null?void 0:t.request)==null?void 0:r.toolName,(a=t==null?void 0:t.request)==null?void 0:a.name].find(l=>typeof l=="string"&&l.trim().length>0);return typeof i=="string"?i.trim():""}normalizeFilePathForRule(e){return e.trim().replace(/\\/g,"/").replace(/\/{2,}/g,"/").replace(/^\.\//,"").toLowerCase()}buildApprovalSummary(e){let t=this.extractApprovalCommand(e);if(t)return`${e.type} (${t.slice(0,80)})`;let i=this.extractApprovalFilePaths(e)[0];if(i)return`${e.type} (${i})`;let s=this.extractApprovalToolName(e);return s?`${e.type} (${s})`:e.type}},Le=class extends M.PluginSettingTab{constructor(e,t){super(e,t);this.plugin=t}display(){let{containerEl:e}=this;e.empty(),e.createEl("h2",{text:o("settingsTitle")}),new M.Setting(e).setName(o("settingLanguageName")).setDesc(o("settingLanguageDesc")).addDropdown(s=>s.addOption("zh",o("localeNameZh")).addOption("en",o("localeNameEn")).setValue(this.plugin.settings.locale).onChange(async r=>{var a;De(r)&&(this.plugin.settings.locale=r,ce(r),await this.plugin.saveSettings(),(a=this.plugin.getOpenView())==null||a.refreshLocale(),this.display())})),new M.Setting(e).setName(o("settingCodexCommandName")).setDesc(o("settingCodexCommandDesc")).addText(s=>s.setPlaceholder("codex.cmd").setValue(this.plugin.settings.codexCommand).onChange(async r=>{this.plugin.settings.codexCommand=r.trim()||F.codexCommand,await this.plugin.saveSettings()})),new M.Setting(e).setName(o("settingWorkingDirName")).setDesc(o("settingWorkingDirDesc")).addText(s=>s.setPlaceholder(this.plugin.getVaultBasePath()).setValue(this.plugin.settings.workingDirectory).onChange(async r=>{this.plugin.settings.workingDirectory=r.trim()||this.plugin.getVaultBasePath(),await this.plugin.saveSettings()})),new M.Setting(e).setName(o("settingModelName")).setDesc(o("settingModelDesc")).addDropdown(s=>{for(let r of j)s.addOption(r.value,r.label);s.setValue(this.plugin.settings.model).onChange(async r=>{this.plugin.settings.model=r,await this.plugin.saveSettings()})}),new M.Setting(e).setName(o("settingEffortName")).setDesc(o("settingEffortDesc")).addDropdown(s=>{for(let r of K)s.addOption(r.value,r.label);s.setValue(this.plugin.settings.thinkingEffort).onChange(async r=>{this.plugin.settings.thinkingEffort=r,await this.plugin.saveSettings()})}),new M.Setting(e).setName(o("settingSkillPresetName")).setDesc(o("settingSkillPresetDesc")).addDropdown(s=>{s.addOption("none",o("skillPresetNone"));for(let a of this.plugin.getAvailableSkills())s.addOption(a,a);let r=this.plugin.settings.skillPreset||"none";r!=="none"&&!this.plugin.getAvailableSkills().includes(r)&&s.addOption(r,r),s.setValue(r).onChange(async a=>{this.plugin.settings.skillPreset=a.trim()||F.skillPreset,await this.plugin.saveSettings()})}),new M.Setting(e).setName(o("settingCollaborationModeName")).setDesc(o("settingCollaborationModeDesc")).addDropdown(s=>{for(let r of Z)s.addOption(r.value,`${r.label} (${r.description})`);s.setValue(this.plugin.settings.approvalMode).onChange(async r=>{this.plugin.settings.approvalMode=Re(r)?r:F.approvalMode,await this.plugin.saveSettings()})}),e.createEl("h3",{text:o("settingsAllowRulesSection")}),e.createEl("p",{cls:"setting-item-description",text:o("settingsAllowRulesDesc")});let t=e.createDiv({cls:"codexidian-allow-rules-list"}),i=[...this.plugin.settings.allowRules].sort((s,r)=>r.createdAt-s.createdAt);if(i.length===0)t.createDiv({cls:"codexidian-allow-rules-empty",text:o("allowRulesEmpty")});else for(let s of i){let r=t.createDiv({cls:"codexidian-allow-rule-item"});r.createDiv({cls:"codexidian-allow-rule-meta",text:`${this.getAllowRuleTypeLabel(s.type)}: ${s.pattern}`});let a=r.createEl("button",{cls:"codexidian-allow-rule-remove",text:o("allowRuleDelete")});a.type="button",a.addEventListener("click",()=>{(async()=>{try{this.plugin.settings.allowRules=this.plugin.settings.allowRules.filter(l=>l.id!==s.id),await this.plugin.saveSettings(),new M.Notice(o("noticeAllowRuleRemoved")),this.display()}catch(l){let d=l instanceof Error?l.message:String(l);new M.Notice(y("noticeAllowRuleRemoveFailed",{error:d}))}})()})}this.plugin.settings.allowRules.length>0&&new M.Setting(e).setName(o("allowRulesClearAll")).addButton(s=>s.setButtonText(o("allowRulesClearAll")).onClick(()=>{(async()=>{if(window.confirm(o("confirmAllowRulesClearAll")))try{this.plugin.settings.allowRules=[],await this.plugin.saveSettings(),new M.Notice(o("noticeAllowRulesCleared")),this.display()}catch(a){let l=a instanceof Error?a.message:String(a);new M.Notice(y("noticeAllowRulesClearFailed",{error:l}))}})()})),new M.Setting(e).setName(o("settingApprovalPolicyName")).setDesc(o("settingApprovalPolicyDesc")).addDropdown(s=>s.addOption("on-request","on-request").addOption("never","never").addOption("untrusted","untrusted").addOption("on-failure","on-failure").setValue(this.plugin.settings.approvalPolicy).onChange(async r=>{this.plugin.settings.approvalPolicy=r,await this.plugin.saveSettings(),this.plugin.refreshStatus()})),new M.Setting(e).setName(o("settingSandboxName")).setDesc(o("settingSandboxDesc")).addDropdown(s=>s.addOption("workspace-write","workspace-write").addOption("read-only","read-only").addOption("danger-full-access","danger-full-access").setValue(this.plugin.settings.sandboxMode).onChange(async r=>{this.plugin.settings.sandboxMode=r,await this.plugin.saveSettings(),this.plugin.refreshStatus()})),new M.Setting(e).setName(o("settingAutoApproveName")).setDesc(o("settingAutoApproveDesc")).addToggle(s=>s.setValue(this.plugin.settings.autoApproveRequests).onChange(async r=>{this.plugin.settings.autoApproveRequests=r,await this.plugin.saveSettings()})),new M.Setting(e).setName(o("settingPersistThreadName")).setDesc(o("settingPersistThreadDesc")).addToggle(s=>s.setValue(this.plugin.settings.persistThread).onChange(async r=>{this.plugin.settings.persistThread=r,r||(this.plugin.settings.lastThreadId="",this.plugin.client.setThreadId(null)),await this.plugin.saveSettings(),this.plugin.refreshStatus()})),new M.Setting(e).setName(o("settingSavedThreadName")).setDesc(this.plugin.settings.lastThreadId||o("settingSavedThreadEmpty")).addButton(s=>s.setButtonText(o("settingSavedThreadClear")).onClick(async()=>{this.plugin.settings.lastThreadId="",this.plugin.client.setThreadId(null),await this.plugin.saveSettings(),this.display(),this.plugin.refreshStatus(),new M.Notice(o("noticeSavedThreadCleared"))})),e.createEl("h3",{text:o("settingsUiSection")}),new M.Setting(e).setName(o("settingMaxTabsName")).setDesc(o("settingMaxTabsDesc")).addSlider(s=>s.setLimits(1,5,1).setValue(this.plugin.settings.maxTabs).setDynamicTooltip().onChange(async r=>{this.plugin.settings.maxTabs=r,await this.plugin.saveSettings()})),new M.Setting(e).setName(o("settingContextInjectionName")).setDesc(o("settingContextInjectionDesc")).addToggle(s=>s.setValue(this.plugin.settings.enableContextInjection).onChange(async r=>{this.plugin.settings.enableContextInjection=r,await this.plugin.saveSettings()})),new M.Setting(e).setName(o("settingSelectionPollingName")).setDesc(o("settingSelectionPollingDesc")).addToggle(s=>s.setValue(this.plugin.settings.enableSelectionPolling).onChange(async r=>{this.plugin.settings.enableSelectionPolling=r,await this.plugin.saveSettings()})),new M.Setting(e).setName(o("settingEnableReviewPaneName")).setDesc(o("settingEnableReviewPaneDesc")).addToggle(s=>s.setValue(this.plugin.settings.enableReviewPane).onChange(async r=>{this.plugin.settings.enableReviewPane=r,await this.plugin.saveSettings()})),e.createEl("h3",{text:o("settingsMcpSection")}),new M.Setting(e).setName(o("settingEnableMcpName")).setDesc(o("settingEnableMcpDesc")).addToggle(s=>s.setValue(this.plugin.settings.enableMcp).onChange(async r=>{this.plugin.settings.enableMcp=r,await this.plugin.saveSettings()})),new M.Setting(e).setName(o("settingMcpEndpointName")).setDesc(o("settingMcpEndpointDesc")).addText(s=>s.setPlaceholder("http://127.0.0.1:27124").setValue(this.plugin.settings.mcpEndpoint).onChange(async r=>{this.plugin.settings.mcpEndpoint=r.trim(),await this.plugin.saveSettings()})),new M.Setting(e).setName(o("settingMcpApiKeyName")).setDesc(o("settingMcpApiKeyDesc")).addText(s=>s.setPlaceholder("API key").setValue(this.plugin.settings.mcpApiKey).onChange(async r=>{this.plugin.settings.mcpApiKey=r.trim(),await this.plugin.saveSettings()})),new M.Setting(e).setName(o("settingMcpContextLimitName")).setDesc(o("settingMcpContextLimitDesc")).addSlider(s=>s.setLimits(0,8,1).setValue(this.plugin.settings.mcpContextNoteLimit).setDynamicTooltip().onChange(async r=>{this.plugin.settings.mcpContextNoteLimit=r,await this.plugin.saveSettings()})),e.createEl("h3",{text:o("settingsSecuritySection")}),new M.Setting(e).setName(o("settingBlockedPathsName")).setDesc(o("settingBlockedPathsDesc")).addTextArea(s=>{s.inputEl.rows=6,s.setPlaceholder(`.obsidian/
.codex/
.env
*.secret`).setValue(this.plugin.settings.securityBlockedPaths.join(`
`)).onChange(async r=>{this.plugin.settings.securityBlockedPaths=r.split(/\r?\n/).map(a=>a.trim()).filter(a=>a.length>0),await this.plugin.saveSettings()})}),new M.Setting(e).setName(o("settingRequireApprovalWriteName")).setDesc(o("settingRequireApprovalWriteDesc")).addToggle(s=>s.setValue(this.plugin.settings.securityRequireApprovalForWrite).onChange(async r=>{this.plugin.settings.securityRequireApprovalForWrite=r,await this.plugin.saveSettings()})),new M.Setting(e).setName(o("settingMaxNoteSizeName")).setDesc(o("settingMaxNoteSizeDesc")).addText(s=>s.setPlaceholder(String(F.securityMaxNoteSize)).setValue(String(this.plugin.settings.securityMaxNoteSize)).onChange(async r=>{let a=Number.parseInt(r.trim(),10);this.plugin.settings.securityMaxNoteSize=Number.isFinite(a)&&a>0?a:F.securityMaxNoteSize,await this.plugin.saveSettings()}))}getAllowRuleTypeLabel(e){return e==="command"?o("allowRuleTypeCommand"):e==="file_write"?o("allowRuleTypeFileWrite"):o("allowRuleTypeTool")}};
