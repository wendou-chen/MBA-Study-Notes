var ot=Object.defineProperty;var Pt=Object.getOwnPropertyDescriptor;var Dt=Object.getOwnPropertyNames;var kt=Object.prototype.hasOwnProperty;var Rt=(T,e)=>{for(var t in e)ot(T,t,{get:e[t],enumerable:!0})},Lt=(T,e,t,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of Dt(e))!kt.call(T,i)&&i!==t&&ot(T,i,{get:()=>e[i],enumerable:!(n=Pt(e,i))||n.enumerable});return T};var $t=T=>Lt(ot({},"__esModule",{value:!0}),T);var Ot={};Rt(Ot,{default:()=>st});module.exports=$t(Ot);var w=require("obsidian");var Ct=require("child_process"),_=class{constructor(e,t,n,i,s,r){this.getSettings=e;this.getVaultPath=t;this.onThreadIdChanged=n;this.onSystemMessage=i;this.onApprovalRequest=s;this.onUserInputRequest=r;this.process=null;this.stdoutBuffer="";this.stderrBuffer="";this.requestCounter=1;this.pendingRequests=new Map;this.pendingTurns=new Map;this.preTurnDeltas=new Map;this.preTurnToolDeltas=new Map;this.preTurnThinkingDeltas=new Map;this.preTurnToolStarts=new Map;this.preTurnToolCompletes=new Map;this.preTurnResult=new Map;this.turnHasMessageDelta=new Set;this.turnHasThinkingDelta=new Set;this.turnActiveToolItemId=new Map;this.startPromise=null;this.disposed=!1;this.currentThreadId=null;this.currentTurnId=null}getThreadId(){return this.currentThreadId}getCurrentTurnId(){return this.currentTurnId}setThreadId(e){this.currentThreadId=e}async cancelTurn(e){var s;let t=e.trim();if(!t)return!1;let n=!1;if(this.process&&!this.process.killed)try{await this.request("turn/cancel",{turnId:t}),n=!0}catch(r){}let i=this.pendingTurns.get(t);return i&&(this.pendingTurns.delete(t),i.resolve({threadId:(s=this.currentThreadId)!=null?s:"",turnId:t,status:"cancelled",errorMessage:"Cancelled by user"}),n=!0),this.preTurnDeltas.delete(t),this.preTurnToolDeltas.delete(t),this.preTurnThinkingDeltas.delete(t),this.preTurnToolStarts.delete(t),this.preTurnToolCompletes.delete(t),this.preTurnResult.delete(t),this.clearTurnTransientState(t),this.clearCurrentTurnId(t),n}async restart(){await this.dispose(),this.disposed=!1,await this.start()}async dispose(){this.disposed=!0;for(let[e,t]of this.pendingRequests)clearTimeout(t.timeout),t.reject(new Error("Codex app-server stopped.")),this.pendingRequests.delete(e);for(let[e,t]of this.pendingTurns)t.reject(new Error(`Turn ${e} interrupted: app-server stopped.`)),this.pendingTurns.delete(e),this.clearTurnTransientState(e),this.clearCurrentTurnId(e);this.process&&!this.process.killed&&this.process.kill(),this.process=null,this.stdoutBuffer="",this.stderrBuffer="",this.startPromise=null,this.currentTurnId=null,this.preTurnDeltas.clear(),this.preTurnToolDeltas.clear(),this.preTurnThinkingDeltas.clear(),this.preTurnToolStarts.clear(),this.preTurnToolCompletes.clear(),this.preTurnResult.clear(),this.turnHasMessageDelta.clear(),this.turnHasThinkingDelta.clear(),this.turnActiveToolItemId.clear()}async newThread(){return await this.start(),await this.startThread()}async sendTurn(e,t={},n){var a,o;await this.start();let i=await this.ensureThread(),s=await this.request("turn/start",{threadId:i,input:[{type:"text",text:e,text_elements:[]}],cwd:null,approvalPolicy:null,sandboxPolicy:null,model:((a=n==null?void 0:n.model)==null?void 0:a.trim())||null,effort:(n==null?void 0:n.effort)||null,summary:null,personality:null,outputSchema:null,collaborationMode:null}),r=(o=s==null?void 0:s.turn)==null?void 0:o.id;if(!r)throw new Error("turn/start did not return turn id.");return this.currentTurnId=r,await new Promise((l,p)=>{var h,y,S,x,A;let g=setTimeout(()=>{this.pendingTurns.has(r)&&(this.pendingTurns.delete(r),this.clearTurnTransientState(r),this.clearCurrentTurnId(r),p(new Error("Turn timed out after 15 minutes.")))},9e5);this.pendingTurns.set(r,{handlers:t,resolve:C=>{clearTimeout(g),this.clearTurnTransientState(r),this.clearCurrentTurnId(r),l(C)},reject:C=>{clearTimeout(g),this.clearTurnTransientState(r),this.clearCurrentTurnId(r),p(C)},startedAt:Date.now()});let m=this.preTurnDeltas.get(r);if(m&&m.length>0){for(let C of m)(h=t.onDelta)==null||h.call(t,C);this.preTurnDeltas.delete(r)}let b=this.preTurnToolDeltas.get(r);if(b&&b.length>0){for(let C of b)(y=t.onToolDelta)==null||y.call(t,C);this.preTurnToolDeltas.delete(r)}let I=this.preTurnThinkingDeltas.get(r);if(I&&I.length>0){for(let C of I)(S=t.onThinkingDelta)==null||S.call(t,C);this.preTurnThinkingDeltas.delete(r)}let d=this.preTurnToolStarts.get(r);if(d&&d.length>0){for(let C of d)(x=t.onToolStart)==null||x.call(t,C);this.preTurnToolStarts.delete(r)}let c=this.preTurnToolCompletes.get(r);if(c&&c.length>0){for(let C of c)(A=t.onToolComplete)==null||A.call(t,C);this.preTurnToolCompletes.delete(r)}let u=this.preTurnResult.get(r);u&&(this.preTurnResult.delete(r),this.pendingTurns.delete(r),this.clearTurnTransientState(r),this.clearCurrentTurnId(r),l(u))})}async start(){if(!this.process){if(this.startPromise){await this.startPromise;return}this.startPromise=this.startInternal();try{await this.startPromise}finally{this.startPromise=null}}}async startInternal(){var i,s;let e=this.getSettings(),t=this.resolveCwd(e),n=(0,Ct.spawn)(e.codexCommand,["app-server","--listen","stdio://"],{cwd:t,env:process.env,shell:process.platform==="win32",windowsHide:!0});this.process=n,(i=n.stdout)==null||i.on("data",r=>{this.consumeStdout(r.toString())}),(s=n.stderr)==null||s.on("data",r=>{this.consumeStderr(r.toString())}),n.on("exit",r=>{let a=`Codex app-server exited (${r!=null?r:"unknown"}).`;this.disposed||this.onSystemMessage(a);for(let[o,l]of this.pendingRequests)clearTimeout(l.timeout),l.reject(new Error(a)),this.pendingRequests.delete(o);for(let[o,l]of this.pendingTurns)l.reject(new Error(a)),this.pendingTurns.delete(o),this.clearTurnTransientState(o),this.clearCurrentTurnId(o);this.process=null,this.currentTurnId=null}),await this.request("initialize",{clientInfo:{name:"codexidian",title:"Codexidian",version:"0.1.0"},capabilities:{experimentalApi:!0,optOutNotificationMethods:null}}),this.notify("initialized")}async ensureThread(){var n,i;if(this.currentThreadId)return this.currentThreadId;let e=this.getSettings(),t=e.persistThread?(n=e.lastThreadId)==null?void 0:n.trim():"";if(t)try{let s=await this.request("thread/resume",{threadId:t,model:e.model.trim()||null,modelProvider:null,cwd:this.resolveCwd(e),approvalPolicy:e.approvalPolicy,sandbox:e.sandboxMode,config:null,baseInstructions:null,developerInstructions:null,personality:null}),r=(i=s==null?void 0:s.thread)==null?void 0:i.id;if(r)return this.updateThreadId(r),r}catch(s){let r=s instanceof Error?s.message:String(s);this.onSystemMessage(`Failed to resume thread, starting new one. (${r})`)}return await this.startThread()}async startThread(){var i;let e=this.getSettings(),t=await this.request("thread/start",{model:e.model.trim()||null,modelProvider:null,cwd:this.resolveCwd(e),approvalPolicy:e.approvalPolicy,sandbox:e.sandboxMode,config:null,baseInstructions:null,developerInstructions:null,personality:null,ephemeral:!1,experimentalRawEvents:!1,persistExtendedHistory:!0}),n=(i=t==null?void 0:t.thread)==null?void 0:i.id;if(!n)throw new Error("thread/start did not return thread id.");return this.updateThreadId(n),n}resolveCwd(e){let t=e.workingDirectory.trim();return t||this.getVaultPath()}consumeStdout(e){var n;this.stdoutBuffer+=e;let t=this.stdoutBuffer.split(/\r?\n/);this.stdoutBuffer=(n=t.pop())!=null?n:"";for(let i of t){let s=i.trim();if(!s)continue;let r;try{r=JSON.parse(s)}catch(a){this.onSystemMessage(`[app-server/stdout] ${s}`);continue}this.routeIncomingMessage(r)}}consumeStderr(e){var n;this.stderrBuffer+=e;let t=this.stderrBuffer.split(/\r?\n/);this.stderrBuffer=(n=t.pop())!=null?n:"";for(let i of t){let s=i.trim();s&&(s.includes("failed to install system skills")||s.includes("failed to record rollout")||s.startsWith("WARNING: proceeding, even though we could not update PATH")||this.onSystemMessage(`[app-server/stderr] ${s}`))}}routeIncomingMessage(e){if(e&&Object.prototype.hasOwnProperty.call(e,"id")&&(Object.prototype.hasOwnProperty.call(e,"result")||Object.prototype.hasOwnProperty.call(e,"error"))){this.resolvePendingRequest(e);return}if(e&&Object.prototype.hasOwnProperty.call(e,"id")&&typeof e.method=="string"){this.handleServerRequest(e);return}e&&typeof e.method=="string"&&this.handleNotification(e)}resolvePendingRequest(e){var i;let t=String(e.id),n=this.pendingRequests.get(t);if(n){if(clearTimeout(n.timeout),this.pendingRequests.delete(t),Object.prototype.hasOwnProperty.call(e,"error")&&e.error){let s=((i=e.error)==null?void 0:i.message)||JSON.stringify(e.error);n.reject(new Error(s));return}n.resolve(e.result)}}async handleServerRequest(e){let t=e.id,n=e.method,i=this.getSettings();try{let s;if(this.isApprovalMethod(n)){let r=this.mapApprovalType(n),a={requestId:t,type:r,command:this.extractApprovalCommand(e.params),filePath:this.extractApprovalFilePath(e.params),cwd:this.extractApprovalCwd(e.params),params:e.params},o=await this.resolveApprovalDecision(a,i.autoApproveRequests);n==="execCommandApproval"||n==="applyPatchApproval"?s={decision:o==="accept"?"approved":"denied"}:s={decision:o}}else if(n==="item/tool/requestUserInput"){let r=this.buildUserInputRequest(t,e.params),a=null;if(this.onUserInputRequest)try{a=await this.withTimeout(this.onUserInputRequest(r),6e4)}catch(o){let l=o instanceof Error?o.message:String(o);this.onSystemMessage(`[input] Request timed out, using fallback response. (${l})`)}s=a!=null?a:this.buildDefaultUserInputResponse(r)}else if(n==="item/tool/call")s={success:!1,contentItems:[{type:"inputText",text:"Dynamic tool call is not handled by Codexidian."}]};else{this.writeJson({id:t,error:{code:-32601,message:`Unsupported server request: ${n}`}});return}this.writeJson({id:t,result:s})}catch(s){let r=s instanceof Error?s.message:String(s);this.writeJson({id:t,error:{code:-32603,message:r}})}}isApprovalMethod(e){return e==="item/commandExecution/requestApproval"||e==="item/fileChange/requestApproval"||e==="execCommandApproval"||e==="applyPatchApproval"}mapApprovalType(e){return e==="item/commandExecution/requestApproval"?"commandExecution":e==="item/fileChange/requestApproval"?"fileChange":e==="execCommandApproval"?"execCommand":"applyPatch"}async resolveApprovalDecision(e,t){let n=this.buildApprovalSummary(e);if(t)return this.onSystemMessage(`[approval] Auto-approved ${n}`),"accept";if(this.onApprovalRequest)try{return await this.withTimeout(this.onApprovalRequest(e),6e4)}catch(i){let s=i instanceof Error?i.message:String(i);return this.onSystemMessage(`[approval] Timed out. Denied ${n}. (${s})`),"decline"}return this.onSystemMessage(`[approval] No approval UI available. Denied ${n}.`),"decline"}buildApprovalSummary(e){return e.command?`${e.type} (${e.command.slice(0,80)})`:e.filePath?`${e.type} (${e.filePath})`:e.type}extractApprovalCommand(e){var n,i,s,r,a,o,l;let t=(l=(a=(s=(n=e==null?void 0:e.command)!=null?n:e==null?void 0:e.cmd)!=null?s:(i=e==null?void 0:e.input)==null?void 0:i.command)!=null?a:(r=e==null?void 0:e.request)==null?void 0:r.command)!=null?l:(o=e==null?void 0:e.request)==null?void 0:o.cmd;if(typeof t=="string"&&t.trim().length>0)return t.trim();if(Array.isArray(e==null?void 0:e.command)&&e.command.every(p=>typeof p=="string"))return e.command.join(" ").trim()||void 0}extractApprovalFilePath(e){var i,s,r,a,o,l,p,g,m;let t=(g=(l=(a=(s=(i=e==null?void 0:e.filePath)!=null?i:e==null?void 0:e.path)!=null?s:e==null?void 0:e.targetPath)!=null?a:(r=e==null?void 0:e.request)==null?void 0:r.filePath)!=null?l:(o=e==null?void 0:e.request)==null?void 0:o.path)!=null?g:(p=e==null?void 0:e.file)==null?void 0:p.path;if(typeof t=="string"&&t.trim().length>0)return t.trim();let n=Array.isArray(e==null?void 0:e.changes)?(m=e.changes.find(b=>typeof(b==null?void 0:b.path)=="string"))==null?void 0:m.path:void 0;if(typeof n=="string"&&n.trim().length>0)return n.trim()}extractApprovalCwd(e){var n,i,s;let t=(s=(n=e==null?void 0:e.cwd)!=null?n:e==null?void 0:e.workingDirectory)!=null?s:(i=e==null?void 0:e.request)==null?void 0:i.cwd;if(typeof t=="string"&&t.trim().length>0)return t.trim()}buildUserInputRequest(e,t){let i=(Array.isArray(t==null?void 0:t.questions)?t.questions:[]).map(s=>{let r=typeof(s==null?void 0:s.id)=="string"?s.id:"";if(!r)return null;let a=typeof(s==null?void 0:s.question)=="string"?s.question:typeof(s==null?void 0:s.text)=="string"?s.text:void 0,o=Array.isArray(s==null?void 0:s.options)?s.options.map(l=>{let p=typeof(l==null?void 0:l.label)=="string"?l.label:"";return p?{label:p}:null}).filter(l=>!!l):void 0;return{id:r,text:a,options:o}}).filter(s=>!!s);return{requestId:e,questions:i}}buildDefaultUserInputResponse(e){let t={};for(let n of e.questions){let i=n.options&&n.options.length>0?n.options[0].label:"";t[n.id]={answers:[i]}}return{answers:t}}async withTimeout(e,t){return await new Promise((n,i)=>{let s=setTimeout(()=>{i(new Error(`timeout after ${t}ms`))},t);e.then(r=>{clearTimeout(s),n(r)},r=>{clearTimeout(s),i(r)})})}handleNotification(e){var i,s,r,a,o,l,p,g,m,b,I;let t=e.method,n=(i=e.params)!=null?i:{};if(t==="thread/started"){let d=(s=n==null?void 0:n.thread)==null?void 0:s.id;typeof d=="string"&&d&&this.updateThreadId(d);return}if(t==="item/agentMessage/delta"){let d=n==null?void 0:n.turnId,c=n==null?void 0:n.delta;typeof d=="string"&&typeof c=="string"&&c.length>0&&(this.turnHasMessageDelta.add(d),this.emitTurnDelta(d,c));return}if(t==="item/commandExecution/outputDelta"||t==="item/fileChange/outputDelta"){let d=n==null?void 0:n.turnId,c=n==null?void 0:n.delta;if(typeof d=="string"&&typeof c=="string"&&c.length>0){let u=this.extractItemId((r=n==null?void 0:n.item)!=null?r:n,d);u&&this.turnActiveToolItemId.set(d,u),this.emitToolDelta(d,c)}return}if(t.startsWith("item/")&&t.endsWith("/delta")){let d=n==null?void 0:n.turnId,c=this.extractTextDelta(n);typeof d=="string"&&typeof c=="string"&&c.length>0&&this.isThinkingMethod(t)&&this.emitThinkingDelta(d,c);return}if(t==="item/started"){let d=n==null?void 0:n.turnId,c=n==null?void 0:n.item,u=this.normalizeItemType((a=c==null?void 0:c.type)!=null?a:n==null?void 0:n.type),h=this.extractItemId(c,d);if(typeof d=="string"&&h){if(this.isThinkingType(u)){let y=this.extractTextDelta(c);y&&this.emitThinkingDelta(d,y);return}if(u!=="agentmessage"){let y={turnId:d,itemId:h,type:u||"tool",name:this.extractToolName(c),command:this.extractCommand(c),filePath:this.extractFilePath(c)};this.turnActiveToolItemId.set(d,h),this.emitToolStart(d,y)}}return}if(t==="item/completed"){let d=n==null?void 0:n.turnId,c=n==null?void 0:n.item,u=this.normalizeItemType((o=c==null?void 0:c.type)!=null?o:n==null?void 0:n.type);if(typeof d=="string"){if(u==="agentmessage"&&typeof(c==null?void 0:c.text)=="string"){!this.turnHasMessageDelta.has(d)&&c.text.length>0&&this.emitTurnDelta(d,c.text);return}if(this.isThinkingType(u)){let y=this.extractTextDelta(c);y&&!this.turnHasThinkingDelta.has(d)&&this.emitThinkingDelta(d,y);return}let h=this.extractItemId(c,d);if(h){let y={turnId:d,itemId:h,type:u||"tool",status:this.extractItemStatus(c,n)};this.emitToolComplete(d,y),this.turnActiveToolItemId.get(d)===h&&this.turnActiveToolItemId.delete(d)}}return}if(t==="error"){let d=n==null?void 0:n.turnId,c=(l=n==null?void 0:n.error)==null?void 0:l.message,u=!!(n!=null&&n.willRetry);if(typeof d=="string"&&typeof c=="string"){let h=this.pendingTurns.get(d);(g=h==null?void 0:(p=h.handlers).onSystem)==null||g.call(p,`[error] ${c}`),!u&&!h&&this.onSystemMessage(`[error] ${c}`)}return}if(t==="turn/completed"){let d=n==null?void 0:n.turn,c=d==null?void 0:d.id,u=n==null?void 0:n.threadId,h=d==null?void 0:d.status,y=(m=d==null?void 0:d.error)==null?void 0:m.message;if(typeof c=="string"&&typeof u=="string"&&typeof h=="string"){let S={threadId:u,turnId:c,status:h,errorMessage:typeof y=="string"?y:void 0},x=this.pendingTurns.get(c);x?(h!=="completed"&&S.errorMessage&&((I=(b=x.handlers).onSystem)==null||I.call(b,`[turn ${h}] ${S.errorMessage}`)),x.resolve(S),this.pendingTurns.delete(c)):h!=="cancelled"?this.preTurnResult.set(c,S):this.clearTurnTransientState(c),x&&this.clearTurnTransientState(c),this.clearCurrentTurnId(c)}return}t.startsWith("codex/event/")}emitTurnDelta(e,t){var s,r,a;let n=this.pendingTurns.get(e);if(n){(r=(s=n.handlers).onDelta)==null||r.call(s,t);return}let i=(a=this.preTurnDeltas.get(e))!=null?a:[];i.push(t),this.preTurnDeltas.set(e,i)}emitToolDelta(e,t){var s,r,a;let n=this.pendingTurns.get(e);if(n){(r=(s=n.handlers).onToolDelta)==null||r.call(s,t);return}let i=(a=this.preTurnToolDeltas.get(e))!=null?a:[];i.push(t),this.preTurnToolDeltas.set(e,i)}emitThinkingDelta(e,t){var s,r,a;this.turnHasThinkingDelta.add(e);let n=this.pendingTurns.get(e);if(n){(r=(s=n.handlers).onThinkingDelta)==null||r.call(s,t);return}let i=(a=this.preTurnThinkingDeltas.get(e))!=null?a:[];i.push(t),this.preTurnThinkingDeltas.set(e,i)}emitToolStart(e,t){var s,r,a;let n=this.pendingTurns.get(e);if(n){(r=(s=n.handlers).onToolStart)==null||r.call(s,t);return}let i=(a=this.preTurnToolStarts.get(e))!=null?a:[];i.push(t),this.preTurnToolStarts.set(e,i)}emitToolComplete(e,t){var s,r,a;let n=this.pendingTurns.get(e);if(n){(r=(s=n.handlers).onToolComplete)==null||r.call(s,t);return}let i=(a=this.preTurnToolCompletes.get(e))!=null?a:[];i.push(t),this.preTurnToolCompletes.set(e,i)}clearTurnTransientState(e){this.preTurnDeltas.delete(e),this.preTurnToolDeltas.delete(e),this.preTurnThinkingDeltas.delete(e),this.preTurnToolStarts.delete(e),this.preTurnToolCompletes.delete(e),this.turnHasMessageDelta.delete(e),this.turnHasThinkingDelta.delete(e),this.turnActiveToolItemId.delete(e)}normalizeItemType(e){return typeof e!="string"?"":e.replace(/[^a-zA-Z]/g,"").toLowerCase()}isThinkingType(e){return e.includes("thinking")||e.includes("reasoning")}isThinkingMethod(e){let t=e.toLowerCase();return t.includes("thinking")||t.includes("reasoning")}extractTextDelta(e){if(!e||typeof e!="object")return null;let t=[e.delta,e.text,e.content,e.message,e.output];for(let n of t)if(typeof n=="string"&&n.length>0)return n;return null}extractItemId(e,t){var r;let n=(r=e==null?void 0:e.id)!=null?r:e==null?void 0:e.itemId;if(typeof n=="string"&&n.trim().length>0)return n;if(typeof t=="string"){let a=this.turnActiveToolItemId.get(t);if(a)return a}let i=typeof t=="string"&&t.length>0?t:"turn",s=`${Date.now()}-${Math.random().toString(36).slice(2,7)}`;return`${i}:${s}`}extractToolName(e){var n,i,s,r,a;let t=(a=(s=(n=e==null?void 0:e.name)!=null?n:e==null?void 0:e.toolName)!=null?s:(i=e==null?void 0:e.tool)==null?void 0:i.name)!=null?a:(r=e==null?void 0:e.command)==null?void 0:r.name;if(typeof t=="string"&&t.trim().length>0)return t.trim()}extractCommand(e){var n,i,s,r,a;let t=(a=(s=(i=e==null?void 0:e.command)!=null?i:(n=e==null?void 0:e.input)==null?void 0:n.command)!=null?s:e==null?void 0:e.rawCommand)!=null?a:(r=e==null?void 0:e.toolInput)==null?void 0:r.command;if(typeof t=="string"&&t.trim().length>0)return t.trim()}extractFilePath(e){var n,i,s,r,a,o;let t=(o=(r=(i=(n=e==null?void 0:e.filePath)!=null?n:e==null?void 0:e.path)!=null?i:e==null?void 0:e.targetPath)!=null?r:(s=e==null?void 0:e.file)==null?void 0:s.path)!=null?o:(a=e==null?void 0:e.input)==null?void 0:a.path;if(typeof t=="string"&&t.trim().length>0)return t.trim()}extractItemStatus(e,t){var i,s,r;let n=(r=(i=e==null?void 0:e.status)!=null?i:t==null?void 0:t.status)!=null?r:(s=t==null?void 0:t.result)==null?void 0:s.status;return typeof n=="string"&&n.trim().length>0?n.trim():"completed"}async request(e,t){if(!this.process||this.process.killed)throw new Error("Codex app-server is not running.");let n=String(this.requestCounter++),i=new Promise((s,r)=>{let a=setTimeout(()=>{this.pendingRequests.delete(n),r(new Error(`Request timeout: ${e}`))},6e4);this.pendingRequests.set(n,{resolve:s,reject:r,timeout:a})});return this.writeJson({id:n,method:e,params:t}),await i}notify(e,t){if(t===void 0){this.writeJson({method:e});return}this.writeJson({method:e,params:t})}writeJson(e){if(!this.process||this.process.killed||!this.process.stdin)throw new Error("Codex app-server is not running.");this.process.stdin.write(`${JSON.stringify(e)}
`)}updateThreadId(e){this.currentThreadId=e,this.onThreadIdChanged(e)}clearCurrentTurnId(e){this.currentTurnId===e&&(this.currentTurnId=null)}};var f=require("obsidian");var B=[{value:"",label:"Default (Codex)"},{value:"codex-5.3",label:"Codex 5.3"},{value:"gpt-5.2",label:"GPT 5.2"}],H=[{value:"low",label:"Low"},{value:"medium",label:"Medium"},{value:"high",label:"High"},{value:"xhigh",label:"Extra High"}],z={codexCommand:process.platform==="win32"?"codex.cmd":"codex",workingDirectory:"",model:"",thinkingEffort:"medium",approvalPolicy:"on-request",sandboxMode:"workspace-write",autoApproveRequests:!0,persistThread:!0,lastThreadId:"",maxTabs:5,enableContextInjection:!0,enableSelectionPolling:!0};function bt(){return`conv-${Date.now()}-${Math.random().toString(36).slice(2,11)}`}function Et(){return`msg-${Date.now()}-${Math.random().toString(36).slice(2,6)}`}function wt(){return`tab-${Date.now()}-${Math.random().toString(36).slice(2,6)}`}var j=class{constructor(e){this.app=e}async exists(e){return this.app.vault.adapter.exists(e)}async read(e){return this.app.vault.adapter.read(e)}async write(e,t){await this.app.vault.adapter.write(e,t)}async delete(e){await this.exists(e)&&await this.app.vault.adapter.remove(e)}async listFiles(e){return await this.exists(e)?(await this.app.vault.adapter.list(e)).files:[]}async ensureFolder(e){await this.exists(e)||await this.app.vault.adapter.mkdir(e)}};var lt=".codexidian/sessions",W=class{constructor(e){this.adapter=e}async init(){await this.adapter.ensureFolder(".codexidian"),await this.adapter.ensureFolder(lt)}filePath(e){return`${lt}/${e}.jsonl`}async saveConversation(e){let t={type:"meta",id:e.id,title:e.title,createdAt:e.createdAt,updatedAt:e.updatedAt,lastResponseAt:e.lastResponseAt,threadId:e.threadId},n=[JSON.stringify(t)];for(let i of e.messages)n.push(JSON.stringify({type:"message",message:i}));await this.adapter.write(this.filePath(e.id),n.join(`
`)+`
`)}async loadConversation(e){let t=this.filePath(e);if(!await this.adapter.exists(t))return null;let i=(await this.adapter.read(t)).split(`
`).filter(a=>a.trim());if(i.length===0)return null;let s=JSON.parse(i[0]),r=[];for(let a=1;a<i.length;a++)try{let o=JSON.parse(i[a]);o.type==="message"&&o.message&&r.push(o.message)}catch(o){}return{id:s.id,title:s.title,createdAt:s.createdAt,updatedAt:s.updatedAt,lastResponseAt:s.lastResponseAt,threadId:s.threadId,messages:r}}async deleteConversation(e){await this.adapter.delete(this.filePath(e))}async listConversations(){let e=await this.adapter.listFiles(lt),t=[];for(let n of e)if(n.endsWith(".jsonl"))try{let i=await this.adapter.read(n),s=i.split(`
`)[0];if(!s)continue;let r=JSON.parse(s);if(r.type!=="meta")continue;let a=i.split(`
`).filter(l=>l.trim()).length-1,o=a>0?this.extractLastPreview(i):"";t.push({id:r.id,title:r.title,createdAt:r.createdAt,updatedAt:r.updatedAt,lastResponseAt:r.lastResponseAt,messageCount:a,preview:o,threadId:r.threadId})}catch(i){}return t.sort((n,i)=>i.updatedAt-n.updatedAt)}extractLastPreview(e){var n;let t=e.split(`
`).filter(i=>i.trim());for(let i=t.length-1;i>=1;i--)try{let s=JSON.parse(t[i]);if(s.type==="message"&&((n=s.message)!=null&&n.content))return s.message.content.slice(0,80)}catch(s){}return""}};var St=require("obsidian"),Bt=100,J=class{constructor(e,t){this.app=e;this.component=t;this.debounceTimers=new Map}async renderContent(e,t,n=""){e.empty(),e.classList.add("codexidian-message-content"),await St.MarkdownRenderer.renderMarkdown(t,e,n,this.component),this.enhanceCodeBlocks(e)}renderStreaming(e,t,n=""){let i=this.debounceTimers.get(e);i&&clearTimeout(i);let s=setTimeout(()=>{this.debounceTimers.delete(e),this.renderContent(e,t,n)},Bt);this.debounceTimers.set(e,s)}destroy(){for(let e of this.debounceTimers.values())clearTimeout(e);this.debounceTimers.clear()}enhanceCodeBlocks(e){var n,i;let t=e.querySelectorAll("pre");for(let s=0;s<t.length;s++){let r=t[s];if((n=r.parentElement)!=null&&n.classList.contains("codexidian-code-wrapper"))continue;let a=document.createElement("div");a.classList.add("codexidian-code-wrapper");let o=r.querySelector("code"),l="";if(o){let b=Array.from(o.classList).find(I=>I.startsWith("language-"));b&&(l=b.replace("language-",""))}let p=document.createElement("div");p.classList.add("codexidian-code-header");let g=document.createElement("span");g.classList.add("codexidian-code-lang-label"),g.setText(l||"text"),p.appendChild(g);let m=document.createElement("button");m.classList.add("codexidian-code-copy-btn"),m.setText("Copy"),m.addEventListener("click",()=>{var I,d;let b=(d=(I=o==null?void 0:o.textContent)!=null?I:r.textContent)!=null?d:"";navigator.clipboard.writeText(b).then(()=>{m.setText("Copied!"),setTimeout(()=>m.setText("Copy"),1500)})}),p.appendChild(m),(i=r.parentNode)==null||i.insertBefore(a,r),a.appendChild(p),a.appendChild(r)}}};var Q=class{createBlock(e){let t=e.createEl("details",{cls:"codexidian-thinking-block codexidian-thinking-streaming"}),n=t.createEl("summary",{cls:"codexidian-thinking-header"});n.createSpan({cls:"codexidian-thinking-title",text:"Thinking..."});let i=n.createSpan({cls:"codexidian-thinking-meta",text:"streaming"}),s=t.createEl("pre",{cls:"codexidian-thinking-content"}),r=Date.now(),a="",o=!1;return{el:t,appendContent:l=>{l&&(a+=l,s.setText(a))},finalize:()=>{if(o)return;o=!0,t.removeClass("codexidian-thinking-streaming");let l=((Date.now()-r)/1e3).toFixed(1);i.setText(`${l}s`)}}}};var X=class{createCard(e,t){let n=e.createDiv({cls:"codexidian-tool-card"}),i=n.createDiv({cls:"codexidian-tool-header"}),s=i.createSpan({cls:"codexidian-tool-icon",text:"\u2699"}),r=i.createSpan({cls:"codexidian-tool-title",text:this.buildTitle(t)}),a=i.createSpan({cls:"codexidian-tool-status codexidian-tool-status-running",text:"\u23F3 running"});t.command&&n.createDiv({cls:"codexidian-tool-command",text:t.command}),t.filePath&&n.createDiv({cls:"codexidian-tool-file",text:t.filePath});let o=n.createEl("details",{cls:"codexidian-tool-output-wrap"});o.createEl("summary",{cls:"codexidian-tool-output-summary",text:"Output"});let l=o.createEl("pre",{cls:"codexidian-tool-output"}),p="";return{el:n,appendOutput:g=>{g&&(p+=g,l.setText(p))},complete:g=>{let m=g.trim().toLowerCase();if(a.removeClass("codexidian-tool-status-running"),a.removeClass("codexidian-tool-status-done"),a.removeClass("codexidian-tool-status-error"),this.isErrorStatus(m)){a.addClass("codexidian-tool-status-error"),a.setText(`\u2717 ${m||"failed"}`),s.setText("\u2716");return}if(this.isDoneStatus(m)){a.addClass("codexidian-tool-status-done"),a.setText(`\u2713 ${m||"done"}`),s.setText("\u2713");return}a.addClass("codexidian-tool-status-running"),a.setText(`\u23F3 ${m||"running"}`),s.setText("\u2699"),r.setText(this.buildTitle(t))}}}buildTitle(e){return e.name&&e.name.trim().length>0?e.name.trim():e.type&&e.type.trim().length>0?e.type.trim():"Tool"}isDoneStatus(e){return e==="completed"||e==="complete"||e==="success"||e==="ok"||e==="done"}isErrorStatus(e){return e.includes("error")||e.includes("fail")||e.includes("deny")||e.includes("reject")||e.includes("cancel")||e.includes("interrupted")}};var Ht=500,G=class{constructor(e,t){this.storage=e;this.renderer=t;this.activeConversation=null;this.saveTimer=null}getActive(){return this.activeConversation}getActiveThreadId(){var e;return(e=this.activeConversation)==null?void 0:e.threadId}setThreadId(e){this.activeConversation&&(this.activeConversation.threadId=e,this.scheduleSave())}async createNew(e){let t=Date.now(),n={id:bt(),title:e!=null?e:`Chat ${new Date(t).toLocaleString()}`,createdAt:t,updatedAt:t,messages:[]};this.activeConversation=n;try{await this.storage.saveConversation(n)}catch(i){}return n}async switchTo(e){await this.flushSave();let t=await this.storage.loadConversation(e);return t&&(this.activeConversation=t),t}async loadActive(e){return this.switchTo(e)}addMessage(e,t){if(!this.activeConversation)throw new Error("No active conversation");let n={id:Et(),role:e,content:t,timestamp:Date.now()};return this.activeConversation.messages.push(n),this.activeConversation.updatedAt=Date.now(),e==="assistant"&&(this.activeConversation.lastResponseAt=Date.now()),this.scheduleSave(),n}async truncateAfter(e){if(!this.activeConversation)throw new Error("No active conversation");let t=this.activeConversation.messages.findIndex(i=>i.id===e);if(t<0)return null;let n=this.activeConversation.messages[t];return this.activeConversation.messages=this.activeConversation.messages.slice(0,t),this.activeConversation.updatedAt=Date.now(),this.recomputeLastResponseAt(),await this.flushSave(),{...n}}getMessagesUpTo(e){if(!this.activeConversation)throw new Error("No active conversation");let t=this.activeConversation.messages.findIndex(n=>n.id===e);return t<0?[]:this.activeConversation.messages.slice(0,t+1).map(n=>({...n}))}setMessages(e){if(!this.activeConversation)throw new Error("No active conversation");this.activeConversation.messages=e.map(t=>({...t})),this.activeConversation.updatedAt=Date.now(),this.recomputeLastResponseAt(),this.scheduleSave()}async deleteConversation(e){var t;await this.storage.deleteConversation(e),((t=this.activeConversation)==null?void 0:t.id)===e&&(this.activeConversation=null)}async renameConversation(e,t){var n;if(((n=this.activeConversation)==null?void 0:n.id)===e)this.activeConversation.title=t,this.activeConversation.updatedAt=Date.now(),this.scheduleSave();else{let i=await this.storage.loadConversation(e);i&&(i.title=t,i.updatedAt=Date.now(),await this.storage.saveConversation(i))}}async listConversations(){return this.storage.listConversations()}scheduleSave(){this.saveTimer&&clearTimeout(this.saveTimer),this.saveTimer=setTimeout(()=>{this.saveTimer=null,this.activeConversation&&this.storage.saveConversation(this.activeConversation).catch(()=>{})},Ht)}async flushSave(){if(this.saveTimer&&(clearTimeout(this.saveTimer),this.saveTimer=null),this.activeConversation)try{await this.storage.saveConversation(this.activeConversation)}catch(e){}}destroy(){this.saveTimer&&(clearTimeout(this.saveTimer),this.saveTimer=null)}recomputeLastResponseAt(){if(!this.activeConversation)return;let e=this.activeConversation.messages.filter(n=>n.role==="assistant");if(e.length===0){this.activeConversation.lastResponseAt=void 0;return}let t=e.reduce((n,i)=>Math.max(n,i.timestamp),0);this.activeConversation.lastResponseAt=t>0?t:void 0}};var It=require("obsidian"),Nt=250,K=class{constructor(e){this.app=e;this.intervalId=null;this.current=null;this.indicatorEl=null;this.enabled=!0;this.onContextChanged=null}setEnabled(e){this.enabled=e,e||(this.current=null,this.updateIndicator())}getContext(){return this.current}setOnContextChanged(e){this.onContextChanged=e}start(e){this.indicatorEl=e,this.stop(),this.intervalId=setInterval(()=>this.poll(),Nt)}stop(){this.intervalId!==null&&(clearInterval(this.intervalId),this.intervalId=null),this.current=null,this.updateIndicator()}poll(){var r,a;if(!this.enabled){this.current&&(this.current=null,this.updateIndicator());return}let e=this.app.workspace.getActiveViewOfType(It.MarkdownView);if(!e){this.current&&(this.current=null,this.updateIndicator());return}let t=e.editor,n=t.getSelection();if(!n||!n.trim()){this.current&&(this.current=null,this.updateIndicator());return}let i=t.getCursor("from"),s=n.split(`
`).length;this.current={notePath:(a=(r=e.file)==null?void 0:r.path)!=null?a:"",mode:"selection",selectedText:n,lineCount:s,startLine:i.line+1},this.updateIndicator()}updateIndicator(){var r,a,o;if(!this.indicatorEl){(r=this.onContextChanged)==null||r.call(this);return}if(!this.current){this.indicatorEl.empty(),this.indicatorEl.style.display="none",(a=this.onContextChanged)==null||a.call(this);return}this.indicatorEl.style.display="flex",this.indicatorEl.empty();let e=this.indicatorEl.createSpan({cls:"codexidian-context-icon",text:"\u{1F4CE}"}),t=this.indicatorEl.createSpan({cls:"codexidian-context-text"}),n=this.current.lineCount,i=this.current.selectedText.slice(0,60).replace(/\n/g," ");t.setText(`${this.current.notePath} (${n} line${n>1?"s":""}): ${i}...`),this.indicatorEl.createSpan({cls:"codexidian-context-clear",text:"\u2715"}).addEventListener("click",()=>{this.current=null,this.updateIndicator()}),(o=this.onContextChanged)==null||o.call(this)}};var Y=class{constructor(e,t){this.tabs=[];this.activeTabId=null;this.maxTabs=t.maxTabs,this.onSelect=t.onSelect,this.onClose=t.onClose,this.onAdd=t.onAdd,this.containerEl=e.createDiv({cls:"codexidian-tab-bar"})}update(e,t){this.tabs=e,this.activeTabId=t,this.render()}setStreaming(e,t){let n=this.containerEl.querySelector(`[data-tab-id="${e}"]`);n&&n.classList.toggle("codexidian-tab-badge-streaming",t)}render(){if(this.containerEl.empty(),this.tabs.forEach((e,t)=>{let n=this.containerEl.createDiv({cls:"codexidian-tab-badge"});n.dataset.tabId=e.tabId,n.setText(String(t+1)),e.tabId===this.activeTabId&&n.classList.add("codexidian-tab-badge-active"),n.addEventListener("click",()=>this.onSelect(e.tabId)),n.addEventListener("contextmenu",i=>{i.preventDefault(),this.tabs.length>1&&this.onClose(e.tabId)})}),this.tabs.length<this.maxTabs){let e=this.containerEl.createDiv({cls:"codexidian-tab-add"});e.setText("+"),e.addEventListener("click",()=>this.onAdd())}}};var Z=class{constructor(e,t,n,i,s){this.tabBar=e;this.messagesContainer=t;this.createConversationController=n;this.client=i;this.onTabSwitch=s;this.tabs=new Map;this.activeTabId=null}getActiveTab(){var e;return this.activeTabId&&(e=this.tabs.get(this.activeTabId))!=null?e:null}getTab(e){var t;return(t=this.tabs.get(e))!=null?t:null}getActiveConversationController(){var e,t;return(t=(e=this.getActiveTab())==null?void 0:e.conversationController)!=null?t:null}getAllTabStates(){return Array.from(this.tabs.values()).map(e=>e.state)}addTab(e=null,t){let n=typeof t=="string"?t.trim():"",i=n&&!this.tabs.has(n)?n:wt(),s=this.messagesContainer.createDiv({cls:"codexidian-tab-panel"});s.style.display="none";let r={state:{tabId:i,conversationId:e},panelEl:s,conversationController:this.createConversationController()};return this.tabs.set(i,r),this.switchTo(i),this.updateTabBar(),r}switchTo(e){let t=this.tabs.get(e);if(!t)return;for(let i of this.tabs.values())i.panelEl.style.display="none";t.panelEl.style.display="flex",this.activeTabId=e;let n=t.conversationController.getActiveThreadId();this.client.setThreadId(n!=null?n:null),this.updateTabBar(),this.onTabSwitch(t)}closeTab(e){if(this.tabs.size<=1)return;let t=this.tabs.get(e);if(t){if(t.conversationController.destroy(),t.panelEl.remove(),this.tabs.delete(e),this.activeTabId===e){let n=this.tabs.keys().next().value;n&&this.switchTo(n)}this.updateTabBar()}}setConversationId(e,t){let n=this.tabs.get(e);n&&(n.state.conversationId=t)}getState(){return{openTabs:this.getAllTabStates(),activeTabId:this.activeTabId}}async restoreState(e){let t=Array.isArray(e==null?void 0:e.openTabs)?e.openTabs:[];if(!t.length){this.addTab();return}for(let n of t){if(!n||typeof n.tabId!="string")continue;let i=typeof n.conversationId=="string"?n.conversationId:null;this.addTab(i,n.tabId)}if(this.tabs.size===0){this.addTab();return}if(e.activeTabId&&this.tabs.has(e.activeTabId))this.switchTo(e.activeTabId);else{let n=this.tabs.keys().next().value;n&&this.switchTo(n)}this.updateTabBar()}updateTabBar(){this.tabBar.update(this.getAllTabStates(),this.activeTabId)}destroy(){for(let e of this.tabs.values())e.conversationController.destroy();this.tabs.clear()}};function qt(T,e,t=[]){let n=[];if(T&&n.push(`<current_note>${T}</current_note>`),e&&e.selectedText.trim()){let i=e.startLine,s=i+e.lineCount-1;n.push(`<editor_selection path="${e.notePath}" lines="${i}-${s}">${e.selectedText}</editor_selection>`)}for(let i of t)n.push(`<attached_file path="${i.path}">${i.content}</attached_file>`);return n.join(`
`)}function Mt(T,e,t,n=[]){let i=qt(e,t,n);return i?`${i}

${T}`:T}var tt=class{constructor(e,t,n){this.app=e;this.inputEl=n;this.files=new Set;this.searchEl=null;this.queryStart=-1;this.queryEnd=-1;var i;this.chipsEl=t.createDiv({cls:"codexidian-file-chips"}),this.inputWrapperEl=(i=this.inputEl.parentElement)!=null?i:t,this.onInputBound=s=>{try{this.handleInput(s)}catch(r){this.hideSearch()}},this.onOutsideClickBound=s=>{try{this.handleOutsideClick(s)}catch(r){this.hideSearch()}},this.inputEl.addEventListener("input",this.onInputBound),document.addEventListener("mousedown",this.onOutsideClickBound)}getFiles(){return Array.from(this.files)}clear(){this.files.clear(),this.renderChips(),this.hideSearch()}destroy(){this.inputEl.removeEventListener("input",this.onInputBound),document.removeEventListener("mousedown",this.onOutsideClickBound),this.hideSearch(),this.chipsEl.empty()}handleInput(e){var l,p;let t=this.inputEl.value,n=(l=this.inputEl.selectionStart)!=null?l:t.length,i=t.slice(0,n),s=/(?:^|\s)@([^\s@]*)$/.exec(i);if(!s){this.hideSearch();return}let r=(p=s[1])!=null?p:"";this.queryStart=n-r.length-1,this.queryEnd=n;let a=r.toLowerCase(),o=this.app.vault.getFiles().map(g=>g.path).filter(g=>!this.files.has(g)).filter(g=>a.length===0||g.toLowerCase().includes(a)).slice(0,10);if(o.length===0){this.hideSearch();return}this.renderSearch(o)}renderSearch(e){this.hideSearch(),this.searchEl=this.inputWrapperEl.createDiv({cls:"codexidian-file-search"});for(let t of e)this.searchEl.createDiv({cls:"codexidian-file-search-item",text:t}).addEventListener("click",()=>{this.addFile(t)})}hideSearch(){this.searchEl&&(this.searchEl.remove(),this.searchEl=null),this.queryStart=-1,this.queryEnd=-1}addFile(e){this.files.add(e),this.renderChips();let t=this.inputEl.value;if(this.queryStart>=0&&this.queryEnd>=this.queryStart){let n=t.slice(0,this.queryStart),i=t.slice(this.queryEnd);this.inputEl.value=`${n}${i}`;let s=n.length;this.inputEl.selectionStart=s,this.inputEl.selectionEnd=s}this.hideSearch(),this.inputEl.focus()}renderChips(){this.chipsEl.empty();for(let e of this.files){let t=this.chipsEl.createDiv({cls:"codexidian-file-chip"});t.createSpan({cls:"codexidian-file-chip-text",text:e}),t.createSpan({cls:"codexidian-file-chip-remove",text:"\u2715"}).addEventListener("click",()=>{this.files.delete(e),this.renderChips()})}}handleOutsideClick(e){let t=e.target;t&&t!==this.inputEl&&(this.searchEl&&this.searchEl.contains(t)||this.hideSearch())}};var et=class{constructor(e,t){this.inputEl=t;this.images=[];this.previewsEl=e.createDiv({cls:"codexidian-image-previews"}),this.onPasteBound=n=>{this.handlePaste(n)},this.inputEl.addEventListener("paste",this.onPasteBound)}getImages(){return this.images.map(e=>({...e}))}clear(){this.images=[],this.render()}destroy(){this.inputEl.removeEventListener("paste",this.onPasteBound),this.clear()}async handlePaste(e){var t;try{let n=(t=e.clipboardData)==null?void 0:t.items;if(!n||n.length===0)return;let i=!1;for(let s of Array.from(n)){if(!s.type.startsWith("image/"))continue;let r=s.getAsFile();if(!r)continue;i=!0;let a=await this.fileToDataUrl(r);this.images.push({name:r.name||`pasted-image-${Date.now()}.png`,dataUrl:a})}i&&(e.preventDefault(),this.render())}catch(n){}}render(){if(this.previewsEl.empty(),this.images.length===0){this.previewsEl.style.display="none";return}this.previewsEl.style.display="flex",this.images.forEach((e,t)=>{let n=this.previewsEl.createDiv({cls:"codexidian-image-preview"}),i=n.createEl("img");i.src=e.dataUrl,i.alt=e.name,i.title=e.name,n.createEl("button",{cls:"codexidian-image-preview-remove",text:"\u2715"}).addEventListener("click",()=>{this.images.splice(t,1),this.render()})})}async fileToDataUrl(e){return await new Promise((t,n)=>{let i=new FileReader;i.onload=()=>{let s=typeof i.result=="string"?i.result:"";t(s)},i.onerror=()=>{n(new Error("failed to read image"))},i.readAsDataURL(e)})}};var nt=class{constructor(e){this.commands=[];this.filteredCommands=[];this.selectedIndex=0;this.visible=!1;this.menuEl=e.createDiv({cls:"codexidian-slash-menu"})}registerCommand(e){let t=this.normalizeName(e.name);if(!t)return;let n={...e,name:t},i=this.commands.findIndex(s=>s.name===t);i>=0?this.commands[i]=n:this.commands.push(n)}getCommands(){return this.commands.map(e=>({...e}))}isVisible(){return this.visible}show(e){let t=e.trim().toLowerCase();if(this.filteredCommands=this.commands.filter(n=>this.matchesFilter(n,t)).slice(0,8),this.filteredCommands.length===0){this.hide();return}this.selectedIndex>=this.filteredCommands.length&&(this.selectedIndex=0),this.visible=!0,this.menuEl.addClass("is-visible"),this.render()}hide(){this.visible=!1,this.filteredCommands=[],this.selectedIndex=0,this.menuEl.removeClass("is-visible"),this.menuEl.empty()}selectNext(){!this.visible||this.filteredCommands.length===0||(this.selectedIndex=(this.selectedIndex+1)%this.filteredCommands.length,this.render())}selectPrev(){!this.visible||this.filteredCommands.length===0||(this.selectedIndex=(this.selectedIndex-1+this.filteredCommands.length)%this.filteredCommands.length,this.render())}async executeSelected(){return!this.visible||this.filteredCommands.length===0?!1:await this.executeByIndex(this.selectedIndex)}async executeByName(e){let t=this.normalizeName(e);if(!t)return!1;let n=this.commands.find(i=>i.name===t);if(!n)return!1;try{await n.execute()}finally{this.hide()}return!0}destroy(){this.hide(),this.commands=[],this.menuEl.remove()}render(){this.menuEl.empty(),this.filteredCommands.forEach((e,t)=>{let n=this.menuEl.createDiv({cls:"codexidian-slash-item"});t===this.selectedIndex&&n.addClass("is-selected");let i=e.icon?`${e.icon} /${e.name}`:`/${e.name}`;n.createDiv({cls:"codexidian-slash-item-name",text:i}),n.createDiv({cls:"codexidian-slash-item-desc",text:e.description||e.label}),n.addEventListener("mouseenter",()=>{this.selectedIndex=t,this.render()}),n.addEventListener("mousedown",s=>{s.preventDefault(),this.executeByIndex(t)})})}async executeByIndex(e){let t=this.filteredCommands[e];if(!t)return!1;try{await t.execute()}finally{this.hide()}return!0}matchesFilter(e,t){if(!t)return!0;let n=e.name.toLowerCase(),i=e.label.toLowerCase(),s=e.description.toLowerCase();return n.includes(t)||i.includes(t)||s.includes(t)}normalizeName(e){let t=e.trim().toLowerCase();return t?t.startsWith("/")?t.slice(1):t:""}};var it=class{constructor(e){this.collapsed=!1;this.entries=[];this.turnStatus="idle";this.cleanupTimer=null;this.containerEl=e,this.containerEl.addClass("codexidian-status-panel"),this.headerEl=this.containerEl.createDiv({cls:"codexidian-status-header"}),this.currentEl=this.headerEl.createDiv({cls:"codexidian-status-current",text:"Idle"}),this.arrowEl=this.headerEl.createSpan({cls:"status-arrow",text:"\u25BE"}),this.entriesEl=this.containerEl.createDiv({cls:"codexidian-status-entries"}),this.headerEl.addEventListener("click",()=>this.toggleCollapsed()),this.render()}setTurnStatus(e){this.turnStatus=e,e==="idle"&&this.clearFinishedAfterDelay(3e3),this.render()}addEntry(e){let t={...e,detail:this.normalizeDetail(e.detail),timestamp:Date.now()},n=this.entries.findIndex(i=>i.id===t.id);if(n>=0){let i=this.entries[n];this.entries[n]={...i,...t,timestamp:i.timestamp}}else this.entries.push(t);this.entries.sort((i,s)=>s.timestamp-i.timestamp),this.entries.length>5&&(this.entries=this.entries.slice(0,5)),this.render()}updateEntry(e,t){var a,o,l;let n=this.entries.findIndex(p=>p.id===e);if(n<0)return;let i=this.entries[n],s=(a=t.status)!=null?a:i.status,r=(o=t.duration)!=null?o:s==="running"?i.duration:Date.now()-i.timestamp;this.entries[n]={...i,...t,id:i.id,timestamp:i.timestamp,detail:this.normalizeDetail((l=t.detail)!=null?l:i.detail),duration:r,status:s},this.render()}clearFinishedAfterDelay(e=3e3){this.cleanupTimer!==null&&window.clearTimeout(this.cleanupTimer),this.cleanupTimer=window.setTimeout(()=>{this.cleanupTimer=null,this.entries=this.entries.filter(t=>t.status==="running"),this.render()},e)}clear(){this.entries=[],this.cleanupTimer!==null&&(window.clearTimeout(this.cleanupTimer),this.cleanupTimer=null),this.render()}destroy(){this.cleanupTimer!==null&&(window.clearTimeout(this.cleanupTimer),this.cleanupTimer=null),this.containerEl.empty()}toggleCollapsed(){this.collapsed=!this.collapsed,this.render()}render(){let e=this.getCurrentStatusText();this.currentEl.setText(e),this.currentEl.toggleClass("is-active",this.turnStatus!=="idle"),this.containerEl.toggleClass("is-collapsed",this.collapsed),this.arrowEl.setText(this.collapsed?"\u25B8":"\u25BE"),this.renderEntries();let t=this.turnStatus!=="idle"||this.entries.length>0;this.containerEl.toggleClass("is-active",t)}renderEntries(){this.entriesEl.empty();for(let e of this.entries){let t=this.entriesEl.createDiv({cls:`codexidian-status-entry codexidian-status-entry--${e.status}`});t.createSpan({cls:"codexidian-status-entry-icon",text:this.statusIcon(e.status)}),t.createSpan({cls:"entry-label",text:this.entryTypeLabel(e.type)});let n=t.createSpan({cls:"entry-detail"}),i=e.detail?`${e.label}: ${e.detail}`:e.label;n.setText(i),n.title=i,e.status!=="running"&&t.createSpan({cls:"entry-duration",text:this.formatDuration(e.duration)})}}getCurrentStatusText(){return this.turnStatus==="idle"?"Idle":this.turnStatus==="thinking"?"Thinking...":this.turnStatus==="streaming"?"Streaming response...":this.turnStatus==="waiting_approval"?"Waiting for approval...":this.entries.find(t=>t.type==="tool_call"&&t.status==="running")?"Running tool...":"Running..."}entryTypeLabel(e){return e==="tool_call"?"TOOL":e==="thinking"?"THINK":e==="subagent"?"AGENT":"INFO"}statusIcon(e){return e==="running"?"\u23F3":e==="completed"?"\u2705":"\u274C"}formatDuration(e){return!e||e<0?"":e<1e3?`${e}ms`:`${(e/1e3).toFixed(1)}s`}normalizeDetail(e){if(!e)return;let t=e.replace(/\s+/g," ").trim();if(t)return t.length<=80?t:`${t.slice(0,80)}...`}};var N="codexidian-view",F=class extends f.ItemView{constructor(t,n){super(t);this.plugin=n;this.fileContext=null;this.imageContext=null;this.slashMenu=null;this.statusPanel=null;this.running=!1;this.historyOpen=!1;this.lastShortcutSendAt=0;this.messageQueue=[];this.currentTurnId=null;this.queueIndicatorEl=null;this.sendSequence=0;this.cancelledSendSequences=new Set;this.includeCurrentNoteContent=!1}getViewType(){return N}getDisplayText(){return"Codexidian"}getIcon(){return"bot"}async onOpen(){let t=this.containerEl.children[1];t.empty(),this.vaultAdapter=new j(this.app),this.sessionStorage=new W(this.vaultAdapter);let n=null;try{await this.sessionStorage.init()}catch(u){n=u instanceof Error?u.message:String(u),new f.Notice(`Codexidian: storage initialization failed (${n}). Continuing without persistence.`)}this.messageRenderer=new J(this.app,this),this.thinkingRenderer=new Q,this.toolCallRenderer=new X,this.rootEl=t.createDiv({cls:"codexidian-view"});let i=this.rootEl.createDiv({cls:"codexidian-header"}),s=i.createDiv({cls:"codexidian-header-left"});s.createDiv({cls:"codexidian-title",text:"Codexidian"}),this.statusEl=s.createDiv({cls:"codexidian-status",text:"Disconnected"});let r=i.createDiv({cls:"codexidian-tab-bar-container"}),a=i.createDiv({cls:"codexidian-header-right"});a.style.position="relative",this.historyBtn=a.createEl("button",{text:"History"}),this.newThreadBtn=a.createEl("button",{text:"New Thread"}),this.restartBtn=a.createEl("button",{text:"Restart"}),this.historyMenuEl=a.createDiv({cls:"codexidian-history-menu"}),this.historyMenuEl.style.display="none",this.messagesContainer=this.rootEl.createDiv({cls:"codexidian-messages-container"}),this.contextRowEl=this.rootEl.createDiv({cls:"codexidian-context-row"}),this.noteContextEl=this.contextRowEl.createDiv({cls:"codexidian-note-context"}),this.noteContextTextEl=this.noteContextEl.createSpan({cls:"codexidian-note-context-text"}),this.noteContextToggleEl=this.noteContextEl.createEl("button",{cls:"codexidian-note-context-toggle"}),this.noteContextToggleEl.addEventListener("click",()=>{this.includeCurrentNoteContent=!this.includeCurrentNoteContent,this.updateNoteContextToggle()}),this.selectionContextEl=this.contextRowEl.createDiv({cls:"codexidian-selection-context"}),this.updateNoteContextToggle();let o=this.rootEl.createDiv({cls:"codexidian-status-panel"});this.statusPanel=new it(o);let l=this.rootEl.createDiv({cls:"codexidian-footer"}),p=l.createDiv({cls:"codexidian-file-chips-container"}),g=l.createDiv({cls:"codexidian-image-previews-container"}),m=l.createDiv({cls:"codexidian-input-wrap"});this.inputEl=m.createEl("textarea",{cls:"codexidian-input"}),this.inputEl.placeholder="Ask Codex about this vault...",this.slashMenu=new nt(m),this.registerBuiltinSlashCommands();let b=l.createDiv({cls:"codexidian-toolbar"}),I=b.createDiv({cls:"codexidian-toolbar-group"});I.createSpan({cls:"codexidian-toolbar-label",text:"Model"}),this.modelSelect=I.createEl("select",{cls:"codexidian-toolbar-select"});for(let u of B){let h=this.modelSelect.createEl("option",{text:u.label,value:u.value});u.value===this.plugin.settings.model&&(h.selected=!0)}this.modelSelect.addEventListener("change",()=>{this.plugin.settings.model=this.modelSelect.value,this.plugin.saveSettings()});let d=b.createDiv({cls:"codexidian-toolbar-group"});d.createSpan({cls:"codexidian-toolbar-label",text:"Effort"}),this.effortSelect=d.createEl("select",{cls:"codexidian-toolbar-select"});for(let u of H){let h=this.effortSelect.createEl("option",{text:u.label,value:u.value});u.value===this.plugin.settings.thinkingEffort&&(h.selected=!0)}this.effortSelect.addEventListener("change",()=>{this.plugin.settings.thinkingEffort=this.effortSelect.value,this.plugin.saveSettings()});let c=l.createDiv({cls:"codexidian-actions"});c.createDiv({cls:"codexidian-hint",text:"Ctrl/Cmd+Enter to send"}),this.sendBtn=c.createEl("button",{text:"Send"}),this.queueIndicatorEl=l.createDiv({cls:"codexidian-queue-indicator"}),this.updateQueueIndicator(),this.tabBar=new Y(r,{maxTabs:this.plugin.settings.maxTabs,onSelect:u=>this.tabManager.switchTo(u),onClose:u=>this.tabManager.closeTab(u),onAdd:()=>this.createNewTab()}),this.tabManager=new Z(this.tabBar,this.messagesContainer,()=>new G(this.sessionStorage,this.messageRenderer),this.plugin.client,u=>this.onTabSwitched(u)),this.selectionController=new K(this.app),this.selectionController.setEnabled(this.plugin.settings.enableSelectionPolling),this.selectionController.setOnContextChanged(()=>this.updateContextRowVisibility()),this.selectionController.start(this.selectionContextEl);try{this.fileContext=new tt(this.app,p,this.inputEl)}catch(u){let h=u instanceof Error?u.message:String(u);new f.Notice(`Codexidian: failed to initialize file mention context (${h})`),this.fileContext=null}try{this.imageContext=new et(g,this.inputEl)}catch(u){let h=u instanceof Error?u.message:String(u);new f.Notice(`Codexidian: failed to initialize image paste context (${h})`),this.imageContext=null}if(this.registerEvent(this.app.workspace.on("active-leaf-change",()=>{this.refreshCurrentNoteContext()})),this.registerEvent(this.app.workspace.on("file-open",()=>{this.refreshCurrentNoteContext()})),this.refreshCurrentNoteContext(),await this.restoreTabsWithFallback(),n){let u=this.tabManager.getActiveTab();u&&this.appendSystemMessageToPanel(u.panelEl,`Storage unavailable. Session will run without persistence. (${n})`)}this.bindEvents(),this.updateStatus()}async onClose(){var t,n,i,s,r,a,o,l;try{let p=this.plugin.settings;this.tabManager&&(p._tabManagerState=this.tabManager.getState()),await this.plugin.saveSettings()}catch(p){let g=p instanceof Error?p.message:String(p);new f.Notice(`Codexidian: failed to persist tab state (${g})`)}(t=this.selectionController)==null||t.stop(),(n=this.selectionController)==null||n.setOnContextChanged(null),(i=this.fileContext)==null||i.destroy(),this.fileContext=null,(s=this.imageContext)==null||s.destroy(),this.imageContext=null,(r=this.slashMenu)==null||r.destroy(),this.slashMenu=null,(a=this.messageRenderer)==null||a.destroy(),(o=this.statusPanel)==null||o.destroy(),this.statusPanel=null,(l=this.tabManager)==null||l.destroy()}bindEvents(){var t,n;this.sendBtn.addEventListener("click",()=>{this.sendCurrentInput()}),this.inputEl.addEventListener("input",()=>{this.handleSlashInputChanged()}),this.inputEl.addEventListener("keydown",i=>{var s;if((s=this.slashMenu)!=null&&s.isVisible()){if(i.key==="ArrowDown"){i.preventDefault(),i.stopPropagation(),this.slashMenu.selectNext();return}if(i.key==="ArrowUp"){i.preventDefault(),i.stopPropagation(),this.slashMenu.selectPrev();return}if(i.key==="Enter"){i.preventDefault(),i.stopPropagation(),this.executeSelectedSlashCommand();return}if(i.key==="Escape"){i.preventDefault(),i.stopPropagation(),this.slashMenu.hide();return}}if(i.key==="Escape"&&this.running){i.preventDefault(),i.stopPropagation(),this.cancelCurrentStream();return}this.isSubmitShortcut(i)&&this.handleSubmitShortcut(i)},!0);try{(t=this.scope)==null||t.register(["Mod"],"Enter",i=>document.activeElement!==this.inputEl?!0:(this.handleSubmitShortcut(i),!1)),(n=this.scope)==null||n.register([],"Escape",()=>{var i;return document.activeElement!==this.inputEl?!0:(i=this.slashMenu)!=null&&i.isVisible()?(this.slashMenu.hide(),!1):this.running?(this.cancelCurrentStream(),!1):!0})}catch(i){}this.newThreadBtn.addEventListener("click",()=>{this.startNewThread()}),this.restartBtn.addEventListener("click",()=>{this.restartEngine()}),this.historyBtn.addEventListener("click",()=>this.toggleHistory())}isSubmitShortcut(t){let n=t.ctrlKey||t.metaKey,i=t.key==="Enter"||t.code==="Enter"||t.code==="NumpadEnter";return n&&i}handleSubmitShortcut(t){var i;if(t.defaultPrevented||this.inputEl.disabled)return;if((i=this.slashMenu)!=null&&i.isVisible()){t.preventDefault(),t.stopPropagation(),this.executeSelectedSlashCommand();return}let n=Date.now();n-this.lastShortcutSendAt<80||(this.lastShortcutSendAt=n,t.preventDefault(),t.stopPropagation(),this.sendCurrentInput())}registerBuiltinSlashCommands(){if(!this.slashMenu)return;let t=n=>{var i;(i=this.slashMenu)==null||i.registerCommand({...n,execute:async()=>{var s;this.inputEl.value="",(s=this.slashMenu)==null||s.hide(),await n.execute(),this.inputEl.focus()}})};t({name:"new",label:"New Chat",description:"Start a new conversation tab.",icon:"\u2795",execute:async()=>{if(this.tabManager.getAllTabStates().length>=this.plugin.settings.maxTabs){new f.Notice(`Cannot create new tab: max tabs (${this.plugin.settings.maxTabs}) reached.`);return}await this.createNewTab()}}),t({name:"clear",label:"Clear Chat",description:"Clear messages in the current conversation.",icon:"\u{1F9F9}",execute:async()=>{await this.clearCurrentConversationMessages()}}),t({name:"model",label:"Cycle Model",description:"Switch to the next configured model.",icon:"\u{1F916}",execute:async()=>{await this.cycleModelSetting()}}),t({name:"effort",label:"Cycle Effort",description:"Cycle thinking effort (low \u2192 medium \u2192 high \u2192 xhigh).",icon:"\u{1F9E0}",execute:async()=>{await this.cycleEffortSetting()}}),t({name:"history",label:"Toggle History",description:"Open or close the conversation history menu.",icon:"\u{1F558}",execute:()=>{this.toggleHistory()}}),t({name:"tabs",label:"Show Tabs",description:"Show a summary of current tabs.",icon:"\u{1F5C2}",execute:()=>{this.showTabsSummary()}}),t({name:"help",label:"Show Help",description:"List all available slash commands.",icon:"\u2753",execute:()=>{this.showSlashCommandHelp()}})}handleSlashInputChanged(){if(!this.slashMenu)return;let t=this.inputEl.value;if(!t.startsWith("/")){this.slashMenu.hide();return}let n=this.extractSlashFilter(t);this.slashMenu.show(n)}async executeSelectedSlashCommand(){var n;await((n=this.slashMenu)==null?void 0:n.executeSelected())&&(this.inputEl.value="",this.inputEl.focus())}async executeSlashCommandByName(t){var i,s;return await((i=this.slashMenu)==null?void 0:i.executeByName(t))?(this.inputEl.value="",(s=this.slashMenu)==null||s.hide(),this.inputEl.focus(),!0):!1}extractSlashFilter(t){if(!t.startsWith("/"))return"";let n=t.slice(1).trimStart(),[i]=n.split(/\s+/,1);return(i!=null?i:"").trim().toLowerCase()}extractSlashCommandName(t){if(!t.startsWith("/"))return null;let n=this.extractSlashFilter(t);return n.length>0?n:null}async clearCurrentConversationMessages(){var n;let t=this.tabManager.getActiveTab();if(!t){new f.Notice("No active tab to clear.");return}t.panelEl.empty(),t.conversationController.setMessages([]),(n=this.statusPanel)==null||n.clear(),new f.Notice("Cleared current conversation messages.")}async cycleModelSetting(){let t=this.plugin.settings.model,n=B.findIndex(r=>r.value===t),i=n>=0?n:0,s=B[(i+1)%B.length];this.plugin.settings.model=s.value,this.modelSelect.value=s.value,await this.plugin.saveSettings(),this.updateStatus(),new f.Notice(`Model set to ${s.label}`)}async cycleEffortSetting(){let t=H.map(a=>a.value),n=this.plugin.settings.thinkingEffort,i=t.indexOf(n),s=i>=0?i:0,r=H[(s+1)%H.length];this.plugin.settings.thinkingEffort=r.value,this.effortSelect.value=r.value,await this.plugin.saveSettings(),this.updateStatus(),new f.Notice(`Thinking effort set to ${r.label}`)}showTabsSummary(){var s,r;let t=this.tabManager.getAllTabStates();if(t.length===0){this.appendSystemMessage("No tabs are currently open.");return}let n=(r=(s=this.tabManager.getActiveTab())==null?void 0:s.state.tabId)!=null?r:null,i=t.map((a,o)=>{let l=a.tabId===n?"*":"",p=a.tabId.slice(-4),g=a.conversationId?a.conversationId.slice(-6):"none";return`${l}${o+1}[${p}] conv:${g}`}).join(" | ");this.appendSystemMessage(`Tabs ${t.length}/${this.plugin.settings.maxTabs}: ${i}`)}showSlashCommandHelp(){var i,s;let t=(s=(i=this.slashMenu)==null?void 0:i.getCommands())!=null?s:[];if(t.length===0){this.appendSystemMessage("No slash commands are registered.");return}let n=t.map(r=>`/${r.name}: ${r.description}`).join(" | ");this.appendSystemMessage(`Available slash commands: ${n}`)}updateQueueIndicator(){if(!this.queueIndicatorEl)return;let t=this.messageQueue.length;if(t<=0){this.queueIndicatorEl.removeClass("visible"),this.queueIndicatorEl.setText("");return}this.queueIndicatorEl.setText(`${t} message${t===1?"":"s"} queued`),this.queueIndicatorEl.addClass("visible")}async cancelCurrentStream(){var s,r,a,o;if(!this.running)return;let t=this.sendSequence;this.cancelledSendSequences.add(t);let n=(s=this.currentTurnId)!=null?s:this.plugin.client.getCurrentTurnId();this.currentTurnId=n;let i=(r=this.tabManager)==null?void 0:r.getActiveTab();i&&(this.tabBar.setStreaming(i.state.tabId,!1),this.appendSystemMessageToPanel(i.panelEl,"(Cancelled by user)")),this.running=!1,this.updateStatus(),(a=this.statusPanel)==null||a.setTurnStatus("idle"),(o=this.statusPanel)==null||o.clearFinishedAfterDelay(3e3);try{n&&await this.plugin.client.cancelTurn(n)}catch(l){let p=l instanceof Error?l.message:String(l);i&&this.appendSystemMessageToPanel(i.panelEl,`Cancel request failed: ${p}`)}finally{this.currentTurnId=null}try{await this.processQueue()}catch(l){let p=l instanceof Error?l.message:String(l);new f.Notice(`Codexidian: failed to process queue (${p})`)}}async processQueue(){var n;if(this.running)return;let t=this.messageQueue.shift();if(this.updateQueueIndicator(),!!t)try{await this.sendCurrentInput(t)}catch(i){let s=i instanceof Error?i.message:String(i),r=(n=this.tabManager)==null?void 0:n.getActiveTab();r&&this.appendSystemMessageToPanel(r.panelEl,`Queued message failed: ${s}`)}}async createNewTab(){let t=this.tabManager.addTab();try{let n=await t.conversationController.createNew();this.tabManager.setConversationId(t.state.tabId,n.id)}catch(n){let i=n instanceof Error?n.message:String(n);this.appendSystemMessageToPanel(t.panelEl,`Failed to initialize conversation: ${i}`)}this.appendSystemMessageToPanel(t.panelEl,"Ready. Click Send to start Codex in this pane.")}async restoreTabConversation(t){if(!t.state.conversationId)return;let n=await t.conversationController.switchTo(t.state.conversationId);n&&(await this.renderConversationMessages(t.panelEl,n.messages),n.threadId&&this.plugin.client.setThreadId(n.threadId))}onTabSwitched(t){this.updateStatus(),t.panelEl.scrollTop=t.panelEl.scrollHeight}async sendCurrentInput(t){var ut,ht,pt,gt,vt,mt,ft,Tt,yt,xt;let i=(t!=null?t:this.inputEl.value).trim();if(!i)return;let s=this.extractSlashCommandName(i);if(s&&await this.executeSlashCommandByName(s)){t===void 0&&(this.inputEl.value="");return}if(this.running){this.messageQueue.push(i),t===void 0&&(this.inputEl.value=""),this.updateQueueIndicator();return}if(!this.tabManager)return;let r=this.tabManager.getActiveTab();if(r||(await this.createNewTab(),r=this.tabManager.getActiveTab()),!r)return;let a=r.conversationController;t===void 0&&(this.inputEl.value="");let o=this.getCurrentMarkdownNotePath(),l=this.plugin.settings.enableContextInjection&&(ht=(ut=this.selectionController)==null?void 0:ut.getContext())!=null?ht:null,p=await this.collectAttachedFileContents(o,r.panelEl),m=((gt=(pt=this.imageContext)==null?void 0:pt.getImages())!=null?gt:[]).map(E=>`(Image attached: ${E.name||"pasted-image"})`),b=m.length>0?`${i}

${m.join(`
`)}`:i,I=Mt(b,o,l,p),d=a.addMessage("user",i);this.appendMessageToPanel(r.panelEl,"user",i,d.id);let c=this.createMessageEl(r.panelEl,"assistant"),u="",h=++this.sendSequence,y=new Map,S=new Set,x=null,A=0,C=null,L=!1,U=new Map,R=null,O=0,ct=()=>{let E=r.panelEl.createDiv();return r.panelEl.insertBefore(E,c),E},V=()=>{var E;L||!C||(L=!0,C.finalize(),R&&((E=this.statusPanel)==null||E.updateEntry(R,{status:"completed",duration:Date.now()-O}),R=null,O=0))},At=()=>{var E;R||(R=`thinking-${h}`,O=Date.now(),(E=this.statusPanel)==null||E.addEntry({id:R,type:"thinking",label:"Reasoning",status:"running"}))},rt=(E,M)=>{var v;let P=y.get(E);if(P)return P;let $=this.toolCallRenderer.createCard(ct(),{type:(v=M==null?void 0:M.type)!=null?v:"tool",name:M==null?void 0:M.name,command:M==null?void 0:M.command,filePath:M==null?void 0:M.filePath});return y.set(E,$),$};this.running=!0,this.currentTurnId=null,this.updateStatus(),(vt=this.statusPanel)==null||vt.setTurnStatus("thinking"),this.tabBar.setStreaming(r.state.tabId,!0);try{let E=this.plugin.client.sendTurn(I,{onDelta:v=>{var k,D;this.currentTurnId||(this.currentTurnId=this.plugin.client.getCurrentTurnId()),R&&((k=this.statusPanel)==null||k.updateEntry(R,{status:"completed",duration:Date.now()-O}),R=null,O=0),(D=this.statusPanel)==null||D.setTurnStatus("streaming"),u+=v,this.messageRenderer.renderStreaming(c,u),r.panelEl.scrollTop=r.panelEl.scrollHeight},onThinkingDelta:v=>{var k;v&&((k=this.statusPanel)==null||k.setTurnStatus("thinking"),At(),C||(C=this.thinkingRenderer.createBlock(ct())),C.appendContent(v),r.panelEl.scrollTop=r.panelEl.scrollHeight)},onToolStart:v=>{var D,q;let k=rt(v.itemId,v);S.add(v.itemId),x=v.itemId,k.complete("running"),U.set(v.itemId,Date.now()),(D=this.statusPanel)==null||D.setTurnStatus("tool_calling"),(q=this.statusPanel)==null||q.addEntry({id:v.itemId,type:"tool_call",label:v.name||v.type||"Tool",detail:this.truncateStatusDetail(v.command||v.filePath),status:"running"}),r.panelEl.scrollTop=r.panelEl.scrollHeight},onToolDelta:v=>{var k;if(this.currentTurnId||(this.currentTurnId=this.plugin.client.getCurrentTurnId()),(k=this.statusPanel)==null||k.setTurnStatus("tool_calling"),v.length>0){let D=x;D||(D=`tool-fallback-${h}-${++A}`,x=D,S.add(D)),rt(D,{type:"tool",name:"Tool output"}).appendOutput(v)}v.trim().length>0&&this.statusEl.setText(`Tool: ${v.trim().slice(0,80)}`)},onToolComplete:v=>{var q;rt(v.itemId,v).complete(v.status);let D=U.get(v.itemId);if((q=this.statusPanel)==null||q.updateEntry(v.itemId,{status:this.resolveEntryStatus(v.status),duration:D?Date.now()-D:void 0}),S.delete(v.itemId),x===v.itemId){let at=Array.from(S);x=at.length>0?at[at.length-1]:null}r.panelEl.scrollTop=r.panelEl.scrollHeight},onSystem:v=>{this.appendSystemMessageToPanel(r.panelEl,v)}},{model:this.modelSelect.value||void 0,effort:this.effortSelect.value||void 0}),M=()=>{if(this.currentTurnId||!this.running||h!==this.sendSequence)return;let v=this.plugin.client.getCurrentTurnId();if(v){this.currentTurnId=v;return}window.setTimeout(M,25)};M();let P=await E;this.currentTurnId=P.turnId,(mt=this.statusPanel)==null||mt.setTurnStatus("streaming");let $=this.cancelledSendSequences.has(h);if(u.trim().length===0&&($||P.status==="cancelled"?u="(Cancelled)":u=P.errorMessage||"(No assistant text output)"),await this.messageRenderer.renderContent(c,u),V(),P.threadId&&a.setThreadId(P.threadId),a.addMessage("assistant",u),P.status!=="completed"&&!($&&P.status==="cancelled")){let v=P.errorMessage?`: ${P.errorMessage}`:"";this.appendSystemMessageToPanel(r.panelEl,`Turn finished with status ${P.status}${v}`)}}catch(E){let M=this.cancelledSendSequences.has(h),P=E instanceof Error?E.message:String(E);if(M){let $=u.trim().length>0?u:"(Cancelled)";await this.messageRenderer.renderContent(c,$),a.addMessage("assistant",$),V()}else await this.messageRenderer.renderContent(c,"(No assistant output)"),this.appendSystemMessageToPanel(r.panelEl,`Request failed: ${P}`),new f.Notice(`Codexidian: ${P}`),V()}finally{if(V(),this.cancelledSendSequences.delete(h),h!==this.sendSequence)return;this.running=!1,this.currentTurnId=null,this.tabBar.setStreaming(r.state.tabId,!1),(ft=this.statusPanel)==null||ft.setTurnStatus("idle"),(Tt=this.statusPanel)==null||Tt.clearFinishedAfterDelay(3e3),this.updateStatus();try{(yt=this.fileContext)==null||yt.clear(),(xt=this.imageContext)==null||xt.clear()}catch(E){}try{await this.processQueue()}catch(E){let M=E instanceof Error?E.message:String(E);new f.Notice(`Codexidian: failed to process queue (${M})`)}}}async startNewThread(){if(!this.running){this.running=!0,this.updateStatus();try{let t=await this.plugin.client.newThread(),n=this.tabManager.getActiveTab();n&&(n.conversationController.setThreadId(t),this.appendSystemMessageToPanel(n.panelEl,`Started new thread: ${t}`))}catch(t){let n=t instanceof Error?t.message:String(t),i=this.tabManager.getActiveTab();i&&this.appendSystemMessageToPanel(i.panelEl,`Failed to start new thread: ${n}`),new f.Notice(`Codexidian: ${n}`)}finally{this.running=!1,this.updateStatus()}}}async restartEngine(){if(!this.running){this.running=!0,this.updateStatus();try{await this.plugin.client.restart();let t=this.tabManager.getActiveTab();t&&this.appendSystemMessageToPanel(t.panelEl,"Codex app-server restarted.")}catch(t){let n=t instanceof Error?t.message:String(t),i=this.tabManager.getActiveTab();i&&this.appendSystemMessageToPanel(i.panelEl,`Restart failed: ${n}`),new f.Notice(`Codexidian: ${n}`)}finally{this.running=!1,this.updateStatus()}}}toggleHistory(){this.historyOpen=!this.historyOpen,this.historyOpen?(this.renderHistoryMenu(),this.historyMenuEl.style.display="block"):this.historyMenuEl.style.display="none"}async renderHistoryMenu(){this.historyMenuEl.empty();let t=this.tabManager.getActiveConversationController();if(!t)return;let n=await t.listConversations();if(n.length===0){this.historyMenuEl.createDiv({cls:"codexidian-history-empty",text:"No conversations yet"});return}for(let i of n)this.renderHistoryItem(i)}renderHistoryItem(t){let n=this.historyMenuEl.createDiv({cls:"codexidian-history-item"}),i=n.createSpan({cls:"codexidian-history-title"});i.setText(t.title),i.title=`${t.messageCount} messages
${t.preview}`;let s=n.createDiv({cls:"codexidian-history-actions"});s.createEl("button",{cls:"codexidian-history-action-btn",text:"Open"}).addEventListener("click",o=>{o.stopPropagation(),this.openConversation(t.id),this.toggleHistory()}),s.createEl("button",{cls:"codexidian-history-action-btn delete",text:"Del"}).addEventListener("click",o=>{o.stopPropagation(),this.deleteConversation(t.id)}),n.addEventListener("click",()=>{this.openConversation(t.id),this.toggleHistory()})}async openConversation(t){let n=this.tabManager.getActiveTab();if(!n)return;let i=await n.conversationController.switchTo(t);if(!i){new f.Notice("Failed to load conversation");return}this.tabManager.setConversationId(n.state.tabId,t),n.panelEl.empty(),await this.renderConversationMessages(n.panelEl,i.messages),i.threadId&&this.plugin.client.setThreadId(i.threadId),this.updateStatus(),n.panelEl.scrollTop=n.panelEl.scrollHeight}async deleteConversation(t){let n=this.tabManager.getActiveConversationController();n&&(await n.deleteConversation(t),this.renderHistoryMenu())}async renderConversationMessages(t,n){for(let i of n)if(i.role==="assistant"){let s=this.createMessageEl(t,"assistant",i.id);await this.messageRenderer.renderContent(s,i.content)}else this.appendMessageToPanel(t,i.role,i.content,i.id)}createMessageEl(t,n,i){let s=t.createDiv({cls:"codexidian-msg-wrapper"});s.dataset.msgRole=n,i&&(s.dataset.msgId=i);let r=s.createDiv({cls:`codexidian-msg codexidian-msg-${n}`});return n==="user"&&i&&this.attachUserMessageActions(s,i),r}appendMessageToPanel(t,n,i,s){let r=this.createMessageEl(t,n,s);return r.setText(i),t.scrollTop=t.scrollHeight,r}attachUserMessageActions(t,n){let i=t.createDiv({cls:"codexidian-msg-actions"});i.createEl("button",{cls:"codexidian-msg-action-btn",text:"\u21A9",title:"Rewind to this message"}).addEventListener("click",a=>{a.preventDefault(),a.stopPropagation(),this.rewindToMessage(n)}),i.createEl("button",{cls:"codexidian-msg-action-btn",text:"\u2442",title:"Fork from this message"}).addEventListener("click",a=>{a.preventDefault(),a.stopPropagation(),this.forkFromMessage(n)})}async rewindToMessage(t){if(this.running){new f.Notice("Cannot rewind while a turn is running.");return}if(!window.confirm("Rewind to this message? Messages after it will be removed."))return;let i=this.tabManager.getActiveTab();if(i)try{let s=await i.conversationController.truncateAfter(t);if(!s||s.role!=="user"){new f.Notice("Unable to rewind: message not found.");return}this.removePanelContentFromMessage(i.panelEl,t),this.inputEl.value=s.content,this.inputEl.focus();try{let r=await this.plugin.client.newThread();i.conversationController.setThreadId(r),this.appendSystemMessageToPanel(i.panelEl,"Rewind complete. Started a fresh thread.")}catch(r){let a=r instanceof Error?r.message:String(r);this.appendSystemMessageToPanel(i.panelEl,`Rewind succeeded, but failed to start new thread: ${a}`)}}catch(s){let r=s instanceof Error?s.message:String(s);new f.Notice(`Rewind failed: ${r}`)}finally{this.updateStatus()}}async forkFromMessage(t){if(this.running){new f.Notice("Cannot fork while a turn is running.");return}if(this.tabManager.getAllTabStates().length>=this.plugin.settings.maxTabs){new f.Notice(`Cannot fork: max tabs (${this.plugin.settings.maxTabs}) reached.`);return}let i=this.tabManager.getActiveTab();if(i)try{let s=i.conversationController.getMessagesUpTo(t);if(s.length===0){new f.Notice("Unable to fork: message not found.");return}let r=this.tabManager.addTab(),a=await r.conversationController.createNew(`Fork ${new Date().toLocaleString()}`);this.tabManager.setConversationId(r.state.tabId,a.id),r.conversationController.setMessages(s),r.panelEl.empty(),await this.renderConversationMessages(r.panelEl,s);try{let o=await this.plugin.client.newThread();r.conversationController.setThreadId(o),this.appendSystemMessageToPanel(r.panelEl,"Fork created with a fresh thread.")}catch(o){let l=o instanceof Error?o.message:String(o);this.appendSystemMessageToPanel(r.panelEl,`Fork created, but failed to start new thread: ${l}`)}this.tabManager.switchTo(r.state.tabId),this.updateStatus()}catch(s){let r=s instanceof Error?s.message:String(s);new f.Notice(`Fork failed: ${r}`)}}removePanelContentFromMessage(t,n){let i=Array.from(t.children),s=i.findIndex(r=>r instanceof HTMLElement&&r.dataset.msgId===n);if(!(s<0)){for(let r=i.length-1;r>=s;r--)i[r].remove();t.scrollTop=t.scrollHeight}}appendSystemMessageToPanel(t,n){this.appendMessageToPanel(t,"system",n)}appendSystemMessage(t){var i;let n=(i=this.tabManager)==null?void 0:i.getActiveTab();n&&this.appendSystemMessageToPanel(n.panelEl,t)}async collectAttachedFileContents(t,n){var a,o;let s=new Set;for(let l of(o=(a=this.fileContext)==null?void 0:a.getFiles())!=null?o:[])s.add(l);this.includeCurrentNoteContent&&t&&s.add(t);let r=[];for(let l of s){let p=this.app.vault.getAbstractFileByPath(l);if(!(p instanceof f.TFile)){this.appendSystemMessageToPanel(n,`Context file not found: ${l}`);continue}try{let g=await this.app.vault.read(p);g.length>1e4&&(g=`${g.slice(0,1e4)}

...[truncated to 10000 characters]`),r.push({path:l,content:g})}catch(g){let m=g instanceof Error?g.message:String(g);this.appendSystemMessageToPanel(n,`Failed to read context file ${l}: ${m}`)}}return r}refreshCurrentNoteContext(){let t=this.getCurrentMarkdownNotePath();if(!t){this.noteContextEl.style.display="none",this.noteContextTextEl.setText(""),this.noteContextTextEl.title="",this.updateContextRowVisibility();return}this.noteContextEl.style.display="flex",this.noteContextTextEl.setText(`\u{1F4DD} ${this.getFileName(t)}`),this.noteContextTextEl.title=t,this.updateContextRowVisibility()}updateNoteContextToggle(){this.noteContextToggleEl.setText(this.includeCurrentNoteContent?"Include note: on":"Include note: off"),this.includeCurrentNoteContent?this.noteContextToggleEl.addClass("is-enabled"):this.noteContextToggleEl.removeClass("is-enabled")}updateContextRowVisibility(){let t=this.noteContextEl.style.display!=="none",n=this.selectionContextEl.style.display!=="none";this.contextRowEl.style.display=t||n?"flex":"none"}getFileName(t){let n=t.split("/");return n[n.length-1]||t}getCurrentMarkdownNotePath(){var i,s;let t=this.app.workspace.getActiveViewOfType(f.MarkdownView);if((i=t==null?void 0:t.file)!=null&&i.path)return t.file.path;let n=this.app.workspace.getLeavesOfType("markdown");for(let r of n){let a=r.view;if(a instanceof f.MarkdownView&&((s=a.file)!=null&&s.path))return a.file.path}return null}async showApprovalCard(t){var m,b;(m=this.statusPanel)==null||m.setTurnStatus("waiting_approval");let n=await this.ensureActiveTabForInlineCard();if(!n)return this.restoreStatusAfterInteractiveCard(),"decline";let i=`approval-${Date.now()}-${Math.random().toString(36).slice(2,8)}`;(b=this.statusPanel)==null||b.addEntry({id:i,type:"info",label:this.getApprovalTitle(t.type),detail:this.truncateStatusDetail(t.command||t.filePath||t.cwd),status:"running"});let s=n.panelEl.createDiv({cls:"codexidian-approval-card"}),r=s.createDiv({cls:"codexidian-approval-header"});r.createSpan({cls:"codexidian-approval-icon",text:t.type==="fileChange"||t.type==="applyPatch"?"\u{1F4DD}":"\u26A1"}),r.createSpan({text:this.getApprovalTitle(t.type)});let a=s.createDiv({cls:"codexidian-approval-body"});t.command&&a.createEl("code",{text:t.command}),t.filePath&&a.createDiv({cls:"codexidian-approval-meta",text:`File: ${t.filePath}`}),t.cwd&&a.createDiv({cls:"codexidian-approval-meta",text:`cwd: ${t.cwd}`}),!t.command&&!t.filePath&&t.params&&a.createEl("code",{text:JSON.stringify(t.params).slice(0,800)});let o=s.createDiv({cls:"codexidian-approval-actions"}),l=o.createEl("button",{cls:"codexidian-approval-btn approve",text:"Approve"}),p=o.createEl("button",{cls:"codexidian-approval-btn deny",text:"Deny"}),g=s.createDiv({cls:"codexidian-approval-status"});return n.panelEl.scrollTop=n.panelEl.scrollHeight,await new Promise(I=>{let d=!1,c=window.setTimeout(()=>{u("decline","Timed out (auto-denied)")},6e4),u=(h,y)=>{var S;d||(d=!0,window.clearTimeout(c),l.disabled=!0,p.disabled=!0,s.addClass("codexidian-approval-card-readonly"),s.addClass(h==="accept"?"codexidian-approval-accepted":"codexidian-approval-denied"),g.setText(`Decision: ${y}`),(S=this.statusPanel)==null||S.updateEntry(i,{status:h==="accept"?"completed":"failed"}),this.restoreStatusAfterInteractiveCard(),I(h))};l.addEventListener("click",()=>u("accept","Approved")),p.addEventListener("click",()=>u("decline","Denied"))})}async showUserInputCard(t){var m,b,I;(m=this.statusPanel)==null||m.setTurnStatus("waiting_approval");let n=await this.ensureActiveTabForInlineCard();if(!n)return this.restoreStatusAfterInteractiveCard(),this.buildDefaultUserInputResponse(t);let i=`input-${Date.now()}-${Math.random().toString(36).slice(2,8)}`;(b=this.statusPanel)==null||b.addEntry({id:i,type:"info",label:"User input request",detail:this.truncateStatusDetail(t.questions.map(d=>d.id).join(", ")),status:"running"});let s=n.panelEl.createDiv({cls:"codexidian-user-input-card"});s.createDiv({cls:"codexidian-user-input-header"}).createSpan({text:"User Input Request"});let a=new Map;for(let d of t.questions){let c=s.createDiv({cls:"codexidian-user-input-question"});c.createDiv({cls:"codexidian-user-input-text",text:d.text||d.id});let u=c.createDiv({cls:"codexidian-user-input-options"}),h=[],y="";for(let A of(I=d.options)!=null?I:[]){y||(y=A.label);let C=u.createEl("button",{cls:"codexidian-user-input-option",text:A.label});h.push(C)}let x={selected:null,inputEl:c.createEl("input",{cls:"codexidian-user-input-freeform",type:"text",placeholder:"Or type a custom answer"}),optionButtons:h,firstOption:y};a.set(d.id,x);for(let A of h)A.addEventListener("click",()=>{var C;x.selected=(C=A.textContent)!=null?C:"";for(let L of h)L===A?L.addClass("is-selected"):L.removeClass("is-selected")})}let l=s.createDiv({cls:"codexidian-user-input-actions"}).createEl("button",{cls:"codexidian-user-input-submit",text:"Submit"}),p=s.createDiv({cls:"codexidian-user-input-status"}),g=d=>{var u,h,y;if(d)return this.buildDefaultUserInputResponse(t);let c={};for(let S of t.questions){let x=a.get(S.id),A=(u=x==null?void 0:x.inputEl.value.trim())!=null?u:"",C=(h=x==null?void 0:x.selected)!=null?h:"",L=(y=x==null?void 0:x.firstOption)!=null?y:"",U=A||C||L;c[S.id]={answers:[U]}}return{answers:c}};return n.panelEl.scrollTop=n.panelEl.scrollHeight,await new Promise(d=>{let c=!1,u=window.setTimeout(()=>{h(g(!0),"Timed out. Used default answers.")},6e4),h=(y,S)=>{var x;if(!c){c=!0,window.clearTimeout(u),l.disabled=!0;for(let A of a.values()){A.inputEl.disabled=!0;for(let C of A.optionButtons)C.disabled=!0}s.addClass("codexidian-user-input-card-readonly"),p.setText(S),(x=this.statusPanel)==null||x.updateEntry(i,{status:S.startsWith("Timed out")?"failed":"completed"}),this.restoreStatusAfterInteractiveCard(),d(y)}};l.addEventListener("click",()=>{h(g(!1),"Submitted")})})}updateStatus(){let t=this.plugin.settings,n=this.plugin.client.getThreadId(),i=this.running?"Running":"Idle",s=n?`thread ${n.slice(0,8)}...`:"no thread";this.statusEl.setText(`${i} | ${s} | ${t.model||"default"} | ${t.thinkingEffort} | ${t.approvalPolicy}`),this.sendBtn.disabled=!1,this.inputEl.disabled=!1,this.newThreadBtn.disabled=this.running,this.restartBtn.disabled=this.running,this.updateQueueIndicator()}isValidTabManagerState(t){if(!t||typeof t!="object")return!1;let n=t;return!Array.isArray(n.openTabs)||n.activeTabId!==null&&n.activeTabId!==void 0&&typeof n.activeTabId!="string"?!1:n.openTabs.every(i=>i&&typeof i=="object"&&typeof i.tabId=="string"&&(i.conversationId===null||typeof i.conversationId=="string"))}async restoreTabsWithFallback(){let t=this.plugin.settings._tabManagerState;if(this.isValidTabManagerState(t))try{await this.tabManager.restoreState(t);for(let i of this.tabManager.getAllTabStates()){if(!i.conversationId)continue;let s=this.tabManager.getTab(i.tabId);s&&await this.restoreTabConversation(s)}}catch(i){let s=i instanceof Error?i.message:String(i);new f.Notice(`Codexidian: failed to restore tabs (${s}), creating a fresh tab.`)}if(!this.tabManager.getActiveTab()){let i=this.tabManager.getAllTabStates()[0];i&&this.tabManager.switchTo(i.tabId)}this.tabManager.getActiveTab()||await this.createNewTab()}async ensureActiveTabForInlineCard(){if(!this.tabManager)return null;let t=this.tabManager.getActiveTab();return t||(await this.createNewTab(),t=this.tabManager.getActiveTab()),t!=null?t:null}buildDefaultUserInputResponse(t){let n={};for(let i of t.questions){let s=i.options&&i.options.length>0?i.options[0].label:"";n[i.id]={answers:[s]}}return{answers:n}}getApprovalTitle(t){return t==="commandExecution"||t==="execCommand"?"Command Execution Request":t==="fileChange"||t==="applyPatch"?"File Change Request":"Approval Request"}resolveEntryStatus(t){let n=t.trim().toLowerCase();return n.includes("error")||n.includes("fail")||n.includes("deny")||n.includes("reject")||n.includes("cancel")||n.includes("interrupt")?"failed":"completed"}truncateStatusDetail(t){if(!t)return;let n=t.replace(/\s+/g," ").trim();if(n)return n.length<=80?n:`${n.slice(0,80)}...`}restoreStatusAfterInteractiveCard(){if(this.statusPanel){if(this.running){this.statusPanel.setTurnStatus("tool_calling");return}this.statusPanel.setTurnStatus("idle"),this.statusPanel.clearFinishedAfterDelay(3e3)}}};var st=class extends w.Plugin{constructor(){super(...arguments);this.settings={...z}}async onload(){await this.loadSettings(),this.client=new _(()=>this.settings,()=>this.getVaultBasePath(),t=>{this.settings.persistThread&&(this.settings.lastThreadId=t,this.saveSettings())},t=>{let n=this.getOpenView();n&&(n.appendSystemMessage(t),n.updateStatus())},async t=>await this.handleApprovalRequest(t),async t=>await this.handleUserInputRequest(t)),this.registerView(N,t=>new F(t,this)),this.addRibbonIcon("bot","Open Codexidian",()=>{this.activateView()}),this.addCommand({id:"open-codexidian",name:"Open Codexidian",callback:()=>{this.activateView()}}),this.addCommand({id:"codexidian-new-thread",name:"Codexidian: Start New Thread",callback:async()=>{try{let t=await this.client.newThread();new w.Notice(`Codexidian new thread: ${t.slice(0,8)}...`),this.refreshStatus()}catch(t){let n=t instanceof Error?t.message:String(t);new w.Notice(`Codexidian: ${n}`)}}}),this.addSettingTab(new dt(this.app,this))}async onunload(){this.app.workspace.detachLeavesOfType(N),this.client&&await this.client.dispose()}getVaultBasePath(){let t=this.app.vault.adapter;return t instanceof w.FileSystemAdapter?t.getBasePath():process.cwd()}getOpenView(){let t=this.app.workspace.getLeavesOfType(N);if(t.length===0)return null;let n=t[0].view;return n instanceof F?n:null}async handleApprovalRequest(t){let n=this.getOpenView();if(n||(await this.activateView(),n=this.getOpenView()),!n)throw new Error("Codexidian view is not available for approval.");return await n.showApprovalCard(t)}async handleUserInputRequest(t){let n=this.getOpenView();if(n||(await this.activateView(),n=this.getOpenView()),!n)throw new Error("Codexidian view is not available for user input.");return await n.showUserInputCard(t)}refreshStatus(){let t=this.getOpenView();t==null||t.updateStatus()}async activateView(){let t=this.app.workspace,n=t.getLeavesOfType(N)[0];if(!n){if(n=t.getRightLeaf(!1),!n)return;await n.setViewState({type:N,active:!0})}t.revealLeaf(n)}async loadSettings(){let t=await this.loadData();this.settings=Object.assign({},z,t!=null?t:{}),this.settings.workingDirectory.trim()||(this.settings.workingDirectory=this.getVaultBasePath())}async saveSettings(){await this.saveData(this.settings)}},dt=class extends w.PluginSettingTab{constructor(t,n){super(t,n);this.plugin=n}display(){let{containerEl:t}=this;t.empty(),t.createEl("h2",{text:"Codexidian Settings"}),new w.Setting(t).setName("Codex command").setDesc("CLI command used to launch app-server. Windows default: codex.cmd").addText(n=>n.setPlaceholder("codex.cmd").setValue(this.plugin.settings.codexCommand).onChange(async i=>{this.plugin.settings.codexCommand=i.trim()||z.codexCommand,await this.plugin.saveSettings()})),new w.Setting(t).setName("Working directory").setDesc("Root directory Codex uses for this plugin session.").addText(n=>n.setPlaceholder(this.plugin.getVaultBasePath()).setValue(this.plugin.settings.workingDirectory).onChange(async i=>{this.plugin.settings.workingDirectory=i.trim()||this.plugin.getVaultBasePath(),await this.plugin.saveSettings()})),new w.Setting(t).setName("Model").setDesc("Select the AI model for Codex sessions.").addDropdown(n=>{for(let i of B)n.addOption(i.value,i.label);n.setValue(this.plugin.settings.model).onChange(async i=>{this.plugin.settings.model=i,await this.plugin.saveSettings()})}),new w.Setting(t).setName("Thinking effort").setDesc("Control how deeply Codex thinks before responding.").addDropdown(n=>{for(let i of H)n.addOption(i.value,i.label);n.setValue(this.plugin.settings.thinkingEffort).onChange(async i=>{this.plugin.settings.thinkingEffort=i,await this.plugin.saveSettings()})}),new w.Setting(t).setName("Approval policy").setDesc("Codex ask-for-approval mode for new or resumed threads.").addDropdown(n=>n.addOption("on-request","on-request").addOption("never","never").addOption("untrusted","untrusted").addOption("on-failure","on-failure").setValue(this.plugin.settings.approvalPolicy).onChange(async i=>{this.plugin.settings.approvalPolicy=i,await this.plugin.saveSettings(),this.plugin.refreshStatus()})),new w.Setting(t).setName("Sandbox mode").setDesc("Sandbox mode for newly started or resumed threads.").addDropdown(n=>n.addOption("workspace-write","workspace-write").addOption("read-only","read-only").addOption("danger-full-access","danger-full-access").setValue(this.plugin.settings.sandboxMode).onChange(async i=>{this.plugin.settings.sandboxMode=i,await this.plugin.saveSettings(),this.plugin.refreshStatus()})),new w.Setting(t).setName("Auto-approve app-server requests").setDesc("If enabled, command/file approval callbacks are answered automatically.").addToggle(n=>n.setValue(this.plugin.settings.autoApproveRequests).onChange(async i=>{this.plugin.settings.autoApproveRequests=i,await this.plugin.saveSettings()})),new w.Setting(t).setName("Persist thread across restarts").setDesc("Reuse the last thread id when possible.").addToggle(n=>n.setValue(this.plugin.settings.persistThread).onChange(async i=>{this.plugin.settings.persistThread=i,i||(this.plugin.settings.lastThreadId="",this.plugin.client.setThreadId(null)),await this.plugin.saveSettings(),this.plugin.refreshStatus()})),new w.Setting(t).setName("Saved thread").setDesc(this.plugin.settings.lastThreadId||"(none)").addButton(n=>n.setButtonText("Clear").onClick(async()=>{this.plugin.settings.lastThreadId="",this.plugin.client.setThreadId(null),await this.plugin.saveSettings(),this.display(),this.plugin.refreshStatus(),new w.Notice("Codexidian saved thread cleared.")})),t.createEl("h3",{text:"UI Settings"}),new w.Setting(t).setName("Max tabs").setDesc("Maximum number of open tabs (1-5).").addSlider(n=>n.setLimits(1,5,1).setValue(this.plugin.settings.maxTabs).setDynamicTooltip().onChange(async i=>{this.plugin.settings.maxTabs=i,await this.plugin.saveSettings()})),new w.Setting(t).setName("Context injection").setDesc("Inject current note path and editor selection into prompts.").addToggle(n=>n.setValue(this.plugin.settings.enableContextInjection).onChange(async i=>{this.plugin.settings.enableContextInjection=i,await this.plugin.saveSettings()})),new w.Setting(t).setName("Selection polling").setDesc("Poll editor selection to show context indicator.").addToggle(n=>n.setValue(this.plugin.settings.enableSelectionPolling).onChange(async i=>{this.plugin.settings.enableSelectionPolling=i,await this.plugin.saveSettings()}))}};
