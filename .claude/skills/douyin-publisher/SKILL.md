---
name: douyin-publisher
description: 自动化抖音图文发布流程。适用于用户说"发抖音"、"发布"、"publish douyin"时触发。扫描素材文件夹，调用 Claude API 生成文案，通过 Puppeteer MCP 打开浏览器上传到抖音创作者平台，仅在最终发布步骤请求用户确认。
---

# 抖音图文发布流程

自动化的端到端发布流程：素材扫描 → 内容排序 → 文案生成 → 浏览器上传 → 用户确认 → 归档。

## 前置条件

- `.env` 中配置 `ANTHROPIC_API_KEY`（文案生成）
- Puppeteer MCP 已配置（浏览器自动化）
- 素材笔记由脚本自动创建（`ensure_daily_note()`），无需手动建文件夹

## 素材目录结构

```
抖音素材/
├── 待发布/
│   └── {YYYY-MM-DD}/
│       ├── {YYYY-MM-DD}.md     # 素材笔记（粘贴目标 + 文案草稿）
│       └── images/             # Obsidian 粘贴图片自动保存到这里
│           └── Pasted image *.png
├── 已发布/
│   └── {YYYY-MM-DD}/          # 发布后整个文件夹归档
└── 发布记录.md                 # 追加式发布日志
```

## 工作流

### Step 0: 确保今日笔记就绪
- 调用 `ensure_daily_note()` 自动创建 `待发布/{today}/{today}.md` 和 `images/` 子目录
- 如笔记已存在则跳过，幂等操作

### Step 1: 扫描素材
- 读取 `抖音素材/待发布/{today}/images/` 目录
- 识别图片文件（jpg, png, webp）
- 从 `{today}.md` 笔记的"文案草稿"部分提取用户手写文案
- 如无素材，提示用户打开笔记粘贴图片

### Step 2: 分析与排序
- 分析图片内容，确定最佳排列顺序：
  - 封面图（最有冲击力）→ 细节图（学习过程）→ 收尾图（成果/情感）
- 超过 9 张图片时建议裁剪（抖音图文上限）
- 向用户展示排序方案，可调整

### Step 3: 生成文案
- 读取当日 `考研计划/` 日志的 frontmatter 数据
- 根据用户选择的风格生成文案：

**风格 A — 任务汇报型：**
从 Planner 日志提取 math_hours, math_problems, completion_rate 等字段，生成数据驱动的进度汇报。示例：
> Day 15 | 数学 4.5h · 16题 · 完成率 85%
> 今天死磕微分方程欧拉方程，终于搞懂了 x=eᵗ 换元的本质...

**风格 B — 情感润色型：**
读取素材笔记中"文案草稿"部分的用户手写内容，结合素材内容和当日 mood 字段进行润色。保留用户原始情感，优化表达和节奏。

**标签自动追加：**
根据内容匹配标签组：#考研 #考研数学 #备考日常 #考研日记 #2027考研

### Step 4: 浏览器上传（Puppeteer MCP）
1. 导航到 `https://creator.douyin.com/creator-micro/content/publish`
2. 检查登录状态；未登录则暂停，等待用户扫码
3. 选择"图文"发布模式
4. 通过文件输入上传图片（按 Step 2 确定的顺序）
5. 填入文案到描述框
6. 等待上传完成

### Step 5: 用户确认（阻塞）
- 截取发布预览页面截图
- 向用户展示：图片顺序、文案内容、标签
- **必须等待用户明确输入 "确认" 或 "y" 后才能点击发布**
- 用户可在此步修改文案或调整图片

### Step 6: 发布与归档
- 点击发布按钮
- 等待发布成功确认
- 将素材从 `抖音素材/待发布/{today}/` 移至 `抖音素材/已发布/{today}/`
- 追加记录到 `抖音素材/发布记录.md`：
  ```markdown
  ## {date}
  - 图片数：{count}
  - 文案风格：{style}
  - 标签：{tags}
  ```

## 脚本

素材扫描、文案生成、归档等非交互操作由 `scripts/douyin_publish.py` 处理。
浏览器操作通过 Puppeteer MCP 工具直接调用。
