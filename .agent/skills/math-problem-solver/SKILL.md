---
name: math-problem-solver
description: 解答数学问题并以 Obsidian 可渲染的公式格式输出。适用于用户提问数学题、求解、计算、证明、推导、公式、方程等数学相关问题时触发。回答直接使用 $...$ 和 $$...$$ 书写公式，而不是代码块。
---

# 数学问题解答 Skill

当用户提出数学相关问题时，按照以下规范进行回答。

---

## 🔀 图片源互斥判定（最优先执行）

每次触发本 skill 时，**首先**执行以下判定，确定题目来源。**题目只分析一次，绝不重复。**

```
第一判定：用户聊天消息中是否包含图片？

  YES → 题目来源 = 聊天图片（绝对不读解题板里的图片）
        ├─ Vault 有最近 5 分钟内的 Pasted image → 模式 A1
        └─ Vault 无最近图片 → 模式 A2

  NO  → 题目来源 = 解题板 或 文字
        ├─ 解题板有未解答的图片 → 模式 B
        ├─ 用户发了文字数学题 → 模式 C
        └─ 用户对当前题追问 → 模式 D

  特殊：解题板有 <!-- 等待图片 embed --> + 用户说"贴好了" → 模式 E
```

> ⚠️ **核心原则**：聊天有图就用聊天图，不碰解题板图片；聊天没图才去读解题板。两个来源互斥。

---

## 📸 图片落盘检测算法

当需要判断图片是否"已落盘"时，按以下优先级搜索 `Pasted image*.png`：

1. `考研数学/images/`（用户在解题板视图下粘贴时直接落这里）
2. Vault 根目录
3. 其他 `*/images/` 一级子目录

从文件名解析时间戳 `YYYYMMDDHHMMSS`，**5 分钟内**视为"最近"。多个匹配时取最新的。

---

## 🎯 五种工作模式

### 模式 A1：聊天发图 + 图片已落盘

- **触发**：用户在聊天中发送了图片 AND 检测到 Vault 中有最近的 Pasted image
- **题目来源**：聊天图片（不读解题板）
- **动作**：
  1. 用聊天图片理解题目，在聊天框给出完整解答
  2. 将 Pasted image 移动到 `考研数学/images/`（如果不在的话）
  3. **覆盖写入** `考研数学/解题板.md`：embed 原图 + 完整解答
  4. 告知：「✅ 已更新解题板，原图已 embed。」

### 模式 A2：聊天发图 + 图片未落盘

- **触发**：用户在聊天中发送了图片 BUT Vault 中没有最近的 Pasted image
- **题目来源**：聊天图片（不读解题板）
- **动作**：
  1. 用聊天图片理解题目，在聊天框给出完整解答
  2. **覆盖写入** `考研数学/解题板.md`：`<!-- 等待图片 embed -->` 占位符 + 完整解答
  3. 告知：「📎 解答已写入解题板。请在 Obsidian 中 Ctrl+V 粘贴这张截图，然后回复「贴好了」，我会自动补上原图。」

---

### 模式 B：解题板读图

- **触发**：用户聊天中**没有发送图片**，但解题板中有图片 embed 且下方没有解答内容（或用户明确说"看解题板"/"解这道题"）
- **题目来源**：解题板中的图片
- **动作**：
  1. 读取 `考研数学/解题板.md`，识别其中的图片题目
  2. 在聊天框给出完整解答
  3. **覆盖写入** `考研数学/解题板.md`：保留原图 embed + 写入完整解答
  4. 告知：「✅ 已更新解题板。」

---

### 模式 C：纯文字新题

- **触发**：用户聊天中没有图片，发送了一道文字数学题
- **题目来源**：文字
- **动作**：
  1. 在聊天框给出完整解答
  2. **覆盖写入** `考研数学/解题板.md`：文字题目 + 完整解答
  3. 告知：「✅ 已更新解题板。」

---

### 模式 D：追问辨析

- **触发**：用户对**当前解题板上这道题**提出疑问或追问（如"第二步为什么"、"能不能用另一种方法"）
- **动作**：
  1. 在聊天框直接解答追问
  2. 在 `解题板.md` **末尾追加** `## 🤔 疑难辨析` 章节

---

### 模式 E：补图

- **触发**：解题板中有 `<!-- 等待图片 embed -->` 占位符，且用户说了"贴好了"/"我贴了"等确认语
- **动作**：
  1. 搜索最近的 Pasted image，移动到 `考研数学/images/`
  2. 将占位符替换为 `![[images/Pasted image xxx.png]]`
  3. 告知：「✅ 原图已补入解题板。」
  4. **不重新解题**，解答已经在了

> ⚠️ **白板规则**：模式 A1/A2/B/C 都是新题，每次全量覆盖解题板！绝对不追加堆叠！

---

## ⚠️ 核心规则（必须遵守）

1. **绝对禁止**将公式放入 ` ``` ` 或 ` ```latex ` 代码块中
2. **绝对禁止**使用反引号 `` ` `` 包裹任何公式
3. **必须**使用标准 LaTeX 书写公式：行内用 `$...$`，独立行用 `$$...$$`
4. 所有回答使用**中文**
5. 解题过程用**自然语言 + 公式混排**，像手写在纸上一样让人直接看懂
6. **解题板里的题目部分必须用原图 embed，绝对不要用文字解析替代题目**（文字解析可能有误，原图才准确）

---

## 📄 解题板写入格式

每次新题覆盖写入 `考研数学/解题板.md` 时，使用如下格式：

```markdown
---
tags: [数学, 解题]
date: {{YYYY-MM-DD}}
---

**📝 题目**

{{以下三选一：}}
![[images/Pasted image xxx.png]]        ← 模式 A1/B/E
<!-- 等待图片 embed -->                  ← 模式 A2（等用户粘贴）
（题目文字描述）                          ← 模式 C

**💡 解题思路**
（核心方法，2~3句话点明题眼）

**📐 详细步骤**

**第一步：...**
（步骤描述 + 公式）

**第二步：...**
...

**✅ 最终答案**

$$\boxed{答案}$$

---

## 📥 收录到错题本？
- [ ] 收录到错题本 · <自动推断章节>

**掌握度**（勾选一项）：
- [ ] 🟢 完全掌握
- [ ] 🟡 需要复习
- [ ] 🔴 仍有疑问
```

章节从以下固定列表中选择：**微分方程 / 无穷级数 / 多元函数积分 / 一元函数积分 / 微分学 / 线性代数 / 概率论**

---

## 追问追加格式（模式 D 专用）

在文件末尾追加：

```markdown
---

## 🤔 疑难辨析（{{日期}}）

**Q：用户的疑问**
> （引用用户的具体问题）

**A：分析与解答**
（针对性解释，可引用上面的步骤编号）
```

---

## LaTeX 公式规范

### 行内公式
用 `$...$` 包裹，如：设函数 $f(x) = x^2 + 1$，求 $f'(x)$。

### 独立行公式
用 `$$...$$` 包裹，如：

$$\int_0^\infty e^{-x^2} dx = \frac{\sqrt{\pi}}{2}$$

### 多行对齐推导
使用 `aligned` 环境：

$$\begin{aligned}
f(x) &= (x+1)^2 \\
&= x^2 + 2x + 1
\end{aligned}$$

### 矩阵
使用 `pmatrix`、`bmatrix` 等环境：

$$A = \begin{pmatrix} a_{11} & a_{12} \\ a_{21} & a_{22} \end{pmatrix}$$

### 分段函数
使用 `cases` 环境：

$$f(x) = \begin{cases} x^2, & x \geq 0 \\ -x, & x < 0 \end{cases}$$

---

## 🔗 速查表交叉引用

每次解题完成后（模式 A1/A2/B/C），执行以下交叉引用流程：

1. **读取速查表**：读取 `考研数学/固定解法速查表.md`，获取所有已收录模式的 H3 标题列表
2. **匹配判定**：将本题的核心解法与速查表模式逐一比对
   - **匹配成功** → 在解题板 `**💡 解题思路**` 段落末尾追加一行：`📋 固定模式：[[固定解法速查表#模式名]]`
   - **未匹配但具有固定性**（即本题解法属于「看到 X → 做 Y」的确定性模式）→ 在聊天中提示：「💡 这道题的解法具有固定模式特征，回复『收录』可添加到速查表。」
   - **不具有固定性**（开放性证明题、综合题等）→ 不做任何操作
3. **收录流程**：当用户回复「收录」时：
   - 根据题目所属章节，在 `考研数学/固定解法速查表.md` 对应 H2 章节下追加新的 H3 条目
   - 格式遵循速查表既有模板（触发/做法/公式/例题/频率标记）
   - **同步更新目录**：在文件顶部 `## 📑 目录` 中，找到对应章节（`- **章节名**`），在其下方嵌套列表末尾追加 `  - [[#模式名]]`（若该章节尚无子项，则在 `- **章节名**` 下一行新增缩进项）
   - 追加完成后告知：「✅ 已收录到 [[固定解法速查表#模式名]]，目录已同步。」

> ⚠️ 速查表只收录**确定性固定模式**，不收录需要灵活判断的综合技巧。

---

## 回答结构（聊天框输出）

### 解题思路分析（题眼）
先用 1~2 句话说清楚「看到什么条件就应该想到什么做法」，建立大脑自动化指令链路。

### 完整步骤
- 每一步都要有**文字说明**，不要只列公式
- 关键变量首次出现时要解释含义
- 复杂推导可以拆成小步，每步有过渡语句

### 核心总结
最后用一小段「大脑链路」总结，帮助用户应对同类题型。
